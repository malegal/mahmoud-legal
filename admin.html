<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المحامي - مؤسسة محمود عبد الحميد</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }
        
        body {
            background: #020617;
            color: #f8fafc;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* حماية الدخول */
        .login-protection {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .login-box {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #bf953f;
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(191, 149, 63, 0.3);
        }
        
        .login-box h2 {
            color: #bf953f;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .login-box input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(191, 149, 63, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            text-align: center;
        }
        
        /* لوحة التحكم */
        .admin-wrapper {
            display: none;
            min-height: 100vh;
        }
        
        .admin-header {
            background: rgba(0, 0, 0, 0.95);
            border-bottom: 2px solid #bf953f;
            padding: 20px 0;
        }
        
        .admin-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .admin-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 30px 0;
        }
        
        .admin-info h1 {
            color: #bf953f;
            font-size: 32px;
        }
        
        /* تبويبات */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-weight: bold;
            color: #94a3b8;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #bf953f 0%, #fcf6ba 100%);
            color: #020617;
        }
        
        /* محتوى التبويبات */
        .tab-content {
            display: none;
            background: rgba(0, 0, 0, 0.7);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 40px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* النماذج */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #bf953f;
            font-weight: bold;
        }
        
        .form-control {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(191, 149, 63, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 16px;
        }
        
        .btn {
            background: linear-gradient(135deg, #bf953f 0%, #fcf6ba 100%);
            color: #020617;
            padding: 15px 40px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* الجداول */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th {
            background: rgba(191, 149, 63, 0.2);
            color: #fcf6ba;
            padding: 15px;
            text-align: right;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(191, 149, 63, 0.1);
        }
        
        /* الرسائل */
        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }
        
        .message.success {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }
        
        .message.error {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid #f87171;
        }
    </style>
</head>
<body>
    <!-- حماية الدخول -->
    <div id="loginProtection" class="login-protection">
        <div class="login-box">
            <h2><i class="fas fa-lock"></i> دخول المحامي</h2>
            <input type="password" id="adminPassword" placeholder="أدخل كلمة المرور" value="mahmoud123">
            <button onclick="checkPassword()" class="btn">دخول</button>
        </div>
    </div>

    <!-- لوحة التحكم -->
    <div class="admin-wrapper" id="adminPanel">
        <header class="admin-header">
            <div class="admin-container">
                <div class="admin-info">
                    <h1><i class="fas fa-user-shield"></i> لوحة تحكم المحامي</h1>
                    <div>
                        <span style="color: #bf953f;">مرحباً، المحامي/محمود عبد الحميد</span>
                        <button class="btn" onclick="logout()" style="margin-right: 20px;">
                            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="admin-container">
            <!-- تبويبات -->
            <div class="tab-container">
                <button class="tab-btn active" onclick="switchTab('dashboard')">الإحصائيات</button>
                <button class="tab-btn" onclick="switchTab('cases')">إدارة القضايا</button>
                <button class="tab-btn" onclick="switchTab('sessions')">إدارة الجلسات</button>
                <button class="tab-btn" onclick="switchTab('fees')">إدارة الأتعاب</button>
                <button class="tab-btn" onclick="switchTab('search')">بحث متقدم</button>
            </div>

            <!-- الإحصائيات -->
            <div id="dashboard" class="tab-content active">
                <h2>نظرة عامة</h2>
                <div id="dashboardStats" class="form-grid">
                    <!-- سيتم تعبئتها بالجافاسكربت -->
                </div>
                <div id="recentCases">
                    <!-- سيتم تعبئتها بالجافاسكربت -->
                </div>
            </div>

            <!-- إدارة القضايا -->
            <div id="cases" class="tab-content">
                <h2>إضافة قضية جديدة</h2>
                <div id="caseMessage" class="message"></div>
                <form id="newCaseForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>اسم العميل *</label>
                            <input type="text" class="form-control" id="clientName" required>
                        </div>
                        <div class="form-group">
                            <label>رقم الهاتف *</label>
                            <input type="tel" class="form-control" id="clientPhone" required>
                        </div>
                        <div class="form-group">
                            <label>رقم القضية *</label>
                            <input type="text" class="form-control" id="caseNumber" required>
                        </div>
                        <div class="form-group">
                            <label>سنة القضية *</label>
                            <select class="form-control" id="caseYear" required>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>نوع القضية</label>
                            <select class="form-control" id="caseType">
                                <option value="مدنية">مدنية</option>
                                <option value="جنائية">جنائية</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>المحكمة</label>
                            <input type="text" class="form-control" id="court">
                        </div>
                    </div>
                    <button type="submit" class="btn">حفظ القضية</button>
                </form>
                
                <div style="margin-top: 50px;">
                    <h3>جميع القضايا</h3>
                    <div id="casesList"></div>
                </div>
            </div>

            <!-- إدارة الجلسات -->
            <div id="sessions" class="tab-content">
                <h2>إضافة جلسة جديدة</h2>
                <div id="sessionMessage" class="message"></div>
                <form id="newSessionForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>كود القضية *</label>
                            <select class="form-control" id="sessionCaseCode" required>
                                <option value="">اختر القضية</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>تاريخ الجلسة *</label>
                            <input type="date" class="form-control" id="sessionDate" required>
                        </div>
                        <div class="form-group">
                            <label>وقت الجلسة</label>
                            <input type="time" class="form-control" id="sessionTime">
                        </div>
                        <div class="form-group">
                            <label>القرار</label>
                            <textarea class="form-control" id="decision"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn">حفظ الجلسة</button>
                </form>
                
                <div style="margin-top: 50px;">
                    <h3>الجلسات القادمة</h3>
                    <div id="upcomingSessions"></div>
                </div>
            </div>

            <!-- إدارة الأتعاب -->
            <div id="fees" class="tab-content">
                <h2>إضافة أتعاب جديدة</h2>
                <div id="feeMessage" class="message"></div>
                <form id="newFeeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>كود القضية *</label>
                            <select class="form-control" id="feeCaseCode" required>
                                <option value="">اختر القضية</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>المبلغ المدفوع *</label>
                            <input type="number" class="form-control" id="paidAmount" required>
                        </div>
                        <div class="form-group">
                            <label>تاريخ الدفع *</label>
                            <input type="date" class="form-control" id="paymentDate" required>
                        </div>
                        <div class="form-group">
                            <label>ملاحظات</label>
                            <textarea class="form-control" id="feeNotes"></textarea>
                        </div>
                    </div>
                    <div id="feeSummary" style="background: rgba(191, 149, 63, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
                        <p>إجمالي الأتعاب: <span id="totalFeesAmount">0</span> ج.م</p>
                        <p>المدفوع سابقاً: <span id="previousPaid">0</span> ج.م</p>
                        <p>الباقي: <span id="remainingAmount">0</span> ج.م</p>
                    </div>
                    <button type="submit" class="btn">حفظ الدفعة</button>
                </form>
                
                <div style="margin-top: 50px;">
                    <h3>ملخص الأتعاب</h3>
                    <div id="feesSummary"></div>
                </div>
            </div>

            <!-- البحث -->
            <div id="search" class="tab-content">
                <h2>بحث متقدم</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>بحث باسم العميل</label>
                        <input type="text" class="form-control" id="searchClientName">
                    </div>
                    <div class="form-group">
                        <label>بحث برقم الهاتف</label>
                        <input type="tel" class="form-control" id="searchPhone">
                    </div>
                    <div class="form-group">
                        <label>بحث برقم القضية</label>
                        <input type="text" class="form-control" id="searchCaseNumber">
                    </div>
                </div>
                <button class="btn" onclick="performSearch()">بحث</button>
                
                <div id="searchResults" style="margin-top: 30px;"></div>
            </div>
        </main>
    </div>

    <script>
        // إعداد Supabase
        const SUPABASE_URL = 'https://iyhfafodhptcdwrjywek.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ';
        
        let supabase = null;

        // تهيئة Supabase
        async function initSupabase() {
            try {
                // تحميل المكتبة
                if (!window.supabase) {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
                    await new Promise((resolve, reject) => {
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }
                
                // إنشاء العميل
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ تم تهيئة Supabase');
                return true;
            } catch (error) {
                console.error('❌ خطأ في تهيئة Supabase:', error);
                showMessage('caseMessage', 'خطأ في الاتصال بقاعدة البيانات', 'error');
                return false;
            }
        }

        // توليد كود قضية
        function generateCaseCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = 'MAH';
            for (let i = 0; i < 5; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // دوال CRUD للقضايا
        async function addCase(caseData) {
            try {
                const caseCode = generateCaseCode();
                const { data, error } = await supabase
                    .from('cases')
                    .insert([{
                        case_code: caseCode,
                        client_name: caseData.clientName,
                        client_phone: caseData.clientPhone,
                        case_number: caseData.caseNumber,
                        case_year: caseData.caseYear,
                        case_type: caseData.caseType,
                        court: caseData.court,
                        case_status: 'متداولة'
                    }])
                    .select();

                if (error) throw error;
                return { success: true, caseCode, data: data[0] };
            } catch (error) {
                console.error('خطأ في إضافة القضية:', error);
                return { success: false, error: error.message };
            }
        }

        async function getAllCases() {
            try {
                const { data, error } = await supabase
                    .from('cases')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('خطأ في جلب القضايا:', error);
                return [];
            }
        }

        // دوال CRUD للجلسات
        async function addSession(sessionData) {
            try {
                // الحصول على case_id من case_code
                const { data: caseData, error: caseError } = await supabase
                    .from('cases')
                    .select('id')
                    .eq('case_code', sessionData.caseCode)
                    .single();

                if (caseError) throw caseError;

                const { data, error } = await supabase
                    .from('sessions')
                    .insert([{
                        case_id: caseData.id,
                        session_date: sessionData.sessionDate,
                        session_time: sessionData.sessionTime,
                        decision: sessionData.decision
                    }])
                    .select();

                if (error) throw error;
                return { success: true, data: data[0] };
            } catch (error) {
                console.error('خطأ في إضافة الجلسة:', error);
                return { success: false, error: error.message };
            }
        }

        async function getUpcomingSessions() {
            try {
                const { data, error } = await supabase
                    .from('sessions')
                    .select(`
                        *,
                        cases (case_code, client_name, case_number)
                    `)
                    .gte('session_date', new Date().toISOString().split('T')[0])
                    .order('session_date', { ascending: true })
                    .limit(10);

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('خطأ في جلب الجلسات:', error);
                return [];
            }
        }

        // دوال CRUD للأتعاب
        async function addFee(feeData) {
            try {
                // الحصول على case_id من case_code
                const { data: caseData, error: caseError } = await supabase
                    .from('cases')
                    .select('id, total_fees')
                    .eq('case_code', feeData.caseCode)
                    .single();

                if (caseError) throw caseError;

                const { data, error } = await supabase
                    .from('fees')
                    .insert([{
                        case_id: caseData.id,
                        paid_amount: feeData.paidAmount,
                        total_amount: caseData.total_fees || 0,
                        payment_date: feeData.paymentDate,
                        notes: feeData.notes
                    }])
                    .select();

                if (error) throw error;
                return { success: true, data: data[0] };
            } catch (error) {
                console.error('خطأ في إضافة الأتعاب:', error);
                return { success: false, error: error.message };
            }
        }

        async function getFeesSummary() {
            try {
                const { data, error } = await supabase
                    .from('cases')
                    .select(`
                        case_code,
                        client_name,
                        total_fees,
                        fees (paid_amount)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('خطأ في جلب الأتعاب:', error);
                return [];
            }
        }

        // واجهة المستخدم
        function showMessage(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        function switchTab(tabName) {
            // إخفاء جميع المحتويات
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إلغاء تفعيل جميع الأزرار
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // إظهار المحتوى المحدد
            document.getElementById(tabName).classList.add('active');
            
            // تفعيل الزر المحدد
            event.target.classList.add('active');
            
            // تحميل البيانات إذا لزم
            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'cases') loadCasesList();
            if (tabName === 'sessions') loadUpcomingSessions();
            if (tabName === 'fees') loadFeesSummary();
        }

        async function loadDashboard() {
            const cases = await getAllCases();
            const stats = document.getElementById('dashboardStats');
            
            const totalCases = cases.length;
            const activeCases = cases.filter(c => c.case_status === 'متداولة').length;
            const closedCases = cases.filter(c => c.case_status === 'مغلقة').length;
            
            stats.innerHTML = `
                <div style="background: rgba(191, 149, 63, 0.1); padding: 30px; border-radius: 15px; text-align: center;">
                    <h3>إجمالي القضايا</h3>
                    <p style="font-size: 48px; color: #fcf6ba;">${totalCases}</p>
                </div>
                <div style="background: rgba(191, 149, 63, 0.1); padding: 30px; border-radius: 15px; text-align: center;">
                    <h3>القضايا النشطة</h3>
                    <p style="font-size: 48px; color: #34D399;">${activeCases}</p>
                </div>
                <div style="background: rgba(191, 149, 63, 0.1); padding: 30px; border-radius: 15px; text-align: center;">
                    <h3>القضايا المغلقة</h3>
                    <p style="font-size: 48px; color: #F87171;">${closedCases}</p>
                </div>
            `;
            
            // عرض آخر القضايا
            const recentCases = cases.slice(0, 5);
            const recentCasesDiv = document.getElementById('recentCases');
            if (recentCases.length > 0) {
                let html = '<h3 style="margin-top: 40px;">آخر القضايا</h3><table class="data-table"><tr><th>الكود</th><th>العميل</th><th>رقم القضية</th><th>الحالة</th></tr>';
                recentCases.forEach(c => {
                    html += `<tr><td>${c.case_code}</td><td>${c.client_name}</td><td>${c.case_number}</td><td>${c.case_status}</td></tr>`;
                });
                html += '</table>';
                recentCasesDiv.innerHTML = html;
            }
        }

        async function loadCasesList() {
            const cases = await getAllCases();
            const casesList = document.getElementById('casesList');
            
            if (cases.length > 0) {
                let html = '<table class="data-table"><tr><th>الكود</th><th>اسم العميل</th><th>رقم الهاتف</th><th>رقم القضية</th><th>السنة</th><th>الحالة</th></tr>';
                cases.forEach(c => {
                    html += `<tr>
                        <td>${c.case_code || 'غير معروف'}</td>
                        <td>${c.client_name}</td>
                        <td>${c.client_phone}</td>
                        <td>${c.case_number}</td>
                        <td>${c.case_year}</td>
                        <td>${c.case_status}</td>
                    </tr>`;
                });
                html += '</table>';
                casesList.innerHTML = html;
            } else {
                casesList.innerHTML = '<p style="color: #94a3b8; text-align: center;">لا توجد قضايا مسجلة</p>';
            }
            
            // تحديث قوائم الاختيار
            updateCaseCodeSelects(cases);
        }

        async function loadUpcomingSessions() {
            const sessions = await getUpcomingSessions();
            const upcomingDiv = document.getElementById('upcomingSessions');
            
            if (sessions.length > 0) {
                let html = '<table class="data-table"><tr><th>كود القضية</th><th>اسم العميل</th><th>تاريخ الجلسة</th><th>الوقت</th></tr>';
                sessions.forEach(s => {
                    const caseInfo = s.cases || {};
                    html += `<tr>
                        <td>${caseInfo.case_code || 'غير معروف'}</td>
                        <td>${caseInfo.client_name || 'غير معروف'}</td>
                        <td>${s.session_date}</td>
                        <td>${s.session_time || 'غير محدد'}</td>
                    </tr>`;
                });
                html += '</table>';
                upcomingDiv.innerHTML = html;
            } else {
                upcomingDiv.innerHTML = '<p style="color: #94a3b8; text-align: center;">لا توجد جلسات قادمة</p>';
            }
        }

        async function loadFeesSummary() {
            const summary = await getFeesSummary();
            const summaryDiv = document.getElementById('feesSummary');
            
            if (summary.length > 0) {
                let html = '<table class="data-table"><tr><th>كود القضية</th><th>اسم العميل</th><th>الإجمالي</th><th>المدفوع</th><th>الباقي</th></tr>';
                summary.forEach(item => {
                    const totalPaid = item.fees ? item.fees.reduce((sum, fee) => sum + (fee.paid_amount || 0), 0) : 0;
                    const remaining = (item.total_fees || 0) - totalPaid;
                    
                    html += `<tr>
                        <td>${item.case_code}</td>
                        <td>${item.client_name}</td>
                        <td>${(item.total_fees || 0).toLocaleString()} ج.م</td>
                        <td>${totalPaid.toLocaleString()} ج.م</td>
                        <td style="color: ${remaining > 0 ? '#F87171' : '#34D399'}">
                            ${remaining.toLocaleString()} ج.م
                        </td>
                    </tr>`;
                });
                html += '</table>';
                summaryDiv.innerHTML = html;
            } else {
                summaryDiv.innerHTML = '<p style="color: #94a3b8; text-align: center;">لا توجد بيانات للأتعاب</p>';
            }
        }

        function updateCaseCodeSelects(cases) {
            const sessionSelect = document.getElementById('sessionCaseCode');
            const feeSelect = document.getElementById('feeCaseCode');
            
            // حفظ القيم الحالية
            const sessionValue = sessionSelect.value;
            const feeValue = feeSelect.value;
            
            // تحديث الخيارات
            sessionSelect.innerHTML = '<option value="">اختر القضية</option>';
            feeSelect.innerHTML = '<option value="">اختر القضية</option>';
            
            cases.forEach(c => {
                const option = document.createElement('option');
                option.value = c.case_code;
                option.textContent = `${c.case_code} - ${c.client_name}`;
                sessionSelect.appendChild(option.cloneNode(true));
                feeSelect.appendChild(option);
            });
            
            // استعادة القيم
            sessionSelect.value = sessionValue;
            feeSelect.value = feeValue;
        }

        async function performSearch() {
            const clientName = document.getElementById('searchClientName').value;
            const phone = document.getElementById('searchPhone').value;
            const caseNumber = document.getElementById('searchCaseNumber').value;
            
            try {
                let query = supabase.from('cases').select('*');
                
                if (clientName) query = query.ilike('client_name', `%${clientName}%`);
                if (phone) query = query.eq('client_phone', phone);
                if (caseNumber) query = query.ilike('case_number', `%${caseNumber}%`);
                
                const { data, error } = await query.order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const resultsDiv = document.getElementById('searchResults');
                if (data.length > 0) {
                    let html = `<h3>نتائج البحث (${data.length} نتيجة)</h3>`;
                    html += '<table class="data-table"><tr><th>الكود</th><th>اسم العميل</th><th>رقم الهاتف</th><th>رقم القضية</th><th>الحالة</th></tr>';
                    data.forEach(c => {
                        html += `<tr>
                            <td>${c.case_code}</td>
                            <td>${c.client_name}</td>
                            <td>${c.client_phone}</td>
                            <td>${c.case_number}</td>
                            <td>${c.case_status}</td>
                        </tr>`;
                    });
                    html += '</table>';
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = '<p style="color: #94a3b8; text-align: center;">لم يتم العثور على نتائج</p>';
                }
            } catch (error) {
                console.error('خطأ في البحث:', error);
                showMessage('searchResults', 'خطأ في البحث', 'error');
            }
        }

        // مستمعات الأحداث
        document.addEventListener('DOMContentLoaded', async function() {
            // تهيئة Supabase
            await initSupabase();
            
            // تحميل القضايا لتحديث القوائم
            const cases = await getAllCases();
            updateCaseCodeSelects(cases);
            
            // إعداد النماذج
            document.getElementById('newCaseForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const caseData = {
                    clientName: document.getElementById('clientName').value,
                    clientPhone: document.getElementById('clientPhone').value,
                    caseNumber: document.getElementById('caseNumber').value,
                    caseYear: document.getElementById('caseYear').value,
                    caseType: document.getElementById('caseType').value,
                    court: document.getElementById('court').value
                };
                
                const result = await addCase(caseData);
                if (result.success) {
                    showMessage('caseMessage', `تم إضافة القضية بنجاح! الكود: ${result.caseCode}`, 'success');
                    this.reset();
                    loadCasesList();
                    loadDashboard();
                } else {
                    showMessage('caseMessage', `خطأ: ${result.error}`, 'error');
                }
            });
            
            document.getElementById('newSessionForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const sessionData = {
                    caseCode: document.getElementById('sessionCaseCode').value,
                    sessionDate: document.getElementById('sessionDate').value,
                    sessionTime: document.getElementById('sessionTime').value,
                    decision: document.getElementById('decision').value
                };
                
                const result = await addSession(sessionData);
                if (result.success) {
                    showMessage('sessionMessage', 'تم إضافة الجلسة بنجاح', 'success');
                    this.reset();
                    loadUpcomingSessions();
                } else {
                    showMessage('sessionMessage', `خطأ: ${result.error}`, 'error');
                }
            });
            
            document.getElementById('newFeeForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const feeData = {
                    caseCode: document.getElementById('feeCaseCode').value,
                    paidAmount: parseFloat(document.getElementById('paidAmount').value),
                    paymentDate: document.getElementById('paymentDate').value,
                    notes: document.getElementById('feeNotes').value
                };
                
                const result = await addFee(feeData);
                if (result.success) {
                    showMessage('feeMessage', 'تم إضافة الدفعة بنجاح', 'success');
                    this.reset();
                    loadFeesSummary();
                } else {
                    showMessage('feeMessage', `خطأ: ${result.error}`, 'error');
                }
            });
            
            // عند اختيار قضية في الأتعاب
            document.getElementById('feeCaseCode').addEventListener('change', async function() {
                const caseCode = this.value;
                if (!caseCode) {
                    document.getElementById('feeSummary').style.display = 'none';
                    return;
                }
                
                try {
                    const { data, error } = await supabase
                        .from('cases')
                        .select('total_fees')
                        .eq('case_code', caseCode)
                        .single();
                    
                    if (error) throw error;
                    
                    const { data: feesData, error: feesError } = await supabase
                        .from('fees')
                        .select('paid_amount')
                        .eq('cases.case_code', caseCode);
                    
                    if (feesError && feesError.code !== 'PGRST116') throw feesError;
                    
                    const totalFees = data.total_fees || 0;
                    const totalPaid = feesData ? feesData.reduce((sum, fee) => sum + (fee.paid_amount || 0), 0) : 0;
                    const remaining = totalFees - totalPaid;
                    
                    document.getElementById('totalFeesAmount').textContent = totalFees.toLocaleString();
                    document.getElementById('previousPaid').textContent = totalPaid.toLocaleString();
                    document.getElementById('remainingAmount').textContent = remaining.toLocaleString();
                    document.getElementById('feeSummary').style.display = 'block';
                } catch (error) {
                    console.error('خطأ في جلب بيانات الأتعاب:', error);
                }
            });
            
            // تعيين التواريخ الافتراضية
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sessionDate').value = today;
            document.getElementById('paymentDate').value = today;
        });

        // حماية الدخول
        function checkPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'mahmoud123') {
                document.getElementById('loginProtection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadDashboard();
            } else {
                alert('كلمة المرور غير صحيحة');
            }
        }

        function logout() {
            if (confirm('هل تريد تسجيل الخروج؟')) {
                document.getElementById('adminPanel').style.display = 'none';
                document.getElementById('loginProtection').style.display = 'flex';
                document.getElementById('adminPassword').value = '';
            }
        }
    </script>
</body>
</html>
