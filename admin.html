<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة القضايا</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #1abc9c;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            padding: 10px 25px;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .case-code {
            font-family: monospace;
            font-size: 1.2rem;
            background-color: #e8f4fc;
            padding: 10px 15px;
            border-radius: 5px;
            border-right: 4px solid var(--accent-color);
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-new { background-color: #d1ecf1; color: #0c5460; }
        .status-in-progress { background-color: #fff3cd; color: #856404; }
        .status-completed { background-color: #d4edda; color: #155724; }
        
        .form-label {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .list-group-item {
            border-right: 5px solid transparent;
            transition: all 0.2s;
        }
        
        .list-group-item:hover {
            border-right-color: var(--accent-color);
            background-color: #f8f9fa;
        }
        
        @media (max-width: 768px) {
            .header {
                text-align: center;
            }
            
            .card {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- رأس الصفحة -->
        <div class="header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-journal-bookmark-fill me-2"></i>نظام إدارة القضايا</h1>
                    <p class="mb-0">أدخل بيانات القضية وستحفظ تلقائياً في قاعدة البيانات</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <div class="case-code" id="lastCaseCode">
                        <span id="currentCaseCode">لم يتم إنشاء قضية بعد</span>
                    </div>
                    <small class="text-light">رمز آخر قضية</small>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- نموذج إدخال القضية -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-pencil-square me-2"></i>إدخال بيانات القضية</h5>
                    </div>
                    <div class="card-body">
                        <form id="caseForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="caseTitle" class="form-label">عنوان القضية *</label>
                                    <input type="text" class="form-control" id="caseTitle" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="caseType" class="form-label">نوع القضية *</label>
                                    <select class="form-select" id="caseType" required>
                                        <option value="">اختر نوع القضية</option>
                                        <option value="مدني">مدني</option>
                                        <option value="جنائي">جنائي</option>
                                        <option value="تجاري">تجاري</option>
                                        <option value="إداري">إداري</option>
                                        <option value="أحوال شخصية">أحوال شخصية</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="caseDescription" class="form-label">وصف القضية</label>
                                <textarea class="form-control" id="caseDescription" rows="4" placeholder="أدخل وصفاً مفصلاً للقضية..."></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="clientName" class="form-label">اسم العميل *</label>
                                    <input type="text" class="form-control" id="clientName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="priority" class="form-label">الأولوية *</label>
                                    <select class="form-select" id="priority" required>
                                        <option value="منخفضة">منخفضة</option>
                                        <option value="متوسطة" selected>متوسطة</option>
                                        <option value="عالية">عالية</option>
                                        <option value="عاجلة">عاجلة</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="status" class="form-label">حالة القضية *</label>
                                <select class="form-select" id="status" required>
                                    <option value="جديدة">جديدة</option>
                                    <option value="قيد التحقيق">قيد التحقيق</option>
                                    <option value="قيد المحاكمة">قيد المحاكمة</option>
                                    <option value="محكوم فيها">محكوم فيها</option>
                                    <option value="مغلقة">مغلقة</option>
                                </select>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="reset" class="btn btn-outline-secondary me-md-2">
                                    <i class="bi bi-x-circle me-1"></i>مسح النموذج
                                </button>
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <i class="bi bi-save me-1"></i>حفظ القضية
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- معلومات الاتصال بـ Supabase -->
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-database me-2"></i>اتصال قاعدة البيانات</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle me-2"></i>إعدادات Supabase</h6>
                            <p class="mb-2">تأكد من تعبئة إعدادات Supabase في ملف <code>admin.html</code> لربط النظام بقاعدة البيانات.</p>
                            <div class="mt-2">
                                <span class="badge bg-success" id="connectionStatus">جارٍ التحقق من الاتصال...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- معاينة القضايا -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>آخر القضايا المضافة</h5>
                        <button class="btn btn-sm btn-outline-primary" id="refreshCases">
                            <i class="bi bi-arrow-clockwise"></i> تحديث
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="casesList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">جارٍ التحميل...</span>
                                </div>
                                <p class="mt-3">جارٍ تحميل القضايا...</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-white">
                        <small class="text-muted">يتم عرض آخر 10 قضايا تم إضافتها</small>
                    </div>
                </div>
                
                <!-- إشعارات النظام -->
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-bell me-2"></i>إشعارات النظام</h5>
                    </div>
                    <div class="card-body">
                        <div id="notifications">
                            <div class="alert alert-light mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                <span>مرحباً بك في نظام إدارة القضايا</span>
                                <small class="d-block text-muted">منذ لحظات</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- تذييل الصفحة -->
        <footer class="mt-5 mb-4 text-center text-muted">
            <hr>
            <p>نظام إدارة القضايا | تم التطوير باستخدام Supabase &copy; 2026</p>
        </footer>
    </div>

    <!-- نموذج نجاح الإضافة -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-success"><i class="bi bi-check-circle-fill me-2"></i>تم الحفظ بنجاح</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-4">
                        <div class="display-6 text-success mb-2"><i class="bi bi-check2-circle"></i></div>
                        <h4>تم حفظ القضية في قاعدة البيانات</h4>
                    </div>
                    <div class="mb-4">
                        <p>رمز القضية المولّد:</p>
                        <div class="case-code display-6 mb-3" id="generatedCaseCode"></div>
                        <p>يمكنك استخدام هذا الرمز للرجوع إلى القضية في أي وقت</p>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">متابعة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- مكتبة Supabase JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ============================================
        // إعدادات Supabase - يجب تحديثها بمعلومات مشروعك
        // ============================================
        const SUPABASE_URL = 'https://your-project-id.supabase.co'; // استبدل بـ URL مشروعك
        const SUPABASE_ANON_KEY = 'your-anon-key'; // استبدل بمفتاح المشروع العام
        
        // ============================================
        // تهيئة عميل Supabase
        // ============================================
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ============================================
        // توليد رمز قضية فريد
        // ============================================
        function generateCaseCode() {
            const prefix = 'CASE';
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}-${timestamp}-${random}`;
        }
        
        // ============================================
        // إدارة النموذج وإرسال البيانات
        // ============================================
        document.getElementById('caseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            // تعطيل زر الإرسال أثناء المعالجة
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> جاري الحفظ...';
            
            try {
                // توليد رمز قضية فريد
                const caseCode = generateCaseCode();
                
                // جمع بيانات النموذج
                const caseData = {
                    case_code: caseCode,
                    title: document.getElementById('caseTitle').value,
                    type: document.getElementById('caseType').value,
                    description: document.getElementById('caseDescription').value,
                    client_name: document.getElementById('clientName').value,
                    priority: document.getElementById('priority').value,
                    status: document.getElementById('status').value,
                    created_at: new Date().toISOString()
                };
                
                // إرسال البيانات إلى Supabase
                const { data, error } = await supabase
                    .from('cases')
                    .insert([caseData])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                // عرض رمز القضية المولدة
                document.getElementById('generatedCaseCode').textContent = caseCode;
                document.getElementById('currentCaseCode').textContent = caseCode;
                
                // إظهار نافذة النجاح
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
                
                // إضافة إشعار
                addNotification(`تم إنشاء قضية جديدة: ${caseData.title}`, 'success');
                
                // تحديث قائمة القضايا
                loadCases();
                
                // إعادة تعيين النموذج
                document.getElementById('caseForm').reset();
                
            } catch (error) {
                console.error('Error saving case:', error);
                addNotification(`فشل حفظ القضية: ${error.message}`, 'danger');
                
                // عرض خطأ للمستخدم
                alert(`حدث خطأ أثناء حفظ القضية: ${error.message}`);
            } finally {
                // إعادة تمكين زر الإرسال
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
        
        // ============================================
        // تحميل وعرض القضايا
        // ============================================
        async function loadCases() {
            try {
                const { data, error } = await supabase
                    .from('cases')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                const casesList = document.getElementById('casesList');
                
                if (data && data.length > 0) {
                    let html = '<div class="list-group">';
                    
                    data.forEach((caseItem, index) => {
                        const statusClass = getStatusClass(caseItem.status);
                        const priorityClass = getPriorityClass(caseItem.priority);
                        
                        html += `
                        <div class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <div class="me-3">
                                    <h6 class="mb-1">${caseItem.title}</h6>
                                    <p class="mb-1 text-muted">${caseItem.description ? caseItem.description.substring(0, 80) + '...' : 'لا يوجد وصف'}</p>
                                    <small class="text-muted">العميل: ${caseItem.client_name}</small>
                                </div>
                                <div class="text-end">
                                    <div class="d-flex flex-column align-items-end">
                                        <span class="badge ${statusClass} mb-1">${caseItem.status}</span>
                                        <span class="badge ${priorityClass} mb-2">${caseItem.priority}</span>
                                        <code class="text-primary">${caseItem.case_code}</code>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <small><i class="bi bi-calendar me-1"></i>${formatDate(caseItem.created_at)}</small>
                                <small><i class="bi bi-grid-3x3-gap me-1"></i>${caseItem.type}</small>
                            </div>
                        </div>
                        `;
                    });
                    
                    html += '</div>';
                    casesList.innerHTML = html;
                    
                    // تحديث حالة الاتصال
                    document.getElementById('connectionStatus').className = 'badge bg-success';
                    document.getElementById('connectionStatus').textContent = 'متصل بقاعدة البيانات';
                    
                } else {
                    casesList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-journal-x display-4 text-muted mb-3"></i>
                        <h5 class="text-muted">لا توجد قضايا مسجلة</h5>
                        <p class="text-muted">ابدأ بإضافة أول قضية باستخدام النموذج على اليسار</p>
                    </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading cases:', error);
                document.getElementById('casesList').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>خطأ في تحميل البيانات:</strong> ${error.message}
                </div>
                `;
                
                // تحديث حالة الاتصال
                document.getElementById('connectionStatus').className = 'badge bg-danger';
                document.getElementById('connectionStatus').textContent = 'انقطع الاتصال بقاعدة البيانات';
            }
        }
        
        // ============================================
        // وظائف مساعدة
        // ============================================
        function getStatusClass(status) {
            switch(status) {
                case 'جديدة': return 'status-new';
                case 'قيد التحقيق': return 'status-in-progress';
                case 'محكوم فيها': return 'status-completed';
                default: return 'bg-secondary';
            }
        }
        
        function getPriorityClass(priority) {
            switch(priority) {
                case 'عاجلة': return 'bg-danger';
                case 'عالية': return 'bg-warning text-dark';
                case 'متوسطة': return 'bg-info';
                case 'منخفضة': return 'bg-secondary';
                default: return 'bg-light text-dark';
            }
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function addNotification(message, type = 'info') {
            const notifications = document.getElementById('notifications');
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'danger' ? 'alert-danger' : 
                              type === 'warning' ? 'alert-warning' : 'alert-light';
            
            const icon = type === 'success' ? 'bi-check-circle text-success' :
                        type === 'danger' ? 'bi-exclamation-circle text-danger' :
                        type === 'warning' ? 'bi-exclamation-triangle text-warning' : 'bi-info-circle text-info';
            
            const notification = `
            <div class="alert ${alertClass} mb-2">
                <i class="bi ${icon} me-2"></i>
                <span>${message}</span>
                <small class="d-block text-muted">منذ لحظات</small>
            </div>
            `;
            
            notifications.innerHTML = notification + notifications.innerHTML;
            
            // الاحتفاظ بحد أقصى 5 إشعارات
            const allAlerts = notifications.querySelectorAll('.alert');
            if (allAlerts.length > 5) {
                allAlerts[allAlerts.length - 1].remove();
            }
        }
        
        // ============================================
        // مستمعي الأحداث
        // ============================================
        document.getElementById('refreshCases').addEventListener('click', loadCases);
        
        // ============================================
        // تهيئة الصفحة
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل القضايا عند فتح الصفحة
            loadCases();
            
            // اختبار الاتصال بـ Supabase
            async function testConnection() {
                try {
                    const { data, error } = await supabase.from('cases').select('count', { count: 'exact', head: true });
                    
                    if (error) throw error;
                    
                    addNotification('تم الاتصال بنجاح بقاعدة البيانات Supabase', 'success');
                    
                } catch (error) {
                    console.error('Connection test failed:', error);
                    addNotification(`تعذر الاتصال بقاعدة البيانات: ${error.message}`, 'danger');
                    
                    // تحديث حالة الاتصال
                    document.getElementById('connectionStatus').className = 'badge bg-danger';
                    document.getElementById('connectionStatus').textContent = 'انقطع الاتصال بقاعدة البيانات';
                }
            }
            
            testConnection();
        });
    </script>
</body>
</html>
