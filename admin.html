<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم | نظام إدارة القضايا المتقدم</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --gold-primary: #D4AF37;
            --gold-light: #F5E8AA;
            --gold-dark: #B8860B;
            --black-primary: #1A1A1A;
            --black-light: #333333;
            --bg-light: #F8F5E6;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            color: var(--black-primary);
        }
        
        .header {
            background: linear-gradient(135deg, var(--black-primary), var(--black-light));
            color: var(--gold-primary);
            border-bottom: 4px solid var(--gold-primary);
            padding: 20px 0;
            margin-bottom: 25px;
        }
        
        .form-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-right: 5px solid var(--gold-primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .btn-gold {
            background-color: var(--gold-primary);
            color: var(--black-primary);
            border: none;
            font-weight: 600;
            padding: 10px 25px;
        }
        
        .btn-gold:hover {
            background-color: var(--gold-dark);
            color: white;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--gold-primary);
            color: var(--black-primary);
            border-color: var(--gold-primary);
            font-weight: 600;
        }

        .case-code-display {
            font-family: 'Courier New', monospace;
            font-size: 1.3rem;
            background: linear-gradient(135deg, var(--black-primary), var(--black-light));
            color: var(--gold-primary);
            padding: 12px 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid var(--gold-primary);
        }

        .session-card {
            background: white;
            border-right: 4px solid var(--gold-primary);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-top: 5px solid var(--gold-primary);
        }
        
        .case-status {
            display: inline-block;
            padding: 3px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-active { background-color: #e3f2fd; color: #1976d2; }
        .status-pending { background-color: #fff3e0; color: #f57c00; }
        .status-closed { background-color: #e8f5e9; color: #388e3c; }
        
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .case-info-badge {
            background-color: var(--gold-light);
            color: var(--black-light);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            margin-left: 5px;
        }
    </style>
</head>
<body>

<!-- صفحة الدخول -->
<div id="loginPage" style="display: block;">
    <div class="container">
        <div class="login-container">
            <h3 class="text-center mb-4"><i class="bi bi-scale-balanced me-2"></i>نظام إدارة القضايا</h3>
            <p class="text-center text-muted mb-4">النسخة الذهبية - المحامي/محمود</p>
            
            <div class="mb-4">
                <label class="form-label">كلمة المرور</label>
                <input type="password" class="form-control" id="password" placeholder="أدخل كلمة المرور">
                <div class="form-text">كلمة المرور: mahmoud237</div>
            </div>
            
            <div class="d-grid">
                <button class="btn btn-gold" onclick="login()">
                    <i class="bi bi-box-arrow-in-right me-2"></i>دخول
                </button>
            </div>
        </div>
    </div>
</div>

<!-- المحتوى الرئيسي (يظهر بعد الدخول) -->
<div id="mainContent" style="display: none;">
    <div class="header text-center">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-outline-gold" onclick="logout()">
                    <i class="bi bi-box-arrow-left me-2"></i>خروج
                </button>
                <div>
                    <h1><i class="bi bi-scale-balanced me-2"></i>نظام إدارة القضايا المتقدم</h1>
                    <p class="mb-0">لوحة تحكم المكتب - النسخة الذهبية</p>
                </div>
                <div class="text-start">
                    <span id="currentDate" class="badge bg-warning text-dark"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="add-tab" data-bs-toggle="tab" data-bs-target="#addCase" type="button">إضافة قضية</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#manageSessions" type="button">إدارة الجلسات</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#searchCases" type="button">بحث واستعلام</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- إضافة قضية -->
            <div class="tab-pane fade show active" id="addCase">
                <form id="caseForm">
                    <div class="form-section">
                        <h5><i class="bi bi-person-badge me-2"></i>بيانات العميل</h5>
                        <div class="row mt-3">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">اسم العميل *</label>
                                <input type="text" class="form-control" id="clientName" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">رقم الهاتف *</label>
                                <input type="tel" class="form-control" id="clientPhone" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">صفة العميل *</label>
                                <select class="form-select" id="clientRole" required>
                                    <option value="مدعي">مدعي</option>
                                    <option value="مدعي عليه">مدعي عليه</option>
                                    <option value="مستانف">مستانف</option>
                                    <option value="مستانف ضده">مستانف ضده</option>
                                    <option value="متهم">متهم</option>
                                    <option value="مدعي بالحق المدني">مدعي بالحق المدني</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h5><i class="bi bi-folder me-2"></i>بيانات القضية</h5>
                        <div class="row mt-3">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">رقم القضية *</label>
                                <input type="text" class="form-control" id="caseNumber" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">سنة القضية *</label>
                                <input type="text" class="form-control" id="caseYear" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">نوع القضية *</label>
                                <select class="form-select" id="caseType" required>
                                    <option value="مدني">مدني</option>
                                    <option value="تجاري">تجاري</option>
                                    <option value="عمالي">عمالي</option>
                                    <option value="اداري">اداري</option>
                                    <option value="أسرة">أسرة</option>
                                    <option value="جنح">جنح</option>
                                    <option value="جنايات">جنايات</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">حالة القضية *</label>
                                <select class="form-select" id="caseStatus" required>
                                    <option value="جارية">جارية</option>
                                    <option value="منتهية">منتهية</option>
                                    <option value="قيد الاستئناف">قيد الاستئناف</option>
                                    <option value="معلقة">معلقة</option>
                                    <option value="محكوم فيها">محكوم فيها</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">المحكمة *</label>
                                <input type="text" class="form-control" id="courtName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الدائرة/القسم *</label>
                                <input type="text" class="form-control" id="circle" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">اسم الخصم *</label>
                                <input type="text" class="form-control" id="opponentName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">صفة الخصم *</label>
                                <select class="form-select" id="opponentRole" required>
                                    <option value="مدعى عليه">مدعى عليه</option>
                                    <option value="مدعي">مدعي</option>
                                    <option value="خصم">خصم</option>
                                    <option value="المدعي العام">المدعي العام</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">موضوع القضية *</label>
                                <textarea class="form-control" id="caseSubject" rows="3" required></textarea>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">ملاحظات إضافية</label>
                                <textarea class="form-control" id="notes" rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mb-5">
                        <button type="submit" class="btn btn-gold btn-lg">
                            <i class="bi bi-save me-2"></i>حفظ القضية وتوليد الكود
                        </button>
                    </div>
                    
                    <div id="caseCodeResult" class="mt-4" style="display: none;"></div>
                </form>
            </div>

            <!-- إدارة الجلسات -->
            <div class="tab-pane fade" id="manageSessions">
                <div class="row">
                    <div class="col-md-5">
                        <div class="form-section">
                            <h5>إضافة جلسة جديدة</h5>
                            <div class="mb-3 mt-3">
                                <label class="form-label">رقم القضية *</label>
                                <input type="text" class="form-control" id="caseNumberInput" placeholder="أدخل رقم القضية" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">سنة القضية *</label>
                                <input type="text" class="form-control" id="caseYearInput" placeholder="أدخل سنة القضية" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">اسم المحكمة *</label>
                                <input type="text" class="form-control" id="courtInput" placeholder="أدخل اسم المحكمة" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">اسم العميل *</label>
                                <input type="text" class="form-control" id="clientInput" placeholder="أدخل اسم العميل" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">اسم الخصم *</label>
                                <input type="text" class="form-control" id="opponentInput" placeholder="أدخل اسم الخصم" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">تاريخ الجلسة *</label>
                                <input type="date" class="form-control" id="sessionDate" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">القرار/ملاحظات الجلسة</label>
                                <textarea class="form-control" id="sessionDecision" rows="3" placeholder="أدخل قرار الجلسة أو الملاحظات المهمة"></textarea>
                            </div>
                            <button class="btn btn-gold w-100" onclick="addSession()">حفظ الجلسة</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="form-section">
                            <h5>الجلسات القادمة</h5>
                            <div class="table-responsive">
                                <table class="table table-hover" id="upcomingSessionsTable">
                                    <thead>
                                        <tr>
                                            <th>رقم/سنة القضية</th>
                                            <th>المحكمة</th>
                                            <th>العميل</th>
                                            <th>الخصم</th>
                                            <th>تاريخ الجلسة</th>
                                            <th>القرار</th>
                                        </tr>
                                    </thead>
                                    <tbody id="upcomingSessionsBody">
                                        <!-- البيانات ستظهر هنا -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <h5 class="mt-4">الجلسات السابقة</h5>
                            <div class="table-responsive">
                                <table class="table table-hover" id="pastSessionsTable">
                                    <thead>
                                        <tr>
                                            <th>رقم/سنة القضية</th>
                                            <th>المحكمة</th>
                                            <th>العميل</th>
                                            <th>الخصم</th>
                                            <th>تاريخ الجلسة</th>
                                            <th>القرار</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pastSessionsBody">
                                        <!-- البيانات ستظهر هنا -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- بحث واستعلام -->
            <div class="tab-pane fade" id="searchCases">
                <div class="form-section">
                    <div class="row align-items-end">
                        <div class="col-md-8">
                            <label class="form-label">ابحث برقم الهاتف أو اسم العميل أو رقم القضية</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="أدخل كلمة البحث...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-gold w-100" onclick="searchCases()">بحث</button>
                        </div>
                    </div>
                </div>
                <div id="searchResults" class="mt-4"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // تهيئة Supabase
    const SUPABASE_URL = "https://iyhfafodhptcdwrjywek.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDQzMjA4NTcsImV4cCI6MjAxOTg5Njg1N30.6Rj7Z1Z8Z1Z8Z1Z8Z1Z8Z1Z8Z1Z8Z1Z8Z1Z8Z1Z8";
    
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // تهيئة التاريخ الحالي
    function updateCurrentDate() {
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent = now.toLocaleDateString('ar-SA', options);
    }
    
    // التحقق من الدخول
    function login() {
        const password = document.getElementById('password').value;
        const correctPassword = "mahmoud237";
        
        if (password === correctPassword) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            updateCurrentDate();
            loadSessionsTables();
            
            Swal.fire({
                icon: 'success',
                title: 'مرحباً!',
                text: 'تم الدخول بنجاح',
                timer: 1500,
                showConfirmButton: false
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'خطأ',
                text: 'كلمة المرور غير صحيحة'
            });
        }
    }
    
    // الخروج
    function logout() {
        document.getElementById('loginPage').style.display = 'block';
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('password').value = '';
        
        Swal.fire({
            icon: 'info',
            title: 'تم الخروج',
            text: 'تم الخروج من النظام بنجاح',
            timer: 1500,
            showConfirmButton: false
        });
    }
    
    // توليد كود القضية
    function generateCaseCode(caseData) {
        const year = caseData.caseYear || new Date().getFullYear();
        const typeCode = getCaseTypeCode(caseData.caseType);
        const randomNum = Math.floor(1000 + Math.random() * 9000);
        return `MA-${year}-${typeCode}-${randomNum}`;
    }
    
    function getCaseTypeCode(type) {
        const codes = {
            'مدني': 'CV',
            'تجاري': 'CO',
            'عمالي': 'LB',
            'اداري': 'AD',
            'أسرة': 'FM',
            'جنح': 'MS',
            'جنايات': 'CR'
        };
        return codes[type] || 'OT';
    }
    
    // حفظ القضية في Supabase
    document.getElementById('caseForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // تجميع بيانات القضية
        const caseData = {
            client_name: document.getElementById('clientName').value,
            client_phone: document.getElementById('clientPhone').value,
            case_number: document.getElementById('caseNumber').value,
            case_year: document.getElementById('caseYear').value,
            case_type: document.getElementById('caseType').value,
            status: document.getElementById('caseStatus').value,
            court: document.getElementById('courtName').value,
            circle: document.getElementById('circle').value,
            opponent_name: document.getElementById('opponentName').value,
            opponent_role: document.getElementById('opponentRole').value,
            description: document.getElementById('caseSubject').value,
            notes: document.getElementById('notes').value,
            client_role: document.getElementById('clientRole').value,
            created_at: new Date().toISOString(),
            lawyer_email: 'mahmoud.legal@gmail.com'
        };
        
        // توليد كود القضية (سيتم توليده تلقائياً بواسطة قاعدة البيانات)
        try {
            // حفظ القضية في Supabase
            const { data, error } = await supabase
                .from('cases')
                .insert([{
                    client_name: caseData.client_name,
                    client_phone: caseData.client_phone,
                    court: caseData.court,
                    case_type: caseData.case_type,
                    status: caseData.status,
                    description: `القضية رقم ${caseData.case_number}/${caseData.case_year} - الخصم: ${caseData.opponent_name} - ${caseData.description}`
                }])
                .select();
            
            if (error) throw error;
            
            // عرض الكود المولد
            document.getElementById('caseCodeResult').innerHTML = `
                <div class="case-code-display">
                    <h5>تم حفظ القضية بنجاح!</h5>
                    <p class="mb-2">كود القضية:</p>
                    <h3 class="mb-3">${data[0].case_code}</h3>
                    <small>احفظ هذا الكود للمراجعة والمتابعة</small>
                    <p class="mt-2 mb-0"><strong>رقم القضية:</strong> ${caseData.case_number}/${caseData.case_year}</p>
                    <p class="mb-0"><strong>الخصم:</strong> ${caseData.opponent_name}</p>
                </div>
            `;
            document.getElementById('caseCodeResult').style.display = 'block';
            
            // إعادة تعيين النموذج
            document.getElementById('caseForm').reset();
            
            Swal.fire({
                icon: 'success',
                title: 'تم الحفظ',
                text: `تم حفظ القضية بالكود: ${data[0].case_code}`,
                timer: 2000,
                showConfirmButton: false
            });
            
        } catch (error) {
            console.error('Error saving case:', error);
            Swal.fire({
                icon: 'error',
                title: 'خطأ',
                text: 'حدث خطأ أثناء حفظ القضية: ' + error.message
            });
        }
    });
    
    // إضافة جلسة جديدة
    async function addSession() {
        // جمع بيانات الجلسة
        const caseNumber = document.getElementById('caseNumberInput').value;
        const caseYear = document.getElementById('caseYearInput').value;
        const court = document.getElementById('courtInput').value;
        const client = document.getElementById('clientInput').value;
        const opponent = document.getElementById('opponentInput').value;
        const sessionDate = document.getElementById('sessionDate').value;
        const decision = document.getElementById('sessionDecision').value;
        
        // التحقق من البيانات المطلوبة
        if (!caseNumber || !caseYear || !court || !client || !opponent || !sessionDate) {
            Swal.fire({
                icon: 'warning',
                title: 'بيانات ناقصة',
                text: 'الرجاء ملء جميع الحقول المطلوبة (*)'
            });
            return;
        }
        
        try {
            // البحث عن القضية بناءً على البيانات المدخلة
            const { data: cases, error: caseError } = await supabase
                .from('cases')
                .select('id, case_code')
                .eq('client_name', client)
                .like('description', `%${caseNumber}/${caseYear}%`);
            
            if (caseError) throw caseError;
            
            let caseId;
            
            if (cases && cases.length > 0) {
                // إذا تم العثور على القضية
                caseId = cases[0].id;
            } else {
                // إذا لم يتم العثور على القضية، نطلب من المستخدم إنشاء قضية جديدة أولاً
                const result = await Swal.fire({
                    icon: 'question',
                    title: 'القضية غير موجودة',
                    text: 'لا توجد قضية مطابقة للبيانات المدخلة. هل ترغب في إنشاء القضية أولاً؟',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، أنشئ القضية',
                    cancelButtonText: 'لا، أضف الجلسة فقط'
                });
                
                if (result.isConfirmed) {
                    // توجيه المستخدم إلى تبويب إضافة قضية
                    document.getElementById('sessions-tab').classList.remove('active');
                    document.getElementById('manageSessions').classList.remove('show', 'active');
                    document.getElementById('add-tab').classList.add('active');
                    document.getElementById('addCase').classList.add('show', 'active');
                    
                    // تعبئة بيانات القضية تلقائياً
                    document.getElementById('clientName').value = client;
                    document.getElementById('caseNumber').value = caseNumber;
                    document.getElementById('caseYear').value = caseYear;
                    document.getElementById('courtName').value = court;
                    document.getElementById('opponentName').value = opponent;
                    
                    Swal.fire({
                        icon: 'info',
                        title: 'إضافة قضية جديدة',
                        text: 'الرجاء إكمال بيانات القضية ثم العودة لإضافة الجلسة'
                    });
                    return;
                } else {
                    // إذا اختار المستخدم إضافة الجلسة فقط، نستخدم حالة خاصة
                    caseId = null;
                }
            }
            
            // حفظ الجلسة في Supabase
            const sessionData = {
                case_id: caseId,
                session_date: sessionDate,
                notes: `القضية: ${caseNumber}/${caseYear} - المحكمة: ${court} - العميل: ${client} - الخصم: ${opponent} - القرار/ملاحظات: ${decision || 'لا توجد ملاحظات'}`
            };
            
            const { data: session, error: sessionError } = await supabase
                .from('sessions')
                .insert([sessionData]);
            
            if (sessionError) throw sessionError;
            
            // إعادة تعيين نموذج الجلسة
            document.getElementById('caseNumberInput').value = '';
            document.getElementById('caseYearInput').value = '';
            document.getElementById('courtInput').value = '';
            document.getElementById('clientInput').value = '';
            document.getElementById('opponentInput').value = '';
            document.getElementById('sessionDate').value = '';
            document.getElementById('sessionDecision').value = '';
            
            // تحديث جداول الجلسات
            loadSessionsTables();
            
            Swal.fire({
                icon: 'success',
                title: 'تم الحفظ',
                text: 'تم حفظ الجلسة بنجاح',
                timer: 1500,
                showConfirmButton: false
            });
            
        } catch (error) {
            console.error('Error adding session:', error);
            Swal.fire({
                icon: 'error',
                title: 'خطأ',
                text: 'حدث خطأ أثناء حفظ الجلسة: ' + error.message
            });
        }
    }
    
    // تحميل الجلسات وعرضها في الجداول
    async function loadSessionsTables() {
        try {
            const now = new Date().toISOString().split('T')[0]; // تاريخ اليوم بصيغة YYYY-MM-DD
            
            // جلب جميع الجلسات مع بيانات القضايا المرتبطة
            const { data: sessions, error } = await supabase
                .from('sessions')
                .select(`
                    *,
                    cases (
                        case_code,
                        client_name,
                        description
                    )
                `)
                .order('session_date', { ascending: true });
            
            if (error) throw error;
            
            // فصل الجلسات إلى قادمة وسابقة
            const upcomingSessions = sessions.filter(s => s.session_date >= now);
            const pastSessions = sessions.filter(s => s.session_date < now);
            
            // عرض الجلسات القادمة
            const upcomingBody = document.getElementById('upcomingSessionsBody');
            if (upcomingSessions.length === 0) {
                upcomingBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="bi bi-calendar-x me-2"></i>لا توجد جلسات قادمة
                        </td>
                    </tr>
                `;
            } else {
                upcomingBody.innerHTML = upcomingSessions.map(session => {
                    // استخراج معلومات من نص الجلسة
                    const notes = session.notes || '';
                    const caseMatch = notes.match(/القضية:\s*([^-\s]+)/);
                    const courtMatch = notes.match(/المحكمة:\s*([^-\s]+)/);
                    const clientMatch = notes.match(/العميل:\s*([^-\s]+)/);
                    const opponentMatch = notes.match(/الخصم:\s*([^-\s]+)/);
                    const decisionMatch = notes.match(/القرار\/ملاحظات:\s*(.+)/);
                    
                    return `
                        <tr>
                            <td>${caseMatch ? caseMatch[1] : 'غير محدد'}</td>
                            <td>${courtMatch ? courtMatch[1] : 'غير محدد'}</td>
                            <td>${clientMatch ? clientMatch[1] : 'غير محدد'}</td>
                            <td>${opponentMatch ? opponentMatch[1] : 'غير محدد'}</td>
                            <td>${new Date(session.session_date).toLocaleDateString('ar-SA')}</td>
                            <td>${decisionMatch ? decisionMatch[1].substring(0, 50) + (decisionMatch[1].length > 50 ? '...' : '') : 'لا توجد ملاحظات'}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            // عرض الجلسات السابقة
            const pastBody = document.getElementById('pastSessionsBody');
            if (pastSessions.length === 0) {
                pastBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="bi bi-calendar-check me-2"></i>لا توجد جلسات سابقة
                        </td>
                    </tr>
                `;
            } else {
                pastBody.innerHTML = pastSessions.map(session => {
                    // استخراج معلومات من نص الجلسة
                    const notes = session.notes || '';
                    const caseMatch = notes.match(/القضية:\s*([^-\s]+)/);
                    const courtMatch = notes.match(/المحكمة:\s*([^-\s]+)/);
                    const clientMatch = notes.match(/العميل:\s*([^-\s]+)/);
                    const opponentMatch = notes.match(/الخصم:\s*([^-\s]+)/);
                    const decisionMatch = notes.match(/القرار\/ملاحظات:\s*(.+)/);
                    
                    return `
                        <tr>
                            <td>${caseMatch ? caseMatch[1] : 'غير محدد'}</td>
                            <td>${courtMatch ? courtMatch[1] : 'غير محدد'}</td>
                            <td>${clientMatch ? clientMatch[1] : 'غير محدد'}</td>
                            <td>${opponentMatch ? opponentMatch[1] : 'غير محدد'}</td>
                            <td>${new Date(session.session_date).toLocaleDateString('ar-SA')}</td>
                            <td>${decisionMatch ? decisionMatch[1].substring(0, 50) + (decisionMatch[1].length > 50 ? '...' : '') : 'لا توجد ملاحظات'}</td>
                        </tr>
                    `;
                }).join('');
            }
            
        } catch (error) {
            console.error('Error loading sessions:', error);
        }
    }
    
    // البحث عن القضايا
    async function searchCases() {
        const searchTerm = document.getElementById('searchInput').value.trim();
        
        if (!searchTerm) {
            Swal.fire({
                icon: 'warning',
                title: 'بحث فارغ',
                text: 'الرجاء إدخال كلمة للبحث'
            });
            return;
        }
        
        try {
            const { data: cases, error } = await supabase
                .from('cases')
                .select('*')
                .or(`client_name.ilike.%${searchTerm}%,client_phone.ilike.%${searchTerm}%,case_code.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%`)
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            const resultsContainer = document.getElementById('searchResults');
            
            if (cases.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-search me-2"></i>
                        لم يتم العثور على نتائج للبحث: "${searchTerm}"
                    </div>
                `;
            } else {
                resultsContainer.innerHTML = `
                    <h5 class="mb-3">نتائج البحث (${cases.length})</h5>
                    <div class="row">
                        ${cases.map(caseItem => `
                            <div class="col-md-6 mb-3">
                                <div class="form-section">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6>${caseItem.case_code}</h6>
                                        <span class="case-status status-${getStatusClass(caseItem.status)}">
                                            ${caseItem.status}
                                        </span>
                                    </div>
                                    <p><strong>العميل:</strong> ${caseItem.client_name}</p>
                                    <p><strong>رقم الهاتف:</strong> ${caseItem.client_phone}</p>
                                    <p><strong>المحكمة:</strong> ${caseItem.court}</p>
                                    <p><strong>نوع القضية:</strong> ${caseItem.case_type}</p>
                                    <p><strong>حالة القضية:</strong> ${caseItem.status}</p>
                                    <p><strong>وصف القضية:</strong> ${caseItem.description}</p>
                                    <p><strong>تاريخ الإضافة:</strong> ${new Date(caseItem.created_at).toLocaleDateString('ar-SA')}</p>
                                    ${caseItem.notes ? `<p><strong>ملاحظات:</strong> ${caseItem.notes}</p>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('Error searching cases:', error);
            Swal.fire({
                icon: 'error',
                title: 'خطأ',
                text: 'حدث خطأ أثناء البحث: ' + error.message
            });
        }
    }
    
    function getStatusClass(status) {
        const classes = {
            'جارية': 'active',
            'منتهية': 'closed',
            'قيد الاستئناف': 'pending',
            'معلقة': 'pending',
            'محكوم فيها': 'closed'
        };
        return classes[status] || 'pending';
    }
    
    // تهيئة الصفحة عند التحميل
    document.addEventListener('DOMContentLoaded', function() {
        updateCurrentDate();
        setInterval(updateCurrentDate, 60000); // تحديث التاريخ كل دقيقة
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
