<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>لوحة تحكم المحامي - مؤسسة محمود عبد الحميد</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet"/>
    
    <!-- Supabase - النسخة المستقرة UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Tajawal',sans-serif; }
        body { background:#020617; color:#f8fafc; min-height:100vh; }

        .login-protection {
            position: fixed; inset:0; background:rgba(0,0,0,0.95);
            display:flex; justify-content:center; align-items:center; z-index:10000;
        }
        .login-box {
            background:rgba(0,0,0,0.9); border:2px solid #bf953f; padding:50px;
            border-radius:20px; max-width:480px; width:92%; text-align:center;
            box-shadow:0 20px 60px rgba(191,149,63,0.3);
        }
        .login-box h2 { color:#bf953f; margin-bottom:28px; font-size:28px; }
        .login-box input {
            width:100%; padding:16px; margin-bottom:20px;
            background:rgba(255,255,255,0.06); border:2px solid rgba(191,149,63,0.4);
            border-radius:10px; color:white; font-size:17px; text-align:center;
        }

        .admin-wrapper { display:none; min-height:100vh; }
        .admin-header { background:rgba(0,0,0,0.92); border-bottom:2px solid #bf953f; padding:18px 0; }
        .admin-container { max-width:1400px; margin:0 auto; padding:0 20px; }

        .tab-container {
            display:flex; flex-wrap:wrap; gap:14px; margin:30px 0 35px;
            border-bottom:2px solid rgba(191,149,63,0.25); padding-bottom:12px;
        }
        .tab-btn {
            padding:16px 32px; background:rgba(255,255,255,0.05); border:none;
            border-radius:10px; cursor:pointer; color:#94a3b8; font-weight:600;
            transition:all 0.25s; min-width:150px;
        }
        .tab-btn.active {
            background:linear-gradient(135deg, #bf953f 0%, #f5e8a0 100%);
            color:#0f172a; transform:scale(1.04); box-shadow:0 8px 20px rgba(191,149,63,0.35);
        }

        .tab-content { display:none; background:rgba(0,0,0,0.65); padding:35px;
                       border-radius:16px; border:1px solid rgba(191,149,63,0.18); }
        .tab-content.active { display:block; }

        .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:22px; }
        .form-group { margin-bottom:22px; }
        .form-group label { color:#bf953f; font-weight:600; margin-bottom:8px; display:block; }
        .form-control {
            width:100%; padding:15px; background:rgba(255,255,255,0.05);
            border:2px solid rgba(191,149,63,0.3); border-radius:10px;
            color:white; font-size:16px;
        }
        .form-control:focus { border-color:#bf953f; outline:none; box-shadow:0 0 0 3px rgba(191,149,63,0.15); }

        .btn {
            background:linear-gradient(135deg,#bf953f 0%,#f5e8a0 100%);
            color:#0f172a; padding:16px 38px; border:none; border-radius:10px;
            font-weight:600; cursor:pointer; transition:all 0.25s; min-height:54px;
        }
        .btn:hover { transform:translateY(-3px); box-shadow:0 10px 24px rgba(191,149,63,0.4); }

        .message {
            padding:16px 24px; border-radius:10px; margin:20px 0; font-weight:600;
            display:none;
        }
        .message.success { background:rgba(34,197,94,0.2); color:#4ade80; border:1px solid #4ade80; }
        .message.error   { background:rgba(239,68,68,0.2);  color:#f87171; border:1px solid #f87171; }

        .case-code-display {
            background:rgba(0,0,0,0.35); padding:30px; border-radius:16px;
            margin-top:40px; text-align:center; border:2px dashed #bf953f;
        }
        .case-code-value {
            font-family:monospace; font-size:38px; letter-spacing:5px;
            color:#f5e8a0; background:rgba(0,0,0,0.5); padding:16px;
            border-radius:10px; border:2px solid #bf953f; margin:20px 0;
        }

        @media (max-width:768px) {
            .form-grid { grid-template-columns:1fr; }
            .tab-btn { padding:14px 24px; min-width:120px; font-size:15px; }
        }
    </style>
</head>
<body>

<!-- شاشة الدخول -->
<div id="loginProtection" class="login-protection">
    <div class="login-box">
        <h2><i class="fas fa-lock"></i> دخول إدارة المكتب</h2>
        <input type="password" id="adminPassword" placeholder="كلمة المرور" autocomplete="off"/>
        <button class="btn" onclick="checkPassword()">
            <i class="fas fa-sign-in-alt"></i> دخول
        </button>
    </div>
</div>

<!-- لوحة التحكم الرئيسية -->
<div class="admin-wrapper" id="adminPanel">
    <header class="admin-header">
        <div class="admin-container">
            <div style="display:flex; justify-content:space-between; align-items:center; padding:20px 0;">
                <h1 style="color:#bf953f;"><i class="fas fa-user-shield"></i> لوحة التحكم</h1>
                <button class="btn" style="background:#4b5563; color:white;" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </div>
        </div>
    </header>

    <main class="admin-container">
        <div class="tab-container">
            <button class="tab-btn active" onclick="switchTab('cases')">إدارة القضايا</button>
            <!-- يمكن إضافة تبويبات أخرى لاحقاً -->
        </div>

        <!-- تبويب إدارة القضايا -->
        <div id="cases" class="tab-content active">
            <h2 style="color:#bf953f; margin-bottom:30px;"><i class="fas fa-plus-circle"></i> إضافة قضية جديدة</h2>

            <div id="caseMessage" class="message"></div>

            <form id="newCaseForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>اسم العميل *</label>
                        <input type="text" class="form-control" id="clientName" required/>
                    </div>
                    <div class="form-group">
                        <label>رقم الهاتف *</label>
                        <input type="tel" class="form-control" id="clientPhone" required pattern="01[0-9]{9}"/>
                    </div>
                    <div class="form-group">
                        <label>نوع القضية *</label>
                        <select class="form-control" id="caseType" required>
                            <option value="">— اختر —</option>
                            <option value="مدني">مدني</option>
                            <option value="جنائي">جنائي</option>
                            <option value="أسرة">أسرة</option>
                            <option value="تجاري">تجاري</option>
                            <option value="إداري">إداري</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>حالة القضية *</label>
                        <select class="form-control" id="caseStatus" required>
                            <option value="متداولة">متداولة</option>
                            <option value="تحت الإجراء">تحت الإجراء</option>
                            <option value="مغلقة">مغلقة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>رقم القضية *</label>
                        <input type="text" class="form-control" id="caseNumber" required/>
                    </div>
                    <div class="form-group">
                        <label>المحكمة *</label>
                        <input type="text" class="form-control" id="court" required/>
                    </div>
                </div>

                <div class="form-group">
                    <label>موضوع القضية *</label>
                    <textarea class="form-control" id="caseSubject" rows="4" required></textarea>
                </div>

                <button type="button" class="btn" id="submitBtn" onclick="addNewCase()">
                    <i class="fas fa-save"></i> حفظ القضية وإنشاء الكود
                </button>
            </form>

            <!-- عرض كود القضية بعد الحفظ -->
            <div id="generatedCodeSection" class="case-code-display" style="display:none;">
                <h3><i class="fas fa-key"></i> كود القضية الجديدة</h3>
                <div class="case-code-value" id="generatedCaseCode"></div>
                <button class="btn" onclick="copyCode()" style="margin-top:20px;">
                    <i class="fas fa-copy"></i> نسخ الكود
                </button>
            </div>
        </div>
    </main>
</div>

<script>
// ================== إعدادات Supabase ==================
const SUPABASE_URL    = 'https://iyhfafodhptcdwrjywek.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ';

let supabase = null;

// تهيئة Supabase بطريقة أكثر أماناً
function initSupabase() {
    if (supabase) return true;
    
    try {
        if (typeof supabase === 'undefined' || !window.supabase) {
            alert('لم يتم تحميل مكتبة Supabase بشكل صحيح\n\nجرب: تحديث الصفحة أو تغيير المتصفح');
            return false;
        }
        
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Supabase تم تهيئته بنجاح");
        return true;
    } catch(e) {
        console.error("Supabase init error:", e);
        alert("فشل تهيئة الاتصال بقاعدة البيانات\n" + e.message);
        return false;
    }
}

// ================== الدخول ==================
async function checkPassword() {
    const pass = document.getElementById('adminPassword').value.trim();
    
    if (pass !== 'mahmoud123') {
        alert('كلمة المرور غير صحيحة');
        return;
    }

    if (!initSupabase()) return;

    document.getElementById('loginProtection').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
}

// ================== تسجيل الخروج ==================
function logout() {
    if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('loginProtection').style.display = 'flex';
        document.getElementById('adminPassword').value = '';
    }
}

// ================== تبديل التبويبات (حالياً تبويب واحد فقط) ==================
function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
}

// ================== توليد كود عشوائي 8 أحرف ==================
function generateCaseCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for(let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

// ================== حفظ القضية الجديدة ==================
async function addNewCase() {
    const btn = document.getElementById('submitBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
    btn.disabled = true;

    try {
        const formData = {
            case_code:     generateCaseCode(),
            client_name:   document.getElementById('clientName').value.trim(),
            client_phone:  document.getElementById('clientPhone').value.trim(),
            case_type:     document.getElementById('caseType').value,
            case_status:   document.getElementById('caseStatus').value,
            case_number:   document.getElementById('caseNumber').value.trim(),
            court:         document.getElementById('court').value.trim(),
            case_subject:  document.getElementById('caseSubject').value.trim(),
            created_at:    new Date().toISOString()
        };

        // التحقق من الحقول المهمة
        if (!formData.client_name || !formData.client_phone || !formData.case_type ||
            !formData.case_status || !formData.case_number || !formData.court || !formData.case_subject) {
            showMessage('يرجى ملء جميع الحقول المطلوبة (*)','error');
            return;
        }

        const { data, error } = await supabase
            .from('cases')
            .insert([formData])
            .select();

        if (error) throw error;

        // نجاح
        showMessage('تم حفظ القضية بنجاح ✓','success');
        document.getElementById('generatedCaseCode').textContent = formData.case_code;
        document.getElementById('generatedCodeSection').style.display = 'block';

        document.getElementById('newCaseForm').reset();

    } catch (err) {
        console.error('حفظ القضية فشل:', err);
        showMessage('حدث خطأ أثناء حفظ القضية<br>' + (err.message || 'غير معروف'),'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// ================== مساعدات ==================
function showMessage(text, type = 'success') {
    const msg = document.getElementById('caseMessage');
    msg.textContent = text;
    msg.className = `message ${type}`;
    msg.style.display = 'block';
    
    setTimeout(() => msg.style.display = 'none', 6000);
}

function copyCode() {
    const code = document.getElementById('generatedCaseCode').textContent;
    navigator.clipboard.writeText(code).then(() => {
        showMessage('تم نسخ الكود بنجاح ✓','success');
    }).catch(() => {
        showMessage('فشل نسخ الكود','error');
    });
}
</script>
</body>
</html>
