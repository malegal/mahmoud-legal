<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة التحكم | نظام إدارة القضايا</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root{
--gold:#D4AF37;
--black:#1A1A1A;
--bg:#F8F5E6;
}
body{background:var(--bg);font-family:Segoe UI}
.header{background:linear-gradient(135deg,#000,#333);color:var(--gold);padding:20px;border-bottom:4px solid var(--gold)}
.form-section{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border-right:5px solid var(--gold)}
.btn-gold{background:var(--gold);border:none;font-weight:600}
.btn-gold:hover{background:#b8962e;color:#fff}
.session-card{background:#fff;border-right:4px solid var(--gold);padding:15px;margin-bottom:10px}
.case-code{font-family:monospace;font-size:1.2rem;color:var(--gold)}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="container mt-5" style="max-width:400px">
<div class="form-section text-center">
<h4>دخول النظام</h4>
<input type="password" id="password" class="form-control my-3" placeholder="كلمة المرور">
<button class="btn btn-gold w-100" onclick="login()">دخول</button>
</div>
</div>

<!-- MAIN -->
<div id="mainContent" style="display:none">

<div class="header text-center">
<h2>نظام إدارة القضايا</h2>
<p id="today"></p>
</div>

<div class="container mt-4">

<ul class="nav nav-tabs mb-3">
<li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cases">القضايا</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sessions">الجلسات</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#search">بحث</button></li>
</ul>

<div class="tab-content">

<!-- القضايا -->
<div class="tab-pane fade show active" id="cases">
<form id="caseForm" class="form-section">
<div class="row g-3">

<div class="col-md-4"><label>اسم العميل</label><input id="client_name" class="form-control" required></div>
<div class="col-md-4"><label>هاتف العميل</label><input id="client_phone" class="form-control" required></div>
<div class="col-md-4"><label>اسم الخصم</label><input id="opponent_name" class="form-control"></div>

<div class="col-md-3"><label>رقم القضية</label><input id="case_number" class="form-control" required></div>
<div class="col-md-3"><label>سنة القضية</label><input id="case_year" class="form-control" required></div>
<div class="col-md-6"><label>المحكمة</label><input id="court_name" class="form-control" required></div>

<div class="col-md-4"><label>الدائرة</label><input id="circle" class="form-control"></div>
<div class="col-md-4"><label>نوع القضية</label><input id="case_type" class="form-control"></div>
<div class="col-md-4"><label>حالة القضية</label><input id="case_status" class="form-control"></div>

<div class="col-md-12"><label>موضوع القضية</label><textarea id="case_subject" class="form-control"></textarea></div>
<div class="col-md-12"><label>ملاحظات</label><textarea id="notes" class="form-control"></textarea></div>

</div>

<button class="btn btn-gold w-100 mt-3">حفظ القضية</button>
<div id="caseCodeResult" class="mt-3 text-center"></div>
</form>
</div>

<!-- الجلسات -->
<div class="tab-pane fade" id="sessions">
<div class="form-section">

<h5>تسجيل جلسة</h5>
<div class="row g-3">

<div class="col-md-3"><label>رقم القضية</label><input id="s_case_number" class="form-control"></div>
<div class="col-md-3"><label>سنة القضية</label><input id="s_case_year" class="form-control"></div>
<div class="col-md-6"><label>المحكمة</label><input id="s_court" class="form-control"></div>

<div class="col-md-6"><label>اسم العميل</label><input id="s_client" class="form-control"></div>
<div class="col-md-6"><label>اسم الخصم</label><input id="s_opponent" class="form-control"></div>

<div class="col-md-6"><label>تاريخ الجلسة</label><input type="date" id="s_date" class="form-control"></div>
<div class="col-md-12"><label>القرار</label><textarea id="s_decision" class="form-control"></textarea></div>

</div>

<button class="btn btn-gold w-100 mt-3" onclick="saveSession()">حفظ الجلسة</button>
</div>

<div class="form-section">
<h5>جلسات الأسبوع / الشهر</h5>
<div id="upcomingSessions"></div>
</div>
</div>

<!-- البحث -->
<div class="tab-pane fade" id="search">
<div class="form-section">
<input id="searchInput" class="form-control" placeholder="ابحث برقم القضية أو السنة أو الاسم أو الهاتف">
<button class="btn btn-gold w-100 mt-2" onclick="searchCases()">بحث</button>
</div>
<div id="searchResults"></div>
</div>

</div>
</div>
</div>

<script>
const SB_URL="https://iyhfafodhptcdwrjywek.supabase.co";
const SB_KEY="ANON_KEY_HERE";
const db=supabase.createClient(SB_URL,SB_KEY);

function login(){
if(document.getElementById('password').value==="mahmoud237"){
loginPage.style.display="none";
mainContent.style.display="block";
today.innerText=new Date().toLocaleDateString('ar-EG');
loadUpcoming();
}else Swal.fire("خطأ","كلمة المرور غير صحيحة","error");
}

caseForm.onsubmit=async e=>{
e.preventDefault();
const code=`MA-${Date.now().toString().slice(-6)}`;
const {error}=await db.from('cases').insert([{
client_name:client_name.value,
client_phone:client_phone.value,
opponent_name:opponent_name.value,
case_number:case_number.value,
case_year:case_year.value,
court_name:court_name.value,
circle:circle.value,
case_type:case_type.value,
case_status:case_status.value,
case_subject:case_subject.value,
notes:notes.value,
case_code:code
}]);
if(error) Swal.fire("خطأ","فشل الحفظ","error");
else{
caseCodeResult.innerHTML=`<div class="case-code">كود القضية: ${code}</div>`;
caseForm.reset();
}
};

async function saveSession(){
const {error}=await db.from('sessions').insert([{
case_number:s_case_number.value,
case_year:s_case_year.value,
court_name:s_court.value,
client_name:s_client.value,
opponent_name:s_opponent.value,
session_date:s_date.value,
decision:s_decision.value
}]);
if(error) Swal.fire("خطأ","فشل حفظ الجلسة","error");
else{Swal.fire("تم","تم حفظ الجلسة","success");loadUpcoming();}
}

async function searchCases(){
const t=searchInput.value;
const {data}=await db.from('cases').select('*')
.or(`case_number.ilike.%${t}%,case_year.ilike.%${t}%,client_name.ilike.%${t}%,client_phone.ilike.%${t}%`);
searchResults.innerHTML=data?.map(c=>`
<div class="form-section">
<b>${c.case_code}</b> - ${c.client_name}<br>
قضية ${c.case_number}/${c.case_year} – ${c.court_name}
</div>`).join('')||"لا نتائج";
}

async function loadUpcoming(){
const {data}=await db.from('sessions').select('*');
const now=new Date();
const week=new Date();week.setDate(now.getDate()+7);
const month=new Date();month.setMonth(now.getMonth()+1);

upcomingSessions.innerHTML=data?.filter(s=>{
const d=new Date(s.session_date);
return d<=month;
}).map(s=>`
<div class="session-card">
${s.client_name} – ${s.case_number}/${s.case_year}<br>
${s.session_date}
</div>`).join('');
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
