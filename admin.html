<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>نظام إدارة القضايا المتكامل</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root{ --gold:#D4AF37; --black:#1A1A1A; --bg:#F8F5E6; }
body{background:var(--bg);font-family:Segoe UI}
.header{background:linear-gradient(135deg,#000,#333);color:var(--gold);padding:20px;border-bottom:4px solid var(--gold)}
.form-section{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border-right:5px solid var(--gold);box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
.btn-gold{background:var(--gold);border:none;font-weight:600;color:#fff}
.btn-gold:hover{background:#b8962e;color:#fff}
.session-card{background:#fff;border-right:4px solid var(--gold);padding:15px;margin-bottom:10px;border-radius:4px;box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
.case-code{font-family:monospace;font-size:1.2rem;color:var(--gold);font-weight:bold}
.nav-tabs .nav-link.active {background-color: var(--gold); color: white; border-color: var(--gold);}
.nav-tabs .nav-link {color: var(--black);}
.auto-fill-badge { font-size: 0.7rem; background: #e9ecef; padding: 2px 8px; border-radius: 10px; color: #666; }
.search-detail-card { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fff; }
.session-history-item { border-right: 2px solid var(--gold); padding-right: 10px; margin-bottom: 5px; font-size: 0.9rem; }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="container mt-5" style="max-width:400px">
<div class="form-section text-center">
<i class="bi bi-shield-lock-fill" style="font-size: 3rem; color: var(--gold);"></i>
<h4 class="mt-3">دخول النظام</h4>
<input type="password" id="password" class="form-control my-3" placeholder="كلمة المرور">
<button class="btn btn-gold w-100" onclick="login()">دخول</button>
</div>
</div>

<!-- MAIN -->
<div id="mainContent" style="display:none">

<div class="header text-center">
<h2>نظام إدارة القضايا</h2>
<p id="today"></p>
</div>

<div class="container mt-4">

<ul class="nav nav-tabs mb-3" id="mainTabs">
<li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cases">القضايا</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sessions">الجلسات</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#search">بحث وتقارير</button></li>
</ul>

<div class="tab-content">

<!-- القضايا -->
<div class="tab-pane fade show active" id="cases">
<form id="caseForm" class="form-section">
<h5>تسجيل قضية جديدة</h5>
<hr>
<div class="row g-3">
<div class="col-md-4"><label>اسم العميل</label><input id="client_name" class="form-control" required></div>
<div class="col-md-4"><label>هاتف العميل</label><input id="client_phone" class="form-control" required></div>
<div class="col-md-4">
    <label>صفة العميل</label>
    <select id="client_role" class="form-select" required>
        <option value="">اختر الصفة...</option>
        <option>مدعي</option><option>مدعى عليه</option><option>مجني عليه</option><option>متهم</option>
        <option>طاعن</option><option>مطعون ضده</option><option>مستأنف</option><option>مستأنف ضده</option>
    </select>
</div>
<div class="col-md-4"><label>اسم الخصم</label><input id="opponent_name" class="form-control"></div>
<div class="col-md-4"><label>رقم القضية</label><input id="case_number" class="form-control" required></div>
<div class="col-md-4"><label>سنة القضية</label><input id="case_year" class="form-control" required></div>
<div class="col-md-6">
    <label>المحكمة</label>
    <select id="court_name" class="form-select" required>
        <option value="">اختر المحكمة...</option>
        <option>محكمة الأسرة</option><option>المحكمة الجزئية</option><option>المحكمة الابتدائية</option>
        <option>محكمة الاستئناف</option><option>محكمة النقض</option><option>مجلس الدولة</option>
    </select>
</div>
<div class="col-md-6"><label>الدائرة</label><input id="circle" class="form-control"></div>
<div class="col-md-6">
    <label>نوع القضية</label>
    <select id="case_type" class="form-select">
        <option value="">اختر النوع...</option>
        <option>مدني</option><option>جنائي</option><option>أسرة</option><option>عمالي</option><option>تجاري</option><option>إداري</option>
    </select>
</div>
<div class="col-md-6">
    <label>حالة القضية</label>
    <select id="case_status" class="form-select">
        <option value="">اختر الحالة...</option>
        <option>متداولة</option><option>محجوزة للحكم</option><option>منتهية</option><option>مشطوبة</option><option>موقوفة</option>
    </select>
</div>
<div class="col-md-12"><label>موضوع القضية</label><textarea id="case_subject" class="form-control" rows="2"></textarea></div>
<div class="col-md-12"><label>ملاحظات</label><textarea id="notes" class="form-control" rows="2"></textarea></div>
</div>
<button type="submit" class="btn btn-gold w-100 mt-3">حفظ القضية</button>
<div id="caseCodeResult" class="mt-3 text-center"></div>
</form>
</div>

<!-- الجلسات -->
<div class="tab-pane fade" id="sessions">
<div class="form-section">
<h5>تسجيل جلسة <span class="auto-fill-badge">أدخل رقم الهاتف لجلب البيانات تلقائياً</span></h5>
<hr>
<div class="row g-3">
<div class="col-md-6"><label>رقم هاتف العميل (للجلب التلقائي)</label><input id="s_phone_search" class="form-control" onchange="autoFillByPhone()"></div>
<div class="col-md-3"><label>رقم القضية</label><input id="s_case_number" class="form-control"></div>
<div class="col-md-3"><label>سنة القضية</label><input id="s_case_year" class="form-control"></div>
<div class="col-md-6"><label>المحكمة</label><input id="s_court" class="form-control"></div>
<div class="col-md-6"><label>اسم العميل</label><input id="s_client" class="form-control"></div>
<div class="col-md-6"><label>اسم الخصم</label><input id="s_opponent" class="form-control"></div>
<div class="col-md-6"><label>تاريخ الجلسة</label><input type="date" id="s_date" class="form-control"></div>
<div class="col-md-12"><label>القرار</label><textarea id="s_decision" class="form-control"></textarea></div>
</div>
<button class="btn btn-gold w-100 mt-3" onclick="saveSession()">حفظ الجلسة</button>
</div>

<div class="form-section">
<h5>جلسات قادمة</h5>
<div class="btn-group w-100 mb-3">
    <button type="button" class="btn btn-outline-secondary active" onclick="loadUpcoming('week', this)">الأسبوع الحالي</button>
    <button type="button" class="btn btn-outline-secondary" onclick="loadUpcoming('month', this)">الشهر الحالي</button>
</div>
<div id="upcomingSessions"></div>
</div>
</div>

<!-- البحث -->
<div class="tab-pane fade" id="search">
<div class="form-section">
    <h5>البحث المتقدم والتقارير</h5>
    <hr>
    <div class="row g-2 mb-3">
        <div class="col-md-8"><input id="searchInput" class="form-control" placeholder="ابحث برقم القضية، السنة، الاسم، أو الهاتف"></div>
        <div class="col-md-4"><button class="btn btn-gold w-100" onclick="searchCases()">بحث شامل</button></div>
    </div>
    
    <div class="p-3 border rounded bg-light">
        <h6>تقرير الجلسات خلال فترة:</h6>
        <div class="row g-2">
            <div class="col-md-5"><label class="small">من تاريخ</label><input type="date" id="date_from" class="form-control"></div>
            <div class="col-md-5"><label class="small">إلى تاريخ</label><input type="date" id="date_to" class="form-control"></div>
            <div class="col-md-2 d-flex align-items-end"><button class="btn btn-dark w-100" onclick="filterByDateRange()"><i class="bi bi-filter"></i></button></div>
        </div>
    </div>
</div>
<div id="searchResults"></div>
</div>

</div>
</div>
</div>

<script>
const SB_URL="https://iyhfafodhptcdwrjywek.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ";
const db=supabase.createClient(SB_URL,SB_KEY);

function login(){
    if(document.getElementById('password').value==="mahmoud237"){
        loginPage.style.display="none"; mainContent.style.display="block";
        today.innerText=new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        loadUpcoming('week');
    } else Swal.fire("خطأ","كلمة المرور غير صحيحة","error");
}

// جلب البيانات برقم الهاتف
async function autoFillByPhone() {
    const phone = document.getElementById('s_phone_search').value;
    if(phone) {
        const { data, error } = await db.from('cases').select('*').eq('client_phone', phone).order('created_at', { ascending: false }).limit(1).single();
        if(data) {
            document.getElementById('s_case_number').value = data.case_number;
            document.getElementById('s_case_year').value = data.case_year;
            document.getElementById('s_court').value = data.court_name;
            document.getElementById('s_client').value = data.client_name;
            document.getElementById('s_opponent').value = data.opponent_name;
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'تم جلب بيانات آخر قضية لهذا الهاتف', showConfirmButton: false, timer: 2000 });
        } else {
            Swal.fire("تنبيه", "لم يتم العثور على قضايا لهذا الرقم", "info");
        }
    }
}

caseForm.onsubmit=async e=>{
    e.preventDefault();
    Swal.fire({title: 'جاري الحفظ...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
    const code=`MA-${Date.now().toString().slice(-6)}`;
    const caseData = {
        client_name: document.getElementById('client_name').value,
        client_phone: document.getElementById('client_phone').value,
        client_role: document.getElementById('client_role').value,
        opponent_name: document.getElementById('opponent_name').value,
        case_number: document.getElementById('case_number').value,
        case_year: document.getElementById('case_year').value,
        court_name: document.getElementById('court_name').value,
        circle: document.getElementById('circle').value,
        case_type: document.getElementById('case_type').value,
        case_status: document.getElementById('case_status').value,
        case_subject: document.getElementById('case_subject').value,
        notes: document.getElementById('notes').value,
        case_code: code
    };
    const { error } = await db.from('cases').insert([caseData]);
    if(error) Swal.fire("خطأ", `فشل الحفظ: ${error.message}`, "error");
    else {
        Swal.fire("تم الحفظ", `تم تسجيل القضية بنجاح بكود: ${code}`, "success");
        caseCodeResult.innerHTML=`<div class="case-code">آخر كود مسجل: ${code}</div>`;
        caseForm.reset();
    }
};

async function saveSession(){
    const sData = {
        case_number: document.getElementById('s_case_number').value,
        case_year: document.getElementById('s_case_year').value,
        court_name: document.getElementById('s_court').value,
        client_name: document.getElementById('s_client').value,
        opponent_name: document.getElementById('s_opponent').value,
        session_date: document.getElementById('s_date').value,
        decision: document.getElementById('s_decision').value
    };
    if(!sData.session_date) return Swal.fire("تنبيه","يرجى اختيار تاريخ الجلسة","warning");
    Swal.fire({title: 'جاري الحفظ...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
    
    const { error } = await db.from('sessions').insert([sData]);
    if(error) {
        console.error(error);
        Swal.fire("خطأ", `فشل حفظ الجلسة: ${error.message}`, "error");
    } else {
        Swal.fire("تم", "تم حفظ الجلسة بنجاح", "success");
        ['s_phone_search','s_case_number','s_case_year','s_court','s_client','s_opponent','s_date','s_decision'].forEach(id=>document.getElementById(id).value="");
        loadUpcoming('week');
    }
}

async function searchCases(){
    const t = document.getElementById('searchInput').value;
    if(!t) return Swal.fire("تنبيه","أدخل كلمة للبحث","info");
    Swal.fire({title: 'جاري البحث...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
    
    const { data: cases, error: caseError } = await db.from('cases').select('*')
        .or(`case_number.ilike.%${t}%,case_year.ilike.%${t}%,client_name.ilike.%${t}%,client_phone.ilike.%${t}%,case_code.ilike.%${t}%`);
    
    if(caseError) { Swal.close(); return Swal.fire("خطأ","فشل البحث","error"); }
    
    if(!cases || cases.length === 0) { Swal.close(); searchResults.innerHTML = '<div class="alert alert-info">لا توجد نتائج</div>'; return; }

    let resultsHtml = `<h6>نتائج البحث (${cases.length}):</h6>`;
    
    for(let c of cases) {
        const { data: sessions } = await db.from('sessions')
            .select('*')
            .eq('case_number', c.case_number)
            .eq('case_year', c.case_year)
            .order('session_date', { ascending: false });

        resultsHtml += `
        <div class="search-detail-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="mb-1 text-primary">${c.client_name}</h5>
                    <span class="badge bg-gold text-dark mb-2">كود: ${c.case_code}</span>
                </div>
                <div class="text-end">
                    <span class="badge bg-secondary">${c.case_status || 'غير محدد'}</span><br>
                    <small class="text-muted">${c.case_type || ''}</small>
                </div>
            </div>
            <hr class="my-2">
            <div class="row small">
                <div class="col-6"><strong>رقم القضية:</strong> ${c.case_number} / ${c.case_year}</div>
                <div class="col-6"><strong>المحكمة:</strong> ${c.court_name}</div>
                <div class="col-12 mt-1"><strong>موضوع القضية:</strong> ${c.case_subject || 'لا يوجد'}</div>
                <div class="col-12 mt-1"><strong>هاتف العميل:</strong> ${c.client_phone}</div>
            </div>
            
            <div class="mt-3">
                <h6 class="small fw-bold text-success"><i class="bi bi-calendar-event"></i> تاريخ الجلسات:</h6>
                <div class="session-history-list">
                    ${sessions && sessions.length > 0 ? sessions.map(s => `
                        <div class="session-history-item">
                            <strong>${s.session_date}</strong>: ${s.decision || 'بانتظار القرار'}
                        </div>
                    `).join('') : '<div class="text-muted small">لا توجد جلسات مسجلة بعد</div>'}
                </div>
            </div>
        </div>`;
    }
    
    Swal.close();
    searchResults.innerHTML = resultsHtml;
}

async function filterByDateRange() {
    const from = document.getElementById('date_from').value;
    const to = document.getElementById('date_to').value;
    if(!from || !to) return Swal.fire("تنبيه","يرجى اختيار الفترة كاملة","warning");
    Swal.fire({title: 'جاري جلب التقرير...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
    const { data, error } = await db.from('sessions').select('*').gte('session_date', from).lte('session_date', to).order('session_date', { ascending: true });
    Swal.close();
    if(error) return Swal.fire("خطأ","فشل جلب البيانات","error");
    if(!data || data.length === 0) { searchResults.innerHTML = '<div class="alert alert-info">لا توجد جلسات في هذه الفترة</div>'; return; }
    searchResults.innerHTML = `<h6>تقرير الجلسات من ${from} إلى ${to} (${data.length}):</h6>` + data.map(s=>`
        <div class="session-card">
            <div class="d-flex justify-content-between"><strong>${s.session_date}</strong><span class="text-muted small">${s.court_name}</span></div>
            <div>${s.client_name} <span class="text-danger">ضد</span> ${s.opponent_name} (قضية ${s.case_number}/${s.case_year})</div>
            ${s.decision ? `<div class="mt-1 p-1 bg-light small"><b>القرار:</b> ${s.decision}</div>` : ''}
        </div>`).join('');
}

async function loadUpcoming(range, btn){
    if(btn) { document.querySelectorAll('#sessions .btn-group .btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
    const now = new Date().toISOString().split('T')[0];
    let endDate = new Date();
    if(range === 'week') endDate.setDate(new Date().getDate() + 7); else endDate.setMonth(new Date().getMonth() + 1);
    const endStr = endDate.toISOString().split('T')[0];
    const { data, error } = await db.from('sessions').select('*').gte('session_date', now).lte(endStr).order('session_date', { ascending: true });
    if(error) { upcomingSessions.innerHTML = "خطأ في التحميل"; return; }
    if(!data || data.length === 0) { upcomingSessions.innerHTML = "<p class='text-center text-muted'>لا توجد جلسات قادمة</p>"; return; }
    upcomingSessions.innerHTML = data.map(s=>`
        <div class="session-card">
            <div class="d-flex justify-content-between"><b>${s.session_date}</b><small>${s.court_name}</small></div>
            ${s.client_name} – ${s.case_number}/${s.case_year}
        </div>`).join('');
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
