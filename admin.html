<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام إدارة القضايا v3 | مكتب محمود عبد الحميد</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#bf953f">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary-dark: #020617;
            --gold-gradient: linear-gradient(135deg, #bf953f 0%, #fcf6ba 45%, #b38728 50%, #fbf5b7 55%, #aa771c 100%);
            --gold-solid: #bf953f;
            --header-height: 70px;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--primary-dark);
            color: #f8fafc;
            padding-top: var(--header-height);
            background-image: radial-gradient(circle at 50% 50%, rgba(191, 149, 63, 0.05) 0%, transparent 50%);
        }

        .gold-text { background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        
        .gold-btn {
            background: var(--gold-gradient); color: #1a1a1a; font-weight: 800;
            border: none; transition: 0.3s; box-shadow: 0 4px 15px rgba(191, 149, 63, 0.3);
        }
        .gold-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(191, 149, 63, 0.5); }

        .card-glass {
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px);
            border: 1px solid rgba(191, 149, 63, 0.2); border-radius: 1.25rem;
        }

        .case-card {
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05);
            transition: 0.3s; border-right: 4px solid var(--gold-solid);
        }
        .case-card:hover { background: rgba(191, 149, 63, 0.1); transform: scale(1.01); }

        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; border: 1px solid currentColor; }

        .log-item { font-size: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 8px 0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--primary-dark); }
        ::-webkit-scrollbar-thumb { background: var(--gold-solid); border-radius: 10px; }
    </style>
</head>

<body>

<div id="loginPage" class="container flex items-center justify-center min-h-screen">
    <div class="card-glass p-10 w-full max-w-md text-center">
        <div class="mb-4 inline-block p-4 rounded-full bg-gold-gradient" style="background: var(--gold-gradient)">
            <i class="bi bi-bank2 text-3xl text-slate-900"></i>
        </div>
        <h2 class="gold-text text-2xl mb-6">نظام إدارة القضايا الذكي</h2>
        <input type="password" id="password" class="form-control text-center mb-4 bg-slate-900 border-gold/30 text-white" placeholder="كلمة المرور">
        <button class="gold-btn w-full py-3 rounded-xl" onclick="login()">دخول المستشار</button>
    </div>
</div>

<div id="mainContent" style="display:none">
    <nav class="fixed top-0 w-full bg-slate-950/90 backdrop-blur-md border-b border-gold/20 z-50 h-[70px] flex items-center px-6 justify-between">
        <div class="flex items-center gap-3">
            <span class="gold-text text-xl font-black">محمود عبد الحميد</span>
            <span id="connection-dot" class="w-2 h-2 rounded-full bg-red-500"></span>
        </div>
        <div class="flex gap-3">
            <button class="btn btn-sm btn-outline-warning" onclick="loadStats()"><i class="bi bi-arrow-clockwise"></i></button>
            <button class="gold-btn px-4 py-1 rounded-lg text-sm" onclick="clearForm()">+ قضية جديدة</button>
        </div>
    </nav>

    <div class="container mt-4">
        <ul class="nav nav-pills mb-4 gap-2 p-2 bg-slate-900/50 rounded-2xl border border-white/5" id="mainTabs">
            <li class="nav-item"><button class="nav-link active text-white" data-bs-toggle="tab" data-bs-target="#cases"><i class="bi bi-plus-circle me-2"></i>التسجيل</button></li>
            <li class="nav-item"><button class="nav-link text-white" data-bs-toggle="tab" data-bs-target="#sessions" onclick="loadUpcoming('week')"><i class="bi bi-calendar-event me-2"></i>الأجندة</button></li>
            <li class="nav-item"><button class="nav-link text-white" data-bs-toggle="tab" data-bs-target="#search"><i class="bi bi-search me-2"></i>الأرشيف</button></li>
            <li class="nav-item"><button class="nav-link text-white" data-bs-toggle="tab" data-bs-target="#logs"><i class="bi bi-shield-check me-2"></i>الأمان</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="cases">
                <div class="card-glass p-6">
                    <form id="caseForm" class="row g-4">
                        <div class="col-md-4"><label class="text-xs opacity-60 mb-2">اسم الموكل</label><input id="client_name" class="form-control border-white/10" required></div>
                        <div class="col-md-4"><label class="text-xs opacity-60 mb-2">رقم الهاتف</label><input id="client_phone" class="form-control border-white/10" required></div>
                        <div class="col-md-4"><label class="text-xs opacity-60 mb-2">رقم القضية</label><input id="case_number" class="form-control border-white/10" required placeholder="مثال: 1234"></div>
                        <div class="col-md-6">
                            <label class="text-xs opacity-60 mb-2">المحكمة</label>
                            <select id="court_name" class="form-select border-white/10 bg-slate-900 text-white">
                                <option>محكمة الأسرة</option><option>الجنايات</option><option>الجنح</option><option>مجلس الدولة</option><option>العمالية</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="text-xs opacity-60 mb-2">الخصم</label>
                            <input id="opponent_name" class="form-control border-white/10">
                        </div>
                        <div class="col-12"><label class="text-xs opacity-60 mb-2">موضوع الدعوى</label><textarea id="case_subject" class="form-control border-white/10 bg-transparent" rows="2"></textarea></div>
                        <div class="col-12"><button type="submit" class="gold-btn w-full py-3 rounded-xl">حفظ في قاعدة البيانات</button></div>
                    </form>
                </div>
            </div>

            <div class="tab-pane fade" id="sessions">
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card-glass p-4">
                            <h6 class="gold-text mb-4">إضافة جلسة</h6>
                            <div class="space-y-3">
                                <input id="s_search" class="form-control form-control-sm" placeholder="ابحث عن القضية..." onkeyup="searchCasesForSession(this.value)">
                                <div id="caseSearchResults" class="bg-slate-800 rounded-lg overflow-hidden hidden mb-2"></div>
                                <input id="s_case_code" class="form-control form-control-sm" readonly placeholder="الكود المختار">
                                <input type="datetime-local" id="s_date" class="form-control form-control-sm">
                                <textarea id="s_decision" class="form-control form-control-sm" placeholder="القرار المترقب/الإجراء"></textarea>
                                <button class="gold-btn w-full py-2 rounded-lg text-sm" onclick="saveSession()">تثبيت الجلسة</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="upcomingSessions" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="search">
                <div class="card-glass p-6 mb-4">
                    <div class="row g-3">
                        <div class="col-md-8"><input id="searchInput" class="form-control border-gold/20" placeholder="ابحث باسم الموكل، الرقم، أو الكود..."></div>
                        <div class="col-md-4"><button class="gold-btn w-full h-full" onclick="searchCases()">بدء البحث</button></div>
                    </div>
                </div>
                <div id="searchResults" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
            </div>

            <div class="tab-pane fade" id="logs">
                <div class="card-glass p-6">
                    <h6 class="gold-text mb-4">سجل مراقبة النظام</h6>
                    <div id="logsContainer" class="max-h-[500px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="caseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-slate-900 border-gold/30">
            <div class="modal-header border-white/10">
                <h5 class="gold-text">تفاصيل الملف القضائي</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="caseDetails"></div>
            <div class="modal-footer border-white/10">
                <button class="btn btn-outline-light btn-sm" onclick="generateCasePDF()"><i class="bi bi-file-pdf"></i> تحميل PDF</button>
            </div>
        </div>
    </div>
</div>

<script>
    // الإعدادات (نفس بياناتك السابقة)
    const SB_URL = "https://iyhfafodhptcdwrjywek.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ";
    const db = supabase.createClient(SB_URL, SB_KEY);

    let currentCaseData = null; // لتخزين بيانات القضية المفتوحة حالياً

    // تسجيل الدخول
    function login() {
        const pass = document.getElementById('password').value;
        if (pass === "mahmoud237") {
            document.getElementById('loginPage').style.display = "none";
            document.getElementById('mainContent').style.display = "block";
            logAction("دخول النظام", "نجاح");
            checkConnection();
            loadStats();
        } else {
            Swal.fire("تنبيه", "كلمة المرور غير صحيحة", "error");
            logAction("محاولة دخول فاشلة", "تحذير");
        }
    }

    async function checkConnection() {
        const { error } = await db.from('cases').select('id').limit(1);
        const dot = document.getElementById('connection-dot');
        dot.className = error ? 'w-2 h-2 rounded-full bg-red-500' : 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
    }

    // إضافة قضية
    document.getElementById('caseForm').onsubmit = async (e) => {
        e.preventDefault();
        const caseData = {
            client_name: document.getElementById('client_name').value,
            client_phone: document.getElementById('client_phone').value,
            case_number: document.getElementById('case_number').value,
            court_name: document.getElementById('court_name').value,
            opponent_name: document.getElementById('opponent_name').value,
            case_subject: document.getElementById('case_subject').value
        };

        const { data, error } = await db.from('cases').insert([caseData]).select();
        if (error) {
            Swal.fire("خطأ", "فشل الحفظ في السحابة", "error");
        } else {
            Swal.fire("تم الحفظ", "تم إضافة القضية بنجاح", "success");
            logAction("إضافة قضية", caseData.client_name);
            e.target.reset();
        }
    };

    // سجل العمليات
    function logAction(action, detail) {
        const container = document.getElementById('logsContainer');
        const time = new Date().toLocaleTimeString('ar-EG');
        const logHtml = `
            <div class="log-item flex justify-between items-center">
                <span><b class="text-gold-solid">${action}:</b> ${detail}</span>
                <span class="opacity-40 text-xs">${time}</span>
            </div>
        `;
        container.insertAdjacentHTML('afterbegin', logHtml);
    }

    // البحث عن القضايا للجلسات
    async function searchCasesForSession(q) {
        if (q.length < 2) return;
        const { data } = await db.from('cases').select('*').ilike('client_name', `%${q}%`).limit(5);
        const res = document.getElementById('caseSearchResults');
        res.innerHTML = data.map(c => `<div class="p-2 hover:bg-gold/20 cursor-pointer text-sm border-b border-white/5" onclick="selectForSession('${c.id}', '${c.client_name}')">${c.client_name} (${c.case_number})</div>`).join('');
        res.classList.remove('hidden');
    }

    function selectForSession(id, name) {
        window.selectedCaseId = id;
        document.getElementById('s_case_code').value = name;
        document.getElementById('caseSearchResults').classList.add('hidden');
    }

    // حفظ الجلسة
    async function saveSession() {
        if (!window.selectedCaseId) return Swal.fire("عذراً", "اختر قضية أولاً", "warning");
        const sData = {
            case_id: window.selectedCaseId,
            session_date: document.getElementById('s_date').value,
            decision: document.getElementById('s_decision').value
        };
        const { error } = await db.from('sessions').insert([sData]);
        if (!error) {
            Swal.fire("تم", "تم جدولة الجلسة", "success");
            loadUpcoming('week');
        }
    }

    // عرض الجلسات القادمة
    async function loadUpcoming(range) {
        const { data, error } = await db.from('sessions').select('*, cases(client_name, case_number)').order('session_date', {ascending: true});
        const container = document.getElementById('upcomingSessions');
        if (data) {
            container.innerHTML = data.map(s => `
                <div class="card-glass p-4 border-r-4 border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <h6 class="text-white font-bold">${s.cases.client_name}</h6>
                            <p class="text-xs opacity-60">قضية رقم: ${s.cases.case_number}</p>
                        </div>
                        <span class="status-badge text-blue-400">${new Date(s.session_date).toLocaleDateString('ar-EG')}</span>
                    </div>
                    <div class="mt-2 text-sm bg-white/5 p-2 rounded italic">${s.decision || 'لا يوجد إجراء مسجل'}</div>
                </div>
            `).join('');
        }
    }

    // البحث العام
    async function searchCases() {
        const q = document.getElementById('searchInput').value;
        const { data } = await db.from('cases').select('*').or(`client_name.ilike.%${q}%,case_number.ilike.%${q}%`);
        const res = document.getElementById('searchResults');
        res.innerHTML = data.map(c => `
            <div class="card-glass p-4 case-card cursor-pointer" onclick="openCase('${c.id}')">
                <div class="flex justify-between">
                    <span class="font-bold text-white">${c.client_name}</span>
                    <span class="text-gold-solid text-xs">${c.case_number}</span>
                </div>
                <div class="text-xs opacity-50 mt-1">${c.court_name}</div>
            </div>
        `).join('');
        logAction("بحث", q);
    }

    // فتح تفاصيل القضية
    async function openCase(id) {
        const { data: c } = await db.from('cases').select('*').eq('id', id).single();
        const { data: sessions } = await db.from('sessions').select('*').eq('case_id', id).order('session_date', {ascending: false});
        
        currentCaseData = { ...c, sessions };

        let html = `
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1 text-xs opacity-50">اسم الموكل</p>
                    <h5 class="text-white mb-3">${c.client_name}</h5>
                    <p class="mb-1 text-xs opacity-50">المحكمة</p>
                    <p class="text-white">${c.court_name}</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1 text-xs opacity-50">رقم الهاتف</p>
                    <p class="text-white mb-3">${c.client_phone}</p>
                    <p class="mb-1 text-xs opacity-50">الخصم</p>
                    <p class="text-white">${c.opponent_name || 'غير محدد'}</p>
                </div>
                <div class="col-12 mt-4">
                    <h6 class="gold-text border-b border-white/10 pb-2">تاريخ الجلسات</h6>
                    <div class="mt-2 space-y-2">
                        ${sessions.map(s => `
                            <div class="flex justify-between text-sm bg-white/5 p-2 rounded">
                                <span>${new Date(s.session_date).toLocaleDateString('ar-EG')}</span>
                                <span class="opacity-70">${s.decision}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        document.getElementById('caseDetails').innerHTML = html;
        new bootstrap.Modal(document.getElementById('caseModal')).show();
    }

    // تصدير PDF (إضافة جديدة v3)
    function generateCasePDF() {
        if (!currentCaseData) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        
        // ملاحظة: jsPDF يحتاج إعدادات خاصة للخطوط العربية ليظهر بشكل صحيح
        // هنا نقوم بإنشاء هيكل التقرير
        doc.setFontSize(20);
        doc.text("Report: Case Summary", 10, 20);
        doc.setFontSize(12);
        doc.text(`Client: ${currentCaseData.client_name}`, 10, 40);
        doc.text(`Case Number: ${currentCaseData.case_number}`, 10, 50);
        doc.text(`Court: ${currentCaseData.court_name}`, 10, 60);
        
        doc.save(`Case_${currentCaseData.case_number}.pdf`);
        Swal.fire("PDF", "تم تحميل ملخص القضية بنجاح", "success");
    }

    function clearForm() {
        document.getElementById('caseForm').reset();
        bootstrap.Tab.getOrCreateInstance(document.querySelector('[data-bs-target="#cases"]')).show();
    }

    async function loadStats() {
        // يمكن إضافة عدادات هنا للإحصائيات
        checkConnection();
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
