<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام إدارة القضايا</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#D4AF37">
    
    <!-- PWA Manifest -->
    <link rel="manifest" id="app-manifest">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="إدارة القضايا">
    
    <!-- Icons -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Groq and Tavily SDKs -->
    <script src="https://unpkg.com/groq-sdk-js"></script>
    <script type="module">
        // This is a placeholder for Tavily SDK if it were available via CDN
        // Since it's not, we will use fetch API to call it.
    </script>

    <style>
    :root {
        --gold: #D4AF37;
        --royal-gold: #E5B80B;
        --black: #0a0a0a;
        --glass-black: rgba(10, 10, 10, 0.85);
        --glass-light: rgba(255, 255, 255, 0.05);
        --glass-light-hover: rgba(255, 255, 255, 0.1);
        --text-color: #EAEAEA;
        --text-muted: #999;
        --border-color: rgba(212, 175, 55, 0.2);
    }

    body {
        background-color: var(--black);
        color: var(--text-color);
        font-family: 'Segoe UI', system-ui;
        background-image: linear-gradient(45deg, rgba(212, 175, 55, 0.02) 25%, transparent 25%),
                          linear-gradient(-45deg, rgba(212, 175, 55, 0.02) 25%, transparent 25%),
                          linear-gradient(45deg, transparent 75%, rgba(212, 175, 55, 0.02) 75%),
                          linear-gradient(-45deg, transparent 75%, rgba(212, 175, 55, 0.02) 75%);
        background-size: 20px 20px;
    }

    .header {
        background: linear-gradient(135deg, #000, #1a1a1a);
        color: var(--gold);
        padding: 20px;
        border-bottom: 4px solid var(--gold);
        text-shadow: 0 0 10px var(--gold);
    }

    .form-section, .modal-content {
        background: var(--glass-black);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }

    .form-control, .form-select {
        background-color: var(--glass-light);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    .form-control:focus, .form-select:focus {
        background-color: var(--glass-light-hover);
        color: var(--text-color);
        border-color: var(--gold);
        box-shadow: 0 0 0 0.25rem rgba(212, 175, 55, 0.25);
    }
    .form-control::placeholder { color: var(--text-muted); }
    
    label { color: var(--gold); }

    .btn-gold {
        background: var(--gold);
        border: none;
        font-weight: 600;
        color: var(--black);
        transition: all 0.3s ease;
    }
    .btn-gold:hover {
        background: var(--royal-gold);
        color: #000;
        box-shadow: 0 0 15px var(--gold);
    }

    .session-card, .case-card, .security-log-card {
        background: var(--glass-black);
        border-right: 4px solid var(--gold);
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.3s;
    }
    .session-card:hover, .case-card:hover, .security-log-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(212, 175, 55, 0.2);
    }

    .case-code {
        font-family: monospace;
        font-size: 1.2rem;
        color: var(--royal-gold);
        font-weight: bold;
        text-shadow: 0 0 5px var(--royal-gold);
    }

    .nav-tabs { border-bottom-color: var(--border-color); }
    .nav-tabs .nav-link { color: var(--text-muted); border: 1px solid transparent; }
    .nav-tabs .nav-link.active {
        background-color: var(--gold);
        color: var(--black);
        border-color: var(--gold);
        font-weight: bold;
    }
    .nav-tabs .nav-link:hover {
        border-color: var(--border-color);
        color: var(--gold);
    }
    
    .modal-header, .modal-footer {
        border-bottom: 1px solid var(--border-color);
        border-top: 1px solid var(--border-color);
    }
    .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

    /* AI Chat Styles */
    #aiChatContainer {
        display: flex;
        flex-direction: column;
        height: 70vh;
    }
    #aiChatBox {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        border: 1px solid var(--border-color);
        margin-bottom: 15px;
    }
    .chat-message {
        padding: 10px 15px;
        border-radius: 15px;
        margin-bottom: 10px;
        max-width: 80%;
        word-wrap: break-word;
    }
    .user-message {
        background-color: var(--gold);
        color: var(--black);
        margin-left: auto;
        border-bottom-right-radius: 0;
    }
    .bot-message {
        background-color: #333;
        color: var(--text-color);
        margin-right: auto;
        border-bottom-left-radius: 0;
    }
    .system-message {
        font-style: italic;
        color: var(--text-muted);
        text-align: center;
        font-size: 0.9em;
    }
    #aiInputContainer { display: flex; gap: 10px; }
    #aiInput { flex-grow: 1; }
    </style>
</head>

<body>

<div id="loginPage" class="container mt-5" style="max-width:400px">
    <div class="form-section text-center">
        <i class="bi bi-shield-lock-fill" style="font-size: 3rem; color: var(--gold);"></i>
        <h4 class="mt-3">دخول النظام</h4>
        <input type="password" id="password" class="form-control my-3" placeholder="كلمة المرور">
        <button class="btn btn-gold w-100" onclick="login()">دخول</button>
    </div>
</div>

<div id="mainContent" style="display:none">
    <div class="header text-center">
        <h2>نظام إدارة القضايا</h2>
        <p id="today"></p>
        <button class="btn btn-sm btn-outline-light" onclick="installPWA()" id="installBtn" style="display:none">
            <i class="bi bi-download"></i> تثبيت التطبيق
        </button>
    </div>

    <div class="container mt-4">
        <ul class="nav nav-tabs mb-3" id="mainTabs">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cases">القضايا</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sessions">الجلسات</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#search">بحث وتقارير</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#securityLogs">سجل الاستعلامات</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#aiAssistant"><i class="bi bi-robot"></i> مساعد المحامي الذكي</button></li>
        </ul>

        <div class="tab-content">
            <!-- تبويب القضايا -->
            <div class="tab-pane fade show active" id="cases">
                <form id="caseForm" class="form-section">
                    <h5>تسجيل قضية جديدة</h5>
                    <hr style="border-color: var(--border-color);">
                    <div class="row g-3">
                        <div class="col-md-4"><label>اسم العميل</label><input id="client_name" class="form-control" required></div>
                        <div class="col-md-4"><label>هاتف العميل</label><input id="client_phone" class="form-control" required></div>
                        <div class="col-md-4"><label>إيميل العميل</label><input type="email" id="client_email" class="form-control"></div>
                        <div class="col-md-4"><label>صفة العميل</label><select id="client_role" class="form-select" required><option value="">اختر الصفة...</option><option>مدعي</option><option>مدعى عليه</option><option>مستأنف</option><option>مستأنف ضده</option><option>طاعن</option><option>مطعون ضده</option><option>مجني عليه</option><option>متهم</option></select></div>
                        <div class="col-md-4"><label>اسم الخصم</label><input id="opponent_name" class="form-control"></div>
                        <div class="col-md-4"><label>رقم القضية</label><input id="case_number" class="form-control" required></div>
                        <div class="col-md-4"><label>سنة القضية</label><input id="case_year" class="form-control" required></div>
                        <div class="col-md-6"><label>المحكمة</label><select id="court_name" class="form-select" required><option value="">اختر المحكمة...</option><option>محكمة الأسرة</option><option>المحكمة الجزئية</option><option>المحكمة الابتدائية</option><option>محكمة الاستئناف</option><option>المحكمة العمالية</option><option>المحكمة الاقتصادية</option><option>المحكمة الادارية</option><option>محكمة القضاء الاداري</option><option>المحكمة الادارية العليا</option><option>محكمة النقض</option></select></div>
                        <div class="col-md-6"><label>الدائرة</label><input id="circle" class="form-control"></div>
                        <div class="col-md-6"><label>نوع القضية</label><select id="case_type" class="form-select" required><option value="">اختر نوع القضية...</option><option>مدنية</option><option>جنائية</option><option>تجارية</option><option>عمالية</option><option>أحوال شخصية</option><option>إدارية</option><option>دستورية</option><option>ضريبية</option></select></div>
                        <div class="col-md-12"><label>موضوع القضية</label><textarea id="case_subject" class="form-control" rows="2"></textarea></div>
                        <div class="col-md-12"><label>ملاحظات</label><textarea id="notes" class="form-control" rows="3" placeholder="ملاحظات إضافية عن القضية..."></textarea></div>
                    </div>
                    <div class="d-flex gap-2 mt-3"><button type="submit" class="btn btn-gold flex-grow-1">حفظ القضية</button><button type="button" class="btn btn-outline-secondary w-25" onclick="clearForm()">جديد</button></div>
                    <div id="caseCodeResult" class="mt-3 text-center"></div>
                </form>
            </div>

            <!-- تبويب الجلسات -->
            <div class="tab-pane fade" id="sessions">
                <!-- محتوى تبويب الجلسات هنا -->
            </div>

            <!-- تبويب البحث والتقارير -->
            <div class="tab-pane fade" id="search">
                <!-- محتوى تبويب البحث هنا -->
            </div>
            
            <!-- تبويب سجل الاستعلامات -->
            <div class="tab-pane fade" id="securityLogs">
                <!-- محتوى تبويب سجل الاستعلامات هنا -->
            </div>

            <!-- تبويب مساعد المحامي الذكي -->
            <div class="tab-pane fade" id="aiAssistant">
                <div class="form-section">
                    <h5><i class="bi bi-robot"></i> مساعد المحامي الذكي</h5>
                    <hr style="border-color: var(--border-color);">
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label for="groqModel">نموذج Groq</label>
                            <input type="text" id="groqModel" class="form-control" value="llama3-70b-8192">
                        </div>
                        <div class="col-md-5">
                            <label for="tavilyKey">مفتاح Tavily API</label>
                            <input type="password" id="tavilyKey" class="form-control" placeholder="أدخل مفتاح Tavily للبحث">
                        </div>
                        <div class="col-md-3">
                            <label for="aiAdminSearch">جلب بيانات قضية (بالرقم الإداري)</label>
                            <div class="input-group">
                                <input id="aiAdminSearch" class="form-control" placeholder="001">
                                <button class="btn btn-gold" type="button" onclick="fetchCaseDataForAI()">
                                    <i class="bi bi-arrow-down-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="aiChatContainer">
                        <div id="aiChatBox">
                            <div class="chat-message bot-message">
                                أهلاً بك، أنا مساعدك القانوني الذكي. كيف يمكنني مساعدتك اليوم؟ يمكنك سؤالي عن أي شيء أو طلب صياغة مذكرة عن طريق جلب بيانات القضية أولاً.
                            </div>
                        </div>
                        <div id="aiInputContainer">
                            <input type="text" id="aiInput" class="form-control" placeholder="اكتب سؤالك أو طلبك هنا...">
                            <button class="btn btn-gold" onclick="sendAiMessage()"><i class="bi bi-send"></i> إرسال</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals will go here -->
<!-- The rest of your HTML body content (modals, etc.) remains unchanged -->

<script>
// The original script content remains here, with the addition of AI functions.
// For brevity, only the new AI functions are shown below.
// Paste your entire original script here, and then add these functions.

const SB_URL="https://iyhfafodhptcdwrjywek.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ";
const db=supabase.createClient(SB_URL,SB_KEY);

// ... (Your existing JS code) ...
login = function(){
    if(document.getElementById('password').value==="mahmoud237"){
        document.getElementById('loginPage').style.display="none";
        document.getElementById('mainContent').style.display="block";
        document.getElementById('today').innerText=new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        // loadUpcoming('week'); // Assuming this function exists
        // requestNotificationPermission(); // Assuming this function exists
        // testSupabaseConnection(); // Assuming this function exists
        // refreshSecurityStats(); // Assuming this function exists
        // setupSecurityLogsTab(); // Assuming this function exists
    } else {
        Swal.fire("خطأ","كلمة المرور غير صحيحة","error");
    }
}


// ============================
// AI Assistant Functions
// ============================

const aiChatBox = document.getElementById('aiChatBox');
const aiInput = document.getElementById('aiInput');
let groq;

aiInput.addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
        sendAiMessage();
    }
});

function addMessageToChat(message, sender) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('chat-message', `${sender}-message`);
    messageElement.textContent = message;
    aiChatBox.appendChild(messageElement);
    aiChatBox.scrollTop = aiChatBox.scrollHeight;
}

async function fetchCaseDataForAI() {
    const adminNumber = document.getElementById('aiAdminSearch').value.trim();
    if (!adminNumber) {
        Swal.fire("تنبيه", "الرجاء إدخال الرقم الإداري للقضية.", "warning");
        return;
    }

    addMessageToChat(`جاري جلب بيانات القضية ذات الرقم الإداري: ${adminNumber}...`, 'system');

    try {
        const { data, error } = await db
            .from('cases')
            .select('*')
            .like('case_code', `%-${adminNumber}-%`)
            .single();

        if (error || !data) {
            addMessageToChat(`خطأ: لم يتم العثور على قضية بالرقم الإداري ${adminNumber}.`, 'system');
            Swal.fire("خطأ", "لم يتم العثور على القضية.", "error");
            return;
        }

        const caseInfo = `
        تم جلب بيانات القضية بنجاح.
        - كود القضية: ${data.case_code}
        - العميل: ${data.client_name} (${data.client_role})
        - الخصم: ${data.opponent_name}
        - المحكمة: ${data.court_name}
        - رقم وسنة القضية: ${data.case_number}/${data.case_year}
        - نوع القضية: ${data.case_type}
        - موضوع القضية: ${data.case_subject}
        
        يمكنك الآن أن تطلب مني صياغة مذكرة أو تحليل لهذه البيانات.
        `;
        addMessageToChat(caseInfo, 'bot');

    } catch (err) {
        addMessageToChat(`حدث خطأ فني أثناء جلب بيانات القضية.`, 'system');
        console.error("Error fetching case for AI:", err);
        Swal.fire("خطأ فني", "حدث خطأ أثناء الاتصال بقاعدة البيانات.", "error");
    }
}

async function sendAiMessage() {
    const userInput = aiInput.value.trim();
    if (!userInput) return;

    addMessageToChat(userInput, 'user');
    aiInput.value = '';

    try {
        // Initialize Groq on first message
        if (!groq) {
            groq = new Groq({
                apiKey: "gsk_YOUR_GROQ_API_KEY", // IMPORTANT: Replace with your actual Groq API key
                dangerouslyAllowBrowser: true,
            });
        }

        const tavilyApiKey = document.getElementById('tavilyKey').value.trim();
        let searchResults = '';

        // Check if user wants to search and if Tavily key is provided
        if (userInput.includes("ابحث عن") && tavilyApiKey) {
            addMessageToChat("جاري البحث على الإنترنت...", 'system');
            const searchQuery = userInput.replace("ابحث عن", "").trim();
            
            // Using fetch for Tavily API
            const tavilyResponse = await fetch('https://api.tavily.com/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    api_key: tavilyApiKey,
                    query: searchQuery,
                    search_depth: "basic",
                    include_answer: true,
                    max_results: 3
                }),
            });

            if (!tavilyResponse.ok) {
                searchResults = "حدث خطأ أثناء البحث في Tavily.";
            } else {
                const tavilyData = await tavilyResponse.json();
                searchResults = `\n\n--- نتائج البحث من Tavily ---\n`;
                searchResults += `الإجابة المباشرة: ${tavilyData.answer || 'لا يوجد'}\n`;
                tavilyData.results.forEach((res, index) => {
                    searchResults += `\n[المصدر ${index + 1}] ${res.title}\n${res.content}\nURL: ${res.url}\n`;
                });
                searchResults += `--- نهاية نتائج البحث ---`;
            }
            addMessageToChat("تم العثور على نتائج البحث.", 'system');
        }

        const systemPrompt = `
        أنت مساعد محامٍ ذكي متخصص في القانون المصري. لغتك عربية فصحى ورصينة وقانونية.
        التزم فقط بالقوانين المصرية وأحكام المحاكم المصرية (النقض، الدستورية العليا، إلخ).
        عند الإشارة إلى قانون، اذكر رقم المادة والسنة. عند الإشارة إلى حكم محكمة، اذكر رقم الطعن والسنة والجلسة.
        مهمتك هي مساعدة المستخدم في فهم القضايا وصياغة المذكرات القانونية.
        إذا قمت بالبحث على الإنترنت، قم بتلخيص النتائج ودمجها في إجابتك مع الإشارة إلى المصادر.
        `;

        const chatCompletion = await groq.chat.completions.create({
            messages: [
                { role: "system", content: systemPrompt },
                { role: "user", content: userInput + searchResults }
            ],
            model: document.getElementById('groqModel').value.trim(),
        });

        const botResponse = chatCompletion.choices[0]?.message?.content || "عفواً، لم أتمكن من معالجة الطلب.";
        addMessageToChat(botResponse, 'bot');

    } catch (error) {
        console.error("Groq API Error:", error);
        addMessageToChat("حدث خطأ أثناء التواصل مع الذكاء الاصطناعي. تأكد من صحة مفتاح Groq API.", 'system');
    }
}

// ... (The rest of your original JavaScript code) ...

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
