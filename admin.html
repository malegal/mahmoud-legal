<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>نظام إدارة القضايا</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root{ --gold:#D4AF37; --black:#1A1A1A; --bg:#F8F5E6; }
body{background:var(--bg);font-family:Segoe UI}
.header{background:linear-gradient(135deg,#000,#333);color:var(--gold);padding:20px;border-bottom:4px solid var(--gold)}
.form-section{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border-right:5px solid var(--gold);box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
.btn-gold{background:var(--gold);border:none;font-weight:600;color:#fff}
.btn-gold:hover{background:#b8962e;color:#fff}
.session-card{background:#fff;border-right:4px solid var(--gold);padding:15px;margin-bottom:10px;border-radius:4px;box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
.case-code{font-family:monospace;font-size:1.2rem;color:var(--gold);font-weight:bold}
.nav-tabs .nav-link.active {background-color: var(--gold); color: white; border-color: var(--gold);}
.nav-tabs .nav-link {color: var(--black);}
.auto-fill-badge { font-size: 0.7rem; background: #e9ecef; padding: 2px 8px; border-radius: 10px; color: #666; }
</style>
</head>

<body>

<div id="loginPage" class="container mt-5" style="max-width:400px">
    <div class="form-section text-center">
        <i class="bi bi-shield-lock-fill" style="font-size: 3rem; color: var(--gold);"></i>
        <h4 class="mt-3">دخول النظام</h4>
        <input type="password" id="password" class="form-control my-3" placeholder="كلمة المرور">
        <button class="btn btn-gold w-100" onclick="login()">دخول</button>
    </div>
</div>

<div id="mainContent" style="display:none">
    <div class="header text-center">
        <h2>نظام إدارة القضايا</h2>
        <p id="today"></p>
    </div>

    <div class="container mt-4">
        <ul class="nav nav-tabs mb-3" id="mainTabs">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cases">القضايا</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sessions">الجلسات</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#search">بحث وتقارير</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="cases">
                <form id="caseForm" class="form-section">
                    <h5>تسجيل قضية جديدة</h5>
                    <hr>
                    <div class="row g-3">
                        <div class="col-md-4"><label>اسم العميل</label><input id="client_name" class="form-control" required></div>
                        <div class="col-md-4"><label>هاتف العميل</label><input id="client_phone" class="form-control" required></div>
                        <div class="col-md-4">
                            <label>صفة العميل</label>
                            <select id="client_role" class="form-select" required>
                                <option value="">اختر الصفة...</option>
                                <option>مدعي</option><option>مدعى عليه</option><option>مجني عليه</option><option>متهم</option>
                            </select>
                        </div>
                        <div class="col-md-4"><label>اسم الخصم</label><input id="opponent_name" class="form-control"></div>
                        <div class="col-md-4"><label>رقم القضية</label><input id="case_number" class="form-control" required></div>
                        <div class="col-md-4"><label>سنة القضية</label><input id="case_year" class="form-control" required></div>
                        <div class="col-md-6">
                            <label>المحكمة</label>
                            <select id="court_name" class="form-select" required>
                                <option value="">اختر المحكمة...</option>
                                <option>محكمة الأسرة</option><option>المحكمة الجزئية</option><option>المحكمة الابتدائية</option>
                                <option>محكمة الاستئناف</option><option>محكمة النقض</option>
                            </select>
                        </div>
                        <div class="col-md-6"><label>الدائرة</label><input id="circle" class="form-control"></div>
                    </div>
                    <button type="submit" class="btn btn-gold w-100 mt-3">حفظ القضية</button>
                    <div id="caseCodeResult" class="mt-3 text-center"></div>
                </form>
            </div>

            <div class="tab-pane fade" id="sessions">
                <div class="form-section">
                    <h5>تسجيل جلسة <span class="auto-fill-badge">الجلب تلقائي</span></h5>
                    <hr>
                    <div class="row g-3">
                        <div class="col-md-3"><label>رقم القضية</label><input id="s_case_number" class="form-control" onchange="autoFillCase()"></div>
                        <div class="col-md-3"><label>سنة القضية</label><input id="s_case_year" class="form-control" onchange="autoFillCase()"></div>
                        <div class="col-md-6"><label>المحكمة</label><input id="s_court" class="form-control" readonly></div>
                        <div class="col-md-6"><label>اسم العميل</label><input id="s_client" class="form-control" readonly></div>
                        <div class="col-md-6"><label>اسم الخصم</label><input id="s_opponent" class="form-control" readonly></div>
                        <div class="col-md-6"><label>تاريخ الجلسة</label><input type="date" id="s_date" class="form-control"></div>
                        <div class="col-md-12"><label>القرار</label><textarea id="s_decision" class="form-control"></textarea></div>
                    </div>
                    <button class="btn btn-gold w-100 mt-3" onclick="saveSession()">حفظ الجلسة</button>
                </div>

                <div class="form-section">
                    <h5>جلسات قادمة</h5>
                    <div class="btn-group w-100 mb-3">
                        <button type="button" class="btn btn-outline-secondary active" onclick="loadUpcoming('week', this)">الأسبوع الحالي</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="loadUpcoming('month', this)">الشهر الحالي</button>
                    </div>
                    <div id="upcomingSessions"></div>
                </div>
            </div>

            <div class="tab-pane fade" id="search">
                <div class="form-section">
                    <h5>البحث المتقدم</h5>
                    <hr>
                    <div class="row g-2 mb-3">
                        <div class="col-md-8"><input id="searchInput" class="form-control" placeholder="رقم قضية، اسم، أو هاتف"></div>
                        <div class="col-md-4"><button class="btn btn-gold w-100" onclick="searchCases()">بحث</button></div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-dark" onclick="filterSessions('week')">جلسات الأسبوع</button>
                        <button class="btn btn-sm btn-outline-dark" onclick="filterSessions('month')">جلسات الشهر</button>
                        <button class="btn btn-sm btn-outline-dark" onclick="searchByPhone()">بحث برقم الهاتف</button>
                    </div>
                </div>
                <div id="searchResults"></div>
            </div>
        </div>
    </div>
</div>

<script>
const SB_URL="https://iyhfafodhptcdwrjywek.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ";
const db=supabase.createClient(SB_URL,SB_KEY);

let currentCaseId = null;

function login(){
    if(document.getElementById('password').value==="mahmoud237"){
        loginPage.style.display="none"; mainContent.style.display="block";
        today.innerText=new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        loadUpcoming('week');
    } else Swal.fire("خطأ","كلمة المرور غير صحيحة","error");
}

async function autoFillCase() {
    const num = document.getElementById('s_case_number').value;
    const year = document.getElementById('s_case_year').value;
    if(num && year) {
        const { data, error } = await db.from('cases').select('*').eq('case_number', num).eq('case_year', year).single();
        if(data) {
            currentCaseId = data.id;
            document.getElementById('s_court').value = data.court_name;
            document.getElementById('s_client').value = data.client_name;
            document.getElementById('s_opponent').value = data.opponent_name;
        } else {
            currentCaseId = null;
            ['s_court','s_client','s_opponent'].forEach(id=>document.getElementById(id).value="");
        }
    }
}

caseForm.onsubmit=async e=>{
    e.preventDefault();
    Swal.fire({title: 'جاري الحفظ...', didOpen: () => Swal.showLoading()});
    const code=`MA-${Date.now().toString().slice(-6)}`;
    const { error } = await db.from('cases').insert([{
        client_name: client_name.value, client_phone: client_phone.value, client_role: client_role.value,
        opponent_name: opponent_name.value, case_number: case_number.value, case_year: case_year.value,
        court_name: court_name.value, circle: circle.value, case_code: code
    }]);
    if(error) Swal.fire("خطأ", error.message, "error");
    else { Swal.fire("تم", "كود القضية: "+code, "success"); caseForm.reset(); }
};

async function saveSession(){
    if(!currentCaseId) return Swal.fire("تنبيه","اختر قضية صحيحة أولاً","warning");
    const { error } = await db.from('sessions').insert([{
        case_id: currentCaseId, session_date: s_date.value, decision: s_decision.value
    }]);
    if(error) Swal.fire("خطأ", error.message, "error");
    else { Swal.fire("تم الحفظ", "", "success"); loadUpcoming('week'); }
}

// دالة البحث العام (قضايا)
async function searchCases(){
    const t = searchInput.value;
    if(!t.trim()) return Swal.fire("تنبيه","أدخل كلمة للبحث","warning");
    
    Swal.fire({title: 'جاري البحث...', didOpen: () => Swal.showLoading()});
    
    // البحث في القضايا فقط
    const { data, error } = await db
        .from('cases')
        .select('*')
        .or(`case_number.ilike.%${t}%,client_name.ilike.%${t}%,client_phone.ilike.%${t}%`);
    
    Swal.close();
    if(error) {
        console.error("Search error:", error);
        return Swal.fire("خطأ", "فشل البحث: " + error.message, "error");
    }
    
    // جلب الجلسات لكل قضية على حدة
    if(data && data.length > 0) {
        for(let caseItem of data) {
            const { data: sessions } = await db
                .from('sessions')
                .select('*')
                .eq('case_id', caseItem.id)
                .order('session_date', { ascending: true });
            caseItem.sessions = sessions || [];
        }
    }
    
    renderSearchResults(data, "cases");
}

async function searchByPhone(){
    const { value: phone } = await Swal.fire({ 
        title: 'البحث برقم الهاتف', 
        input: 'text', 
        inputPlaceholder: 'أدخل رقم الهاتف',
        showCancelButton: true 
    });
    if (phone) { 
        searchInput.value = phone; 
        searchCases(); 
    }
}

// دالة فلترة الجلسات (الأسبوع والشهر)
async function filterSessions(range){
    Swal.fire({title: 'جاري الجلب...', didOpen: () => Swal.showLoading()});
    
    const today = new Date();
    const startDate = today.toISOString().split('T')[0];
    
    const endDate = new Date();
    if(range === 'week') {
        endDate.setDate(today.getDate() + 7);
    } else {
        endDate.setMonth(today.getMonth() + 1);
    }
    
    const endDateStr = endDate.toISOString().split('T')[0];
    
    // استعلام الجلسات فقط
    const { data, error } = await db
        .from('sessions')
        .select('*')
        .gte('session_date', startDate)
        .lte('session_date', endDateStr)
        .order('session_date', { ascending: true });
    
    Swal.close();
    if(error) {
        console.error("Filter sessions error:", error);
        return Swal.fire("خطأ", "فشل جلب الجلسات: " + error.message, "error");
    }
    
    // جلب بيانات القضية لكل جلسة
    if(data && data.length > 0) {
        for(let session of data) {
            const { data: caseData } = await db
                .from('cases')
                .select('*')
                .eq('id', session.case_id)
                .single();
            session.cases = caseData || {};
        }
    }
    
    renderSearchResults(data, "sessions");
}

// دالة عرض نتائج البحث
function renderSearchResults(data, type) {
    if(!data || data.length === 0) { 
        searchResults.innerHTML = '<div class="alert alert-info">لا توجد نتائج</div>'; 
        return; 
    }
    
    let html = `<h6>نتائج البحث (${data.length}):</h6>`;
    
    if(type === "sessions") {
        // عرض بيانات الجلسات مع بيانات القضية
        data.forEach(item => {
            const caseData = item.cases || {};
            html += `
            <div class="session-card">
                <div class="d-flex justify-content-between">
                    <strong class="text-primary">${item.session_date || 'غير محدد'}</strong>
                    <span>${caseData.court_name || 'غير محدد'}</span>
                </div>
                <div>
                    <strong>العميل:</strong> ${caseData.client_name || 'غير معروف'} 
                    <span class="text-danger"> ضد </span> 
                    <strong>الخصم:</strong> ${caseData.opponent_name || 'غير معروف'}
                </div>
                <div>
                    <strong>القضية:</strong> ${caseData.case_number || 'غير محدد'}/${caseData.case_year || 'غير محدد'}
                </div>
                ${item.decision ? `<div class="mt-2 p-2 bg-light small"><b>القرار:</b> ${item.decision}</div>` : ''}
            </div>`;
        });
    } else {
        // عرض بيانات القضايا مع جلساتها
        data.forEach(item => {
            const sessionsList = item.sessions && item.sessions.length > 0 
                ? item.sessions.map(s => `<li>${s.session_date || 'غير محدد'}: ${s.decision || 'لا يوجد قرار'}</li>`).join('') 
                : '<li>لا توجد جلسات مسجلة</li>';
            
            html += `
            <div class="form-section mb-2">
                <div class="d-flex justify-content-between">
                    <b class="case-code">${item.case_code || 'غير محدد'}</b>
                    <span class="badge" style="background-color: var(--gold); color: white;">${item.court_name || 'غير محدد'}</span>
                </div>
                <div class="mt-2">
                    <strong>العميل:</strong> ${item.client_name || 'غير معروف'} 
                    <span class="text-danger"> ضد </span> 
                    <strong>الخصم:</strong> ${item.opponent_name || 'غير معروف'}<br>
                    <strong>القضية:</strong> ${item.case_number || 'غير محدد'}/${item.case_year || 'غير محدد'}
                </div>
                <div class="mt-2 small border-top pt-1">
                    <strong>تاريخ الجلسات:</strong>
                    <ul class="mb-0">${sessionsList}</ul>
                </div>
            </div>`;
        });
    }
    searchResults.innerHTML = html;
}

// دالة تحميل الجلسات القادمة
async function loadUpcoming(range, btn){
    if(btn) { 
        document.querySelectorAll('#sessions .btn-group .btn').forEach(b=>b.classList.remove('active')); 
        btn.classList.add('active'); 
    }
    
    const today = new Date();
    const startDate = today.toISOString().split('T')[0];
    
    const endDate = new Date();
    if(range === 'week') {
        endDate.setDate(today.getDate() + 7);
    } else {
        endDate.setMonth(today.getMonth() + 1);
    }
    
    const endDateStr = endDate.toISOString().split('T')[0];

    // استعلام الجلسات فقط
    const { data, error } = await db
        .from('sessions')
        .select('*')
        .gte('session_date', startDate)
        .lte('session_date', endDateStr)
        .order('session_date', { ascending: true });
    
    if(error) { 
        console.error("Load upcoming error:", error);
        upcomingSessions.innerHTML = "<div class='alert alert-danger'>خطأ في التحميل: " + error.message + "</div>"; 
        return; 
    }
    
    // جلب بيانات القضية لكل جلسة
    if(data && data.length > 0) {
        for(let session of data) {
            const { data: caseData } = await db
                .from('cases')
                .select('*')
                .eq('id', session.case_id)
                .single();
            session.cases = caseData || {};
        }
    }
    
    if(data.length === 0) {
        upcomingSessions.innerHTML = "<p class='text-center text-muted'>لا توجد جلسات قادمة</p>";
        return;
    }
    
    upcomingSessions.innerHTML = data.map(s => {
        const caseData = s.cases || {};
        return `
        <div class="session-card">
            <div class="d-flex justify-content-between">
                <b>${s.session_date || 'غير محدد'}</b>
                <small>${caseData.court_name || 'غير محدد'}</small>
            </div>
            <div>
                ${caseData.client_name || 'غير معروف'} - 
                قضية ${caseData.case_number || 'غير محدد'}/${caseData.case_year || 'غير محدد'}
            </div>
            ${caseData.opponent_name ? `<div><small>ضد: ${caseData.opponent_name}</small></div>` : ''}
        </div>`;
    }).join('');
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
