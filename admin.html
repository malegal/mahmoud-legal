<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام إدارة القضايا | الأستاذ محمود عبد الحميد</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#bf953f">
    
    <link rel="manifest" id="app-manifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { 
            --gold-solid: #bf953f;
            --gold-gradient: linear-gradient(135deg, #bf953f 0%, #fcf6ba 45%, #b38728 50%, #fbf5b7 55%, #aa771c 100%);
            --primary-dark: #020617;
            --card-bg: #0f172a;
            --text-light: #f8fafc;
        }

        body {
            background-color: var(--primary-dark);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, sans-serif;
            min-height: 100vh;
        }

        /* الهيكل العلوي */
        .header {
            background: linear-gradient(to bottom, #000, #020617);
            color: var(--gold-solid);
            padding: 30px 20px;
            border-bottom: 2px solid var(--gold-solid);
        }

        .header h2 {
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
        }

        /* الحاويات والكروت */
        .form-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(191, 149, 63, 0.2);
        }

        .form-section h5 { color: var(--gold-solid); font-weight: bold; border-bottom: 1px solid rgba(191, 149, 63, 0.1); padding-bottom: 10px; }

        /* الأزرار والحقول */
        .btn-gold { background: var(--gold-gradient); border: none; font-weight: 800; color: #000; transition: 0.3s; }
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(191, 149, 63, 0.3); color: #000; }
        
        .form-control, .form-select {
            background-color: rgba(255,255,255,0.05);
            border: 1px solid rgba(191, 149, 63, 0.3);
            color: white !important;
        }
        .form-control::placeholder { color: rgba(255,255,255,0.3); }

        /* التبويبات */
        .nav-tabs { border-bottom: 1px solid rgba(191, 149, 63, 0.2); }
        .nav-tabs .nav-link { color: #888; border: none; }
        .nav-tabs .nav-link.active {
            background: transparent;
            color: var(--gold-solid);
            border-bottom: 3px solid var(--gold-solid);
            font-weight: bold;
        }

        /* بطاقات القضايا والجلسات */
        .case-card, .session-card {
            background: rgba(255,255,255,0.03);
            border-right: 4px solid var(--gold-solid);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: 0.3s;
        }
        .case-card:hover { background: rgba(255,255,255,0.06); }
        .case-code { color: var(--gold-solid); font-family: monospace; font-weight: bold; }

        /* المودال */
        .modal-content { background-color: var(--card-bg); border: 1px solid var(--gold-solid); color: white; }
        .modal-header { border-bottom: 1px solid rgba(191, 149, 63, 0.2); }
        .btn-close { filter: invert(1); }

        /* الحالات */
        .status-open { background: rgba(0,255,100,0.1); color: #00ff64; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; }
        .status-closed { background: rgba(255,50,50,0.1); color: #ff3232; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; }
    </style>
</head>

<body>

<div id="loginPage" class="container mt-5" style="max-width:400px">
    <div class="form-section text-center shadow-lg">
        <i class="bi bi-shield-lock-fill" style="font-size: 3.5rem; color: var(--gold-solid);"></i>
        <h4 class="mt-3" style="color: var(--gold-solid);">دخول النظام</h4>
        <input type="password" id="password" class="form-control my-4 text-center p-3" placeholder="كلمة المرور">
        <button class="btn btn-gold w-100 py-3" onclick="login()">دخول آمن</button>
    </div>
</div>

<div id="mainContent" style="display:none">
    <div class="header text-center shadow">
        <h2>⚖️ نظام إدارة مكتب المحاماة</h2>
        <p id="today" class="text-white-50 small mt-2"></p>
        <button class="btn btn-sm btn-outline-light mt-2" onclick="installPWA()" id="installBtn" style="display:none">تثبيت التطبيق</button>
    </div>

    <div class="container mt-4">
        <ul class="nav nav-tabs mb-4" id="mainTabs">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cases">القضايا</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sessions">أجندة الجلسات</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#search">الأرشيف والتقارير</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="cases">
                <form id="caseForm" class="form-section shadow">
                    <h5>تسجيل قضية جديدة</h5>
                    <hr class="opacity-10">
                    <div class="row g-3">
                        <div class="col-md-4"><label>اسم العميل</label><input id="client_name" class="form-control" required></div>
                        <div class="col-md-4"><label>هاتف العميل</label><input id="client_phone" class="form-control" required></div>
                        <div class="col-md-4">
                            <label>صفة العميل</label>
                            <select id="client_role" class="form-select" required>
                                <option value="">اختر الصفة...</option>
                                <option>مدعي</option><option>مدعى عليه</option><option>مجني عليه</option><option>متهم</option>
                            </select>
                        </div>
                        <div class="col-md-4"><label>اسم الخصم</label><input id="opponent_name" class="form-control"></div>
                        <div class="col-md-4"><label>رقم القضية</label><input id="case_number" class="form-control" required></div>
                        <div class="col-md-4"><label>سنة القضية</label><input id="case_year" class="form-control" required></div>
                        <div class="col-md-6">
                            <label>المحكمة</label>
                            <select id="court_name" class="form-select" required>
                                <option value="">اختر المحكمة...</option>
                                <option>محكمة الأسرة</option><option>المحكمة الجزئية</option><option>المحكمة الابتدائية</option>
                                <option>محكمة الاستئناف</option><option>محكمة النقض</option>
                            </select>
                        </div>
                        <div class="col-md-6"><label>الدائرة</label><input id="circle" class="form-control"></div>
                        <div class="col-md-12"><label>موضوع القضية</label><textarea id="case_subject" class="form-control" rows="2"></textarea></div>
                    </div>
                    <button type="submit" class="btn btn-gold w-100 mt-4 py-3">حفظ بيانات الملف</button>
                </form>
            </div>

            <div class="tab-pane fade" id="sessions">
                <div class="form-section shadow">
                    <h5>تسجيل جلسة</h5>
                    <hr class="opacity-10">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label>بحث عن قضية</label>
                            <input id="s_search" class="form-control" placeholder="اكتب كود القضية أو اسم العميل..." onkeyup="searchCasesForSession(this.value)">
                            <div id="caseSearchResults" class="mt-2 shadow" style="max-height:150px;overflow-y:auto;display:none; background: #1e293b; border-radius: 8px;"></div>
                        </div>
                        <div class="col-md-6"><label>تاريخ الجلسة</label><input type="datetime-local" id="s_date" class="form-control"></div>
                        <div class="col-md-12"><label>القرار</label><textarea id="s_decision" class="form-control" rows="2"></textarea></div>
                    </div>
                    <button class="btn btn-gold w-100 mt-4" onclick="saveSession()">تثبيت موعد الجلسة</button>
                </div>
                <div id="upcomingSessions" class="mt-3"></div>
            </div>

            <div class="tab-pane fade" id="search">
                <div class="form-section shadow">
                    <h5>الأرشيف والبحث المتقدم</h5>
                    <hr class="opacity-10">
                    <div class="row g-2 mb-4">
                        <div class="col-md-9">
                            <input id="searchInput" class="form-control p-3" placeholder="مثال: 1234 (رقم قضية) أو محمود (اسم عميل) أو 010... (هاتف)">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-gold w-100 h-100" onclick="searchCases()">بحث عام</button>
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-5"><label>من تاريخ</label><input type="date" id="searchFrom" class="form-control"></div>
                        <div class="col-md-5"><label>إلى تاريخ</label><input type="date" id="searchTo" class="form-control"></div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-outline-warning w-100" onclick="searchByDateRange()">بحث تاريخي</button>
                        </div>
                    </div>
                </div>
                <div id="searchResults" class="mt-4"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // الإعدادات البرمجية
    const SB_URL="https://iyhfafodhptcdwrjywek.supabase.co";
    const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ";
    const db=supabase.createClient(SB_URL,SB_KEY);

    let currentCaseId = null;

    // الدخول
    function login(){
        if(document.getElementById('password').value === "mahmoud237"){
            loginPage.style.display="none"; 
            mainContent.style.display="block";
            today.innerText=new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            loadUpcoming();
        } else {
            Swal.fire("خطأ", "كلمة المرور غير صحيحة", "error");
        }
    }

    // حفظ قضية
    caseForm.onsubmit = async (e) => {
        e.preventDefault();
        Swal.fire({title: 'جاري الحفظ...', didOpen: () => Swal.showLoading()});
        const code = `MA-${Date.now().toString().slice(-6)}`;
        const { error } = await db.from('cases').insert([{
            client_name: client_name.value, client_phone: client_phone.value, 
            client_role: client_role.value, opponent_name: opponent_name.value, 
            case_number: case_number.value, case_year: case_year.value,
            court_name: court_name.value, circle: circle.value, case_code: code,
            case_subject: case_subject.value
        }]);
        Swal.close();
        if(error) Swal.fire("خطأ", error.message, "error");
        else { Swal.fire("تم الحفظ", `كود القضية: ${code}`, "success"); caseForm.reset(); }
    };

    // بحث سريع لاختيار قضية للجلسة
    async function searchCasesForSession(q) {
        if(q.length < 2) { caseSearchResults.style.display='none'; return; }
        const { data } = await db.from('cases').select('*').or(`client_name.ilike.%${q}%,case_code.ilike.%${q}%`).limit(5);
        if(data && data.length > 0) {
            caseSearchResults.innerHTML = data.map(c => `<div class="p-2 border-bottom text-white small" style="cursor:pointer" onclick="selectCase('${c.id}','${c.client_name}','${c.case_code}')">${c.client_name} (${c.case_code})</div>`).join('');
            caseSearchResults.style.display='block';
        }
    }

    function selectCase(id, name, code) {
        currentCaseId = id;
        s_search.value = name;
        caseSearchResults.style.display='none';
    }

    // حفظ جلسة
    async function saveSession() {
        if(!currentCaseId || !s_date.value) return Swal.fire("تنبيه", "اختر القضية والتاريخ", "warning");
        const { error } = await db.from('sessions').insert([{ case_id: currentCaseId, session_date: s_date.value, decision: s_decision.value }]);
        if(!error) { Swal.fire("تم", "تم تسجيل الجلسة", "success"); loadUpcoming(); }
    }

    // البحث التاريخي (تم الإصلاح)
    async function searchByDateRange() {
        const from = searchFrom.value;
        const to = searchTo.value;
        if(!from || !to) return Swal.fire("تنبيه", "حدد النطاق الزمني", "warning");
        
        Swal.fire({title: 'جاري البحث...', didOpen: () => Swal.showLoading()});
        const { data, error } = await db.from('sessions').select('*, cases(*)').gte('session_date', from).lte('session_date', to);
        Swal.close();

        if(data && data.length > 0) {
            searchResults.innerHTML = data.map(s => `
                <div class="session-card">
                    <div class="d-flex justify-content-between">
                        <b class="text-gold">${new Date(s.session_date).toLocaleDateString('ar-EG')}</b>
                        <span class="small">${s.cases.court_name}</span>
                    </div>
                    <div class="mt-2">العميل: ${s.cases.client_name}</div>
                    <div class="small text-white-50">القرار: ${s.decision || 'لا يوجد'}</div>
                </div>
            `).join('');
        } else {
            searchResults.innerHTML = '<div class="alert alert-dark text-center">لا توجد نتائج</div>';
        }
    }

    // البحث العام
    async function searchCases() {
        const val = searchInput.value;
        if(!val) return;
        const { data } = await db.from('cases').select('*').or(`client_name.ilike.%${val}%,case_number.ilike.%${val}%,client_phone.ilike.%${val}%,case_code.ilike.%${val}%`);
        if(data) {
            searchResults.innerHTML = data.map(c => `
                <div class="case-card">
                    <b class="case-code">${c.case_code}</b>
                    <div>${c.client_name} ضد ${c.opponent_name || '...'}</div>
                    <div class="small text-white-50">${c.court_name} - رقم ${c.case_number}</div>
                </div>
            `).join('');
        }
    }

    async function loadUpcoming() {
        const today = new Date().toISOString().split('T')[0];
        const { data } = await db.from('sessions').select('*, cases(*)').gte('session_date', today).order('session_date');
        if(data) {
            upcomingSessions.innerHTML = '<h6 class="text-gold mb-3">الجلسات القادمة:</h6>' + data.map(s => `
                <div class="session-card" style="border-right-color: #00ff64">
                    <div class="d-flex justify-content-between">
                        <b>${new Date(s.session_date).toLocaleDateString('ar-EG')}</b>
                        <small>${s.cases.court_name}</small>
                    </div>
                    <div>${s.cases.client_name}</div>
                </div>
            `).join('');
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
