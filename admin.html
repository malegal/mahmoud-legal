<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
:root{ --gold:#D4AF37; --black:#1A1A1A; --bg:#F8F5E6; }
body{background:var(--bg);font-family:Segoe UI}
.header{background:linear-gradient(135deg,#000,#333);color:var(--gold);padding:20px;border-bottom:4px solid var(--gold)}
.form-section{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border-right:5px solid var(--gold);box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
.btn-gold{background:var(--gold);border:none;font-weight:600;color:#fff}
.btn-gold:hover{background:#b8962e;color:#fff}
.session-card{background:#fff;border-right:4px solid var(--gold);padding:15px;margin-bottom:10px;border-radius:4px;}
.case-code{font-family:monospace;font-size:1.2rem;color:var(--gold);font-weight:bold}
.nav-tabs .nav-link.active {background-color: var(--gold); color: white; border-color: var(--gold);}
.nav-tabs .nav-link {color: var(--black);}
.detail-label { font-weight: bold; color: #555; font-size: 0.9rem; }
</style>
</head>
<body>

<div id="loginPage" class="container mt-5" style="max-width:400px">
    <div class="form-section text-center">
        <i class="bi bi-shield-lock-fill" style="font-size: 3rem; color: var(--gold);"></i>
        <h4 class="mt-3">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
        <input type="password" id="password" class="form-control my-3" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-gold w-100" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<div id="mainContent" style="display:none">
    <div class="header text-center">
        <h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§</h2>
        <p id="today"></p>
    </div>

    <div class="container mt-4">
        <ul class="nav nav-tabs mb-3" id="mainTabs">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cases">Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sessions">Ø§Ù„Ø¬Ù„Ø³Ø§Øª</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#search">Ø¨Ø­Ø« ÙˆØªÙ‚Ø§Ø±ÙŠØ±</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="cases">
                <form id="caseForm" class="form-section">
                    <h5>ØªØ³Ø¬ÙŠÙ„ Ù‚Ø¶ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h5><hr>
                    <div class="row g-3">
                        <div class="col-md-4"><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input id="client_name" class="form-control" required></div>
                        <div class="col-md-4"><label>Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input id="client_phone" class="form-control" required></div>
                        <div class="col-md-4"><label>ØµÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„</label><select id="client_role" class="form-select" required><option value="">Ø§Ø®ØªØ±...</option><option>Ù…Ø¯Ø¹ÙŠ</option><option>Ù…Ø¯Ø¹Ù‰ Ø¹Ù„ÙŠÙ‡</option></select></div>
                        <div class="col-md-4"><label>Ø§Ø³Ù… Ø§Ù„Ø®ØµÙ…</label><input id="opponent_name" class="form-control"></div>
                        <div class="col-md-4"><label>Ø±Ù‚Ù… Ø§Ù„Ù‚Ø¶ÙŠØ©</label><input id="case_number" class="form-control" required></div>
                        <div class="col-md-4"><label>Ø³Ù†Ø© Ø§Ù„Ù‚Ø¶ÙŠØ©</label><input id="case_year" class="form-control" required></div>
                        <div class="col-md-6"><label>Ø§Ù„Ù…Ø­ÙƒÙ…Ø©</label><input id="court_name" class="form-control" required></div>
                        <div class="col-md-12"><label>Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù‚Ø¶ÙŠØ©</label><textarea id="case_subject" class="form-control" rows="2"></textarea></div>
                    </div>
                    <button type="submit" class="btn btn-gold w-100 mt-3">Ø­ÙØ¸ Ø§Ù„Ù‚Ø¶ÙŠØ©</button>
                    <div id="caseCodeResult" class="mt-3 text-center"></div>
                </form>
            </div>

            <div class="tab-pane fade" id="sessions">
                <div class="form-section">
                    <h5>ØªØ³Ø¬ÙŠÙ„ Ø¬Ù„Ø³Ø©</h5><hr>
                    <div class="row g-3">
                        <div class="col-md-3"><label>Ø±Ù‚Ù… Ø§Ù„Ù‚Ø¶ÙŠØ©</label><input id="s_case_number" class="form-control" onchange="autoFillCase()"></div>
                        <div class="col-md-3"><label>Ø³Ù†Ø© Ø§Ù„Ù‚Ø¶ÙŠØ©</label><input id="s_case_year" class="form-control" onchange="autoFillCase()"></div>
                        <div class="col-md-6"><label>Ø§Ù„Ù…Ø­ÙƒÙ…Ø©</label><input id="s_court" class="form-control" readonly></div>
                        <div class="col-md-6"><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input id="s_client" class="form-control" readonly></div>
                        <div class="col-md-6"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø³Ø©</label><input type="date" id="s_date" class="form-control"></div>
                        <div class="col-md-12"><label>Ø§Ù„Ù‚Ø±Ø§Ø±</label><textarea id="s_decision" class="form-control"></textarea></div>
                    </div>
                    <button class="btn btn-gold w-100 mt-3" onclick="saveSession()">Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
                </div>
                <div class="form-section">
                    <h5>Ø¬Ù„Ø³Ø§Øª Ø§Ù„ÙØªØ±Ø©</h5>
                    <div class="row g-2 mb-3">
                        <div class="col-5"><input type="date" id="s_filter_from" class="form-control"></div>
                        <div class="col-5"><input type="date" id="s_filter_to" class="form-control"></div>
                        <div class="col-2"><button class="btn btn-dark w-100" onclick="loadUpcomingByRange()"><i class="bi bi-search"></i></button></div>
                    </div>
                    <div id="upcomingSessions"></div>
                </div>
            </div>

            <div class="tab-pane fade" id="search">
                <div class="form-section">
                    <h5>Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h5><hr>
                    <div class="row g-2 mb-3">
                        <div class="col-md-8"><input id="searchInput" class="form-control" placeholder="Ø±Ù‚Ù… Ù‚Ø¶ÙŠØ©ØŒ Ø¹Ù…ÙŠÙ„ØŒ Ù‡Ø§ØªÙØŒ ÙƒÙˆØ¯"></div>
                        <div class="col-md-4"><button class="btn btn-gold w-100" onclick="searchCases()">Ø¨Ø­Ø«</button></div>
                    </div>
                    <div class="p-3 border rounded bg-light">
                        <h6>ØªÙ‚Ø±ÙŠØ± Ø¨Ø§Ù„ÙØªØ±Ø© (Ù…Ù†/Ø¥Ù„Ù‰)</h6>
                        <div class="row g-2">
                            <div class="col-md-5"><input type="date" id="date_from" class="form-control"></div>
                            <div class="col-md-5"><input type="date" id="date_to" class="form-control"></div>
                            <div class="col-md-2"><button class="btn btn-dark w-100" onclick="filterByDateRange()">ÙÙ„ØªØ±Ø©</button></div>
                        </div>
                    </div>
                </div>
                <div id="searchResults"></div>
            </div>
        </div>
    </div>
</div>

<script>
const SB_URL="https://iyhfafodhptcdwrjywek.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ";
const db=supabase.createClient(SB_URL,SB_KEY);

let currentCaseId = null;

function login(){
    if(document.getElementById('password').value==="mahmoud237"){
        loginPage.style.display="none"; mainContent.style.display="block";
        today.innerText=new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    } else alert("Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
}

async function autoFillCase() {
    const num = document.getElementById('s_case_number').value;
    const year = document.getElementById('s_case_year').value;
    if(num && year) {
        const { data } = await db.from('cases').select('*').eq('case_number', num).eq('case_year', year).maybeSingle();
        if(data) {
            currentCaseId = data.id;
            document.getElementById('s_court').value = data.court_name;
            document.getElementById('s_client').value = data.client_name;
            document.getElementById('s_opponent').value = data.opponent_name;
        } else { currentCaseId = null; }
    }
}

caseForm.onsubmit=async e=>{
    e.preventDefault();
    const code=`MA-${Date.now().toString().slice(-6)}`;
    const { error } = await db.from('cases').insert([{
        client_name: document.getElementById('client_name').value,
        client_phone: document.getElementById('client_phone').value,
        client_role: document.getElementById('client_role').value,
        opponent_name: document.getElementById('opponent_name').value,
        case_number: document.getElementById('case_number').value,
        case_year: document.getElementById('case_year').value,
        court_name: document.getElementById('court_name').value,
        case_subject: document.getElementById('case_subject').value,
        case_code: code
    }]);
    if(!error) { Swal.fire("ØªÙ…", "ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¶ÙŠØ©: "+code, "success"); caseForm.reset(); }
};

async function saveSession(){
    if(!currentCaseId) return alert("Ø§Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¶ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹");
    const { error } = await db.from('sessions').insert([{
        case_id: currentCaseId,
        session_date: document.getElementById('s_date').value,
        decision: document.getElementById('s_decision').value
    }]);
    if(!error) Swal.fire("ØªÙ…", "ØªÙ… Ø§Ù„Ø­ÙØ¸", "success");
    else alert("Ø®Ø·Ø£: " + error.message);
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… (ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)
async function searchCases(){
    const t = document.getElementById('searchInput').value;
    if(!t) return;
    Swal.showLoading();
    
    // 1. Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ ÙÙ‚Ø· Ø£ÙˆÙ„Ø§Ù‹
    const { data: cases, error } = await db.from('cases').select('*')
        .or(`case_number.ilike.%${t}%,case_year.ilike.%${t}%,client_name.ilike.%${t}%,client_phone.ilike.%${t}%,case_code.ilike.%${t}%`);
    
    if(error || !cases) { Swal.close(); return alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«"); }
    
    let html = `<h6>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (${cases.length}):</h6>`;
    
    for(let c of cases) {
        // 2. Ø¬Ù„Ø¨ Ø¬Ù„Ø³Ø§Øª ÙƒÙ„ Ù‚Ø¶ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ Ø§Ù„Ø±Ø¨Ø·
        const { data: sess } = await db.from('sessions').select('*').eq('case_id', c.id).order('session_date');
        html += renderResultCard(c, sess);
    }
    
    searchResults.innerHTML = html;
    Swal.close();
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙØªØ±Ø© (ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§ ØªÙ…Ø§Ù…Ø§Ù‹)
async function filterByDateRange() {
    const from = document.getElementById('date_from').value;
    const to = document.getElementById('date_to').value;
    if(!from || !to) return;
    Swal.showLoading();
    
    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©
    const { data: sessions, error } = await db.from('sessions').select('*').gte('session_date', from).lte('session_date', to);
    
    if(error || !sessions) { Swal.close(); return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª"); }
    
    // 2. Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
    let html = `<h6>Ù‚Ø¶Ø§ÙŠØ§ Ù„Ù‡Ø§ Ø¬Ù„Ø³Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:</h6>`;
    const caseIds = [...new Set(sessions.map(s => s.case_id))];
    
    for(let id of caseIds) {
        const { data: c } = await db.from('cases').select('*').eq('id', id).single();
        const caseSessions = sessions.filter(s => s.case_id === id);
        if(c) html += renderResultCard(c, caseSessions);
    }
    
    searchResults.innerHTML = html;
    Swal.close();
}

function renderResultCard(c, sessions) {
    const sessHtml = sessions && sessions.length > 0 
        ? sessions.map(s => `<div class="small border-bottom py-1">ğŸ“… ${s.session_date}: ${s.decision || 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‚Ø±Ø§Ø±'}</div>`).join('')
        : '<div class="text-muted small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª</div>';

    return `
        <div class="form-section mb-3">
            <div class="d-flex justify-content-between"><b>${c.case_code}</b><span class="badge bg-gold text-dark">Ù‚Ø¶ÙŠØ©</span></div>
            <div class="row small mt-2">
                <div class="col-6"><b>Ø±Ù‚Ù…:</b> ${c.case_number}/${c.case_year}</div>
                <div class="col-6"><b>Ø§Ù„Ù…Ø­ÙƒÙ…Ø©:</b> ${c.court_name}</div>
                <div class="col-6"><b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${c.client_name}</div>
                <div class="col-6"><b>Ø§Ù„ØµÙØ©:</b> ${c.client_role}</div>
                <div class="col-12"><b>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</b> ${c.case_subject || '---'}</div>
            </div>
            <hr><h6>Ø³Ø¬Ù„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª:</h6>
            <div class="p-2 bg-light rounded">${sessHtml}</div>
        </div>`;
}

async function loadUpcomingByRange(){
    const from = document.getElementById('s_filter_from').value;
    const to = document.getElementById('s_filter_to').value;
    const { data } = await db.from('sessions').select('*, cases(client_name, case_number, case_year)').gte('session_date', from).lte('session_date', to);
    if(data) {
        upcomingSessions.innerHTML = data.map(s=>`
            <div class="session-card shadow-sm border mb-2 p-2">
                <b>${s.session_date}</b> | ${s.cases?.client_name} (Ù‚Ø¶ÙŠØ© ${s.cases?.case_number})
            </div>`).join('');
    }
}
</script>
</body>
</html>
