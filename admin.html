<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <title>نظام إدارة القضايا</title>  
    <meta name="viewport" content="width=device-width, initial-scale=1">  
    <meta name="theme-color" content="#D4AF37">  
      
    <!-- PWA Manifest -->  
    <link rel="manifest" id="app-manifest">  
      
    <!-- iOS Meta Tags -->  
    <meta name="apple-mobile-web-app-capable" content="yes">  
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">  
    <meta name="apple-mobile-web-app-title" content="إدارة القضايا">  
      
    <!-- Icons -->  
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>">  
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>">  
  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">  
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>  
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>  
  
    <style>  
    :root{ --gold:#D4AF37; --black:#1A1A1A; --bg:#F8F5E6; }  
    body{background:var(--bg);font-family:'Segoe UI', system-ui;}  
    .header{background:linear-gradient(135deg,#000,#333);color:var(--gold);padding:20px;border-bottom:4px solid var(--gold)}  
    .form-section{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border-right:5px solid var(--gold);box-shadow: 0 2px 5px rgba(0,0,0,0.1);}  
    .btn-gold{background:var(--gold);border:none;font-weight:600;color:#fff}  
    .btn-gold:hover{background:#b8962e;color:#fff}  
    .session-card{background:#fff;border-right:4px solid var(--gold);padding:15px;margin-bottom:10px;border-radius:4px;box-shadow: 0 1px 3px rgba(0,0,0,0.05);cursor:pointer;transition:transform 0.2s;}  
    .session-card:hover{transform:translateX(-5px);}  
    .case-card{background:#fff;border-radius:8px;padding:15px;margin-bottom:15px;box-shadow:0 3px 10px rgba(0,0,0,0.08);border-right:4px solid var(--gold);cursor:pointer;transition:all 0.3s;}  
    .case-card:hover{box-shadow:0 5px 15px rgba(0,0,0,0.1);}  
    .case-code{font-family:monospace;font-size:1.2rem;color:var(--gold);font-weight:bold}  
    .nav-tabs .nav-link.active {background-color: var(--gold); color: white; border-color: var(--gold);}  
    .nav-tabs .nav-link {color: var(--black);}  
    .auto-fill-badge { font-size: 0.7rem; background: #e9ecef; padding: 2px 8px; border-radius: 10px; color: #666; }  
    .print-btn{position:fixed;bottom:20px;left:20px;z-index:1000;}  
    .case-status{display:inline-block;padding:3px 10px;border-radius:20px;font-size:0.8rem;font-weight:bold;}  
    .status-new{background:#d4edda;color:#155724;}  
    .status-postponed{background:#fff3cd;color:#856404;}  
    .status-canceled{background:#f8d7da;color:#721c24;}  
    .status-suspended{background:#e2e3e5;color:#383d41;}  
    .status-reserved{background:#cce5ff;color:#004085;}  
    .status-judged{background:#d1ecf1;color:#0c5460;}  
    .admin-search-input { border-color: var(--gold); }  
    .admin-code-display { background: #f8f9fa; padding: 8px; border-radius: 5px; border-right: 3px solid var(--gold); }  
    </style>  
</head>  
  
<body>  
  
<div id="loginPage" class="container mt-5" style="max-width:400px">  
    <div class="form-section text-center">  
        <i class="bi bi-shield-lock-fill" style="font-size: 3rem; color: var(--gold);"></i>  
        <h4 class="mt-3">دخول النظام</h4>  
        <input type="password" id="password" class="form-control my-3" placeholder="كلمة المرور">  
        <button class="btn btn-gold w-100" onclick="login()">دخول</button>  
    </div>  
</div>  
  
<div id="mainContent" style="display:none">  
    <div class="header text-center">  
        <h2>نظام إدارة القضايا</h2>  
        <p id="today"></p>  
        <button class="btn btn-sm btn-outline-light" onclick="installPWA()" id="installBtn" style="display:none">  
            <i class="bi bi-download"></i> تثبيت التطبيق  
        </button>  
    </div>  
  
    <div class="container mt-4">  
        <ul class="nav nav-tabs mb-3" id="mainTabs">  
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cases">القضايا</button></li>  
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sessions">الجلسات</button></li>  
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#search">بحث وتقارير</button></li>  
        </ul>  
  
        <div class="tab-content">  
            <!-- تبويب القضايا -->  
            <div class="tab-pane fade show active" id="cases">  
                <form id="caseForm" class="form-section">  
                    <h5>تسجيل قضية جديدة</h5>  
                    <hr>  
                    <div class="row g-3">  
                        <div class="col-md-4">
                            <label>اسم العميل</label>
                            <input id="client_name" class="form-control" required>
                        </div>  
                        <div class="col-md-4">
                            <label>هاتف العميل</label>
                            <input id="client_phone" class="form-control" required>
                        </div>  
                        <div class="col-md-4">
                            <label>إيميل العميل</label>
                            <input type="email" id="client_email" class="form-control">
                        </div>  
                        <div class="col-md-4">  
                            <label>صفة العميل</label>  
                            <select id="client_role" class="form-select" required>  
                                <option value="">اختر الصفة...</option>  
                                <option>مدعي</option><option>مدعى عليه</option><option>مستأنف</option><option>مستأنف ضده</option><option>طاعن</option><option>مطعون ضده</option><option>مجني عليه</option><option>متهم</option>  
                            </select>  
                        </div>  
                        <div class="col-md-4">
                            <label>اسم الخصم</label>
                            <input id="opponent_name" class="form-control">
                        </div>  
                        <div class="col-md-4">
                            <label>رقم القضية</label>
                            <input id="case_number" class="form-control" required>
                        </div>  
                        <div class="col-md-4">
                            <label>سنة القضية</label>
                            <input id="case_year" class="form-control" required>
                        </div>  
                        <div class="col-md-6">  
                            <label>المحكمة</label>  
                            <select id="court_name" class="form-select" required>  
                                <option value="">اختر المحكمة...</option>  
                                <option>محكمة الأسرة</option>و<option>المحكمة الجزئية</option><option>المحكمة الابتدائية</option>  
                                <option>محكمة الاستئناف</option><option>المحكمة العمالية</option><option>المحكمة الاقتصادية</option><option>المحكمة الادارية</option><option>محكمة القضاء الاداري</option><option>المحكمة الادارية العليا</option><option>محكمة النقض</option>  
                            </select>  
                        </div>  
                        <div class="col-md-6">
                            <label>الدائرة</label>
                            <input id="circle" class="form-control">
                        </div>  
                        <div class="col-md-6">
                            <label>نوع القضية</label>
                            <select id="case_type" class="form-select" required>
                                <option value="">اختر نوع القضية...</option>
                                <option value="مدنية">مدنية</option>
                                <option value="جنائية">جنائية</option>
                                <option value="تجارية">تجارية</option>
                                <option value="عمالية">عمالية</option>
                                <option value="أحوال شخصية">أحوال شخصية</option>
                                <option value="إدارية">إدارية</option>
                                <option value="دستورية">دستورية</option>
                                <option value="ضريبية">ضريبية</option>
                            </select>
                        </div>  
                        <div class="col-md-12">
                            <label>موضوع القضية</label>
                            <textarea id="case_subject" class="form-control" rows="2"></textarea>
                        </div>  
                        <div class="col-md-12">
                            <label>ملاحظات</label>
                            <textarea id="notes" class="form-control" rows="3" placeholder="ملاحظات إضافية عن القضية..."></textarea>
                        </div>  
                    </div>  
                    <div class="d-flex gap-2 mt-3">  
                        <button type="submit" class="btn btn-gold flex-grow-1">حفظ القضية</button>  
                        <button type="button" class="btn btn-outline-secondary w-25" onclick="clearForm()">جديد</button>  
                    </div>  
                    <div id="caseCodeResult" class="mt-3 text-center"></div>  
                </form>  
            </div>  
  
            <!-- تبويب الجلسات -->  
            <div class="tab-pane fade" id="sessions">  
                <div class="form-section">  
                    <h5>تسجيل جلسة <span class="auto-fill-badge">الجلب تلقائي</span></h5>  
                    <hr>  
                    <div class="row g-3">  
                        <div class="col-md-12 mb-3">
                            <div class="admin-code-display">
                                <strong>تنسيق كود القضية:</strong> MA-26-001-H7G4D9
                                <small class="text-muted d-block">(001 هو الرقم الإداري)</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">  
                            <label>الرقم الإداري (مثل: 001)</label>  
                            <div class="input-group">  
                                <input id="admin_search" class="form-control admin-search-input" placeholder="أدخل الرقم الإداري (001)" onkeyup="searchByAdminNumber(this.value)">  
                                <button class="btn btn-gold" type="button" onclick="searchByAdminNumber(admin_search.value)">  
                                    <i class="bi bi-search"></i>  
                                </button>  
                            </div>  
                        </div>
                        
                        <div class="col-md-6">  
                            <label>بحث بالرقم أو الاسم</label>  
                            <div class="input-group">  
                                <input id="s_search" class="form-control" placeholder="رقم القضية أو اسم العميل" onkeyup="searchCasesForSession(this.value)">  
                                <button class="btn btn-outline-secondary" type="button" onclick="searchCasesForSession(s_search.value)">  
                                    <i class="bi bi-search"></i>  
                                </button>  
                            </div>  
                        </div>
                        
                        <div id="caseSearchResults" class="col-md-12 mt-2" style="max-height:200px;overflow-y:auto;display:none;"></div>  
                        
                        <div class="col-md-4">
                            <label>كود القضية الكامل</label>
                            <input id="s_case_code" class="form-control" readonly>
                        </div>
                        <div class="col-md-4">
                            <label>رقم القضية</label>
                            <input id="s_case_number" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>سنة القضية</label>
                            <input id="s_case_year" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>المحكمة</label>
                            <input id="s_court" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>اسم العميل</label>
                            <input id="s_client" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>هاتف العميل</label>
                            <input id="s_client_phone" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>إيميل العميل</label>
                            <input id="s_client_email" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>اسم الخصم</label>
                            <input id="s_opponent" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>صفة العميل</label>
                            <input id="s_client_role" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>نوع القضية</label>
                            <input id="s_case_type" class="form-control" readonly>
                        </div>  
                        <div class="col-md-6">
                            <label>تاريخ الجلسة</label>
                            <input type="datetime-local" id="s_date" class="form-control">
                        </div>  
                        <div class="col-md-6">
                            <label>حالة القضية</label>
                            <select id="s_case_status" class="form-select">
                                <option value="جديدة">جديدة</option>
                                <option value="مؤجلة">مؤجلة</option>
                                <option value="مشطوبة">مشطوبة</option>
                                <option value="موقوفة">موقوفة</option>
                                <option value="محجوزة للحكم">محجوزة للحكم</option>
                                <option value="محكوم فيها">محكوم فيها</option>
                            </select>
                        </div>  
                        <div class="col-md-12">
                            <label>القرار</label>
                            <textarea id="s_decision" class="form-control" rows="3"></textarea>
                        </div>  
                        <div class="col-md-12">
                            <label>ملاحظات القضية</label>
                            <textarea id="s_notes" class="form-control" rows="2" readonly></textarea>
                        </div>  
                    </div>  
                    <div class="d-flex gap-2 mt-3">  
                        <button class="btn btn-gold flex-grow-1" onclick="saveSession()">حفظ الجلسة</button>  
                        <button class="btn btn-outline-success" onclick="addToGoogleCalendar()" id="calendarBtn" disabled>  
                            <i class="bi bi-calendar-plus"></i> إضافة للتقويم  
                        </button>  
                    </div>  
                </div>  
  
                <div class="form-section">  
                    <h5>جلسات قادمة</h5>  
                    <div class="btn-group w-100 mb-3">  
                        <button type="button" class="btn btn-outline-secondary active" onclick="loadUpcoming('week', this)">الأسبوع الحالي</button>  
                        <button type="button" class="btn btn-outline-secondary" onclick="loadUpcoming('month', this)">الشهر الحالي</button>  
                        <button type="button" class="btn btn-outline-secondary" onclick="enableNotifications()">  
                            <i class="bi bi-bell"></i> تفعيل التنبيهات  
                        </button>  
                    </div>  
                    <div id="upcomingSessions"></div>  
                </div>  
            </div>  
  
            <!-- تبويب البحث والتقارير -->  
            <div class="tab-pane fade" id="search">  
                <div class="form-section">  
                    <h5>البحث المتقدم</h5>  
                    <hr>  
                    <div class="row g-2 mb-3">  
                        <div class="col-md-8"><input id="searchInput" class="form-control" placeholder="كود القضية، الرقم الإداري، اسم العميل، رقم الهاتف"></div>  
                        <div class="col-md-4"><button class="btn btn-gold w-100" onclick="searchCases()">بحث</button></div>  
                    </div>  
                    
                    <div class="row g-2 mb-3">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <strong>ملاحظة:</strong> للبحث بالرقم الإداري فقط، استخدم الزر المخصص للبحث بالرقم الإداري
                            </div>
                        </div>
                    </div>
                      
                    <div class="row g-3 mb-3">  
                        <div class="col-md-5"><label>من تاريخ</label><input type="date" id="searchFrom" class="form-control"></div>  
                        <div class="col-md-5"><label>إلى تاريخ</label><input type="date" id="searchTo" class="form-control"></div>  
                        <div class="col-md-2 d-flex align-items-end">  
                            <button class="btn btn-outline-dark w-100" onclick="searchByDateRange()">بحث بالتاريخ</button>  
                        </div>  
                    </div>  
                      
                    <div class="d-flex flex-wrap gap-2">  
                        <button class="btn btn-sm btn-outline-dark" onclick="filterSessions('week')">جلسات الأسبوع</button>  
                        <button class="btn btn-sm btn-outline-dark" onclick="filterSessions('month')">جلسات الشهر</button>  
                        <button class="btn btn-sm btn-outline-dark" onclick="searchByAdminNumberInSearch()">بحث بالرقم الإداري</button>  
                        <button class="btn btn-sm btn-outline-dark" onclick="searchByPhone()">بحث برقم الهاتف</button>  
                        <button class="btn btn-sm btn-outline-dark" onclick="exportToPDF()">تصدير PDF</button>  
                    </div>  
                </div>  
                <div id="searchResults"></div>  
            </div>  
        </div>  
    </div>  
</div>  
  
<!-- Modal لعرض تفاصيل القضية -->  
<div class="modal fade" id="caseModal" tabindex="-1">  
    <div class="modal-dialog modal-lg">  
        <div class="modal-content">  
            <div class="modal-header">  
                <h5 class="modal-title">تفاصيل القضية</h5>  
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>  
            </div>  
            <div class="modal-body" id="caseDetails">  
                <!-- سيتم تعبئته ديناميكياً -->  
            </div>  
            <div class="modal-footer">  
                <button class="btn btn-gold" onclick="printCasePDF()"><i class="bi bi-printer"></i> طباعة PDF</button>  
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>  
            </div>  
        </div>  
    </div>  
</div>  
  
<!-- Modal لتعديل القضية -->  
<div class="modal fade" id="editCaseModal" tabindex="-1">  
    <div class="modal-dialog modal-lg">  
        <div class="modal-content">  
            <div class="modal-header">  
                <h5 class="modal-title">تعديل القضية</h5>  
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>  
            </div>  
            <div class="modal-body">  
                <form id="editCaseForm">  
                    <div class="row g-3">  
                        <div class="col-md-4">
                            <label>اسم العميل</label>
                            <input id="edit_client_name" class="form-control" required>
                        </div>  
                        <div class="col-md-4">
                            <label>هاتف العميل</label>
                            <input id="edit_client_phone" class="form-control" required>
                        </div>  
                        <div class="col-md-4">
                            <label>إيميل العميل</label>
                            <input type="email" id="edit_client_email" class="form-control">
                        </div>  
                        <div class="col-md-4">  
                            <label>صفة العميل</label>  
                            <select id="edit_client_role" class="form-select" required>  
                                <option value="">اختر الصفة...</option>  
                                <option>مدعي</option><option>مدعى عليه</option><option>مجني عليه</option><option>متهم</option>  
                            </select>  
                        </div>  
                        <div class="col-md-4">
                            <label>اسم الخصم</label>
                            <input id="edit_opponent_name" class="form-control">
                        </div>  
                        <div class="col-md-4">
                            <label>رقم القضية</label>
                            <input id="edit_case_number" class="form-control" required>
                        </div>  
                        <div class="col-md-4">
                            <label>سنة القضية</label>
                            <input id="edit_case_year" class="form-control" required>
                        </div>  
                        <div class="col-md-6">  
                            <label>المحكمة</label>  
                            <select id="edit_court_name" class="form-select" required>  
                                <option value="">اختر المحكمة...</option>  
                                <option>محكمة الأسرة</option><option>المحكمة الجزئية</option><option>المحكمة الابتدائية</option>  
                                <option>محكمة الاستئناف</option><option>محكمة النقض</option>  
                            </select>  
                        </div>  
                        <div class="col-md-6">
                            <label>الدائرة</label>
                            <input id="edit_circle" class="form-control">
                        </div>  
                        <div class="col-md-6">
                            <label>نوع القضية</label>
                            <select id="edit_case_type" class="form-select" required>
                                <option value="">اختر نوع القضية...</option>
                                <option value="مدنية">مدنية</option>
                                <option value="جنائية">جنائية</option>
                                <option value="تجارية">تجارية</option>
                                <option value="عمالية">عمالية</option>
                                <option value="أحوال شخصية">أحوال شخصية</option>
                                <option value="إدارية">إدارية</option>
                                <option value="دستورية">دستورية</option>
                                <option value="ضريبية">ضريبية</option>
                            </select>
                        </div>  
                        <div class="col-md-12">
                            <label>موضوع القضية</label>
                            <textarea id="edit_case_subject" class="form-control" rows="2"></textarea>
                        </div>  
                        <div class="col-md-12">
                            <label>ملاحظات</label>
                            <textarea id="edit_notes" class="form-control" rows="3"></textarea>
                        </div>  
                    </div>  
                </form>  
            </div>  
            <div class="modal-footer">  
                <button class="btn btn-success" onclick="updateCase()">تحديث</button>  
                <button class="btn btn-danger" onclick="confirmDeleteCase()">حذف القضية</button>  
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>  
            </div>  
        </div>  
    </div>  
</div>  
  
<!-- Modal لتعديل الجلسة -->  
<div class="modal fade" id="editSessionModal" tabindex="-1">  
    <div class="modal-dialog">  
        <div class="modal-content">  
            <div class="modal-header">  
                <h5 class="modal-title">تعديل الجلسة</h5>  
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>  
            </div>  
            <div class="modal-body">  
                <form id="editSessionForm">  
                    <div class="mb-3">  
                        <label>تاريخ الجلسة</label>  
                        <input type="datetime-local" id="edit_session_date" class="form-control" required>  
                    </div>  
                    <div class="mb-3">  
                        <label>القرار</label>  
                        <textarea id="edit_decision" class="form-control" rows="3"></textarea>  
                    </div>  
                    <div class="mb-3">
                        <label>حالة القضية</label>
                        <select id="edit_session_case_status" class="form-select">
                            <option value="جديدة">جديدة</option>
                            <option value="مؤجلة">مؤجلة</option>
                            <option value="مشطوبة">مشطوبة</option>
                            <option value="موقوفة">موقوفة</option>
                            <option value="محجوزة للحكم">محجوزة للحكم</option>
                            <option value="محكوم فيها">محكوم فيها</option>
                        </select>
                    </div>  
                </form>  
            </div>  
            <div class="modal-footer">  
                <button class="btn btn-success" onclick="updateSession()">تحديث الجلسة</button>  
                <button class="btn btn-danger" onclick="confirmDeleteSession()">حذف الجلسة</button>  
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>  
            </div>  
        </div>  
    </div>  
</div>  
  
<script>  
const SB_URL="https://iyhfafodhptcdwrjywek.supabase.co";  
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ";  
const db=supabase.createClient(SB_URL,SB_KEY);  
  
let currentCaseId = null;  
let selectedCaseForCalendar = null;  
let deferredPrompt = null;  

// إلغاء تسجيل Service Workers لمنع مشاكل الاتصال
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
            registration.unregister();
        }
        console.log('تم إلغاء تسجيل Service Workers');
    });
}
  
// PWA Setup  
window.addEventListener('beforeinstallprompt', (e) => {  
    e.preventDefault();  
    deferredPrompt = e;  
    document.getElementById('installBtn').style.display = 'block';  
});  
  
function installPWA() {  
    if (deferredPrompt) {  
        deferredPrompt.prompt();  
        deferredPrompt.userChoice.then((choiceResult) => {  
            if (choiceResult.outcome === 'accepted') {  
                console.log('تم تثبيت التطبيق');  
            }  
            deferredPrompt = null;  
        });  
    }  
}  
  
// إنشاء Manifest ديناميكياً  
const manifest = {  
    "name": "نظام إدارة القضايا",  
    "short_name": "القضايا",  
    "description": "نظام إدارة القضايا للمحامين",  
    "start_url": ".",  
    "display": "standalone",  
    "background_color": "#F8F5E6",  
    "theme_color": "#D4AF37",  
    "icons": [  
        {  
            "src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>",  
            "sizes": "192x192",  
            "type": "image/svg+xml"  
        }  
    ]  
};  
  
document.getElementById('app-manifest').setAttribute('href',   
    'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifest))  
);  

// اختبار اتصال Supabase
async function testSupabaseConnection() {
    try {
        console.log('اختبار اتصال Supabase...');
        const { data, error } = await db
            .from('cases')
            .select('count', { count: 'exact', head: true });
        
        if (error) {
            console.error('خطأ في Supabase:', error);
            return false;
        }
        
        console.log('✅ اتصال Supabase ناجح!');
        return true;
    } catch (err) {
        console.error('❌ خطأ في الاتصال:', err);
        return false;
    }
}

// الدوال الأساسية  
function login(){  
    if(document.getElementById('password').value==="mahmoud237"){  
        loginPage.style.display="none";   
        mainContent.style.display="block";  
        today.innerText=new Date().toLocaleDateString('ar-EG', {   
            weekday: 'long',   
            year: 'numeric',   
            month: 'long',   
            day: 'numeric'   
        });  
        loadUpcoming('week');  
        requestNotificationPermission();  
        testSupabaseConnection();
    } else {  
        Swal.fire("خطأ","كلمة المرور غير صحيحة","error");  
    }  
}  
  
// دالة مسح النموذج  
function clearForm() {  
    caseForm.reset();  
    document.getElementById('caseCodeResult').innerHTML = '';  
    currentCaseId = null;  
}  

// دالة استخراج الرقم الإداري من كود القضية
function extractAdminNumber(caseCode) {
    if (!caseCode) return null;
    const parts = caseCode.split('-');
    if (parts.length >= 3) {
        return parts[2]; // الجزء الثالث هو الرقم الإداري (مثال: MA-26-001-H7G4D9 -> 001)
    }
    return null;
}
  
// البحث عن قضايا بالرقم الإداري  
async function searchByAdminNumber(query) {  
    if (!query || query.length < 1) {  
        document.getElementById('caseSearchResults').style.display = 'none';  
        return;  
    }  
  
    try {
        // البحث في كود القضية بالرقم الإداري (الجزء الثالث)
        const { data, error } = await db  
            .from('cases')  
            .select('*')  
            .like('case_code', `%-${query}-%`)  
            .limit(5);  
    
        if (error) {
            console.error('خطأ في البحث:', error);
            return;
        }
        
        if (data && data.length > 0) {  
            const resultsDiv = document.getElementById('caseSearchResults');  
            resultsDiv.innerHTML = data.map(caseItem => `  
                <div class="case-card p-2 mb-1" onclick="selectCaseForSession('${caseItem.id}')">  
                    <div class="d-flex justify-content-between">  
                        <strong class="case-code">${caseItem.case_code || 'بدون كود'}</strong>  
                        <small>${caseItem.court_name}</small>  
                    </div>  
                    <div>${caseItem.client_name} - ${caseItem.case_number}/${caseItem.case_year}</div>
                    <small class="text-muted">الرقم الإداري: ${extractAdminNumber(caseItem.case_code) || 'غير محدد'}</small>
                </div>  
            `).join('');  
            resultsDiv.style.display = 'block';  
        } else {  
            document.getElementById('caseSearchResults').innerHTML = '<div class="text-center p-2">لا توجد نتائج</div>';  
            document.getElementById('caseSearchResults').style.display = 'block';  
        }  
    } catch (err) {
        console.error('خطأ في البحث:', err);
        document.getElementById('caseSearchResults').innerHTML = '<div class="text-center p-2 text-danger">خطأ في الاتصال</div>';  
        document.getElementById('caseSearchResults').style.display = 'block';  
    }
}

// البحث عن قضايا بالرقم الإداري في تبويب البحث
async function searchByAdminNumberInSearch() {
    const { value: adminNumber } = await Swal.fire({
        title: 'البحث بالرقم الإداري',
        input: 'text',
        inputPlaceholder: 'أدخل الرقم الإداري (مثل: 001)',
        showCancelButton: true,
        confirmButtonText: 'بحث',
        cancelButtonText: 'إلغاء'
    });
    
    if (adminNumber) {
        searchInput.value = adminNumber;
        searchCasesByAdminNumber(adminNumber);
    }
}

async function searchCasesByAdminNumber(adminNumber) {
    Swal.fire({title: 'جاري البحث...', didOpen: () => Swal.showLoading()});
    
    try {
        // البحث في كود القضية بالرقم الإداري
        const { data, error } = await db
            .from('cases')
            .select('*')
            .like('case_code', `%-${adminNumber}-%`);
        
        Swal.close();
        if (error) {
            return Swal.fire("خطأ", "فشل البحث: " + error.message, "error");
        }
        
        // جلب الجلسات واخر حالة لكل قضية
        if (data && data.length > 0) {
            for (let caseItem of data) {
                const { data: sessions } = await db
                    .from('sessions')
                    .select('*')
                    .eq('case_id', caseItem.id)
                    .order('session_date', { ascending: false });
                caseItem.sessions = sessions || [];
                
                // الحصول على آخر حالة للقضية من آخر جلسة
                if (sessions && sessions.length > 0) {
                    caseItem.last_case_status = sessions[0].case_status;
                } else {
                    caseItem.last_case_status = 'جديدة';
                }
            }
        }
        
        renderSearchResults(data, "cases");
    } catch (err) {
        Swal.close();
        Swal.fire("خطأ", "حدث خطأ أثناء البحث: " + err.message, "error");
    }
}
  
// البحث عن قضايا لتسجيل الجلسة  
async function searchCasesForSession(query) {  
    if (!query || query.length < 2) {  
        document.getElementById('caseSearchResults').style.display = 'none';  
        return;  
    }  
  
    try {
        const { data, error } = await db  
            .from('cases')  
            .select('*')  
            .or(`case_number.ilike.%${query}%,client_name.ilike.%${query}%,case_code.ilike.%${query}%`)  
            .limit(5);  
    
        if (error) {
            console.error('خطأ في البحث:', error);
            return;
        }
        
        if (data && data.length > 0) {  
            const resultsDiv = document.getElementById('caseSearchResults');  
            resultsDiv.innerHTML = data.map(caseItem => `  
                <div class="case-card p-2 mb-1" onclick="selectCaseForSession('${caseItem.id}')">  
                    <div class="d-flex justify-content-between">  
                        <strong class="case-code">${caseItem.case_code || 'بدون كود'}</strong>  
                        <small>${caseItem.court_name}</small>  
                    </div>  
                    <div>${caseItem.client_name} - ${caseItem.case_number}/${caseItem.case_year}</div>
                    <small class="text-muted">الرقم الإداري: ${extractAdminNumber(caseItem.case_code) || 'غير محدد'}</small>
                </div>  
            `).join('');  
            resultsDiv.style.display = 'block';  
        } else {  
            document.getElementById('caseSearchResults').innerHTML = '<div class="text-center p-2">لا توجد نتائج</div>';  
            document.getElementById('caseSearchResults').style.display = 'block';  
        }  
    } catch (err) {
        console.error('خطأ في البحث:', err);
        document.getElementById('caseSearchResults').innerHTML = '<div class="text-center p-2 text-danger">خطأ في الاتصال</div>';  
        document.getElementById('caseSearchResults').style.display = 'block';  
    }
}  
  
async function selectCaseForSession(caseId) {  
    try {
        const { data, error } = await db  
            .from('cases')  
            .select('*')  
            .eq('id', caseId)  
            .single();  
    
        if (error) {
            Swal.fire("خطأ", "حدث خطأ في جلب بيانات القضية", "error");
            return;
        }
        
        if (data) {  
            currentCaseId = data.id;  
            selectedCaseForCalendar = data;  
              
            // تعبئة جميع بيانات القضية  
            document.getElementById('s_case_code').value = data.case_code || '';  
            document.getElementById('s_case_number').value = data.case_number;  
            document.getElementById('s_case_year').value = data.case_year;  
            document.getElementById('s_court').value = data.court_name;  
            document.getElementById('s_client').value = data.client_name;  
            document.getElementById('s_client_phone').value = data.client_phone;  
            document.getElementById('s_client_email').value = data.client_email || '';  
            document.getElementById('s_opponent').value = data.opponent_name || '';  
            document.getElementById('s_client_role').value = data.client_role;  
            document.getElementById('s_notes').value = data.notes || '';  
            document.getElementById('s_case_type').value = data.case_type || 'مدنية';  
            
            // الحصول على آخر حالة للقضية من الجلسات
            const { data: lastSession } = await db
                .from('sessions')
                .select('case_status')
                .eq('case_id', caseId)
                .order('session_date', { ascending: false })
                .limit(1);
            
            if (lastSession && lastSession.length > 0) {
                document.getElementById('s_case_status').value = lastSession[0].case_status || 'جديدة';
            } else {
                document.getElementById('s_case_status').value = 'جديدة';
            }
              
            document.getElementById('caseSearchResults').style.display = 'none';  
            
            // تعبئة حقول البحث
            if (data.case_code) {
                const adminNumber = extractAdminNumber(data.case_code);
                document.getElementById('admin_search').value = adminNumber || '';
            }
            document.getElementById('s_search').value = `${data.case_number}/${data.case_year}`;  
            
            document.getElementById('calendarBtn').disabled = false;  
              
            // تعيين التاريخ الافتراضي للجلسة (بعد 7 أيام من اليوم)  
            const nextWeek = new Date();  
            nextWeek.setDate(nextWeek.getDate() + 7);  
            const localDateTime = nextWeek.toISOString().slice(0, 16);  
            document.getElementById('s_date').value = localDateTime;  
        }  
    } catch (err) {
        console.error('خطأ في جلب القضية:', err);
        Swal.fire("خطأ", "حدث خطأ في جلب بيانات القضية", "error");
    }
}  
  
// حفظ القضية
caseForm.onsubmit = async e => {  
    e.preventDefault();  
    Swal.fire({ 
        title: 'جاري الحفظ...', 
        didOpen: () => Swal.showLoading(),
        allowOutsideClick: false 
    });  
    
    try {
        // تحقق من أن جميع الحقول المطلوبة مملوءة
        if (!client_name.value || !client_phone.value || !client_role.value || 
            !case_number.value || !case_year.value || !court_name.value || !case_type.value) {
            Swal.fire("خطأ", "يرجى ملء جميع الحقول المطلوبة", "error");
            return;
        }
        
        const caseData = {
            client_name: client_name.value,  
            client_phone: client_phone.value,  
            client_email: client_email.value,  
            client_role: client_role.value,  
            opponent_name: opponent_name.value,  
            case_number: case_number.value,  
            case_year: case_year.value,  
            court_name: court_name.value,  
            circle: circle.value,  
            case_type: case_type.value,
            case_subject: case_subject.value,  
            notes: notes.value
            // لا نرسل case_code، قاعدة البيانات ستنشئه تلقائياً
        };
        
        console.log('بيانات القضية المرسلة:', caseData);
        
        // إرسال البيانات
        const { data, error } = await db
            .from('cases')
            .insert([caseData])
            .select()
            .single();
        
        if (error) {
            console.error("تفاصيل الخطأ:", error);
            
            // محاولة بديلة إذا فشلت المحاولة الأولى
            if (error.code === '23505') { // كود مكرر
                Swal.fire("خطأ", "رقم القضية موجود مسبقاً", "error");
            } else {
                // محاولة مرة أخرى بدون .single()
                const { data: retryData, error: retryError } = await db
                    .from('cases')
                    .insert([caseData])
                    .select();
                
                if (retryError) {
                    Swal.fire("خطأ", retryError.message, "error");  
                } else if (retryData && retryData.length > 0) {
                    const savedCase = retryData[0];
                    showSuccessMessage(savedCase);
                }
            }
        } else if (data) {  
            showSuccessMessage(data);
        } else {
            Swal.fire("خطأ", "لم يتم حفظ القضية، يرجى المحاولة مرة أخرى", "error");
        }
    } catch (err) {
        console.error("خطأ غير متوقع:", err);
        Swal.fire("خطأ", "حدث خطأ غير متوقع أثناء الحفظ", "error");
    }
};

// دالة لعرض رسالة النجاح
function showSuccessMessage(savedCase) {
    const adminNumber = extractAdminNumber(savedCase.case_code);
    
    Swal.fire({  
        title: "تم الحفظ بنجاح",  
        html: `<div class="text-center">
                  <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                  <h4 class="mt-3">تم تسجيل القضية</h4>
                  <p class="case-code mt-2">${savedCase.case_code || `${savedCase.case_number}/${savedCase.case_year}`}</p>
                  ${adminNumber ? `<p><strong>الرقم الإداري:</strong> ${adminNumber}</p>` : ''}
                  <small class="text-muted">يمكنك الآن تسجيل جلسات للقضية</small>
               </div>`,  
        icon: "success",
        confirmButtonText: "تم"
    });  
    caseForm.reset();  
    
    let resultHtml = `
        <div class="alert alert-success">
            <strong>تم حفظ القضية بنجاح</strong>
            <div class="mt-2">
                <strong>كود القضية:</strong> ${savedCase.case_code || `${savedCase.case_number}/${savedCase.case_year}`}
            </div>
    `;
    
    if (adminNumber) {
        resultHtml += `<div><strong>الرقم الإداري:</strong> ${adminNumber}</div>`;
    }
    
    resultHtml += `</div>`;
    document.getElementById('caseCodeResult').innerHTML = resultHtml;
}
  
// حفظ الجلسة  
async function saveSession() {  
    if (!currentCaseId) return Swal.fire("تنبيه", "اختر قضية صحيحة أولاً", "warning");  
    if (!s_date.value) return Swal.fire("تنبيه", "أدخل تاريخ الجلسة", "warning");  
    
    Swal.fire({ title: 'جاري حفظ الجلسة...', didOpen: () => Swal.showLoading() });
    
    try {
        // حفظ الجلسة  
        const { data, error } = await db.from('sessions').insert([{  
            case_id: currentCaseId,  
            session_date: s_date.value,  
            decision: s_decision.value,  
            case_status: document.getElementById('s_case_status').value
        }]).select();  
        
        if (error) {
            console.error('خطأ في حفظ الجلسة:', error);
            
            // محاولة بديلة بدون select
            const { error: retryError } = await db.from('sessions').insert([{  
                case_id: currentCaseId,  
                session_date: s_date.value,  
                decision: s_decision.value,  
                case_status: document.getElementById('s_case_status').value
            }]);
            
            if (retryError) {
                Swal.fire("خطأ", retryError.message, "error");  
            } else {
                showSessionSuccess();
            }
        } else {  
            showSessionSuccess();
        }  
    } catch (err) {
        console.error('خطأ غير متوقع في حفظ الجلسة:', err);
        Swal.fire("خطأ", "حدث خطأ غير متوقع أثناء حفظ الجلسة: " + err.message, "error");
    }
}

function showSessionSuccess() {
    Swal.fire({
        title: "تم الحفظ بنجاح",
        text: "تم إضافة الجلسة إلى القضية",
        icon: "success",
        timer: 2000
    });  
    loadUpcoming('week');  
    
    // إزالة استدعاء sendNotification الذي يسبب المشكلة
    // sendNotification('تم تسجيل جلسة جديدة', 'تم إضافة جلسة جديدة إلى القضية');  
    
    // مسح الحقول
    document.getElementById('s_decision').value = '';
    document.getElementById('s_case_status').value = 'جديدة';
    
    // تعيين تاريخ جديد بعد 7 أيام
    const nextWeek = new Date();  
    nextWeek.setDate(nextWeek.getDate() + 7);  
    const localDateTime = nextWeek.toISOString().slice(0, 16);  
    document.getElementById('s_date').value = localDateTime;  
}
  
// إضافة إلى تقويم Google  
function addToGoogleCalendar() {  
    if (!selectedCaseForCalendar || !s_date.value) {  
        return Swal.fire("تنبيه", "املأ بيانات الجلسة أولاً", "warning");  
    }  
  
    // تحويل تاريخ الجلسة من الحقل مباشرة  
    const sessionDateTime = new Date(s_date.value);  
      
    // التحقق من صحة التاريخ  
    if (isNaN(sessionDateTime.getTime())) {  
        return Swal.fire("خطأ", "تاريخ الجلسة غير صالح", "error");  
    }  
      
    // إضافة ساعة واحدة للمدة  
    const endDateTime = new Date(sessionDateTime.getTime() + 60 * 60 * 1000);  
      
    const title = `جلسة قضية: ${selectedCaseForCalendar.client_name} ضد ${selectedCaseForCalendar.opponent_name || 'الخصم'}`;  
    const description = `  
القضية: ${selectedCaseForCalendar.case_number}/${selectedCaseForCalendar.case_year}  
كود القضية: ${selectedCaseForCalendar.case_code || 'بدون كود'}  
المحكمة: ${selectedCaseForCalendar.court_name}  
نوع القضية: ${selectedCaseForCalendar.case_type || 'مدنية'}  
القرار: ${s_decision.value || 'لم يتم تحديد قرار'}  
    `.trim();  
  
    // تحويل التواريخ إلى التنسيق المطلوب لـ Google Calendar (YYYYMMDDTHHMMSSZ)  
    const formatDateForGoogle = (date) => {  
        return date.toISOString()  
            .replace(/-/g, '')  
            .replace(/:/g, '')  
            .replace(/\..+/, '') + 'Z';  
    };  
  
    const startStr = formatDateForGoogle(sessionDateTime);  
    const endStr = formatDateForGoogle(endDateTime);  
  
    // إنشاء رابط تقويم Google مع التواريخ الصحيحة  
    const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&details=${encodeURIComponent(description)}&dates=${startStr}/${endStr}`;  
      
    // فتح الرابط في نافذة جديدة  
    window.open(calendarUrl, '_blank');  
      
    // إشعار للمستخدم  
    Swal.fire({  
        title: "تم إنشاء رابط التقويم",  
        text: "سيتم فتح نافذة جديدة لإضافة الجلسة إلى تقويم Google",  
        icon: "info",  
        timer: 3000,  
        showConfirmButton: false  
    });  
}  
  
// البحث بالتاريخ  
async function searchByDateRange() {  
    const from = document.getElementById('searchFrom').value;  
    const to = document.getElementById('searchTo').value;  
      
    if (!from || !to) {  
        return Swal.fire("تنبيه", "أدخل تاريخ البداية والنهاية", "warning");  
    }  
      
    Swal.fire({title: 'جاري البحث...', didOpen: () => Swal.showLoading()});  
      
    try {
        // البحث في الجلسات في النطاق الزمني  
        const { data: sessions, error } = await db  
            .from('sessions')  
            .select('*')  
            .gte('session_date', from)  
            .lte('session_date', to)  
            .order('session_date', { ascending: false });  
          
        if (error) {  
            Swal.close();  
            return Swal.fire("خطأ", "فشل البحث: " + error.message, "error");  
        }  
          
        // جلب بيانات القضايا لكل جلسة  
        if (sessions && sessions.length > 0) {  
            for (let session of sessions) {  
                const { data: caseData } = await db  
                    .from('cases')  
                    .select('*')  
                    .eq('id', session.case_id)  
                    .single();  
                session.cases = caseData || {};  
            }  
        }  
          
        Swal.close();  
        renderSearchResults(sessions, "sessions");  
    } catch (err) {
        Swal.close();
        Swal.fire("خطأ", "حدث خطأ أثناء البحث: " + err.message, "error");
    }
}  
  
// البحث العام  
async function searchCases(){  
    const t = searchInput.value;  
    if(!t.trim()) return Swal.fire("تنبيه","أدخل كلمة للبحث","warning");  
      
    Swal.fire({title: 'جاري البحث...', didOpen: () => Swal.showLoading()});  
      
    try {
        const { data, error } = await db  
            .from('cases')  
            .select('*')  
            .or(`case_number.ilike.%${t}%,client_name.ilike.%${t}%,client_phone.ilike.%${t}%,case_code.ilike.%${t}%,client_email.ilike.%${t}%`);  
          
        Swal.close();  
        if(error) {  
            return Swal.fire("خطأ", "فشل البحث: " + error.message, "error");  
        }  
          
        // جلب الجلسات واخر حالة لكل قضية  
        if(data && data.length > 0) {  
            for(let caseItem of data) {  
                const { data: sessions } = await db  
                    .from('sessions')  
                    .select('*')  
                    .eq('case_id', caseItem.id)  
                    .order('session_date', { ascending: false });  
                caseItem.sessions = sessions || [];  
                
                // الحصول على آخر حالة للقضية من آخر جلسة
                if (sessions && sessions.length > 0) {
                    caseItem.last_case_status = sessions[0].case_status;
                } else {
                    caseItem.last_case_status = 'جديدة';
                }
            }  
        }  
          
        renderSearchResults(data, "cases");  
    } catch (err) {
        Swal.close();
        Swal.fire("خطأ", "حدث خطأ أثناء البحث: " + err.message, "error");
    }
}  
  
async function searchByPhone(){  
    const { value: phone } = await Swal.fire({   
        title: 'البحث برقم الهاتف',   
        input: 'text',   
        inputPlaceholder: 'أدخل رقم الهاتف',  
        showCancelButton: true   
    });  
    if (phone) {   
        searchInput.value = phone;   
        searchCases();   
    }  
}  
  
// فلترة الجلسات  
async function filterSessions(range){  
    Swal.fire({title: 'جاري الجلب...', didOpen: () => Swal.showLoading()});  
      
    const today = new Date();  
    const startDate = today.toISOString().split('T')[0];  
      
    const endDate = new Date();  
    if(range === 'week') {  
        endDate.setDate(today.getDate() + 7);  
    } else {  
        endDate.setMonth(today.getMonth() + 1);  
    }  
      
    const endDateStr = endDate.toISOString().split('T')[0];  
      
    try {
        const { data, error } = await db  
            .from('sessions')  
            .select('*')  
            .gte('session_date', startDate)  
            .lte('session_date', endDateStr)  
            .order('session_date', { ascending: true });  
          
        Swal.close();  
        if(error) {  
            return Swal.fire("خطأ", "فشل جلب الجلسات: " + error.message, "error");  
        }  
          
        if(data && data.length > 0) {  
            for(let session of data) {  
                const { data: caseData } = await db  
                    .from('cases')  
                    .select('*')  
                    .eq('id', session.case_id)  
                    .single();  
                session.cases = caseData || {};  
            }  
        }  
          
        renderSearchResults(data, "sessions");  
    } catch (err) {
        Swal.close();
        Swal.fire("خطأ", "حدث خطأ أثناء جلب الجلسات: " + err.message, "error");
    }
}  
  
// عرض النتائج في بطاقات  
function renderSearchResults(data, type) {  
    if(!data || data.length === 0) {   
        searchResults.innerHTML = '<div class="alert alert-info text-center">لا توجد نتائج</div>';   
        return;   
    }  
      
    let html = `<h6 class="mb-3">نتائج البحث (${data.length}):</h6>`;  
      
    if(type === "sessions") {  
        data.forEach(item => {  
            const caseData = item.cases || {};  
            const sessionDate = new Date(item.session_date);  
            const formattedDate = sessionDate.toLocaleDateString('ar-EG', {  
                weekday: 'long',  
                year: 'numeric',  
                month: 'long',  
                day: 'numeric',  
                hour: '2-digit',  
                minute: '2-digit'  
            });  
              
            const statusClass = getStatusClass(item.case_status);  
              
            html += `  
            <div class="case-card">  
                <div class="d-flex justify-content-between align-items-start">  
                    <div onclick="openCaseDetails('${caseData.id}')" style="cursor:pointer; flex-grow:1;">  
                        <strong class="text-primary">${formattedDate}</strong>  
                        <div class="text-muted small">${caseData.court_name}</div>  
                    </div>  
                    <div class="d-flex align-items-center gap-2">  
                        <span class="case-status ${statusClass}">${item.case_status || 'جديدة'}</span>  
                        <div class="btn-group btn-group-sm">  
                            <button class="btn btn-outline-warning" onclick="loadSessionForEdit('${item.id}')">  
                                <i class="bi bi-pencil"></i>  
                            </button>  
                            <button class="btn btn-outline-danger" onclick="deleteSession('${item.id}')">  
                                <i class="bi bi-trash"></i>  
                            </button>  
                        </div>  
                    </div>  
                </div>  
                <div class="mt-2">  
                    <div><strong>كود القضية:</strong> ${caseData.case_code || 'بدون كود'}</div>
                    ${caseData.case_code ? `<div><strong>الرقم الإداري:</strong> ${extractAdminNumber(caseData.case_code) || 'غير محدد'}</div>` : ''}
                    <div><strong>العميل:</strong> ${caseData.client_name}</div>  
                    <div><strong>الخصم:</strong> ${caseData.opponent_name || 'غير محدد'}</div>  
                    <div><strong>القضية:</strong> ${caseData.case_number}/${caseData.case_year}</div>  
                    <div><strong>نوع القضية:</strong> ${caseData.case_type || 'مدنية'}</div>  
                </div>  
                ${item.decision ? `<div class="mt-2 p-2 bg-light small rounded"><b>القرار:</b> ${item.decision}</div>` : ''}  
            </div>`;  
        });  
    } else {  
        data.forEach(item => {  
            const statusClass = getStatusClass(item.last_case_status);  
            const adminNumber = extractAdminNumber(item.case_code);
              
            html += `  
            <div class="case-card">  
                <div class="d-flex justify-content-between align-items-start">  
                    <div onclick="openCaseDetails('${item.id}')" style="cursor:pointer; flex-grow:1;">  
                        <b class="case-code">${item.case_code || `${item.case_number}/${item.case_year}`}</b>  
                        <div class="text-muted small">${item.court_name}</div>  
                    </div>  
                    <div class="d-flex align-items-center gap-2">  
                        <span class="case-status ${statusClass}">${item.last_case_status || 'جديدة'}</span>  
                        <div class="btn-group btn-group-sm">  
                            <button class="btn btn-outline-warning" onclick="loadCaseForEdit('${item.id}')">  
                                <i class="bi bi-pencil"></i>  
                            </button>  
                            <button class="btn btn-outline-danger" onclick="confirmDeleteCaseFromSearch('${item.id}')">  
                                <i class="bi bi-trash"></i>  
                            </button>  
                        </div>  
                    </div>  
                </div>  
                <div class="mt-2">  
                    ${item.case_code ? `<div><strong>الرقم الإداري:</strong> ${adminNumber || 'غير محدد'}</div>` : ''}
                    <div><strong>العميل:</strong> ${item.client_name} (${item.client_phone})</div>  
                    <div><strong>الإيميل:</strong> ${item.client_email || 'غير محدد'}</div>  
                    <div><strong>الخصم:</strong> ${item.opponent_name || 'غير محدد'}</div>  
                    <div><strong>القضية:</strong> ${item.case_number}/${item.case_year}</div>  
                    <div><strong>نوع القضية:</strong> ${item.case_type || 'مدنية'}</div>  
                    ${item.case_subject ? `<div class="mt-1"><strong>الموضوع:</strong> ${item.case_subject}</div>` : ''}  
                </div>  
                <div class="mt-2 small border-top pt-2">  
                    <strong>آخر جلسة:</strong>  
                    ${item.sessions && item.sessions.length > 0   
                        ? item.sessions.slice(0, 2).map(s =>   
                            `<div class="text-muted">${new Date(s.session_date).toLocaleDateString('ar-EG')}: ${s.decision || 'لا يوجد قرار'}</div>`  
                        ).join('')  
                        : '<div class="text-muted">لا توجد جلسات مسجلة</div>'  
                    }  
                </div>  
            </div>`;  
        });  
    }  
    searchResults.innerHTML = html;  
}  
  
// دالة مساعدة للحصول على فئة الحالة  
function getStatusClass(status) {  
    const statusMap = {  
        'جديدة': 'status-new',  
        'مؤجلة': 'status-postponed',  
        'مشطوبة': 'status-canceled',  
        'موقوفة': 'status-suspended',  
        'محجوزة للحكم': 'status-reserved',  
        'محكوم فيها': 'status-judged'  
    };  
    return statusMap[status] || 'status-new';  
}  
  
// فتح تفاصيل القضية  
async function openCaseDetails(caseId) {  
    try {
        const { data: caseData, error } = await db  
            .from('cases')  
            .select('*')  
            .eq('id', caseId)  
            .single();  
          
        if (error || !caseData) {  
            return Swal.fire("خطأ", "لم يتم العثور على القضية", "error");  
        }  
          
        const { data: sessions } = await db  
            .from('sessions')  
            .select('*')  
            .eq('case_id', caseId)  
            .order('session_date', { ascending: false });  
          
        // الحصول على آخر حالة للقضية من آخر جلسة
        let lastCaseStatus = 'جديدة';
        if (sessions && sessions.length > 0) {
            lastCaseStatus = sessions[0].case_status || 'جديدة';
        }
        
        const statusClass = getStatusClass(lastCaseStatus);  
        const adminNumber = extractAdminNumber(caseData.case_code);
          
        let detailsHTML = `  
            <div class="case-details">  
                <div class="d-flex justify-content-between align-items-start mb-3">  
                    <div>  
                        <h4 class="case-code">${caseData.case_code || `${caseData.case_number}/${caseData.case_year}`}</h4>  
                        ${adminNumber ? `<p class="text-muted"><strong>الرقم الإداري:</strong> ${adminNumber}</p>` : ''}
                        <h5>${caseData.client_name} ضد ${caseData.opponent_name || 'غير محدد'}</h5>  
                    </div>  
                    <span class="case-status ${statusClass}">${lastCaseStatus}</span>  
                </div>  
                  
                <div class="row g-3">  
                    <div class="col-md-6">  
                        <strong>رقم القضية:</strong> ${caseData.case_number}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>سنة القضية:</strong> ${caseData.case_year}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>المحكمة:</strong> ${caseData.court_name}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>الدائرة:</strong> ${caseData.circle || 'غير محدد'}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>نوع القضية:</strong> ${caseData.case_type || 'مدنية'}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>صفة العميل:</strong> ${caseData.client_role}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>هاتف العميل:</strong> ${caseData.client_phone}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>إيميل العميل:</strong> ${caseData.client_email || 'غير محدد'}  
                    </div>  
                </div>  
                  
                ${caseData.case_subject ? `  
                <div class="mt-3">  
                    <strong>موضوع القضية:</strong>  
                    <p class="border p-2 rounded bg-light">${caseData.case_subject}</p>  
                </div>  
                ` : ''}  
                  
                ${caseData.notes ? `  
                <div class="mt-3">  
                    <strong>ملاحظات:</strong>  
                    <p class="border p-2 rounded bg-light">${caseData.notes}</p>  
                </div>  
                ` : ''}  
                  
                <div class="mt-4">  
                    <h6>الجلسات المسجلة (${sessions ? sessions.length : 0})</h6>  
                    <div class="sessions-list" style="max-height: 300px; overflow-y: auto;">  
        `;  
          
        if (sessions && sessions.length > 0) {  
            sessions.forEach(session => {  
                const sessionDate = new Date(session.session_date);  
                const formattedDate = sessionDate.toLocaleDateString('ar-EG', {  
                    weekday: 'long',  
                    year: 'numeric',  
                    month: 'long',  
                    day: 'numeric',  
                    hour: '2-digit',  
                    minute: '2-digit'  
                });  
                  
                const sessionStatusClass = getStatusClass(session.case_status);  
                  
                detailsHTML += `  
                    <div class="session-card mb-2">  
                        <div class="d-flex justify-content-between">  
                            <div>  
                                <strong>${formattedDate}</strong>  
                                <span class="case-status ${sessionStatusClass} ms-2">${session.case_status || 'جديدة'}</span>  
                            </div>  
                            <div class="btn-group btn-group-sm">  
                                <button class="btn btn-outline-warning" onclick="loadSessionForEdit('${session.id}')">  
                                    <i class="bi bi-pencil"></i>  
                                </button>  
                                <button class="btn btn-outline-danger" onclick="deleteSessionFromDetails('${session.id}', '${caseData.id}')">  
                                    <i class="bi bi-trash"></i>  
                                </button>  
                            </div>  
                        </div>  
                        ${session.decision ? `<div class="mt-1"><strong>القرار:</strong> ${session.decision}</div>` : ''}  
                    </div>  
                `;  
            });  
        } else {  
            detailsHTML += '<div class="alert alert-info">لا توجد جلسات مسجلة</div>';  
        }  
          
        detailsHTML += `  
                    </div>  
                </div>  
                <div class="mt-4 d-flex gap-2">  
                    <button class="btn btn-warning" onclick="loadCaseForEdit('${caseData.id}')">  
                        <i class="bi bi-pencil"></i> تعديل القضية  
                    </button>  
                    <button class="btn btn-danger" onclick="confirmDeleteCaseFromDetails('${caseData.id}')">  
                        <i class="bi bi-trash"></i> حذف القضية  
                    </button>  
                </div>  
            </div>  
        `;  
          
        document.getElementById('caseDetails').innerHTML = detailsHTML;  
          
        // تخزين بيانات القضية للطباعة  
        window.currentCaseForPrint = {  
            ...caseData,  
            sessions: sessions || [],
            case_status: lastCaseStatus  
        };  
          
        const caseModal = new bootstrap.Modal(document.getElementById('caseModal'));  
        caseModal.show();  
    } catch (err) {
        Swal.fire("خطأ", "حدث خطأ في جلب تفاصيل القضية", "error");
    }
}  
  
// تحميل القضية للتعديل  
async function loadCaseForEdit(caseId) {  
    try {
        const { data, error } = await db  
            .from('cases')  
            .select('*')  
            .eq('id', caseId)  
            .single();  
    
        if (error || !data) {  
            return Swal.fire("خطأ", "لم يتم العثور على القضية", "error");  
        }  
    
        // تعبئة الحقول  
        document.getElementById('edit_client_name').value = data.client_name;  
        document.getElementById('edit_client_phone').value = data.client_phone;  
        document.getElementById('edit_client_email').value = data.client_email || '';  
        document.getElementById('edit_client_role').value = data.client_role;  
        document.getElementById('edit_opponent_name').value = data.opponent_name || '';  
        document.getElementById('edit_case_number').value = data.case_number;  
        document.getElementById('edit_case_year').value = data.case_year;  
        document.getElementById('edit_court_name').value = data.court_name;  
        document.getElementById('edit_circle').value = data.circle || '';  
        document.getElementById('edit_case_type').value = data.case_type || 'مدنية';  
        document.getElementById('edit_case_subject').value = data.case_subject || '';  
        document.getElementById('edit_notes').value = data.notes || '';  
    
        // حفظ ID القضية للاستخدام لاحقاً  
        window.editingCaseId = caseId;  
    
        // عرض المودال  
        const editModal = new bootstrap.Modal(document.getElementById('editCaseModal'));  
        editModal.show();  
    } catch (err) {
        Swal.fire("خطأ", "حدث خطأ في تحميل القضية للتعديل", "error");
    }
}  
  
// تحديث القضية  
async function updateCase() {  
    if (!window.editingCaseId) return;  
  
    const updatedData = {  
        client_name: document.getElementById('edit_client_name').value,  
        client_phone: document.getElementById('edit_client_phone').value,  
        client_email: document.getElementById('edit_client_email').value,  
        client_role: document.getElementById('edit_client_role').value,  
        opponent_name: document.getElementById('edit_opponent_name').value,  
        case_number: document.getElementById('edit_case_number').value,  
        case_year: document.getElementById('edit_case_year').value,  
        court_name: document.getElementById('edit_court_name').value,  
        circle: document.getElementById('edit_circle').value,  
        case_type: document.getElementById('edit_case_type').value,  
        case_subject: document.getElementById('edit_case_subject').value,  
        notes: document.getElementById('edit_notes').value
    };  

    try {
        const { error } = await db  
            .from('cases')  
            .update(updatedData)  
            .eq('id', window.editingCaseId);  
    
        if (error) {  
            Swal.fire("خطأ", error.message, "error");  
        } else {  
            Swal.fire("تم", "تم تحديث القضية بنجاح", "success");  
            bootstrap.Modal.getInstance(document.getElementById('editCaseModal')).hide();  
              
            // إعادة تحميل البيانات إذا كان في نتائج البحث  
            if (searchInput.value) {  
                searchCases();  
            }  
        }  
    } catch (err) {
        Swal.fire("خطأ", "حدث خطأ أثناء تحديث القضية", "error");
    }
}  
  
// تأكيد حذف القضية  
function confirmDeleteCase() {  
    if (!window.editingCaseId) return;  
  
    Swal.fire({  
        title: 'هل أنت متأكد؟',  
        text: "سيتم حذف القضية وجميع جلساتها!",  
        icon: 'warning',  
        showCancelButton: true,  
        confirmButtonColor: '#d33',  
        cancelButtonColor: '#3085d6',  
        confirmButtonText: 'نعم، احذف',  
        cancelButtonText: 'إلغاء'  
    }).then(async (result) => {  
        if (result.isConfirmed) {  
            await deleteCase(window.editingCaseId);  
        }  
    });  
}  
  
// حذف القضية  
async function deleteCase(caseId) {  
    Swal.fire({ title: 'جاري الحذف...', didOpen: () => Swal.showLoading() });
    
    try {
        // حذف الجلسات أولاً  
        await db.from('sessions').delete().eq('case_id', caseId);  
          
        // حذف القضية  
        const { error } = await db.from('cases').delete().eq('id', caseId);  
          
        if (error) {  
            Swal.fire("خطأ", error.message, "error");  
        } else {  
            Swal.fire("تم", "تم حذف القضية بنجاح", "success");  
            bootstrap.Modal.getInstance(document.getElementById('editCaseModal')).hide();  
              
            // إعادة تحميل البيانات  
            if (searchInput.value) {  
                searchCases();  
            }  
        }  
    } catch (err) {
        Swal.fire("خطأ", "حدث خطأ أثناء حذف القضية", "error");
    }
}  
  
// تأكيد حذف القضية من تفاصيل القضية  
function confirmDeleteCaseFromDetails(caseId) {  
    Swal.fire({  
        title: 'هل أنت متأكد؟',  
        text: "سيتم حذف القضية وجميع جلساتها!",  
        icon: 'warning',  
        showCancelButton: true,  
        confirmButtonColor: '#d33',  
        cancelButtonColor: '#3085d6',  
        confirmButtonText: 'نعم، احذف',  
        cancelButtonText: 'إلغاء'  
    }).then(async (result) => {  
        if (result.isConfirmed) {  
            await deleteCase(caseId);  
            bootstrap.Modal.getInstance(document.getElementById('caseModal')).hide();  
        }  
    });  
}  
  
// تأكيد حذف القضية من نتائج البحث  
function confirmDeleteCaseFromSearch(caseId) {  
    Swal.fire({  
        title: 'هل أنت متأكد؟',  
        text: "سيتم حذف القضية وجميع جلساتها!",  
        icon: 'warning',  
        showCancelButton: true,  
        confirmButtonColor: '#d33',  
        cancelButtonColor: '#3085d6',  
        confirmButtonText: 'نعم، احذف',  
        cancelButtonText: 'إلغاء'  
    }).then(async (result) => {  
        if (result.isConfirmed) {  
            await deleteCase(caseId);  
            searchCases();  
        }  
    });  
}  
  
// تحميل الجلسة للتعديل  
async function loadSessionForEdit(sessionId) {  
    try {
        const { data, error } = await db  
            .from('sessions')  
            .select('*')  
            .eq('id', sessionId)  
            .single();  
    
        if (error || !data) {  
            return Swal.fire("خطأ", "لم يتم العثور على الجلسة", "error");  
        }  
    
        // تعبئة الحقول  
        const sessionDate = new Date(data.session_date);  
        const localDateTime = sessionDate.toISOString().slice(0, 16);  
        document.getElementById('edit_session_date').value = localDateTime;  
        document.getElementById('edit_decision').value = data.decision || '';  
        document.getElementById('edit_session_case_status').value = data.case_status || 'جديدة';  
    
        // حفظ ID الجلسة للاستخدام لاحقاً  
        window.editingSessionId = sessionId;  
    
        // عرض المودال  
        const editModal = new bootstrap.Modal(document.getElementById('editSessionModal'));  
        editModal.show();  
    } catch (err) {
        Swal.fire("خطأ", "حدث خطأ في تحميل الجلسة للتعديل", "error");
    }
}  
  
// تحديث الجلسة  
async function updateSession() {  
    if (!window.editingSessionId) return;  
  
    const updatedData = {  
        session_date: document.getElementById('edit_session_date').value,  
        decision: document.getElementById('edit_decision').value,  
        case_status: document.getElementById('edit_session_case_status').value
    };  
    
    console.log('بيانات تحديث الجلسة:', updatedData);
    
    try {
        const { error } = await db  
            .from('sessions')  
            .update(updatedData)  
            .eq('id', window.editingSessionId);  
    
        if (error) {  
            console.error('خطأ في تحديث الجلسة:', error);
            Swal.fire("خطأ", error.message, "error");  
        } else {  
            Swal.fire("تم", "تم تحديث الجلسة بنجاح", "success");  
            bootstrap.Modal.getInstance(document.getElementById('editSessionModal')).hide();  
              
            // إعادة تحميل الجلسات القادمة  
            loadUpcoming('week');  
        }  
    } catch (err) {
        console.error('خطأ غير متوقع في تحديث الجلسة:', err);
        Swal.fire("خطأ", "حدث خطأ أثناء تحديث الجلسة: " + err.message, "error");
    }
}  
  
// تأكيد حذف الجلسة  
function confirmDeleteSession() {  
    if (!window.editingSessionId) return;  
  
    Swal.fire({  
        title: 'هل أنت متأكد؟',  
        text: "سيتم حذف الجلسة!",  
        icon: 'warning',  
        showCancelButton: true,  
        confirmButtonColor: '#d33',  
        cancelButtonColor: '#3085d6',  
        confirmButtonText: 'نعم، احذف',  
        cancelButtonText: 'إلغاء'  
    }).then(async (result) => {  
        if (result.isConfirmed) {  
            await deleteSession(window.editingSessionId);  
        }  
    });  
}  
  
// حذف الجلسة  
async function deleteSession(sessionId) {  
    try {
        const { error } = await db  
            .from('sessions')  
            .delete()  
            .eq('id', sessionId);  
    
        if (error) {  
            Swal.fire("خطأ", error.message, "error");  
        } else {  
            Swal.fire("تم", "تم حذف الجلسة بنجاح", "success");  
            bootstrap.Modal.getInstance(document.getElementById('editSessionModal')).hide();  
              
            // إعادة تحميل الجلسات القادمة  
            loadUpcoming('week');  
        }  
    } catch (err) {
        Swal.fire("خطأ", "حدث خطأ أثناء حذف الجلسة", "error");
    }
}  
  
// حذف الجلسة من تفاصيل القضية  
function deleteSessionFromDetails(sessionId, caseId) {  
    Swal.fire({  
        title: 'هل أنت متأكد؟',  
        text: "سيتم حذف الجلسة!",  
        icon: 'warning',  
        showCancelButton: true,  
        confirmButtonColor: '#d33',  
        cancelButtonColor: '#3085d6',  
        confirmButtonText: 'نعم، احذف',  
        cancelButtonText: 'إلغاء'  
    }).then(async (result) => {  
        if (result.isConfirmed) {  
            await deleteSession(sessionId);  
            // إعادة فتح تفاصيل القضية لتحديث البيانات  
            openCaseDetails(caseId);  
        }  
    });  
}  
  
// طباعة PDF  
async function printCasePDF() {  
    if (!window.currentCaseForPrint) return;  
      
    const { jsPDF } = window.jspdf;  
    const doc = new jsPDF();  
      
    const caseData = window.currentCaseForPrint;  
      
    // إعداد النص العربي  
    doc.setFont('Times', 'normal');  
      
    // العنوان  
    doc.setFontSize(20);  
    doc.text('نظام إدارة القضايا', 105, 15, { align: 'center' });  
    doc.setFontSize(16);  
    doc.text('تفاصيل القضية', 105, 25, { align: 'center' });  
      
    doc.setFontSize(12);  
    let y = 40;  
      
    // معلومات القضية  
    doc.text(`كود القضية: ${caseData.case_code || `${caseData.case_number}/${caseData.case_year}`}`, 20, y);  
    y += 10;  
    doc.text(`رقم القضية: ${caseData.case_number}/${caseData.case_year}`, 20, y);  
    y += 10;  
    doc.text(`المحكمة: ${caseData.court_name}`, 20, y);  
    y += 10;  
    doc.text(`الدائرة: ${caseData.circle || 'غير محدد'}`, 20, y);  
    y += 10;  
    doc.text(`نوع القضية: ${caseData.case_type || 'مدنية'}`, 20, y);  
    y += 10;  
    doc.text(`حالة القضية: ${caseData.case_status || 'جديدة'}`, 20, y);  
    y += 15;  
      
    // معلومات الأطراف  
    doc.text('معلومات الأطراف:', 20, y);  
    y += 10;  
    doc.text(`العميل: ${caseData.client_name}`, 30, y);  
    y += 10;  
    doc.text(`صفة العميل: ${caseData.client_role}`, 30, y);  
    y += 10;  
    doc.text(`هاتف العميل: ${caseData.client_phone}`, 30, y);  
    y += 10;  
    doc.text(`إيميل العميل: ${caseData.client_email || 'غير محدد'}`, 30, y);  
    y += 10;  
    doc.text(`الخصم: ${caseData.opponent_name || 'غير محدد'}`, 30, y);  
    y += 15;  
      
    // موضوع القضية  
    if (caseData.case_subject) {  
        doc.text('موضوع القضية:', 20, y);  
        y += 10;  
        const splitSubject = doc.splitTextToSize(caseData.case_subject, 170);  
        doc.text(splitSubject, 30, y);  
        y += splitSubject.length * 7;  
    }  
      
    // ملاحظات  
    if (caseData.notes) {  
        doc.text('ملاحظات:', 20, y);  
        y += 10;  
        const splitNotes = doc.splitTextToSize(caseData.notes, 170);  
        doc.text(splitNotes, 30, y);  
        y += splitNotes.length * 7;  
    }  
      
    // الجلسات  
    if (caseData.sessions && caseData.sessions.length > 0) {  
        doc.text('سجل الجلسات:', 20, y);  
        y += 10;  
          
        caseData.sessions.forEach((session, index) => {  
            if (y > 250) {  
                doc.addPage();  
                y = 20;  
            }  
              
            const sessionDate = new Date(session.session_date);  
            const dateStr = sessionDate.toLocaleDateString('ar-EG');  
              
            doc.text(`${index + 1}. تاريخ الجلسة: ${dateStr}`, 30, y);  
            y += 10;  
            doc.text(`   حالة القضية: ${session.case_status || 'جديدة'}`, 30, y);  
            y += 10;  
              
            if (session.decision) {  
                const splitDecision = doc.splitTextToSize(`القرار: ${session.decision}`, 160);  
                doc.text(splitDecision, 40, y);  
                y += splitDecision.length * 7;  
            }  
            y += 5;  
        });  
    }  
      
    // توقيع و تاريخ الطباعة  
    doc.text(`تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG')}`, 20, 280);  
      
    // حفظ الملف  
    doc.save(`قضية_${caseData.case_code || caseData.case_number || 'غير_مسمى'}.pdf`);  
}  
  
// تصدير جميع النتائج إلى PDF  
async function exportToPDF() {  
    const { jsPDF } = window.jspdf;  
    const doc = new jsPDF();  
      
    doc.setFont('Times', 'normal');  
    doc.setFontSize(20);  
    doc.text('تقرير القضايا', 105, 15, { align: 'center' });  
      
    doc.setFontSize(12);  
    doc.text(`تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG')}`, 20, 30);  
      
    // يمكن تطوير هذه الدالة أكثر حسب الحاجة  
    doc.text('لتطوير هذه الخاصية أكثر، يرجى التواصل مع المطور.', 105, 150, { align: 'center' });  
      
    doc.save('تقرير_القضايا.pdf');  
}  
  
// تحميل الجلسات القادمة  
async function loadUpcoming(range, btn){  
    if(btn) {   
        document.querySelectorAll('#sessions .btn-group .btn').forEach(b=>b.classList.remove('active'));   
        btn.classList.add('active');   
    }  
      
    const today = new Date();  
    const startDate = today.toISOString().split('T')[0];  
      
    const endDate = new Date();  
    if(range === 'week') {  
        endDate.setDate(today.getDate() + 7);  
    } else {  
        endDate.setMonth(today.getMonth() + 1);  
    }  
      
    const endDateStr = endDate.toISOString().split('T')[0];  
    
    try {
        // نستخدم استعلام منفصل لجلب البيانات
        // أولاً: جلب الجلسات في النطاق الزمني
        const { data: sessions, error: sessionsError } = await db  
            .from('sessions')  
            .select('*')  
            .gte('session_date', startDate)  
            .lte('session_date', endDateStr)  
            .order('session_date', { ascending: true });  
          
        if(sessionsError) {   
            upcomingSessions.innerHTML = "<div class='alert alert-danger'>خطأ في التحميل: " + sessionsError.message + "</div>";   
            return;   
        }  
          
        if(!sessions || sessions.length === 0) {  
            upcomingSessions.innerHTML = "<p class='text-center text-muted'>لا توجد جلسات قادمة</p>";  
            return;  
        }  
        
        // ثانياً: جلب بيانات القضايا لكل جلسة
        const sessionsWithCases = [];
        
        for(let session of sessions) {
            const { data: caseData, error: caseError } = await db
                .from('cases')
                .select('*')
                .eq('id', session.case_id)
                .single();
            
            if (!caseError && caseData) {
                sessionsWithCases.push({
                    ...session,
                    cases: caseData
                });
            } else {
                sessionsWithCases.push({
                    ...session,
                    cases: {}
                });
            }
        }
          
        upcomingSessions.innerHTML = sessionsWithCases.map(s => {  
            const caseData = s.cases || {};  
            const sessionDate = new Date(s.session_date);  
            const formattedDate = sessionDate.toLocaleDateString('ar-EG', {  
                weekday: 'long',  
                year: 'numeric',  
                month: 'long',  
                day: 'numeric',  
                hour: '2-digit',  
                minute: '2-digit'  
            });  
              
            const statusClass = getStatusClass(s.case_status);  
            const adminNumber = extractAdminNumber(caseData.case_code);
              
            return `  
            <div class="session-card">  
                <div class="d-flex justify-content-between">  
                    <div>  
                        <b>${formattedDate}</b>  
                        <span class="case-status ${statusClass} ms-2">${s.case_status || 'جديدة'}</span>  
                    </div>  
                    <div class="btn-group btn-group-sm">  
                        <button class="btn btn-outline-warning" onclick="loadSessionForEdit('${s.id}')">  
                            <i class="bi bi-pencil"></i>  
                        </button>  
                        <button class="btn btn-outline-danger" onclick="deleteSession('${s.id}')">  
                            <i class="bi bi-trash"></i>  
                        </button>  
                    </div>  
                </div>  
                <div>  
                    ${caseData.client_name || 'غير معروف'} -   
                    قضية ${caseData.case_number || 'غير محدد'}/${caseData.case_year || 'غير محدد'}  
                </div>  
                <div><small>كود القضية: ${caseData.case_code || `${caseData.case_number}/${caseData.case_year}`}</small></div>  
                ${adminNumber ? `<div><small>الرقم الإداري: ${adminNumber}</small></div>` : ''}
                ${caseData.opponent_name ? `<div><small>ضد: ${caseData.opponent_name}</small></div>` : ''}  
                <div class="mt-2 d-flex gap-2">  
                    <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); addToGoogleCalendarFromSession('${s.id}')">  
                        <i class="bi bi-calendar-plus"></i>  
                    </button>  
                    <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); setReminder('${s.id}')">  
                        <i class="bi bi-bell"></i>  
                    </button>  
                </div>  
            </div>`;  
        }).join('');  
    } catch (err) {
        console.error('خطأ في تحميل الجلسات القادمة:', err);
        upcomingSessions.innerHTML = "<div class='alert alert-danger'>خطأ في تحميل الجلسات القادمة</div>";
    }
}  
  
// الإشعارات - نسخة معدلة لا تسبب أخطاء
function requestNotificationPermission() {  
    if ("Notification" in window && Notification.permission === "default") {  
        Notification.requestPermission().then(permission => {  
            if (permission === "granted") {  
                console.log("تم تفعيل الإشعارات");  
            }  
        });  
    }  
}  
  
function sendNotification(title, body) {  
    try {
        // تحقق من أن المتصفح يدعم الإشعارات
        if (!("Notification" in window)) {
            console.log("هذا المتصفح لا يدعم الإشعارات");
            return;
        }
        
        // تحقق من صلاحية إنشاء إشعار
        if (Notification.permission === "granted") {
            // استخدم ServiceWorkerRegistration إذا كان متاحاً
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.ready.then(function(registration) {
                    registration.showNotification(title, {
                        body: body,
                        icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>'
                    });
                });
            } else {
                // استخدم Notification العادي
                new Notification(title, {   
                    body: body,  
                    icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>'  
                });
            }
        }
    } catch (err) {
        console.log('خطأ في إرسال الإشعار:', err);
        // لا تظهر خطأ للمستخدم
    }
}  
  
function enableNotifications() {  
    if ("Notification" in window) {  
        Notification.requestPermission().then(permission => {  
            if (permission === "granted") {  
                Swal.fire("تم", "تم تفعيل الإشعارات بنجاح", "success");  
                // إشعار اختباري آمن
                try {
                    sendNotification('نظام القضايا', 'تم تفعيل الإشعارات بنجاح');
                } catch (err) {
                    console.log('تعذر إرسال الإشعار الاختباري:', err);
                }
            } else {  
                Swal.fire("تم", "يمكنك تفعيل الإشعارات لاحقاً من إعدادات المتصفح", "info");  
            }  
        });  
    } else {  
        Swal.fire("عذراً", "المتصفح لا يدعم الإشعارات", "warning");  
    }  
}  
  
// وظائف مساعدة للجلسات  
async function addToGoogleCalendarFromSession(sessionId) {  
    // يمكن تطوير هذه الدالة لإضافة جلسة محددة للتقويم  
    Swal.fire("معلومة", "سيتم تطوير هذه الخاصية في التحديث القادم", "info");  
}  
  
function setReminder(sessionId) {  
    Swal.fire("معلومة", "سيتم تطوير خاصية التذكير في التحديث القادم", "info");  
}  
  
// تهيئة التاريخ الافتراضي في حقل الجلسة  
document.addEventListener('DOMContentLoaded', function() {  
    const now = new Date();  
    const nextWeek = new Date();  
    nextWeek.setDate(now.getDate() + 7);  
    const localDateTime = nextWeek.toISOString().slice(0, 16);  
    document.getElementById('s_date').value = localDateTime;  
    
    // اختبار اتصال Supabase عند تحميل الصفحة
    testSupabaseConnection();
});  
</script>  
  
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>  
</body>  
</html>
