<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام إدارة القضايا | محمود عبد الحميد للمحاماة</title>
    <meta name="theme-color" content="#bf953f">
    
    <!-- تحسين PWA -->
    <meta name="description" content="نظام إدارة قضايا المكتب - محمود عبد الحميد للمحاماة">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <link rel="manifest" href="data:application/manifest+json,{
        &quot;name&quot;: &quot;نظام إدارة القضايا&quot;,
        &quot;short_name&quot;: &quot;القضايا&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#020617&quot;,
        &quot;theme_color&quot;: &quot;#bf953f&quot;,
        &quot;orientation&quot;: &quot;portrait-primary&quot;,
        &quot;icons&quot;: [
            {
                &quot;src&quot;: &quot;https://cdn-icons-png.flaticon.com/512/1048/1048953.png&quot;,
                &quot;sizes&quot;: &quot;512x512&quot;,
                &quot;type&quot;: &quot;image/png&quot;,
                &quot;purpose&quot;: &quot;any maskable&quot;
            }
        ]
    }">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700;900&family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* ────────────────────────────────────────────── */
        /* لم يتم تعديل أي جزء من الـ CSS الأصلي          */
        /* ────────────────────────────────────────────── */

        :root {
            --primary-dark: #020617;
            --gold-gradient: linear-gradient(135deg, #bf953f 0%, #fcf6ba 45%, #b38728 50%, #fbf5b7 55%, #aa771c 100%);
            --gold-solid: #bf953f;
            --gold-glow: rgba(191, 149, 63, 0.5);
            --header-height: 70px;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--primary-dark);
            color: #f8fafc;
            padding-top: var(--header-height);
            -webkit-tap-highlight-color: transparent;
        }

        /* ... باقي الـ CSS كما هو تماماً ... */
        
        /* إضافة بسيطة لتحسين الشعور بالنقر على البطاقات */
        .case-card, .session-card, .security-log-card {
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .case-card:active, .session-card:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }
    </style>
</head>
<body>

<!-- باقي محتوى الـ body كما هو تماماً -->

<div class="admin-toolbar">
    <div class="d-flex align-items-center gap-2">
        <i class="bi bi-shield-check text-warning fs-5"></i>
        <h1 class="gold-text fs-5 fw-bold mb-0">نظام إدارة القضايا | محمود عبد الحميد المحامي</h1>
    </div>
    <button class="gold-btn btn btn-sm px-3" onclick="installPWA()" id="installBtn" style="display:none">تثبيت التطبيق</button>
</div>

<!-- ... باقي الـ HTML كما هو ... -->

<div id="searchResults" class="mt-4"></div>

<!-- باقي المودالز والسكريبت كما هو -->

<script>
// ──────────────────────────────────────────────
// باقي المتغيرات والدوال كما هي
// ──────────────────────────────────────────────

let deferredPrompt = null;

// ──────────────────────────────────────────────
// تحسين دالة عرض نتائج البحث (النقطة الأولى)
// ──────────────────────────────────────────────
function renderSearchResults(data, type) {  
    const container = document.getElementById('searchResults');
    if(!data || data.length === 0) { 
        container.innerHTML = '<div class="alert alert-info text-center">لا توجد نتائج</div>'; 
        return; 
    }
    
    let html = `<h6 class="mb-3 gold-text">نتائج البحث (${data.length}):</h6>`;  

    data.forEach(item => {
        if(type === "sessions") {
            const c = item.cases || {};
            html += `
                <div class="session-card mb-3" 
                     onclick="openCaseDetails('${c.id}')"
                     role="button"
                     tabindex="0">
                    <div class="d-flex justify-content-between">
                        <strong class="gold-text">${new Date(item.session_date).toLocaleString('ar-EG')}</strong>
                        <span class="case-status \( {getStatusClass(item.case_status)}"> \){item.case_status}</span>
                    </div>
                    <div class="mt-2">
                        <div><b>العميل:</b> ${c.client_name} - <b>القضية:</b> \( {c.case_number}/ \){c.case_year}</div>
                        <div class="small text-white-50">كود: ${c.case_code || ''}</div>
                    </div>
                    ${item.decision ? `<div class="mt-2 p-2 bg-dark rounded small"><b>القرار:</b> ${item.decision}</div>` : ''}
                </div>`;
        } else {
            html += `
                <div class="case-card mb-3" 
                     onclick="openCaseDetails('${item.id}')"
                     role="button"
                     tabindex="0">
                    <div class="d-flex justify-content-between">
                        <strong class="case-code">${item.case_code || ''}</strong>
                        <span class="case-status \( {getStatusClass(item.last_case_status)}"> \){item.last_case_status}</span>
                    </div>
                    <div class="mt-2">
                        <div><b>العميل:</b> \( {item.client_name} ( \){item.client_phone})</div>
                        <div><b>القضية:</b> \( {item.case_number}/ \){item.case_year} - ${item.court_name}</div>
                    </div>
                    <div class="mt-3 d-flex gap-2 flex-wrap" onclick="event.stopPropagation()">
                        <button class="btn btn-sm btn-outline-warning" onclick="loadCaseForEdit('${item.id}'); event.stopPropagation();">
                            <i class="bi bi-pencil"></i> تعديل
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteCaseFromSearch('${item.id}'); event.stopPropagation();">
                            <i class="bi bi-trash"></i> حذف
                        </button>
                    </div>
                </div>`;
        }
    });
    
    container.innerHTML = html;
}

// ──────────────────────────────────────────────
// تحسين التعامل مع PWA + زر التثبيت (النقطة الثانية)
// ──────────────────────────────────────────────
window.addEventListener('beforeinstallprompt', (e) => {
    // منع الظهور التلقائي
    e.preventDefault();
    deferredPrompt = e;
    
    // إظهار الزر فوراً عندما يكون التثبيت ممكناً
    document.getElementById('installBtn').style.display = 'inline-block';
});

function installPWA() {
    if (!deferredPrompt) {
        Swal.fire({
            title: "التثبيت غير متاح حالياً",
            text: "جرب الضغط على زر المشاركة في المتصفح ثم اختيار 'إضافة إلى الشاشة الرئيسية'",
            icon: "info"
        });
        return;
    }

    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
            Swal.fire("تم التثبيت!", "يمكنك الآن فتح التطبيق من الشاشة الرئيسية", "success");
        }
        deferredPrompt = null;
        document.getElementById('installBtn').style.display = 'none';
    });
}

// إخفاء زر التثبيت بعد التثبيت أو إذا تم رفضه
window.addEventListener('appinstalled', () => {
    document.getElementById('installBtn').style.display = 'none';
    deferredPrompt = null;
});

// باقي الكود كما هو تماماً...
// (login, generateCaseCode, searchCases, saveSession, إلخ)

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
