<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <title>نظام إدارة القضايا</title>  
    <meta name="viewport" content="width=device-width, initial-scale=1">  
    <meta name="theme-color" content="#D4AF37">  
      
    <link rel="manifest" id="app-manifest">  
      
    <meta name="apple-mobile-web-app-capable" content="yes">  
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">  
    <meta name="apple-mobile-web-app-title" content="إدارة القضايا">  
      
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>">  
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>">  
  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">  
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>  
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>  
  
    <style>  
    :root{ --gold:#D4AF37; --black:#1A1A1A; --bg:#F8F5E6; }  
    body{background:var(--bg);font-family:'Segoe UI', system-ui;}  
    .header{background:linear-gradient(135deg,#000,#333);color:var(--gold);padding:20px;border-bottom:4px solid var(--gold)}  
    .form-section{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border-right:5px solid var(--gold);box-shadow: 0 2px 5px rgba(0,0,0,0.1);}  
    .btn-gold{background:var(--gold);border:none;font-weight:600;color:#fff}  
    .btn-gold:hover{background:#b8962e;color:#fff}  
    .session-card{background:#fff;border-right:4px solid var(--gold);padding:15px;margin-bottom:10px;border-radius:4px;box-shadow: 0 1px 3px rgba(0,0,0,0.05);cursor:pointer;transition:transform 0.2s;}  
    .session-card:hover{transform:translateX(-5px);}  
    .case-card{background:#fff;border-radius:8px;padding:15px;margin-bottom:15px;box-shadow:0 3px 10px rgba(0,0,0,0.08);border-right:4px solid var(--gold);cursor:pointer;transition:all 0.3s;}  
    .case-card:hover{box-shadow:0 5px 15px rgba(0,0,0,0.1);}  
    .case-code{font-family:monospace;font-size:1.2rem;color:var(--gold);font-weight:bold}  
    .nav-tabs .nav-link.active {background-color: var(--gold); color: white; border-color: var(--gold);}  
    .nav-tabs .nav-link {color: var(--black);}  
    .auto-fill-badge { font-size: 0.7rem; background: #e9ecef; padding: 2px 8px; border-radius: 10px; color: #666; }  
    .case-status{display:inline-block;padding:3px 10px;border-radius:20px;font-size:0.8rem;font-weight:bold;}  
    .status-new{background:#d4edda;color:#155724;}  
    .status-postponed{background:#fff3cd;color:#856404;}  
    .status-canceled{background:#f8d7da;color:#721c24;}  
    .status-suspended{background:#e2e3e5;color:#383d41;}  
    .status-reserved{background:#cce5ff;color:#004085;}  
    .status-judged{background:#d1ecf1;color:#0c5460;}  
    </style>  
</head>  
  
<body>  
  
<div id="loginPage" class="container mt-5" style="max-width:400px">  
    <div class="form-section text-center">  
        <i class="bi bi-shield-lock-fill" style="font-size: 3rem; color: var(--gold);"></i>  
        <h4 class="mt-3">دخول النظام</h4>  
        <input type="password" id="password" class="form-control my-3" placeholder="كلمة المرور">  
        <button class="btn btn-gold w-100" onclick="login()">دخول</button>  
    </div>  
</div>  
  
<div id="mainContent" style="display:none">  
    <div class="header text-center">  
        <h2>نظام إدارة القضايا</h2>  
        <p id="today"></p>  
    </div>  
  
    <div class="container mt-4">  
        <ul class="nav nav-tabs mb-3" id="mainTabs">  
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cases">القضايا</button></li>  
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sessions">الجلسات</button></li>  
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#search">بحث وتقارير</button></li>  
        </ul>  
  
        <div class="tab-content">  
            <div class="tab-pane fade show active" id="cases">  
                <form id="caseForm" class="form-section">  
                    <h5>تسجيل قضية جديدة</h5>  
                    <hr>  
                    <div class="row g-3">  
                        <div class="col-md-4"><label>اسم العميل</label><input id="client_name" class="form-control" required></div>  
                        <div class="col-md-4"><label>هاتف العميل</label><input id="client_phone" class="form-control" required></div>  
                        <div class="col-md-4"><label>إيميل العميل</label><input type="email" id="client_email" class="form-control"></div>  
                        <div class="col-md-4">  
                            <label>صفة العميل</label>  
                            <select id="client_role" class="form-select" required>  
                                <option value="">اختر الصفة...</option>  
                                <option>مدعي</option><option>مدعى عليه</option><option>مستأنف</option><option>طاعن</option><option>مجني عليه</option><option>متهم</option>  
                            </select>  
                        </div>  
                        <div class="col-md-4"><label>اسم الخصم</label><input id="opponent_name" class="form-control"></div>  
                        <div class="col-md-4"><label>رقم القضية</label><input id="case_number" class="form-control" required></div>  
                        <div class="col-md-4"><label>سنة القضية</label><input id="case_year" class="form-control" required></div>  
                        <div class="col-md-6">  
                            <label>المحكمة</label>  
                            <select id="court_name" class="form-select" required>  
                                <option value="">اختر المحكمة...</option>  
                                <option>محكمة الأسرة</option><option>المحكمة الابتدائية</option><option>محكمة الاستئناف</option><option>محكمة النقض</option>  
                            </select>  
                        </div>  
                        <div class="col-md-6"><label>الدائرة</label><input id="circle" class="form-control"></div>  
                        <div class="col-md-6">  
                            <label>نوع القضية</label>  
                            <select id="case_type" class="form-select" required>  
                                <option value="">اختر النوع...</option>  
                                <option>مدنية</option><option>جنائية</option><option>أحوال شخصية</option>  
                            </select>  
                        </div>  
                        <div class="col-md-12"><label>موضوع القضية</label><textarea id="case_subject" class="form-control" rows="2"></textarea></div>  
                        <div class="col-md-12"><label>ملاحظات</label><textarea id="notes" class="form-control" rows="2"></textarea></div>  
                    </div>  
                    <div class="d-flex gap-2 mt-3">  
                        <button type="submit" id="saveCaseBtn" class="btn btn-gold flex-grow-1">حفظ القضية</button>  
                        <button type="button" class="btn btn-outline-secondary w-25" onclick="clearForm()">جديد</button>  
                    </div>  
                </form>  
            </div>  
  
            <div class="tab-pane fade" id="sessions">  
                <div class="form-section">  
                    <h5>تسجيل جلسة</h5>  
                    <hr>  
                    <div class="row g-3">  
                        <div class="col-md-12">  
                            <label>ابحث عن القضية بالكود أو الاسم</label>  
                            <input id="s_search" class="form-control" placeholder="بحث سريع..." onkeyup="searchCasesForSession(this.value)">  
                            <div id="caseSearchResults" class="mt-2" style="max-height:150px;overflow-y:auto;display:none;border:1px solid #ddd;padding:5px;"></div>  
                        </div>  
                        <div class="col-md-4"><label>رقم القضية</label><input id="s_case_number" class="form-control" readonly></div>  
                        <div class="col-md-4"><label>المحكمة</label><input id="s_court" class="form-control" readonly></div>  
                        <div class="col-md-4"><label>العميل</label><input id="s_client" class="form-control" readonly></div>  
                        <div class="col-md-6"><label>تاريخ الجلسة</label><input type="datetime-local" id="s_date" class="form-control"></div>  
                        <div class="col-md-6">  
                            <label>حالة القضية</label>  
                            <select id="s_case_status" class="form-select">  
                                <option>جديدة</option><option>مؤجلة</option><option>محجوزة للحكم</option><option>محكوم فيها</option>  
                            </select>  
                        </div>  
                        <div class="col-md-12"><label>القرار</label><textarea id="s_decision" class="form-control" rows="2"></textarea></div>  
                    </div>  
                    <button id="saveSessionBtn" class="btn btn-gold w-100 mt-3" onclick="saveSession()">حفظ الجلسة</button>  
                </div>  
                <div class="form-section">  
                    <h5>جلسات الأسبوع الحالي</h5>  
                    <div id="upcomingSessions"></div>  
                </div>  
            </div>  

            <div class="tab-pane fade" id="search">  
                <div class="form-section">  
                    <h5>البحث المتقدم</h5>  
                    <div class="input-group">  
                        <input id="searchInput" class="form-control" placeholder="رقم قضية، اسم، أو هاتف">  
                        <button class="btn btn-gold" onclick="searchCases()">بحث</button>  
                    </div>  
                </div>  
                <div id="searchResults"></div>  
            </div>  
        </div>  
    </div>  
</div>  

<div class="modal fade" id="caseModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">تفاصيل القضية</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="caseDetails"></div></div></div></div>

<script>  
const SB_URL="https://iyhfafodhptcdwrjywek.supabase.co";  
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ";  
const db=supabase.createClient(SB_URL,SB_KEY);  
  
let currentCaseId = null;  

function login(){  
    if(document.getElementById('password').value==="mahmoud237"){  
        loginPage.style.display="none";   
        mainContent.style.display="block";  
        today.innerText=new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });  
        loadUpcoming('week');  
    } else {  
        Swal.fire("خطأ","كلمة المرور غير صحيحة","error");  
    }  
}  

// حفظ القضية مع حماية ضد التكرار
caseForm.onsubmit = async e => {  
    e.preventDefault();  
    const btn = document.getElementById('saveCaseBtn');
    btn.disabled = true; // تعطيل الزر فوراً
    
    Swal.fire({ title: 'جاري الحفظ...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });  
    
    try {
        const caseData = {
            client_name: client_name.value,  
            client_phone: client_phone.value,  
            client_email: client_email.value,  
            client_role: client_role.value,  
            opponent_name: opponent_name.value,  
            case_number: case_number.value,  
            case_year: case_year.value,  
            court_name: court_name.value,  
            circle: circle.value,  
            case_type: case_type.value,
            case_subject: case_subject.value,  
            notes: notes.value
        };
        
        const { data, error } = await db.from('cases').insert([caseData]).select();
        
        if (error) throw error;
        
        Swal.fire("تم الحفظ", "تم تسجيل القضية بنجاح", "success");
        caseForm.reset();
    } catch (err) {
        console.error(err);
        Swal.fire("خطأ", "حدثت مشكلة أثناء الحفظ، تأكد من عدم تكرار رقم القضية", "error");
    } finally {
        btn.disabled = false; // إعادة تفعيل الزر
    }
};

// حفظ الجلسة مع حماية ضد التكرار
async function saveSession() {  
    if (!currentCaseId) return Swal.fire("تنبيه", "اختر قضية أولاً", "warning");  
    
    const btn = document.getElementById('saveSessionBtn');
    btn.disabled = true;

    Swal.fire({ title: 'جاري الحفظ...', didOpen: () => Swal.showLoading() });
    
    try {
        const { error } = await db.from('sessions').insert([{  
            case_id: currentCaseId,  
            session_date: s_date.value,  
            decision: s_decision.value,  
            case_status: s_case_status.value
        }]);  
        
        if (error) throw error;
        
        Swal.fire("تم", "تم تسجيل الجلسة", "success");  
        loadUpcoming('week');  
        s_decision.value = '';
    } catch (err) {
        Swal.fire("خطأ", err.message, "error");
    } finally {
        btn.disabled = false;
    }
}  

// دوال البحث والجلب (مبسطة ومصححة)
async function searchCasesForSession(q) {
    if(q.length < 2) return;
    const { data } = await db.from('cases').select('*').or(`client_name.ilike.%${q}%,case_number.ilike.%${q}%`).limit(5);
    const res = document.getElementById('caseSearchResults');
    res.innerHTML = data.map(c => `<div class="p-2 border-bottom cursor-pointer" onclick="selectCaseForS('${c.id}','${c.case_number}','${c.court_name}','${c.client_name}')">${c.client_name} - ${c.case_number}</div>`).join('');
    res.style.display = 'block';
}

function selectCaseForS(id, num, court, client) {
    currentCaseId = id;
    s_case_number.value = num;
    s_court.value = court;
    s_client.value = client;
    document.getElementById('caseSearchResults').style.display = 'none';
}

async function loadUpcoming(range) {
    const { data } = await db.from('sessions').select('*, cases(*)').order('session_date', { ascending: true }).limit(10);
    upcomingSessions.innerHTML = data.map(s => `
        <div class="session-card">
            <b>${new Date(s.session_date).toLocaleDateString('ar-EG')}</b> | ${s.cases.client_name}
            <div class="small text-muted">قرار: ${s.decision || 'لا يوجد'}</div>
        </div>
    `).join('');
}

async function searchCases() {
    const q = searchInput.value;
    const { data } = await db.from('cases').select('*').or(`client_name.ilike.%${q}%,case_number.ilike.%${q}%`);
    searchResults.innerHTML = data.map(c => `
        <div class="case-card" onclick="openCaseDetails('${c.id}')">
            <b>${c.client_name}</b> [${c.case_number}/${c.case_year}]
            <div class="small">${c.court_name}</div>
        </div>
    `).join('');
}

async function openCaseDetails(id) {
    const { data: c } = await db.from('cases').select('*').eq('id', id).single();
    const { data: ss } = await db.from('sessions').select('*').eq('case_id', id).order('session_date', {descending:true});
    
    let html = `<h6>${c.client_name} ضد ${c.opponent_name || '---'}</h6><p>المحكمة: ${c.court_name}</p><hr><h6>الجلسات:</h6>`;
    html += ss.map(s => `<div class="p-2 bg-light mb-1 small">${new Date(s.session_date).toLocaleDateString('ar-EG')}: ${s.decision}</div>`).join('');
    
    document.getElementById('caseDetails').innerHTML = html;
    new bootstrap.Modal(document.getElementById('caseModal')).show();
}

function clearForm() { caseForm.reset(); }
</script>  
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>  
</body>  
</html>
