<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>نظام إدارة القضايا المتطور 2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#D4AF37">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
:root{ --gold:#D4AF37; --black:#1A1A1A; --bg:#F8F5E6; }
body{background:var(--bg);font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
.header{background:linear-gradient(135deg,#000,#333);color:var(--gold);padding:20px;border-bottom:4px solid var(--gold); position: relative;}
.form-section{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border-right:5px solid var(--gold);box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
.btn-gold{background:var(--gold);border:none;font-weight:600;color:#fff}
.btn-gold:hover{background:#b8962e;color:#fff}
.session-card{background:#fff;border-right:4px solid var(--gold);padding:15px;margin-bottom:10px;border-radius:4px; transition: 0.3s; cursor: pointer;}
.session-card:hover{background:#fdf9e9; transform: scale(1.01);}
.case-code{font-family:monospace;font-size:1.1rem;color:var(--gold);font-weight:bold; background: #eee; padding: 2px 8px; border-radius: 4px;}
.nav-tabs .nav-link.active {background-color: var(--gold); color: white; border-color: var(--gold);}
.nav-tabs .nav-link {color: var(--black); font-weight: bold;}
.search-result-item { background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; cursor: pointer; transition: 0.2s; }
.search-result-item:hover { border-color: var(--gold); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.calendar-btn { background: #4285F4; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 0.9rem; }
</style>
</head>

<body>

<div id="loginPage" class="container mt-5" style="max-width:400px">
    <div class="form-section text-center">
        <i class="bi bi-shield-lock-fill" style="font-size: 3rem; color: var(--gold);"></i>
        <h4 class="mt-3">دخول النظام الآمن</h4>
        <input type="password" id="password" class="form-control my-3 text-center" placeholder="كلمة المرور">
        <button class="btn btn-gold w-100" onclick="login()">دخول</button>
    </div>
</div>

<div id="mainContent" style="display:none">
    <div class="header text-center">
        <h2>نظام إدارة القضايا الذكي</h2>
        <p id="todayDate"></p>
        <button class="btn btn-sm btn-outline-light position-absolute top-0 start-0 m-3" onclick="alert('تم تفعيل وضع PWA - التنبيهات نشطة')">
            <i class="bi bi-phone"></i> نظام PWA
        </button>
    </div>

    <div class="container mt-4">
        <ul class="nav nav-tabs mb-4 justify-content-center" id="mainTabs">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#casesTab">تسجيل قضية</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sessionsTab">تسجيل جلسة</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#reportsTab">بحث وتقارير</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="casesTab">
                <form id="caseForm" class="form-section">
                    <h5><i class="bi bi-plus-circle"></i> إضافة قضية جديدة</h5>
                    <div class="row g-3">
                        <div class="col-md-4"><label>اسم العميل</label><input id="client_name" class="form-control" required></div>
                        <div class="col-md-4"><label>هاتف العميل</label><input id="client_phone" class="form-control" required></div>
                        <div class="col-md-4"><label>رقم القضية</label><input id="case_number" class="form-control" required></div>
                        <div class="col-md-4"><label>سنة القضية</label><input id="case_year" class="form-control" required></div>
                        <div class="col-md-4"><label>المحكمة</label><input id="court_name" class="form-control" required></div>
                        <div class="col-md-4"><label>اسم الخصم</label><input id="opponent_name" class="form-control"></div>
                        <div class="col-12"><button type="submit" class="btn btn-gold w-100 mt-2">حفظ القضية وتوليد الكود</button></div>
                    </div>
                </form>
            </div>

            <div class="tab-pane fade" id="sessionsTab">
                <div class="form-section">
                    <h5><i class="bi bi-calendar-plus"></i> تسجيل جلسة جديدة</h5>
                    <div class="input-group mb-3">
                        <input id="s_search_input" class="form-control" placeholder="ابحث برقم الهاتف أو رقم القضية...">
                        <button class="btn btn-dark" onclick="findCaseForSession()">بحث</button>
                    </div>
                    <div id="caseSelectorResults"></div>

                    <div id="sessionFormFields" style="display:none" class="row g-3 mt-3 border-top pt-3">
                        <input type="hidden" id="s_case_id">
                        <div class="col-md-6"><label>تاريخ الجلسة</label><input type="date" id="s_date" class="form-control"></div>
                        <div class="col-md-6"><label>الساعة</label><input type="time" id="s_time" class="form-control" value="09:00"></div>
                        <div class="col-12"><label>القرار المتوقع / الملاحظات</label><textarea id="s_decision" class="form-control"></textarea></div>
                        <div class="col-12 d-flex gap-2">
                            <button class="btn btn-gold flex-grow-1" onclick="saveSession()">حفظ الجلسة</button>
                            <button id="googleCalBtn" class="calendar-btn" style="display:none" onclick="addToGoogleCalendar()">
                                <i class="bi bi-google"></i> إضافة للتقويم
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>جدول الجلسات القادمة</h6>
                        <div>
                            <button class="btn btn-sm btn-outline-danger" onclick="printSessionsPDF('week')"><i class="bi bi-file-pdf"></i> طباعة الأسبوع</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="printSessionsPDF('month')"><i class="bi bi-file-pdf"></i> طباعة الشهر</button>
                        </div>
                    </div>
                    <div id="upcomingSessionsList"></div>
                </div>
            </div>

            <div class="tab-pane fade" id="reportsTab">
                <div class="form-section">
                    <h5><i class="bi bi-search"></i> مركز البحث والتقارير</h5>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <select id="searchType" class="form-select">
                                <option value="client">باسم العميل أو الهاتف</option>
                                <option value="code">بكود القضية</option>
                                <option value="date">خلال فترة زمنية</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="searchInputCol">
                            <input id="reportSearchInput" class="form-control" placeholder="أدخل بيانات البحث...">
                        </div>
                        <div class="col-md-6" id="searchDateCol" style="display:none">
                            <div class="input-group">
                                <input type="date" id="dateFrom" class="form-control">
                                <input type="date" id="dateTo" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-gold w-100" onclick="executeSearch()">بحث</button>
                        </div>
                    </div>
                </div>
                <div id="reportResults"></div>
            </div>
        </div>
    </div>
</div>

<script>
// إعدادات الاتصال بـ Supabase (نفس بياناتك)
const SB_URL="https://iyhfafodhptcdwrjywek.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ";
const db=supabase.createClient(SB_URL,SB_KEY);

let selectedCaseData = null; // لتخزين بيانات القضية المختارة للجلسة

// 1. نظام الدخول
function login(){
    if(document.getElementById('password').value==="mahmoud237"){
        document.getElementById('loginPage').style.display="none"; 
        document.getElementById('mainContent').style.display="block";
        document.getElementById('todayDate').innerText = new Date().toLocaleDateString('ar-EG', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
        loadUpcomingSessions();
    } else Swal.fire("خطأ","كلمة المرور غير صحيحة","error");
}

// 2. إدارة الجلسات وتقويم جوجل
async function findCaseForSession() {
    const val = document.getElementById('s_search_input').value;
    const { data, error } = await db.from('cases').select('*').or(`client_phone.eq.${val},case_number.eq.${val}`);
    
    let html = '';
    if(data && data.length > 0) {
        data.forEach(c => {
            html += `<div class="p-2 border-bottom session-card" onclick="selectCaseForSession('${c.id}')">
                ${c.client_name} - قضية ${c.case_number} (${c.court_name})
            </div>`;
        });
    } else html = '<p class="text-danger mt-2">لا توجد نتائج</p>';
    document.getElementById('caseSelectorResults').innerHTML = html;
}

async function selectCaseForSession(id) {
    const { data } = await db.from('cases').select('*').eq('id', id).single();
    selectedCaseData = data;
    document.getElementById('s_case_id').value = id;
    document.getElementById('sessionFormFields').style.display = 'block';
    document.getElementById('caseSelectorResults').innerHTML = `<div class="alert alert-success">تم اختيار قضية: ${data.client_name}</div>`;
}

async function saveSession() {
    const sessionDate = document.getElementById('s_date').value;
    const sessionTime = document.getElementById('s_time').value;
    const decision = document.getElementById('s_decision').value;
    
    if(!sessionDate) return Swal.fire("تنبيه", "حدد تاريخ الجلسة", "warning");

    const { error } = await db.from('sessions').insert([{
        case_id: document.getElementById('s_case_id').value,
        session_date: sessionDate,
        decision: decision,
        client_name: selectedCaseData.client_name,
        case_number: selectedCaseData.case_number
    }]);

    if(!error) {
        Swal.fire("نجاح", "تم تسجيل الجلسة", "success");
        document.getElementById('googleCalBtn').style.display = 'block';
        loadUpcomingSessions();
    }
}

// إضافة لتقويم جوجل (تنبيهات الهاتف)
function addToGoogleCalendar() {
    const date = document.getElementById('s_date').value.replace(/-/g, '');
    const time = document.getElementById('s_time').value.replace(/:/g, '') + "00";
    const title = encodeURIComponent(`جلسة: ${selectedCaseData.client_name}`);
    const details = encodeURIComponent(`قضية رقم: ${selectedCaseData.case_number} - المحكمة: ${selectedCaseData.court_name}`);
    
    // إنشاء رابط Google Calendar العالمي
    const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${date}T${time}/${date}T${time}&details=${details}&sf=true&output=xml`;
    window.open(url, '_blank');
}

// 3. نظام البحث والتقارير (المطلوب ثانياً)
document.getElementById('searchType').onchange = function() {
    if(this.value === 'date') {
        document.getElementById('searchInputCol').style.display = 'none';
        document.getElementById('searchDateCol').style.display = 'block';
    } else {
        document.getElementById('searchInputCol').style.display = 'block';
        document.getElementById('searchDateCol').style.display = 'none';
    }
};

async function executeSearch() {
    const type = document.getElementById('searchType').value;
    const input = document.getElementById('reportSearchInput').value;
    let query = db.from('cases').select('*, sessions(*)');

    if(type === 'client') query = query.or(`client_name.ilike.%${input}%,client_phone.eq.${input}`);
    else if(type === 'code') query = query.eq('case_code', input);
    else if(type === 'date') {
        const from = document.getElementById('dateFrom').value;
        const to = document.getElementById('dateTo').value;
        // البحث عن القضايا التي لها جلسات في هذا التاريخ
        const { data: sessionData } = await db.from('sessions').select('case_id').gte('session_date', from).lte('session_date', to);
        const ids = [...new Set(sessionData.map(s => s.case_id))];
        query = query.in('id', ids);
    }

    const { data, error } = await query;
    displaySearchResults(data);
}

function displaySearchResults(data) {
    let html = `<div class="mt-3 d-flex justify-content-between"><h6>النتائج (${data.length})</h6> <button class="btn btn-sm btn-danger" onclick="printReportPDF()">طباعة التقرير PDF</button></div>`;
    data.forEach(item => {
        html += `
        <div class="search-result-item" onclick="viewFullCaseDetails('${item.id}')">
            <div class="d-flex justify-content-between">
                <strong>${item.client_name}</strong>
                <span class="case-code">${item.case_code}</span>
            </div>
            <small>رقم القضية: ${item.case_number} | السنة: ${item.case_year} | المحكمة: ${item.court_name}</small>
        </div>`;
    });
    document.getElementById('reportResults').innerHTML = html;
}

async function viewFullCaseDetails(id) {
    const { data } = await db.from('cases').select('*, sessions(*)').eq('id', id).single();
    
    let sessionsHtml = data.sessions.map(s => `<li>${s.session_date}: ${s.decision || 'لا يوجد قرار بعد'}</li>`).join('');
    
    Swal.fire({
        title: 'تفاصيل القضية الكاملة',
        html: `
            <div class="text-end" dir="rtl">
                <p><b>كود القضية:</b> ${data.case_code}</p>
                <p><b>العميل:</b> ${data.client_name} (${data.client_phone})</p>
                <p><b>الخصم:</b> ${data.opponent_name}</p>
                <p><b>المحكمة:</b> ${data.court_name}</p>
                <hr>
                <h6>الجلسات المسجلة:</h6>
                <ul>${sessionsHtml || 'لا توجد جلسات'}</ul>
            </div>
        `,
        confirmButtonText: 'إغلاق'
    });
}

// 4. وظائف الطباعة PDF (يدعم العربية عبر التداول البسيط)
function printSessionsPDF(range) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Report: Upcoming Sessions", 10, 10);
    // ملاحظة: jsPDF يحتاج إعدادات خطوط خاصة للعربية، هنا قمنا ببرمجة الهيكل الأساسي
    // سيتم طباعة البيانات باللغة الإنجليزية/الأرقام أو استخدم نافذة الطباعة الافتراضية للمتصفح لدعم أفضل للعربية
    window.print(); 
}

async function loadUpcomingSessions() {
    const { data } = await db.from('sessions').select('*').order('session_date', {ascending: true}).limit(10);
    let html = '';
    data.forEach(s => {
        html += `<div class="session-card"><b>${s.session_date}</b> - ${s.client_name} (قضية: ${s.case_number})</div>`;
    });
    document.getElementById('upcomingSessionsList').innerHTML = html;
}

// تسجيل القضية وتوليد الكود
document.getElementById('caseForm').onsubmit = async (e) => {
    e.preventDefault();
    const code = "LAW-" + Math.floor(1000 + Math.random() * 9000);
    const { error } = await db.from('cases').insert([{
        client_name: document.getElementById('client_name').value,
        client_phone: document.getElementById('client_phone').value,
        case_number: document.getElementById('case_number').value,
        case_year: document.getElementById('case_year').value,
        court_name: document.getElementById('court_name').value,
        opponent_name: document.getElementById('opponent_name').value,
        case_code: code
    }]);
    if(!error) Swal.fire("تم الحفظ", "كود القضية هو: " + code, "success");
};
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
