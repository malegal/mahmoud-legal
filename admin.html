<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام إدارة القضايا | محمود عبد الحميد للمحاماة</title>
    <meta name="theme-color" content="#bf953f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href='data:application/manifest+json,{"name":"نظام إدارة القضايا","short_name":"القضايا","start_url":".","display":"standalone","background_color":"#020617","theme_color":"#bf953f","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/1048/1048953.png","sizes":"512x512","type":"image/png"}]}'>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700;900&family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* نفس الأنماط السابقة */
        :root {
            --primary-dark: #020617;
            --gold-gradient: linear-gradient(135deg, #bf953f 0%, #fcf6ba 45%, #b38728 50%, #fbf5b7 55%, #aa771c 100%);
            --gold-solid: #bf953f;
            --gold-glow: rgba(191, 149, 63, 0.5);
            --header-height: 70px;
        }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--primary-dark);
            color: #f8fafc;
            padding-top: var(--header-height);
            -webkit-tap-highlight-color: transparent;
        }
        label, .form-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 0.25rem;
        }
        .form-control, .form-select {
            font-size: 1rem;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(191,149,63,0.3); color: white; border-radius: 0.8rem;
        }
        .form-control:focus { background: rgba(255,255,255,0.1); border-color: var(--gold-solid); color: white; box-shadow: none; }
        .gold-text { background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .gold-btn { background: var(--gold-gradient); color: #1a1a1a; font-weight: 800; border: none; box-shadow: 0 0 15px var(--gold-glow); transition: 0.3s; }
        .gold-btn:hover { transform: translateY(-2px); box-shadow: 0 0 25px var(--gold-glow); }
        .card-glass { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(191, 149, 63, 0.2); border-radius: 1.2rem; }
        .gold-border { border: 1px solid var(--gold-solid) !important; }
        .admin-toolbar {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); border-bottom: 2px solid var(--gold-solid); z-index: 1100;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .nav-tabs { border-bottom: none; gap: 0.5rem; }
        .nav-tabs .nav-link { color: #ccc; background: rgba(0,0,0,0.4); border: 1px solid rgba(191,149,63,0.3); border-radius: 2rem !important; padding: 0.6rem 1.5rem; font-weight: 600; }
        .nav-tabs .nav-link.active { background: var(--gold-gradient) !important; color: #1a1a1a !important; font-weight: 800; }
        .case-card, .session-card, .security-log-card {
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(191,149,63,0.3); border-radius: 1rem; padding: 1.2rem; margin-bottom: 1rem; color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .case-card:hover, .session-card:hover {
            transform: scale(1.01);
            border-color: var(--gold-solid);
        }
        .stats-card { background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); border: 1px solid rgba(191,149,63,0.2); border-radius: 1rem; padding: 1rem; text-align: center; }
        .stats-number { font-size: 2rem; font-weight: bold; color: var(--gold-solid); }
        .case-code { font-family: monospace; font-size: 1.2rem; color: var(--gold-solid); font-weight: bold; }
        .case-status { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .status-new { background: #d4edda; color: #155724; }
        .status-postponed { background: #fff3cd; color: #856404; }
        .status-canceled { background: #f8d7da; color: #721c24; }
        .status-suspended { background: #e2e3e5; color: #383d41; }
        .status-reserved { background: #cce5ff; color: #004085; }
        .status-judged { background: #d1ecf1; color: #0c5460; }
        .log-action-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-left: 5px; }
        .log-ip-display { font-family: monospace; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 5px; border: 1px solid rgba(191,149,63,0.3); }
        .log-details { font-size: 0.85rem; color: #ccc; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid rgba(191,149,63,0.2); white-space: pre-wrap; word-break: break-all; max-height: 150px; overflow-y: auto; }
        @media (max-width: 768px) {
            .admin-toolbar h1 { font-size: 0.9rem !important; }
            .nav-tabs .nav-link { font-size: 0.75rem; padding: 8px 12px; }
        }
    </style>
</head>
<body>

<div class="admin-toolbar">
    <div class="d-flex align-items-center gap-2">
        <i class="bi bi-shield-check text-warning fs-5"></i>
        <h1 class="gold-text fs-5 fw-bold mb-0">نظام إدارة القضايا | محمود عبد الحميد المحامي</h1>
    </div>
    <button class="gold-btn btn btn-sm px-3" onclick="installPWA()" id="installBtn" style="display:none">تثبيت التطبيق</button>
</div>

<div id="loginPage" class="container mt-5" style="max-width:450px">  
    <div class="card-glass p-5 text-center gold-border">  
        <div class="mb-3">
            <span style="font-size: 4rem; font-weight: 900; background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">MA</span>
        </div>
        <h3 class="gold-text serif-font" style="font-size: 2rem;">محمود عبد الحميد</h3>
        <p class="text-white-50 mb-4">المحامي بالنقض والدستورية العليا</p>
        <input type="password" id="password" class="form-control my-3 text-center py-3" placeholder="كلمة المرور">  
        <button class="gold-btn btn w-100 py-3" onclick="login()">
            <i class="bi bi-key"></i> دخول
        </button>
    </div>  
</div>  

<div id="mainContent" style="display:none">  
    <div class="container-fluid px-3 mt-4">  
        <ul class="nav nav-tabs mb-3" id="mainTabs">  
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cases">القضايا</button></li>  
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sessions">الجلسات</button></li>  
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#searchTab">بحث وتقارير</button></li>  
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#securityLogs">سجل الاستعلامات</button></li>  
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#aiAssistant">المحامي الآلي</button></li>
        </ul>  
  
        <div class="tab-content">  
            <!-- تبويب القضايا (كما هو) -->
            <div class="tab-pane fade show active" id="cases">  
                <form id="caseForm" class="card-glass p-3 p-md-4 mb-4">  
                    <h5 class="gold-text mb-3">تسجيل قضية جديدة</h5>  
                    <div class="row g-3">  
                        <div class="col-md-4"><label>اسم العميل</label><input id="client_name" class="form-control" required></div>  
                        <div class="col-md-4"><label>هاتف العميل</label><input id="client_phone" class="form-control" required></div>  
                        <div class="col-md-4"><label>إيميل العميل</label><input type="email" id="client_email" class="form-control"></div>  
                        <div class="col-md-4">
                            <label>صفة العميل</label>
                            <select id="client_role" class="form-select" required>
                                <option value="">اختر الصفة...</option><option>مدعي</option><option>مدعى عليه</option><option>مستأنف</option><option>مستأنف ضده</option><option>طاعن</option><option>مطعون ضده</option><option>مجني عليه</option><option>متهم</option>
                            </select>
                        </div>  
                        <div class="col-md-4"><label>اسم الخصم</label><input id="opponent_name" class="form-control"></div>  
                        <div class="col-md-4"><label>رقم القضية</label><input id="case_number" class="form-control" required></div>  
                        <div class="col-md-4"><label>سنة القضية</label><input id="case_year" class="form-control" required></div>  
                        <div class="col-md-8">
                            <label>المحكمة</label>
                            <select id="court_name" class="form-select" required>
                                <option value="">اختر المحكمة...</option><option>محكمة الأسرة</option><option>المحكمة الجزئية</option><option>المحكمة الابتدائية</option><option>محكمة الاستئناف</option><option>المحكمة العمالية</option><option>المحكمة الاقتصادية</option><option>المحكمة الادارية</option><option>محكمة القضاء الاداري</option><option>المحكمة الادارية العليا</option><option>محكمة النقض</option>
                            </select>
                        </div>  
                        <div class="col-md-6"><label>الدائرة</label><input id="circle" class="form-control"></div>  
                        <div class="col-md-6">
                            <label>نوع القضية</label>
                            <select id="case_type" class="form-select" required>
                                <option value="">اختر النوع...</option><option value="مدنية">مدنية</option><option value="جنائية">جنائية</option><option value="أحوال شخصية">أحوال شخصية</option><option value="إدارية">إدارية</option><option value="تجارية">تجارية</option><option value="عمالية">عمالية</option><option value="دستورية">دستورية</option><option value="ضريبية">ضريبية</option>
                            </select>
                        </div>  
                        <div class="col-md-12"><label>موضوع القضية</label><textarea id="case_subject" class="form-control" rows="2"></textarea></div>  
                        <div class="col-md-12"><label>ملاحظات</label><textarea id="notes" class="form-control" rows="2"></textarea></div>  
                    </div>  
                    <div class="d-flex gap-2 mt-3">  
                        <button type="submit" class="gold-btn btn flex-grow-1 py-3">حفظ القضية</button>  
                        <button type="button" class="btn btn-outline-secondary w-25 py-3" onclick="clearForm()">جديد</button>  
                    </div>  
                    <div id="caseCodeResult" class="mt-3 text-center"></div>
                </form>  
            </div>  

            <!-- تبويب الجلسات (كما هو) -->
            <div class="tab-pane fade" id="sessions">  
                <div class="card-glass p-3 p-md-4 mb-4">  
                    <h5 class="gold-text mb-3">تسجيل جلسة <span class="badge bg-secondary">الملء تلقائي</span></h5>  
                    <div class="row g-3">  
                        <div class="col-md-12 mb-3">
                            <div class="p-3 bg-dark rounded border-gold">
                                <strong>تنسيق كود القضية:</strong> MA-26-001-H7G4D9
                                <small class="text-muted d-block">(001 هو الرقم الإداري)</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label>الرقم الإداري (مثل: 001)</label>
                            <div class="input-group">
                                <input id="admin_search" class="form-control gold-border" placeholder="أدخل الرقم الإداري (001)" onkeyup="searchByAdminNumber(this.value)">
                                <button class="gold-btn btn" type="button" onclick="searchByAdminNumber(admin_search.value)"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label>بحث بالرقم أو الاسم</label>
                            <div class="input-group">
                                <input id="s_search" class="form-control" placeholder="رقم القضية أو اسم العميل" onkeyup="searchCasesForSession(this.value)">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchCasesForSession(s_search.value)"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        
                        <div id="caseSearchResults" class="col-md-12 mt-2" style="max-height:200px;overflow-y:auto;display:none;"></div>  
                        
                        <div class="col-md-4"><label>كود القضية الكامل</label><input id="s_case_code" class="form-control" readonly></div>
                        <div class="col-md-4"><label>رقم القضية</label><input id="s_case_number" class="form-control" readonly></div>  
                        <div class="col-md-4"><label>سنة القضية</label><input id="s_case_year" class="form-control" readonly></div>  
                        <div class="col-md-4"><label>المحكمة</label><input id="s_court" class="form-control" readonly></div>  
                        <div class="col-md-4"><label>اسم العميل</label><input id="s_client" class="form-control" readonly></div>  
                        <div class="col-md-4"><label>هاتف العميل</label><input id="s_client_phone" class="form-control" readonly></div>  
                        <div class="col-md-4"><label>إيميل العميل</label><input id="s_client_email" class="form-control" readonly></div>  
                        <div class="col-md-4"><label>اسم الخصم</label><input id="s_opponent" class="form-control" readonly></div>  
                        <div class="col-md-4"><label>صفة العميل</label><input id="s_client_role" class="form-control" readonly></div>  
                        <div class="col-md-4"><label>نوع القضية</label><input id="s_case_type" class="form-control" readonly></div>  
                        <div class="col-md-6"><label>تاريخ الجلسة</label><input type="datetime-local" id="s_date" class="form-control"></div>  
                        <div class="col-md-6">
                            <label>حالة القضية</label>
                            <select id="s_case_status" class="form-select">
                                <option value="جديدة">جديدة</option><option value="مؤجلة">مؤجلة</option><option value="مشطوبة">مشطوبة</option><option value="موقوفة">موقوفة</option><option value="محجوزة للحكم">محجوزة للحكم</option><option value="محكوم فيها">محكوم فيها</option>
                            </select>
                        </div>  
                        <div class="col-md-12"><label>القرار</label><textarea id="s_decision" class="form-control" rows="2"></textarea></div>  
                        <div class="col-md-12"><label>ملاحظات القضية</label><textarea id="s_notes" class="form-control" rows="2" readonly></textarea></div>  
                    </div>  
                    <div class="d-flex gap-2 mt-3">  
                        <button class="gold-btn btn flex-grow-1 py-3" onclick="saveSession()">حفظ الجلسة</button>  
                        <button class="btn btn-outline-success py-3" onclick="addToGoogleCalendar()" id="calendarBtn" disabled>  
                            <i class="bi bi-calendar-plus"></i> إضافة للتقويم  
                        </button>  
                    </div>  
                </div>  

                <div class="card-glass p-3 p-md-4">  
                    <h5 class="gold-text mb-3">جلسات قادمة</h5>  
                    <div class="btn-group w-100 mb-3">  
                        <button type="button" class="btn btn-outline-secondary active" onclick="loadUpcoming('week', this)">الأسبوع الحالي</button>  
                        <button type="button" class="btn btn-outline-secondary" onclick="loadUpcoming('month', this)">الشهر الحالي</button>  
                    </div>  
                    <div id="upcomingSessions"></div>  
                </div>  
            </div>  

            <!-- تبويب البحث والتقارير -->
            <div class="tab-pane fade" id="searchTab">
                <div class='row g-3 mb-4'>
                    <div class='col-6'><div class='stats-card'><i class='bi bi-briefcase gold-text fs-3'></i><div class='stats-number' id='totalCasesCount'>0</div><div class='text-white-50 small'>إجمالي القضايا</div></div></div>
                    <div class='col-6'><div class='stats-card'><i class='bi bi-people gold-text fs-3'></i><div class='stats-number' id='totalClientsCount'>0</div><div class='text-white-50 small'>العملاء</div></div></div>
                </div>
  
                <div class="card-glass p-3 p-md-4 mb-4">  
                    <h5 class="gold-text mb-3">البحث المتقدم</h5>  
                    <div class="row g-2 mb-3">  
                        <div class="col-md-8"><input id="searchInput" class="form-control" placeholder="كود، اسم، هاتف، رقم قضية"></div>  
                        <div class="col-md-4"><button class="gold-btn btn w-100 py-2" onclick="searchCases()">بحث عام</button></div>  
                    </div>  
                    <div class="row g-3 mb-3">  
                        <div class="col-md-5"><label>من تاريخ</label><input type="date" id="searchFrom" class="form-control"></div>  
                        <div class="col-md-5"><label>إلى تاريخ</label><input type="date" id="searchTo" class="form-control"></div>  
                        <div class="col-md-2 d-flex align-items-end"><button class="gold-btn btn w-100 py-2" onclick="searchByDateRange()">بحث تاريخي</button></div>  
                    </div>  
                    <div class="d-flex flex-wrap gap-2">  
                        <button class="btn btn-sm btn-outline-light" onclick="searchByPhone()">بحث برقم الهاتف</button>  
                        <button class="btn btn-sm btn-outline-light" onclick="searchByAdminNumberInSearch()">بحث بالرقم الإداري</button>
                        <button class="btn btn-sm btn-outline-light" onclick="exportToPDF()">تصدير PDF</button>  
                    </div>  
                </div>  
                <div id="searchResults" class="mt-4"></div>  
            </div>  

            <!-- تبويب سجل الاستعلامات (كما هو) -->
            <div class="tab-pane fade" id="securityLogs">  
                <div class="card-glass p-3 p-md-4 mb-4">  
                    <h5 class="gold-text mb-3"><i class="bi bi-shield-lock"></i> نظام المراقبة الأمنية</h5>  
                    <div class="row g-3 mb-3">  
                        <div class="col-md-3"><label>بحث بالهاتف</label><input id="logPhoneSearch" class="form-control"></div>  
                        <div class="col-md-3"><label>عنوان IP</label><input id="logIPSearch" class="form-control"></div>
                        <div class="col-md-3"><label>نوع النشاط</label><select id="logActionFilter" class="form-select"><option value="">الكل</option><option value="entry_warning_accepted">قبول تحذير</option><option value="entry_warning_rejected">رفض تحذير</option><option value="search_attempt">محاولة بحث</option><option value="search_success">بحث ناجح</option><option value="search_failed">بحث فاشل</option></select></div>  
                        <div class="col-md-3 d-flex align-items-end"><button class="gold-btn btn w-100" onclick="loadSecurityLogs()">تحديث السجلات</button></div>  
                    </div>  
                    <div id="securityLogsResults"></div>  
                </div>  
            </div>  

            <!-- تبويب المحامي الآلي (AI Legal Assistant) مع خاصية البحث على الإنترنت -->
            <div class="tab-pane fade" id="aiAssistant">
                <div class="card-glass p-3 p-md-4">
                    <h5 class="gold-text mb-3"><i class="bi bi-robot"></i> المحامي الآلي - البحث على الإنترنت (Tavily)</h5>
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <label>مفتاح Groq API</label>
                            <input type="text" id="groqApiKey" class="form-control" placeholder="أدخل مفتاح Groq API" value="YOUR_GROQ_API_KEY">
                            <small class="text-white-50">احصل على مفتاح مجاني من groq.com</small>
                        </div>
                        <div class="col-12">
                            <label>مفتاح Tavily API (للبحث على الإنترنت)</label>
                            <input type="text" id="tavilyApiKey" class="form-control" placeholder="أدخل مفتاح Tavily API" value="YOUR_TAVILY_API_KEY">
                            <small class="text-white-50">احصل على مفتاح مجاني من tavily.com</small>
                        </div>
                        <div class="col-12">
                            <label>موضوع المذكرة / البحث القانوني</label>
                            <textarea id="aiPrompt" class="form-control" rows="4" placeholder="مثال: اكتب مذكرة دفاع في قضية تبديد منقولات زوجية تتضمن الوقائع والدفوع القانونية...."></textarea>
                        </div>
                        <div class="col-12 d-flex gap-2">
                            <button class="gold-btn btn flex-grow-1 py-3" onclick="generateLegalContentWithWebSearch()"><i class="bi bi-stars"></i> بحث + إنشاء المحتوى</button>
                            <button class="btn btn-outline-secondary py-3" onclick="clearAiFields()"><i class="bi bi-eraser"></i> مسح</button>
                        </div>
                    </div>
                    <div id="aiResultContainer" style="display:none;">
                        <hr class="border-secondary">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="gold-text">النتيجة:</h6>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-success" onclick="saveAsWord()"><i class="bi bi-file-word"></i> Word</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="saveAsPdf()"><i class="bi bi-file-pdf"></i> PDF</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard()"><i class="bi bi-clipboard"></i> نسخ</button>
                            </div>
                        </div>
                        <div id="aiResult" class="p-3 bg-dark rounded border border-gold" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-family: 'Amiri', serif; line-height: 1.8;"></div>
                    </div>
                </div>
            </div>
        </div>  
    </div>  
</div>  

<!-- باقي الـ Modals كما هي (لم يتم تغييرها) -->
<!-- ... -->

<script>
// ========== إعدادات Supabase ==========
const SB_URL="https://iyhfafodhptcdwrjywek.supabase.co";  
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ";  
const db = supabase.createClient(SB_URL, SB_KEY);  

let currentCaseId = null;  
let selectedCaseForCalendar = null;
let currentSecurityLogId = null;
let blockedIPsCache = {};

// متغير لتخزين حدث التثبيت
let deferredPrompt;

// ========== دوال تسجيل الدخول والإحصائيات (كما هي) ==========
function login(){  
    if(document.getElementById('password').value==="mahmoud237"){  
        document.getElementById('loginPage').style.display="none";   
        document.getElementById('mainContent').style.display="block";  
        updateStatistics();
        loadUpcoming('week');
        loadSecurityLogs();
    } else { Swal.fire("خطأ","كلمة المرور غير صحيحة","error"); }  
}

async function updateStatistics() {
    try {
        const { count: casesCount } = await db.from('cases').select('*', { count: 'exact', head: true });
        const { data: clients } = await db.from('cases').select('client_phone');
        const uniqueClients = new Set(clients.map(c => c.client_phone)).size;
        
        document.getElementById('totalCasesCount').textContent = casesCount || 0;
        document.getElementById('totalClientsCount').textContent = uniqueClients || 0;
    } catch (err) { console.error('Error updating stats:', err); }
}

// ========== دوال القضايا والجلسات (كما هي) ==========
// ... (نفس الدوال السابقة بدون تغيير)
// لقد تم حذف التكرار للاختصار، ولكن في الكود الفعلي يجب إبقاء جميع الدوال السابقة كما هي.

// ========== المحامي الآلي مع البحث على الإنترنت ==========
let generatedContent = '';

// دالة البحث باستخدام Tavily
async function searchWithTavily(query, apiKey) {
    const url = 'https://api.tavily.com/search';
    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            api_key: apiKey,
            query: query,
            search_depth: 'advanced', // أو basic
            include_answer: true,      // يلخص الإجابة
            include_raw_content: false,
            max_results: 5
        })
    });
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'فشل البحث في Tavily');
    }
    const data = await response.json();
    return data;
}

// الدالة الرئيسية: بحث + إنشاء محتوى
async function generateLegalContentWithWebSearch() {
    let groqApiKey = document.getElementById('groqApiKey').value.trim();
    let tavilyApiKey = document.getElementById('tavilyApiKey').value.trim();
    const prompt = document.getElementById('aiPrompt').value.trim();

    if (!groqApiKey || groqApiKey === 'YOUR_GROQ_API_KEY') {
        Swal.fire('تنبيه', 'الرجاء إدخال مفتاح Groq API صحيح', 'warning');
        return;
    }
    if (!tavilyApiKey || tavilyApiKey === 'YOUR_TAVILY_API_KEY') {
        Swal.fire('تنبيه', 'الرجاء إدخال مفتاح Tavily API صحيح', 'warning');
        return;
    }
    if (!prompt) {
        Swal.fire('تنبيه', 'الرجاء إدخال موضوع المذكرة', 'warning');
        return;
    }

    // التحقق من صحة المفاتيح (ASCII فقط)
    if (/[^\x00-\x7F]/.test(groqApiKey) || /[^\x00-\x7F]/.test(tavilyApiKey)) {
        Swal.fire('خطأ', 'المفاتيح تحتوي على أحرف غير مسموح بها. استخدم أحرف إنجليزية وأرقام فقط.', 'error');
        return;
    }

    Swal.fire({ title: 'جاري البحث على الإنترنت...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    try {
        // 1. البحث باستخدام Tavily
        const searchResults = await searchWithTavily(prompt, tavilyApiKey);
        
        // استخراج المعلومات المفيدة
        let searchContext = '';
        if (searchResults.answer) {
            searchContext += `ملخص البحث: ${searchResults.answer}\n\n`;
        }
        if (searchResults.results && searchResults.results.length > 0) {
            searchContext += 'مصادر إضافية من الإنترنت:\n';
            searchResults.results.forEach((r, index) => {
                searchContext += `${index + 1}. ${r.title}: ${r.content}\n`;
            });
        }

        Swal.fire({ title: 'جاري إنشاء المحتوى القانوني...', didOpen: () => Swal.showLoading() });

        // 2. إرسال المعلومات إلى Groq
        const systemPrompt = `أنت محامي خبير بالنقض والمحاكم العليا المصرية. لديك قدرة فائقة على صياغة المذكرات القانونية والأبحاث بلغة قانونية رصينة وإبداعية. تلتزم بالقانون المصري، وأحكام محكمة النقض، والمحاكم العليا، والفقه القانوني المصري. عند كتابة أي مذكرة أو بحث، تقوم بتضمين المصادر بدقة: ذكر نصوص المواد من القوانين المصرية، وأرقام الطعن وأحكام محكمة النقض، وآراء الفقهاء البارزين. استخدم المعلومات الواردة من البحث على الإنترنت كمصدر للأحداث والوقائع والتطورات الحديثة، وقم بالاستشهاد بها. أسلوبك مهني، منظم، مقنع.`;

        const userPrompt = `المطلوب: ${prompt}\n\nمعلومات حديثة من الإنترنت (استخدمها في الصياغة واستشهد بها عند الاقتضاء):\n${searchContext}`;

        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${groqApiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'llama-3.3-70b-versatile',
                messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userPrompt }
                ],
                temperature: 0.7,
                max_tokens: 4000,
                top_p: 1,
                stream: false
            })
        });

        Swal.close();

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'فشل الاتصال بالخدمة');
        }

        const data = await response.json();
        generatedContent = data.choices[0].message.content;

        document.getElementById('aiResult').innerHTML = generatedContent.replace(/\n/g, '<br>');
        document.getElementById('aiResultContainer').style.display = 'block';

    } catch (err) {
        Swal.close();
        Swal.fire('خطأ', err.message, 'error');
    }
}

// دوال الحفظ والنسخ (كما هي مع التحسينات السابقة)
function saveAsWord() {
    if (!generatedContent) {
        Swal.fire('تنبيه', 'لا يوجد محتوى للحفظ', 'warning');
        return;
    }

    const formattedContent = generatedContent
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\n/g, '<br>');

    const htmlContent = `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>مذكرة قانونية</title>
    <style>
        body {
            font-family: 'Amiri', 'Tajawal', serif;
            line-height: 1.8;
            padding: 20px;
            direction: rtl;
        }
        h1, h2, h3 {
            color: #bf953f;
        }
    </style>
</head>
<body>
    ${formattedContent}
</body>
</html>`;

    const blob = new Blob([htmlContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `مذكرة_قانونية_${new Date().toLocaleDateString('ar-EG').replace(/\//g, '-')}.doc`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function saveAsPdf() {
    Swal.fire('قريباً', 'خاصية حفظ PDF قيد التطوير', 'info');
}

function copyToClipboard() {
    if (!generatedContent) {
        Swal.fire('تنبيه', 'لا يوجد محتوى للنسخ', 'warning');
        return;
    }
    navigator.clipboard.writeText(generatedContent).then(() => {
        Swal.fire('تم', 'تم نسخ المحتوى إلى الحافظة', 'success');
    }).catch(() => {
        Swal.fire('خطأ', 'فشل النسخ', 'error');
    });
}

function clearAiFields() {
    document.getElementById('aiPrompt').value = '';
    document.getElementById('aiResultContainer').style.display = 'none';
    document.getElementById('aiResult').innerHTML = '';
    generatedContent = '';
}

// ========== باقي دوال النظام الأصلي (لم يتم تضمينها للاختصار، لكن يجب إضافتها هنا) ==========
// ... (جميع الدوال السابقة من openCaseDetails، loadUpcoming، etc.)

// ========== دوال PWA ==========
function installPWA() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the install prompt');
            }
            deferredPrompt = null;
        });
    }
}

// تسجيل Service Worker (كما هو)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        const swContent = `
            self.addEventListener('install', e => {
                e.waitUntil(
                    caches.open('v1').then(cache => {
                        return cache.addAll([
                            '/',
                            'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css',
                            'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css',
                            'https://cdn.tailwindcss.com',
                            'https://fonts.googleapis.com/css2?family=Amiri:wght@400;700;900&family=Tajawal:wght@300;400;500;700;900&display=swap',
                            'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2',
                            'https://cdn.jsdelivr.net/npm/sweetalert2@11',
                            'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'
                        ]);
                    })
                );
            });
            self.addEventListener('fetch', e => {
                e.respondWith(
                    caches.match(e.request).then(res => res || fetch(e.request))
                );
            });
        `;
        const blob = new Blob([swContent], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl, { scope: './' }).then(reg => {
            console.log('Service Worker registered');
        }).catch(err => console.log('SW registration failed:', err));
    });
}

// الاستماع لحدث beforeinstallprompt
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const installBtn = document.getElementById('installBtn');
    if (installBtn) installBtn.style.display = 'inline-block';
});

// تهيئة التاريخ في حقل الجلسة
document.addEventListener('DOMContentLoaded', () => {
    const nextWeek = new Date(); nextWeek.setDate(nextWeek.getDate() + 7);
    const sDateField = document.getElementById('s_date');
    if (sDateField) sDateField.value = nextWeek.toISOString().slice(0, 16);
});

// تفويض الأحداث للنقر على بطاقات نتائج البحث
document.getElementById('searchResults').addEventListener('click', function(e) {
    const card = e.target.closest('.case-card[data-case-id]');
    if (!card) return;
    if (e.target.closest('button')) return;
    const caseId = card.getAttribute('data-case-id');
    if (caseId) openCaseDetails(caseId);
});

// تحسين ظهور زر تثبيت PWA
(function enhancePWA() {
    const installBtn = document.getElementById('installBtn');
    if (!installBtn) return;
    if (window.matchMedia('(display-mode: standalone)').matches) {
        installBtn.style.display = 'none';
    } else {
        if ('onbeforeinstallprompt' in window) {
            // سيتم إظهار الزر عند الحدث
        } else {
            installBtn.style.display = 'inline-block';
        }
    }
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
