<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <!-- Ù…Ù†Ø¹ Ù…Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ø£Ø±Ø´ÙØ© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <meta name="robots" content="noindex, nofollow">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ù„ØªØ­Ø±ÙŠØ± -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0f172a;
            --panel-bg: rgba(30, 41, 59, 0.9); /* Ø®Ù„ÙÙŠØ© Ø£ÙƒØ«Ø± ÙƒØ«Ø§ÙØ© */
            --gold-primary: #d4af37;
            --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
        }
        
        body { font-family: 'Tajawal', sans-serif; background-color: #020617; color: #e2e8f0; overflow-x: hidden; background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 80%); }
        .serif-font { font-family: 'Amiri', serif; }
        
        .gold-text { background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        
        /* ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø­Ø±Ø± Ù„Ù„Ù…Ø­Ø§Ù…ÙŠÙ† */
        .ql-toolbar { background: #1e293b !important; border-radius: 8px 8px 0 0 !important; border: 1px solid rgba(255,255,255,0.1) !important; direction: ltr; }
        .ql-toolbar button { filter: invert(1); }
        .ql-container { background: #ffffff !important; color: #000 !important; border-radius: 0 0 8px 8px !important; min-height: 600px; font-size: 1.25rem; border: none !important; }
        .ql-editor { text-align: right; direction: rtl; font-family: 'Amiri', serif; line-height: 2.2; padding: 3rem; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù‚Ø§Ù„ */
        .ql-editor h2 { color: #1e3a8a; border-bottom: 2px solid #d4af37; padding-bottom: 8px; margin-top: 35px; margin-bottom: 15px; font-weight: bold; font-size: 1.6em; }
        .ql-editor p { margin-bottom: 15px; text-align: justify; }
        .ql-editor ul { padding-right: 20px; }
        
        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(12px); border: 1px solid rgba(212, 175, 55, 0.15); border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4); }
        
        .input-pro { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 12px; color: white; width: 100%; transition: all 0.3s; }
        .input-pro:focus { border-color: var(--gold-primary); box-shadow: 0 0 15px rgba(212, 175, 55, 0.15); outline: none; }
        
        .btn-royal { background: var(--gold-gradient); color: #0f172a; font-weight: bold; padding: 10px 24px; border-radius: 6px; transition: 0.3s; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Amiri', serif; font-size: 1.1em; }
        .btn-royal:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(191, 149, 63, 0.4); }
        .btn-royal:disabled { opacity: 0.7; cursor: wait; filter: grayscale(1); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
    </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ -->
<div id="lock-screen" class="fixed inset-0 z-[9999] bg-[#020617] flex items-center justify-center p-4">
    <div class="glass-panel p-10 max-w-md w-full text-center border-t-2 border-yellow-600 shadow-2xl">
        <div class="mb-6"><i class="fas fa-scale-balanced text-6xl gold-text"></i></div>
        <h2 class="text-3xl font-bold text-white mb-2 serif-font">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± | Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
        <p class="text-yellow-600/80 mb-8 text-xs tracking-[0.2em]">ALMOSTSHAR LEGAL DASHBOARD</p>
        <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="input-pro text-center text-xl mb-6">
        <button onclick="checkPass()" class="btn-royal w-full py-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<div id="dashboard" class="hidden flex flex-col min-h-screen">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <header class="border-b border-white/5 bg-[#0f172a]/95 backdrop-blur-md sticky top-0 z-50 shadow-lg">
        <div class="max-w-[1800px] mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-university text-yellow-500 text-xl"></i>
                <div>
                    <h1 class="font-bold text-lg text-white serif-font">Ù…Ø¤Ø³Ø³Ø© Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ù…ÙŠØ¯</h1>
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                        <span class="text-[10px] text-gray-400">Ù…ØªØµÙ„: almostshar.vercel.app</span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="toggleSettings()" class="bg-slate-800 hover:bg-slate-700 text-gray-300 px-3 py-2 rounded text-xs transition border border-white/10">
                    <i class="fas fa-key"></i> Ø§Ù„Ù…ÙØ§ØªÙŠØ­
                </button>
                <button onclick="saveToGitHub()" id="publish-btn" class="btn-royal text-sm px-6">
                    <i class="fas fa-globe"></i> Ù†Ø´Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                </button>
            </div>
        </div>
    </header>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div id="settings-panel" class="hidden fixed inset-0 z-40 bg-black/80 backdrop-blur-sm flex justify-end">
        <div class="w-full max-w-md bg-[#1e293b] h-full p-8 shadow-2xl border-l border-yellow-500/20 overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xl font-bold text-white serif-font">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø¨Ø· (API)</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-6">
                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ -->
                <div class="p-4 bg-black/20 rounded-lg border border-white/5">
                    <h4 class="text-yellow-500 text-xs font-bold mb-3">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (GitHub Repo)</h4>
                    <div class="space-y-3">
                        <input type="text" id="repoOwner" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ (Owner)" class="input-pro text-xs" value="malegal">
                        <input type="text" id="repoName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Repo)" class="input-pro text-xs" value="mahmoud-legal">
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-yellow-500 mb-2 font-bold">OpenRouter Key:</label>
                    <input type="password" id="orKey" placeholder="sk-or-v1-..." class="input-pro font-mono text-xs">
                </div>
                <div>
                    <label class="block text-xs text-yellow-500 mb-2 font-bold">GitHub Token:</label>
                    <input type="password" id="ghToken" placeholder="ghp_..." class="input-pro font-mono text-xs">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-2">Ù…Ø¹Ø±Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Model ID):</label>
                    <input type="text" id="modelId" value="riverflow-v2-pro" class="input-pro font-mono text-xs text-gray-400">
                </div>
                <button onclick="saveKeys()" class="btn-royal w-full py-2 mt-4">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
        </div>
    </div>

    <main class="flex-grow p-6 max-w-[1800px] mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Ø§Ù„Ù…Ø­Ø±Ø± (Ø§Ù„ÙˆØ³Ø·) -->
        <div class="lg:col-span-9 space-y-4">
            <div class="glass-panel p-6 relative min-h-[85vh]">
                <!-- Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ø­Ø±Ø± -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-4">
                    <div class="w-full md:w-2/3">
                         <input type="text" id="postTitle" placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ (Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„ÙŠØ© Ø§Ù„ØªÙ‚ØµÙŠØ±ÙŠØ©...)" 
                           class="w-full bg-transparent text-3xl font-bold text-white placeholder-gray-600 border-b border-gray-700 focus:border-yellow-500 outline-none pb-3 serif-font transition-all">
                    </div>
                    <button onclick="aiLegalDraft()" id="ai-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-lg text-sm shadow-xl transition flex items-center gap-2 whitespace-nowrap border border-indigo-400/30 w-full md:w-auto justify-center">
                        <i class="fas fa-robot text-lg"></i> 
                        <div class="text-right">
                            <span class="block font-bold">Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ Ø§Ù„Ø¢Ù„ÙŠ</span>
                            <span class="block text-[9px] opacity-80">Riverflow V2 Pro</span>
                        </div>
                    </button>
                </div>

                <div class="bg-white rounded-b-lg overflow-hidden shadow-2xl h-full border-t-4 border-yellow-500">
                    <div id="editor"></div>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ (Ø§Ù„ÙŠØ³Ø§Ø±) -->
        <div class="lg:col-span-3 space-y-4">
            <div class="glass-panel p-5">
                <h3 class="text-sm font-bold text-yellow-500 mb-4 border-b border-white/10 pb-2 serif-font">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø± (Vercel)</h3>
                
                <div class="space-y-4">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('imgInput').click()">
                        <input type="file" id="imgInput" class="hidden" accept="image/*">
                        <div class="h-40 w-full border-2 border-dashed border-gray-600 rounded-lg flex flex-col items-center justify-center text-gray-500 group-hover:border-yellow-500 transition bg-black/20 overflow-hidden">
                            <img id="previewImg" class="absolute inset-0 w-full h-full object-cover hidden">
                            <i class="fas fa-image text-3xl mb-2"></i>
                            <span class="text-xs">ØµÙˆØ±Ø© Ø¨Ø§Ø±Ø²Ø©</span>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] text-gray-400 block mb-1">Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø§Ø¦Ù… (Slug)</label>
                        <input type="text" id="slug" placeholder="example-article" class="input-pro text-xs text-left" dir="ltr">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 block mb-1">ÙˆØµÙ Ø§Ù„Ù…ÙŠØªØ§ (Meta Description)</label>
                        <textarea id="excerpt" rows="4" placeholder="Ù…Ù„Ø®Øµ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø¬ÙˆØ¬Ù„..." class="input-pro text-xs leading-relaxed"></textarea>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-5 flex flex-col h-[400px]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-white serif-font">Ø§Ù„Ø£Ø±Ø´ÙŠÙ (GitHub)</h3>
                    <button onclick="loadArticles()" class="text-yellow-500 hover:rotate-180 transition duration-500"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div id="articlesList" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scroll">
                    <p class="text-center text-gray-500 text-xs py-10">Ù‚Ù… Ø¨Ø±Ø¨Ø· GitHub Ø£ÙˆÙ„Ø§Ù‹...</p>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    // --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ---
    // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
    const DEFAULT_OWNER = "malegal";
    const DEFAULT_REPO = "mahmoud-legal";
    
    let ghToken = localStorage.getItem('mahmoud_gh') || "";
    let orKey = localStorage.getItem('mahmoud_or') || "";
    let aiModelId = localStorage.getItem('mahmoud_model') || "riverflow-v2-pro"; 
    
    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    let repoOwner = localStorage.getItem('mahmoud_owner') || DEFAULT_OWNER;
    let repoName = localStorage.getItem('mahmoud_repo') || DEFAULT_REPO;

    let isEditing = false;
    let currentSha = null;
    let imageBase64 = null;

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­Ø±Ø±
    const quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Ø§ÙƒØªØ¨ Ø­ÙŠØ«ÙŠØ§Øª Ø§Ù„Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ù‡Ù†Ø§...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }, { 'direction': 'rtl' }],
                ['link', 'clean']
            ]
        }
    });
    quill.format('direction', 'rtl');
    quill.format('align', 'right');

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø¸Ø§Ù… ---

    function checkPass() {
        if(document.getElementById('adminPass').value === "mahmoud237") {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            document.getElementById('ghToken').value = ghToken;
            document.getElementById('orKey').value = orKey;
            document.getElementById('modelId').value = aiModelId;
            document.getElementById('repoOwner').value = repoOwner;
            document.getElementById('repoName').value = repoName;
            
            if(ghToken) loadArticles();
        } else { alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); }
    }

    function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }

    function saveKeys() {
        ghToken = document.getElementById('ghToken').value.trim();
        orKey = document.getElementById('orKey').value.trim();
        aiModelId = document.getElementById('modelId').value.trim();
        
        repoOwner = document.getElementById('repoOwner').value.trim();
        repoName = document.getElementById('repoName').value.trim();

        localStorage.setItem('mahmoud_gh', ghToken);
        localStorage.setItem('mahmoud_or', orKey);
        localStorage.setItem('mahmoud_model', aiModelId);
        localStorage.setItem('mahmoud_owner', repoOwner);
        localStorage.setItem('mahmoud_repo', repoName);

        alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
        toggleSettings();
        loadArticles();
    }

    // --- ğŸ¤– Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ Ø§Ù„Ø¢Ù„ÙŠ (Riverflow V2 Pro) ---
    async function aiLegalDraft() {
        const title = document.getElementById('postTitle').value;
        if(!orKey) return alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¶Ø¨Ø· Ù…ÙØªØ§Ø­ OpenRouter ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
        if(!title) return alert("âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹");

        const btn = document.getElementById('ai-btn');
        const oldContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin text-xl"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØµÙŠØ§ØºØ©...';
        btn.disabled = true;

        // Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ Ø§Ù„Ù…ØµØ±ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†
        const systemPrompt = `Ø£Ù†Øª Ù…Ø³ØªØ´Ø§Ø± Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ù…ØµØ±ÙŠ Ø¶Ù„ÙŠØ¹ØŒ ÙˆÙ…Ø­Ø§Ù…Ù Ø£Ù…Ø§Ù… Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ù†Ù‚Ø¶.
        Ø§Ù„Ù…Ù‡Ù…Ø©: ÙƒØªØ§Ø¨Ø© "Ø¨Ø­Ø« Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ù…Ù‚Ø§Ø±Ù†" Ø±ØµÙŠÙ† Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ù‚Ø¯Ù….
        
        Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØµØ§Ø±Ù…Ø© Ù„Ù„ØµÙŠØ§ØºØ©:
        1. Ø§Ù„Ø£Ø³Ù„ÙˆØ¨: Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙØµØ­Ù‰ Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©ØŒ Ø¬Ø²Ù„Ø©ØŒ Ø®Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø­Ø´Ùˆ ÙˆØ§Ù„Ø±ÙƒØ§ÙƒØ©.
        2. Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©: ÙŠØ¬Ø¨ Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ù…ÙˆÙ‚Ù Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ù…ØµØ±ÙŠ ÙˆØ§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„ÙØ±Ù†Ø³ÙŠ (Code civil des FranÃ§ais) ÙÙŠ ÙƒÙ„ Ù†Ù‚Ø·Ø© Ø¬ÙˆÙ‡Ø±ÙŠØ©.
        3. Ø§Ù„ØªØ¯Ù„ÙŠÙ„: Ø§Ø°ÙƒØ± Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠÙ† (Ø§Ù„Ù…ØµØ±ÙŠ ÙˆØ§Ù„ÙØ±Ù†Ø³ÙŠ) ÙˆØ£Ø­ÙƒØ§Ù… Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ù†Ù‚Ø¶ Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©.
        
        Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù…Ù‚Ø§Ù„ (HTML Format Only):
        - <h2>Ù…Ù‚Ø¯Ù…Ø© ÙˆØªØ£ØµÙŠÙ„</h2>: (Ø´Ø±Ø­ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… ÙÙŠ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠÙ†).
        - <h2>Ù…ÙˆÙ‚Ù Ø§Ù„Ù…Ø´Ø±Ø¹ Ø§Ù„Ù…ØµØ±ÙŠ</h2>: (Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯).
        - <h2>Ø§Ù„Ù†Ø¸Ø±Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„ÙØ±Ù†Ø³ÙŠ</h2>: (Ø£ÙˆØ¬Ù‡ Ø§Ù„Ø§ØªÙØ§Ù‚ ÙˆØ§Ù„Ø§Ø®ØªÙ„Ø§Ù).
        - <h2>ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ù†Ù‚Ø¶ Ø§Ù„Ù…ØµØ±ÙŠØ©</h2>: (Ø§Ù„Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ù…Ø³ØªÙ‚Ø±Ø©).
        - <h2>Ø§Ù„Ø®Ø§ØªÙ…Ø© ÙˆØ§Ù„Ø±Ø£ÙŠ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ</h2>.
        
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ø³ØªØ®Ø¯Ù… ÙˆØ³ÙˆÙ… HTML ÙÙ‚Ø· (h2, p, ul) ÙˆÙ„Ø§ ØªØ³ØªØ®Ø¯Ù… Markdown.`;

        try {
            console.log(`Connecting to OpenRouter via almostshar.vercel.app`);
            
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${orKey}`,
                    "Content-Type": "application/json",
                    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù€ Referer Ø¨Ø¯Ù‚Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ù…ÙˆØ«ÙˆÙ‚ÙŠØ© Ø§Ù„Ø·Ù„Ø¨
                    "HTTP-Referer": "https://almostshar.vercel.app/",
                    "X-Title": "Almostshar Legal Admin"
                },
                body: JSON.stringify({
                    "model": aiModelId,
                    "messages": [
                        {"role": "system", "content": systemPrompt},
                        {"role": "user", "content": `Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø§Ù„Ø¢Ù† Ø¨Ø¹Ù†ÙˆØ§Ù†: ${title}`}
                    ],
                    "temperature": 0.5, // Ø¯Ø±Ø¬Ø© Ø­Ø±Ø§Ø±Ø© Ù…Ù†Ø®ÙØ¶Ø© Ù„Ù„Ø¯Ù‚Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©
                    "max_tokens": 4000
                })
            });

            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);
            if (!data.choices || !data.choices[0]) throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¯ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬");

            let content = data.choices[0].message.content;
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙˆØ¯
            content = content.replace(/```html/g, '').replace(/```/g, '');
            quill.root.innerHTML = content;
            
            // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù€ Slug ÙˆØ§Ù„ÙˆØµÙ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            const slug = title.trim().replace(/\s+/g, '-').replace(/[^\u0600-\u06FFa-zA-Z0-9-]/g, '');
            document.getElementById('slug').value = slug;
            document.getElementById('excerpt').value = quill.getText().substring(0, 160) + "...";

            alert("âœ… ØªÙ…Øª Ø§Ù„ØµÙŠØ§ØºØ© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");

        } catch (error) {
            console.error(error);
            alert(`âŒ Ø®Ø·Ø£: ${error.message}`);
        } finally {
            btn.innerHTML = oldContent;
            btn.disabled = false;
        }
    }

    // --- Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ GitHub ---
    async function saveToGitHub() {
        if(!ghToken) return alert("âš ï¸ Ø£Ø¯Ø®Ù„ ØªÙˆÙƒÙ† GitHub");
        
        const title = document.getElementById('postTitle').value;
        const slug = document.getElementById('slug').value;
        const content = quill.root.innerHTML;
        const excerpt = document.getElementById('excerpt').value;

        if(!title || !slug) return alert("âš ï¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø±Ø§Ø¨Ø· (Slug) Ù…Ø·Ù„ÙˆØ¨Ø§Ù†");

        const btn = document.getElementById('publish-btn');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...';
        btn.disabled = true;

        try {
            // 1. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
            let imgPath = "images/default-law.jpg"; // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            if(imageBase64) {
                const imgName = `post-${Date.now()}.jpg`;
                // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ± Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù…Ø´Ø±ÙˆØ¹ Vercel
                await uploadFile(`images/posts/${imgName}`, imageBase64);
                imgPath = `images/posts/${imgName}`;
            }

            // 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Markdown (Jekyll/Hugo/Next.js Compatible)
            const mdContent = `---
title: "${title}"
date: "${new Date().toISOString()}"
description: "${excerpt}"
image: "${imgPath}"
layout: post
---
${content}`;

            const b64Content = btoa(unescape(encodeURIComponent(mdContent)));
            
            // 3. Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…Ø¬Ù„Ø¯ (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± blog/articles ÙÙŠ Ù…Ø³ØªÙˆØ¯Ø¹Ùƒ)
            const filePath = `blog/articles/${slug}.md`;
            
            const body = {
                message: isEditing ? `Update: ${title}` : `New: ${title}`,
                content: b64Content,
                sha: isEditing ? currentSha : undefined
            };

            const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${ghToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if(res.ok) {
                alert("âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ Vercel!");
                resetEditor();
                loadArticles();
            } else {
                const err = await res.json();
                throw new Error(err.message);
            }

        } catch (e) {
            alert(`âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±: ${e.message}`);
        } finally {
            btn.innerHTML = oldText;
            btn.disabled = false;
        }
    }

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
    async function uploadFile(path, content) {
        return fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${ghToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: "Image upload", content: content })
        });
    }

    async function loadArticles() {
        const list = document.getElementById('articlesList');
        if(!ghToken) return;
        
        list.innerHTML = '<p class="text-center text-gray-500 text-xs mt-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
        try {
            const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/blog/articles`, {
                headers: { 'Authorization': `token ${ghToken}` }
            });
            if(!res.ok) throw new Error("Connection Error");
            const files = await res.json();
            
            list.innerHTML = files.filter(f => f.name.endsWith('.md')).map(f => `
                <div class="flex items-center justify-between bg-white/5 p-3 rounded border border-white/5 hover:border-yellow-500/50 transition mb-2">
                    <span class="text-xs text-gray-300 truncate w-3/4">${decodeURIComponent(f.name.replace('.md', '').replace(/-/g, ' '))}</span>
                    <button onclick="editArticle('${f.path}', '${f.sha}')" class="text-yellow-500 hover:text-white px-2"><i class="fas fa-pen"></i></button>
                </div>
            `).join('');
        } catch (e) {
            list.innerHTML = `<p class="text-center text-red-400 text-xs mt-4">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª.<br>ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ÙˆØ§Ù„ØªÙˆÙƒÙ†.</p>`;
        }
    }

    async function editArticle(path, sha) {
        const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, {
            headers: { 'Authorization': `token ${ghToken}` }
        });
        const data = await res.json();
        const content = decodeURIComponent(escape(atob(data.content)));
        const parts = content.split('---');
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const titleMatch = parts[1].match(/title:\s*"(.*)"/);
        if(titleMatch) document.getElementById('postTitle').value = titleMatch[1];
        
        document.getElementById('slug').value = data.name.replace('.md', '');
        quill.root.innerHTML = parts.slice(2).join('---');
        
        isEditing = true;
        currentSha = sha;
        document.getElementById('publish-btn').innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetEditor() {
        document.getElementById('postTitle').value = '';
        document.getElementById('slug').value = '';
        document.getElementById('excerpt').value = '';
        quill.setContents([]);
        document.getElementById('previewImg').classList.add('hidden');
        isEditing = false;
        currentSha = null;
        document.getElementById('publish-btn').innerHTML = '<i class="fas fa-globe"></i> Ù†Ø´Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
    }

    document.getElementById('imgInput').addEventListener('change', function(e) {
        const r = new FileReader();
        r.onload = function(evt) {
            imageBase64 = evt.target.result.split(',')[1];
            document.getElementById('previewImg').src = evt.target.result;
            document.getElementById('previewImg').classList.remove('hidden');
        };
        r.readAsDataURL(e.target.files[0]);
    });
</script>
</body>
</html>
