<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المقالات | محمود عبد الحميد</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --gold: #bf953f; --dark: #020617; }
        body { background-color: var(--dark); color: white; font-family: 'Tajawal', sans-serif; }
        .serif-font { font-family: 'Amiri', serif; }
        .gold-border { border: 1px solid rgba(191, 149, 63, 0.3); }
        .ql-container { background: rgba(255,255,255,0.05); border-radius: 0 0 12px 12px; height: 300px; color: white; font-size: 16px; text-align: right; }
        .ql-toolbar { background: #f3f4f6; border-radius: 12px 12px 0 0; }
        .ql-editor.ql-blank::before { color: rgba(255,255,255,0.3); right: 15px; left: auto; }
        .article-card { background: rgba(255,255,255,0.03); transition: all 0.3s ease; }
    </style>
</head>
<body class="min-h-screen">

    <div id="lock-screen" class="fixed inset-0 z-[1000] bg-[#020617] flex flex-col items-center justify-center p-6 text-center">
        <div class="w-full max-w-sm">
            <i class="fas fa-shield-halved text-6xl text-[#bf953f] mb-6"></i>
            <h2 class="text-2xl font-bold mb-6 serif-font">دخول الإدارة الآمن</h2>
            <input type="password" id="adminPass" placeholder="كلمة المرور" class="w-full bg-slate-900 border-2 border-[#bf953f]/30 p-4 rounded-2xl text-center outline-none focus:border-[#bf953f] mb-4 text-white">
            <button onclick="checkPass()" class="w-full bg-[#bf953f] text-black font-black py-4 rounded-2xl shadow-xl hover:scale-105 transition">دخول</button>
        </div>
    </div>

    <div id="admin-content" class="hidden">
        <nav class="border-b border-white/5 bg-black/20 p-4 sticky top-0 z-50 backdrop-blur-md">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <a href="index.html" class="text-gray-400 hover:text-[#bf953f] flex items-center gap-2 transition font-bold">
                    <i class="fas fa-home"></i> <span>الرئيسية</span>
                </a>
                <h1 class="text-[#bf953f] font-black serif-font text-lg">لوحة تحكم الأستاذ محمود</h1>
                <div id="connection-indicator" class="flex items-center gap-2 bg-red-500/10 px-3 py-1 rounded-full border border-red-500/20">
                    <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                    <span class="text-[10px] text-red-500 font-bold uppercase">Offline</span>
                </div>
            </div>
        </nav>

        <main class="max-w-6xl mx-auto p-4 md:p-8">
            <section class="mb-12">
                <div class="bg-white/5 p-4 md:p-8 rounded-3xl gold-border shadow-2xl">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-edit text-[#bf953f]"></i> <span id="editor-status-text">إضافة مقال جديد</span>
                    </h2>

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div class="space-y-2">
                            <label class="text-xs text-gray-400 mr-2 italic">مفتاح الوصول (GitHub Token)</label>
                            <input type="password" id="ghToken" placeholder="Personal Access Token" class="w-full bg-black/40 border border-white/10 p-3 rounded-xl outline-none focus:border-[#bf953f]">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs text-gray-400 mr-2 italic">اسم الملف الرابط (بالإنجليزي)</label>
                            <input type="text" id="fileName" placeholder="مثلاً: inheritance-law" class="w-full bg-black/40 border border-white/10 p-3 rounded-xl outline-none focus:border-[#bf953f]">
                        </div>
                    </div>

                    <div class="space-y-4 mb-6">
                        <input type="text" id="postTitle" placeholder="عنوان المقال القانوني..." class="w-full bg-black/40 border border-white/10 p-4 rounded-xl text-xl font-bold outline-none focus:border-[#bf953f]">
                        
                        <div class="relative">
                            <i class="fas fa-image absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                            <input type="text" id="postImage" placeholder="رابط صورة المقال (اختياري)" class="w-full bg-black/40 border border-white/10 p-4 pl-12 rounded-xl outline-none focus:border-[#bf953f]">
                        </div>
                    </div>
                    
                    <div id="editor-container" class="mb-6"><div id="editor"></div></div>

                    <div class="flex gap-4">
                        <button onclick="publish()" id="pubBtn" class="flex-[2] bg-[#bf953f] text-black font-black py-4 rounded-2xl text-lg hover:shadow-lg hover:shadow-[#bf953f]/20 transition active:scale-95">
                            <i class="fas fa-paper-plane ml-2"></i> حفظ ونشر المقال
                        </button>
                        <button onclick="resetEditor()" id="reset-btn" class="flex-1 bg-white/5 text-gray-400 py-4 rounded-2xl hover:bg-red-500/10 hover:text-red-500 transition">
                            إلغاء
                        </button>
                    </div>
                </div>
            </section>

            <section>
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <i class="fas fa-folder-open text-[#bf953f]"></i> المقالات الحالية
                </h3>
                <div id="articles-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </section>
        </main>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        let isEditing = false;
        let currentFileSha = null;

        // كلمة السر الجديدة
        function checkPass() {
            const pass = document.getElementById('adminPass').value;
            if(pass === "mahmoud237") {
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
            } else { alert("عذراً، كلمة المرور خاطئة"); }
        }

        var quill = new Quill('#editor', {
            theme: 'snow',
            modules: { toolbar: [[{'header': [1, 2, false]}], ['bold', 'italic'], [{'list': 'ordered'}, {'list': 'bullet'}], [{'direction': 'rtl'}], ['link', 'image', 'clean']] }
        });

        const owner = "malegal";
        const repo = "mahmoud-legal";

        async function publish() {
            const token = document.getElementById('ghToken').value;
            const title = document.getElementById('postTitle').value;
            const name = document.getElementById('fileName').value;
            const imageUrl = document.getElementById('postImage').value || "images/blog-bg.jpg"; // صورة افتراضية
            const content = quill.root.innerHTML;
            const btn = document.getElementById('pubBtn');

            if(!token || !title || !name) { alert("تأكد من إدخال التوكن، العنوان، واسم الملف"); return; }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch animate-spin"></i> جاري الحفظ...';

            const path = `blog/articles/${name.endsWith('.md') ? name : name + '.md'}`;
            
            // هيكلة ملف الـ MD ليشمل الصورة في البداية
            const mdContent = `---
title: ${title}
image: ${imageUrl}
---
# ${title}

![صورة المقال](${imageUrl})

${content}`;

            const body = {
                message: isEditing ? `تعديل المقال: ${title}` : `نشر مقال جديد: ${title}`,
                content: btoa(unescape(encodeURIComponent(mdContent)))
            };
            if(isEditing && currentFileSha) body.sha = currentFileSha;

            try {
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if(res.ok) {
                    alert("تمت العملية بنجاح!");
                    resetEditor();
                    loadExistingArticles();
                } else { throw new Error(); }
            } catch (e) { alert("فشل الاتصال بـ GitHub. تأكد من صحة التوكن."); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane ml-2"></i> حفظ ونشر المقال'; }
        }

        async function loadExistingArticles() {
            const token = document.getElementById('ghToken').value;
            if(!token) return;
            
            try {
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/blog/articles`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                const files = await res.json();
                
                const list = document.getElementById('articles-list');
                list.innerHTML = '';
                
                files.filter(f => f.name.endsWith('.md')).forEach(file => {
                    const card = document.createElement('div');
                    card.className = 'article-card p-4 rounded-2xl border border-white/10 hover:border-[#bf953f]/50 transition';
                    card.innerHTML = `
                        <p class="text-xs text-gray-500 mb-2 truncate">${file.name}</p>
                        <div class="flex gap-2">
                            <button onclick="editArticle('${file.path}', '${file.sha}')" class="flex-1 bg-white/5 py-2 rounded-lg text-xs hover:bg-[#bf953f] hover:text-black transition">تعديل</button>
                            <button onclick="deleteArticle('${file.path}', '${file.sha}')" class="flex-1 bg-red-500/10 text-red-500 py-2 rounded-lg text-xs hover:bg-red-500 hover:text-white transition">حذف</button>
                        </div>
                    `;
                    list.appendChild(card);
                });
                
                document.getElementById('connection-indicator').className = 'flex items-center gap-2 bg-green-500/10 px-3 py-1 rounded-full border border-green-500/20';
                document.getElementById('connection-indicator').innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full"></span><span class="text-[10px] text-green-500 font-bold uppercase">Connected</span>';
            } catch (e) {}
        }

        async function editArticle(path, sha) {
            const token = document.getElementById('ghToken').value;
            try {
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                const data = await res.json();
                const rawContent = decodeURIComponent(escape(atob(data.content)));
                
                // استخراج البيانات من الملف
                const titleMatch = rawContent.match(/^# (.*)\n/m);
                const imgMatch = rawContent.match(/!\[.*\]\((.*)\)/);
                const body = rawContent.split('\n\n').slice(2).join('\n\n');

                document.getElementById('postTitle').value = titleMatch ? titleMatch[1] : '';
                document.getElementById('postImage').value = imgMatch ? imgMatch[1] : '';
                document.getElementById('fileName').value = data.name;
                document.getElementById('fileName').disabled = true;
                quill.root.innerHTML = body;
                
                isEditing = true;
                currentFileSha = sha;
                document.getElementById('editor-status-text').innerText = "تعديل مقال منشور";
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) { alert("فشل في جلب محتوى المقال"); }
        }

        async function deleteArticle(path, sha) {
            if(!confirm("سيتم حذف المقال نهائياً من الموقع، هل أنت متأكد؟")) return;
            const token = document.getElementById('ghToken').value;
            try {
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "حذف مقال", sha: sha })
                });
                loadExistingArticles();
            } catch (e) { alert("فشل الحذف"); }
        }

        function resetEditor() {
            isEditing = false;
            currentFileSha = null;
            document.getElementById('postTitle').value = '';
            document.getElementById('postImage').value = '';
            document.getElementById('fileName').value = '';
            document.getElementById('fileName').disabled = false;
            quill.root.innerHTML = '';
            document.getElementById('editor-status-text').innerText = "إضافة مقال جديد";
        }

        document.getElementById('ghToken').addEventListener('blur', loadExistingArticles);
    </script>
</body>
</html>
