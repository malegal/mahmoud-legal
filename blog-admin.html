<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة إدارة المدونة | نظام الملفات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #020617;
            --gold-gradient: linear-gradient(135deg, #bf953f 0%, #fcf6ba 45%, #b38728 50%, #fbf5b7 55%, #aa771c 100%);
            --gold-solid: #bf953f;
        }
        
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: var(--primary-dark); 
            color: #f8fafc;
        }
        
        .gold-text { 
            background: var(--gold-gradient); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text;
        }
        
        .gold-btn { 
            background: var(--gold-gradient); 
            color: #1a1a1a; 
            font-weight: 800; 
            transition: all 0.4s ease; 
        }
        
        .gold-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(191, 149, 63, 0.3); 
        }
        
        .card-glass { 
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(191, 149, 63, 0.15); 
            border-radius: 1.5rem; 
        }
        
        .editor-container {
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .editor-toolbar {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .editor-content {
            min-height: 300px;
            font-family: 'Courier New', monospace;
        }
        
        .file-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-item:hover {
            background: rgba(191, 149, 63, 0.1);
            transform: translateX(-5px);
        }
        
        .upload-area {
            border: 2px dashed rgba(191, 149, 63, 0.3);
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: var(--gold-solid);
            background: rgba(191, 149, 63, 0.05);
        }
        
        .modal-backdrop {
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- نافذة تسجيل الدخول -->
    <div id="loginOverlay" class="fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
        <div class="bg-black/90 border-2 border-gold-solid rounded-3xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <i class="fas fa-lock text-4xl gold-text mb-4"></i>
                <h2 class="text-2xl font-bold gold-text mb-2">لوحة إدارة المدونة</h2>
                <p class="text-white/70">أدخل كلمة المرور للوصول</p>
            </div>
            
            <div class="space-y-4">
                <input type="password" 
                       id="passwordInput"
                       class="w-full p-4 rounded-xl bg-black/50 text-white border border-gold-solid/30 outline-none text-center text-xl"
                       placeholder="••••••••"
                       maxlength="20"
                       onkeypress="if(event.key=='Enter') checkPassword()">
                
                <div id="errorMessage" class="text-red-400 text-center hidden">
                    <i class="fas fa-exclamation-triangle ml-2"></i>
                    كلمة المرور غير صحيحة
                </div>
                
                <button onclick="checkPassword()" 
                        class="gold-btn w-full py-4 rounded-xl text-lg font-bold">
                    <i class="fas fa-sign-in-alt ml-2"></i>
                    دخول
                </button>
            </div>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <div id="mainContent" class="hidden">
        <!-- شريط التنقل -->
        <nav class="bg-black/95 border-b border-gold-solid/20 py-4 px-6">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <a href="index.html" class="text-xl gold-text font-bold">
                        <i class="fas fa-arrow-right ml-2"></i>
                        العودة للموقع
                    </a>
                </div>
                <div class="text-center">
                    <h1 class="text-2xl font-bold gold-text">
                        <i class="fas fa-newspaper ml-2"></i>
                        نظام إدارة المقالات
                    </h1>
                    <p class="text-white/60 text-sm mt-1">نظام الملفات - حفظ مباشر في .md</p>
                </div>
                <div>
                    <button onclick="logout()" 
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition">
                        <i class="fas fa-sign-out-alt ml-2"></i>
                        خروج
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 py-8">
            <!-- الإحصائيات -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="card-glass p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/60 text-sm">مقالات</p>
                            <p id="articlesCount" class="text-2xl font-bold gold-text">0</p>
                        </div>
                        <i class="fas fa-file-alt text-2xl text-gold-solid/50"></i>
                    </div>
                </div>
                
                <div class="card-glass p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/60 text-sm">ملفات MD</p>
                            <p id="mdFilesCount" class="text-2xl font-bold text-blue-400">0</p>
                        </div>
                        <i class="fab fa-markdown text-2xl text-blue-400/50"></i>
                    </div>
                </div>
                
                <div class="card-glass p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/60 text-sm">صور</p>
                            <p id="imagesCount" class="text-2xl font-bold text-green-400">0</p>
                        </div>
                        <i class="fas fa-images text-2xl text-green-400/50"></i>
                    </div>
                </div>
                
                <div class="card-glass p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/60 text-sm">آخر تحديث</p>
                            <p id="lastUpdate" class="text-lg font-bold text-white">-</p>
                        </div>
                        <i class="fas fa-clock text-2xl text-purple-400/50"></i>
                    </div>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <!-- القائمة الجانبية -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- زر إنشاء مقال -->
                    <div class="card-glass p-6">
                        <button onclick="openCreateArticleModal()" 
                                class="gold-btn w-full py-4 rounded-xl text-lg font-bold">
                            <i class="fas fa-plus-circle ml-2"></i>
                            إنشاء مقال جديد
                        </button>
                    </div>

                    <!-- قائمة المقالات -->
                    <div class="card-glass p-6">
                        <h2 class="text-xl font-bold gold-text mb-4">
                            <i class="fas fa-list ml-2"></i>
                            المقالات الحالية
                        </h2>
                        
                        <div class="space-y-2 max-h-96 overflow-y-auto" id="articlesList">
                            <!-- سيتم ملؤها بالمقالات -->
                        </div>
                    </div>

                    <!-- إدارة الصور -->
                    <div class="card-glass p-6">
                        <h2 class="text-xl font-bold gold-text mb-4">
                            <i class="fas fa-images ml-2"></i>
                            إدارة الصور
                        </h2>
                        
                        <div class="upload-area rounded-xl p-6 text-center mb-4 cursor-pointer"
                             onclick="document.getElementById('imageUpload').click()"
                             id="dropArea">
                            <i class="fas fa-cloud-upload-alt text-3xl gold-text mb-2"></i>
                            <p class="text-white/70">اسحب وأفلت الصور هنا</p>
                            <p class="text-white/50 text-sm">أو انقر للاختيار</p>
                        </div>
                        
                        <input type="file" 
                               id="imageUpload" 
                               accept="image/*" 
                               multiple 
                               class="hidden" 
                               onchange="handleImageUpload(event)">
                        
                        <div class="space-y-2 max-h-64 overflow-y-auto" id="imagesList">
                            <!-- سيتم ملؤها بالصور -->
                        </div>
                    </div>
                </div>

                <!-- المحرر الرئيسي -->
                <div class="lg:col-span-2">
                    <div id="editorContainer" class="card-glass p-6 hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold gold-text" id="editorTitle">
                                <i class="fas fa-edit ml-2"></i>
                                محرر المقال
                            </h2>
                            <div class="flex gap-2">
                                <button onclick="saveArticle()" 
                                        class="gold-btn px-4 py-2 rounded-lg font-bold">
                                    <i class="fas fa-save ml-2"></i>
                                    حفظ
                                </button>
                                <button onclick="closeEditor()" 
                                        class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition">
                                    <i class="fas fa-times ml-2"></i>
                                    إلغاء
                                </button>
                            </div>
                        </div>

                        <!-- معلومات المقال -->
                        <div class="mb-6">
                            <input type="text" 
                                   id="articleTitleInput"
                                   class="w-full p-4 rounded-xl bg-black/50 text-white border border-gold-solid/30 outline-none text-xl mb-4"
                                   placeholder="عنوان المقال">
                            
                            <div class="grid grid-cols-2 gap-4">
                                <input type="date" 
                                       id="articleDateInput"
                                       class="p-3 rounded-xl bg-black/50 text-white border border-white/10 outline-none">
                                
                                <input type="text" 
                                       id="articleSlugInput"
                                       class="p-3 rounded-xl bg-black/50 text-white border border-white/10 outline-none"
                                       placeholder="الرابط (slug)">
                            </div>
                        </div>

                        <!-- أدوات المحرر -->
                        <div class="editor-toolbar p-3 rounded-xl mb-4 flex flex-wrap gap-2">
                            <button onclick="formatText('bold')" 
                                    class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button onclick="formatText('italic')" 
                                    class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button onclick="formatText('h1')" 
                                    class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white">
                                <i class="fas fa-heading"></i> 1
                            </button>
                            <button onclick="formatText('h2')" 
                                    class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white">
                                <i class="fas fa-heading"></i> 2
                            </button>
                            <button onclick="formatText('link')" 
                                    class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white">
                                <i class="fas fa-link"></i>
                            </button>
                            <button onclick="formatText('image')" 
                                    class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white">
                                <i class="fas fa-image"></i>
                            </button>
                            <button onclick="formatText('code')" 
                                    class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white">
                                <i class="fas fa-code"></i>
                            </button>
                            <button onclick="formatText('list')" 
                                    class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white">
                                <i class="fas fa-list"></i>
                            </button>
                            <button onclick="insertImageFromGallery()" 
                                    class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                                <i class="fas fa-image ml-2"></i> معرض الصور
                            </button>
                        </div>

                        <!-- محتوى المقال -->
                        <textarea id="articleContent" 
                                  class="editor-content w-full p-4 rounded-xl bg-black/50 text-white border border-white/10 outline-none font-mono"
                                  rows="20"
                                  placeholder="اكتب محتوى المقال هنا بصيغة Markdown..."></textarea>

                        <!-- معاينة -->
                        <div class="mt-6">
                            <h3 class="text-lg font-bold text-white mb-3">معاينة:</h3>
                            <div id="previewContent" 
                                 class="p-4 rounded-xl bg-black/30 border border-white/10 min-h-40">
                            </div>
                        </div>
                    </div>

                    <!-- الشاشة الافتراضية -->
                    <div id="defaultView" class="card-glass p-12 text-center">
                        <i class="fas fa-newspaper text-6xl gold-text mb-6"></i>
                        <h2 class="text-2xl font-bold gold-text mb-4">مرحباً في نظام إدارة المقالات</h2>
                        <p class="text-white/70 mb-8">اختر مقالاً للتعديل أو أنشئ مقالاً جديداً</p>
                        <button onclick="openCreateArticleModal()" 
                                class="gold-btn px-8 py-3 rounded-xl text-lg font-bold">
                            <i class="fas fa-plus-circle ml-2"></i>
                            بدء مقال جديد
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة معرض الصور -->
    <div id="imageGalleryModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
        <div class="bg-black/90 border-2 border-gold-solid rounded-3xl p-6 max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold gold-text">
                    <i class="fas fa-images ml-2"></i>
                    معرض الصور
                </h2>
                <button onclick="closeImageGallery()" 
                        class="text-2xl gold-text hover:rotate-90 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 overflow-y-auto flex-1 p-2" id="galleryImages">
                <!-- سيتم ملؤها بالصور -->
            </div>
            
            <div class="mt-6 pt-6 border-t border-white/10">
                <button onclick="closeImageGallery()" 
                        class="w-full py-3 bg-white/10 hover:bg-white/20 text-white rounded-xl transition">
                    إغلاق
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== تهيئة النظام ==========
        const MASTER_PASSWORD = 'mahmoud237';
        let currentArticle = null;
        let articlesData = [];
        let imagesList = [];

        document.addEventListener('DOMContentLoaded', function() {
            checkPreviousSession();
            document.getElementById('passwordInput').focus();
            
            // إعداد سحب وإفلات الصور
            setupDragAndDrop();
            
            // تحديث المعاينة عند الكتابة
            document.getElementById('articleContent').addEventListener('input', updatePreview);
        });

        // ========== نظام المصادقة ==========
        function checkPreviousSession() {
            const lastSession = localStorage.getItem('admin_last_session');
            if (lastSession) {
                const sessionTime = new Date(lastSession);
                const now = new Date();
                const diffHours = (now - sessionTime) / (1000 * 60 * 60);
                
                if (diffHours < 1) {
                    const storedPassword = localStorage.getItem('admin_temp_password');
                    if (storedPassword === MASTER_PASSWORD) {
                        grantAccess();
                    }
                }
            }
        }

        function checkPassword() {
            const password = document.getElementById('passwordInput').value.trim();
            const errorMessage = document.getElementById('errorMessage');
            
            if (password === MASTER_PASSWORD) {
                localStorage.setItem('admin_last_session', new Date().toISOString());
                localStorage.setItem('admin_temp_password', password);
                grantAccess();
            } else {
                errorMessage.classList.remove('hidden');
                setTimeout(() => errorMessage.classList.add('hidden'), 3000);
                document.getElementById('passwordInput').value = '';
            }
        }

        function grantAccess() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContent').classList.remove('hidden');
            loadArticles();
            loadImages();
            updateStats();
        }

        function logout() {
            if (confirm('هل تريد تسجيل الخروج؟')) {
                localStorage.removeItem('admin_temp_password');
                window.location.href = 'blog-admin.html';
            }
        }

        // ========== إدارة المقالات ==========
        async function loadArticles() {
            try {
                // تحميل الفهرس
                const response = await fetch('blog/data/articles.json');
                if (response.ok) {
                    const data = await response.json();
                    articlesData = data.articles || [];
                    displayArticlesList();
                }
                
                // حساب عدد ملفات MD
                const mdResponse = await fetch('blog/articles/');
                if (mdResponse.ok) {
                    const text = await mdResponse.text();
                    const parser = new DOMParser();
                    const html = parser.parseFromString(text, 'text/html');
                    const links = html.querySelectorAll('a[href$=".md"]');
                    document.getElementById('mdFilesCount').textContent = links.length;
                }
                
            } catch (error) {
                console.error('Error loading articles:', error);
            }
        }

        function displayArticlesList() {
            const container = document.getElementById('articlesList');
            
            if (articlesData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-white/50">
                        <i class="fas fa-newspaper text-2xl mb-2"></i>
                        <p>لا توجد مقالات بعد</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = articlesData.map(article => `
                <div class="file-item p-3 rounded-lg border border-white/10 hover:border-gold-solid/30 flex justify-between items-center"
                     onclick="openArticle('${article.id}')">
                    <div class="flex items-center gap-3">
                        <i class="fab fa-markdown text-blue-400"></i>
                        <div>
                            <h4 class="font-bold text-white">${article.title}</h4>
                            <p class="text-white/50 text-sm">${article.date}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editArticle('${article.id}')" 
                                class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteArticle('${article.id}', event)" 
                                class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            document.getElementById('articlesCount').textContent = articlesData.length;
        }

        async function openArticle(articleId) {
            try {
                const article = articlesData.find(a => a.id === articleId);
                if (!article) throw new Error('المقال غير موجود');

                // تحميل محتوى ملف MD
                const response = await fetch(`blog/articles/${articleId}.md`);
                if (!response.ok) throw new Error('تعذر تحميل الملف');

                const content = await response.text();
                
                // فتح المحرر
                document.getElementById('defaultView').classList.add('hidden');
                document.getElementById('editorContainer').classList.remove('hidden');
                document.getElementById('editorTitle').innerHTML = `<i class="fas fa-edit ml-2"></i> تحرير: ${article.title}`;
                
                // تعبئة البيانات
                document.getElementById('articleTitleInput').value = article.title;
                document.getElementById('articleDateInput').value = article.date;
                document.getElementById('articleSlugInput').value = articleId;
                document.getElementById('articleContent').value = content;
                
                currentArticle = { ...article, id: articleId };
                
                updatePreview();
                
            } catch (error) {
                showNotification('خطأ: ' + error.message, 'error');
            }
        }

        function openCreateArticleModal() {
            document.getElementById('defaultView').classList.add('hidden');
            document.getElementById('editorContainer').classList.remove('hidden');
            document.getElementById('editorTitle').innerHTML = '<i class="fas fa-plus-circle ml-2"></i> مقال جديد';
            
            // إعادة تعيين الحقول
            document.getElementById('articleTitleInput').value = '';
            document.getElementById('articleDateInput').value = new Date().toISOString().split('T')[0];
            document.getElementById('articleSlugInput').value = '';
            document.getElementById('articleContent').value = '';
            
            currentArticle = null;
            
            updatePreview();
        }

        function closeEditor() {
            if (confirm('هل تريد إغلاق المحرر؟ التغييرات غير المحفوظة ستفقد.')) {
                document.getElementById('editorContainer').classList.add('hidden');
                document.getElementById('defaultView').classList.remove('hidden');
                currentArticle = null;
            }
        }

        // ========== حفظ المقال ==========
        async function saveArticle() {
            const title = document.getElementById('articleTitleInput').value.trim();
            const date = document.getElementById('articleDateInput').value;
            const slug = document.getElementById('articleSlugInput').value.trim() || generateSlug(title);
            const content = document.getElementById('articleContent').value.trim();

            if (!title || !content) {
                showNotification('الرجاء ملء العنوان والمحتوى', 'warning');
                return;
            }

            try {
                // إنشاء/تحديث ملف MD
                await saveMarkdownFile(slug, content, title, date);
                
                // تحديث الفهرس
                await updateArticlesIndex(slug, title, date, content);
                
                showNotification('تم حفظ المقال بنجاح!', 'success');
                loadArticles();
                updateStats();
                
            } catch (error) {
                showNotification('خطأ في الحفظ: ' + error.message, 'error');
            }
        }

        async function saveMarkdownFile(slug, content, title, date) {
            // في الواقع، هنا ستحتاج إلى رفع الملف إلى الخادم
            // لكن بما أننا في GitHub Pages، سننشئ ملفاً للتحميل
            
            const mdContent = `---
title: "${title}"
date: "${date}"
slug: "${slug}"
---

${content}`;

            // إنشاء ملف للتحميل
            const blob = new Blob([mdContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = `${slug}.md`;
            a.click();
            
            URL.revokeObjectURL(url);
            
            // تخزين مؤقت في localStorage (للعرض فقط)
            localStorage.setItem(`article_${slug}`, mdContent);
            
            return slug;
        }

        async function updateArticlesIndex(slug, title, date, content) {
            // إنشاء أو تحديث المقال في الفهرس
            const articleIndex = articlesData.findIndex(a => a.id === slug);
            
            const description = content.substring(0, 150) + '...';
            
            const articleData = {
                id: slug,
                title: title,
                date: date,
                description: description,
                image: 'images/blog-bg.jpg', // الصورة الافتراضية
                content: `articles/${slug}.md`,
                type: 'local-md',
                tags: extractTags(content)
            };
            
            if (articleIndex > -1) {
                articlesData[articleIndex] = articleData;
            } else {
                articlesData.unshift(articleData);
            }
            
            // حفظ الفهرس
            const indexData = {
                lastUpdate: new Date().toISOString(),
                articles: articlesData
            };
            
            // إنشاء ملف الفهرس للتحميل
            const blob = new Blob([JSON.stringify(indexData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = 'articles.json';
            a.click();
            
            URL.revokeObjectURL(url);
            
            // تخزين مؤقت
            localStorage.setItem('articles_index', JSON.stringify(indexData));
        }

        // ========== إدارة الصور ==========
        function setupDragAndDrop() {
            const dropArea = document.getElementById('dropArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.style.borderColor = 'var(--gold-solid)';
                dropArea.style.background = 'rgba(191, 149, 63, 0.1)';
            }
            
            function unhighlight() {
                dropArea.style.borderColor = '';
                dropArea.style.background = '';
            }
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleImageFiles(files);
            }
        }

        function handleImageUpload(event) {
            const files = event.target.files;
            handleImageFiles(files);
        }

        function handleImageFiles(files) {
            for (let file of files) {
                if (!file.type.match('image.*')) continue;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    saveImageToGallery(file.name, e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function saveImageToGallery(filename, dataUrl) {
            // إنشاء معرف فريد للصورة
            const imageId = 'img_' + Date.now() + '_' + filename.replace(/\s+/g, '-');
            
            // تخزين في localStorage
            let gallery = JSON.parse(localStorage.getItem('image_gallery') || '[]');
            gallery.push({
                id: imageId,
                name: filename,
                data: dataUrl,
                date: new Date().toISOString()
            });
            
            localStorage.setItem('image_gallery', JSON.stringify(gallery));
            
            // إنشاء ملف للتحميل
            const base64Data = dataUrl.split(',')[1];
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'image/jpeg' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = filename;
            a.click();
            
            URL.revokeObjectURL(url);
            
            showNotification('تم حفظ الصورة: ' + filename, 'success');
            loadImages();
            updateStats();
        }

        function loadImages() {
            const gallery = JSON.parse(localStorage.getItem('image_gallery') || '[]');
            imagesList = gallery;
            
            // عرض الصور في القائمة
            const container = document.getElementById('imagesList');
            if (gallery.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-white/50">
                        <i class="fas fa-images text-2xl mb-2"></i>
                        <p>لا توجد صور بعد</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = gallery.slice(0, 5).map(img => `
                <div class="p-2 rounded-lg border border-white/10 hover:border-gold-solid/30 flex items-center gap-3">
                    <img src="${img.data}" class="w-12 h-12 object-cover rounded-lg">
                    <div class="flex-1">
                        <p class="text-white text-sm truncate">${img.name}</p>
                        <p class="text-white/50 text-xs">${new Date(img.date).toLocaleDateString('ar-EG')}</p>
                    </div>
                    <button onclick="insertImage('${img.id}')" 
                            class="px-2 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-sm">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            `).join('');
            
            document.getElementById('imagesCount').textContent = gallery.length;
        }

        // ========== معرض الصور ==========
        function insertImageFromGallery() {
            const gallery = JSON.parse(localStorage.getItem('image_gallery') || '[]');
            const container = document.getElementById('galleryImages');
            
            if (gallery.length === 0) {
                container.innerHTML = `
                    <div class="col-span-4 text-center py-8 text-white/50">
                        <i class="fas fa-images text-4xl mb-4"></i>
                        <p>لا توجد صور في المعرض</p>
                    </div>
                `;
            } else {
                container.innerHTML = gallery.map(img => `
                    <div class="relative group">
                        <img src="${img.data}" 
                             class="w-full h-32 object-cover rounded-lg cursor-pointer"
                             onclick="selectImage('${img.data}', '${img.name}')">
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2 rounded-lg">
                            <button onclick="selectImage('${img.data}', '${img.name}')"
                                    class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded">
                                <i class="fas fa-check"></i>
                            </button>
                            <button onclick="deleteImage('${img.id}')"
                                    class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('imageGalleryModal').classList.remove('hidden');
        }

        function closeImageGallery() {
            document.getElementById('imageGalleryModal').classList.add('hidden');
        }

        function selectImage(dataUrl, filename) {
            const markdownImage = `![${filename}](${dataUrl})`;
            insertTextAtCursor(markdownImage);
            closeImageGallery();
        }

        function deleteImage(imageId) {
            if (confirm('هل تريد حذف هذه الصورة؟')) {
                let gallery = JSON.parse(localStorage.getItem('image_gallery') || '[]');
                gallery = gallery.filter(img => img.id !== imageId);
                localStorage.setItem('image_gallery', JSON.stringify(gallery));
                loadImages();
                insertImageFromGallery(); // تحديث المعرض
                showNotification('تم حذف الصورة', 'success');
            }
        }

        // ========== أدوات المحرر ==========
        function formatText(command) {
            const textarea = document.getElementById('articleContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            let formattedText = '';
            
            switch(command) {
                case 'bold':
                    formattedText = `**${selectedText}**`;
                    break;
                case 'italic':
                    formattedText = `*${selectedText}*`;
                    break;
                case 'h1':
                    formattedText = `# ${selectedText}`;
                    break;
                case 'h2':
                    formattedText = `## ${selectedText}`;
                    break;
                case 'link':
                    const url = prompt('أدخل الرابط:');
                    if (url) {
                        formattedText = `[${selectedText}](${url})`;
                    }
                    break;
                case 'image':
                    const imageUrl = prompt('أدخل رابط الصورة:');
                    if (imageUrl) {
                        formattedText = `![${selectedText}](${imageUrl})`;
                    }
                    break;
                case 'code':
                    formattedText = "```\n" + selectedText + "\n```";
                    break;
                case 'list':
                    formattedText = selectedText.split('\n').map(line => `- ${line}`).join('\n');
                    break;
            }
            
            if (formattedText) {
                textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
                textarea.focus();
                textarea.setSelectionRange(start, start + formattedText.length);
                updatePreview();
            }
        }

        function insertTextAtCursor(text) {
            const textarea = document.getElementById('articleContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            
            textarea.value = textarea.value.substring(0, start) + text + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + text.length, start + text.length);
            updatePreview();
        }

        function updatePreview() {
            const content = document.getElementById('articleContent').value;
            const preview = document.getElementById('previewContent');
            
            // تحويل Markdown بسيط
            let html = content
                .replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold gold-text mt-4 mb-2">$1</h1>')
                .replace(/^## (.*$)/gm, '<h2 class="text-xl font-bold text-white mt-3 mb-2">$1</h2>')
                .replace(/^### (.*$)/gm, '<h3 class="text-lg font-bold text-white mt-2 mb-1">$1</h3>')
                .replace(/\*\*(.*)\*\*/g, '<strong class="font-bold text-white">$1</strong>')
                .replace(/\*(.*)\*/g, '<em class="italic text-white/90">$1</em>')
                .replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1" class="rounded-lg my-4 max-w-full">')
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" class="text-blue-400 hover:underline">$1</a>')
                .replace(/^- (.*$)/gm, '<li class="mr-4">$1</li>')
                .replace(/\n/g, '<br>');
            
            preview.innerHTML = html || '<p class="text-white/50">المعاينة ستظهر هنا...</p>';
        }

        // ========== حذف المقالات ==========
        async function deleteArticle(articleId, event) {
            event.stopPropagation();
            
            if (!confirm('هل أنت متأكد من حذف هذا المقال؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                return;
            }
            
            try {
                // حذف من الفهرس
                articlesData = articlesData.filter(a => a.id !== articleId);
                
                // تحديث الفهرس
                const indexData = {
                    lastUpdate: new Date().toISOString(),
                    articles: articlesData
                };
                
                // حفظ الفهرس الجديد
                localStorage.setItem('articles_index', JSON.stringify(indexData));
                
                // إنشاء ملف للتحميل
                const blob = new Blob([JSON.stringify(indexData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = 'articles.json';
                a.click();
                
                URL.revokeObjectURL(url);
                
                showNotification('تم حذف المقال بنجاح', 'success');
                loadArticles();
                updateStats();
                
            } catch (error) {
                showNotification('خطأ في الحذف: ' + error.message, 'error');
            }
        }

        // ========== دوال مساعدة ==========
        function generateSlug(title) {
            return title
                .toLowerCase()
                .replace(/[^\w\u0600-\u06FF\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .substring(0, 50);
        }

        function extractTags(content) {
            const words = content.split(/\s+/);
            const commonWords = ['في', 'من', 'على', 'أن', 'هذا', 'هذه', 'كان', 'يكون'];
            const tags = words
                .filter(word => word.length > 3 && !commonWords.includes(word))
                .slice(0, 5);
            return [...new Set(tags)]; // إزالة التكرارات
        }

        function updateStats() {
            document.getElementById('articlesCount').textContent = articlesData.length;
            document.getElementById('imagesCount').textContent = imagesList.length;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ar-EG');
            
            // تحديث عدد ملفات MD من localStorage
            const mdCount = Object.keys(localStorage)
                .filter(key => key.startsWith('article_'))
                .length;
            document.getElementById('mdFilesCount').textContent = mdCount;
        }

        function showNotification(message, type = 'success') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-4 px-6 py-3 rounded-lg shadow-lg z-50 ${colors[type]} text-white`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} ml-2"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ========== دعم GitHub Pages ==========
        // ملاحظة: في GitHub Pages، لا يمكن حفظ الملفات مباشرة
        // لذلك النظام يقوم بإنشاء الملفات للتحميل، ويجب رفعها يدوياً
        function showUploadInstructions() {
            const instructions = `
                <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                    <div class="bg-black/90 border-2 border-gold-solid rounded-3xl p-8 max-w-2xl">
                        <h2 class="text-2xl font-bold gold-text mb-4">تعليمات الرفع إلى GitHub</h2>
                        <div class="space-y-4 text-white/80">
                            <p>1. بعد إنشاء المقال، سيتم تحميل ملفين:</p>
                            <ul class="mr-4 space-y-2">
                                <li>• <code class="bg-black/50 px-2 py-1 rounded">اسم-المقال.md</code> - ضعه في <code>blog/articles/</code></li>
                                <li>• <code class="bg-black/50 px-2 py-1 rounded">articles.json</code> - ضعه في <code>blog/data/</code></li>
                            </ul>
                            <p>2. الصور المرفوعة: ضعها في <code>blog/images/</code></p>
                            <p>3. ارفع الملفات إلى مستودع GitHub الخاص بك</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                class="gold-btn w-full py-3 rounded-xl mt-6 font-bold">
                            فهمت
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', instructions);
        }
    </script>
</body>
</html>
