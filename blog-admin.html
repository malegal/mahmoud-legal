<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="robots" content="noindex, nofollow">
    <title>المستشار الذكي | Groq Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root { --bg-dark: #0f172a; --panel-bg: rgba(30, 41, 59, 0.96); --gold-primary: #d4af37; --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c); }
        body { font-family: 'Tajawal', sans-serif; background-color: #020617; color: #e2e8f0; overflow-x: hidden; background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 80%); }
        .serif-font { font-family: 'Amiri', serif; }
        .gold-text { background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        .ql-toolbar { background: #1e293b !important; border-radius: 8px 8px 0 0 !important; border: 1px solid rgba(255,255,255,0.1) !important; direction: ltr; }
        .ql-toolbar .ql-stroke { stroke: #9ca3af; } .ql-toolbar .ql-fill { fill: #9ca3af; } 
        .ql-container { background: #ffffff !important; color: #000 !important; border-radius: 0 0 8px 8px !important; min-height: 600px; font-size: 1.25rem; border: none !important; }
        .ql-editor { text-align: right; direction: rtl; font-family: 'Amiri', serif; line-height: 2.2; padding: 3rem; }
        .ql-editor h2 { color: #1e3a8a; border-bottom: 2px solid #d4af37; padding-bottom: 8px; margin-top: 35px; margin-bottom: 15px; font-weight: bold; font-size: 1.6em; }
        .ql-editor p { margin-bottom: 15px; text-align: justify; }
        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(12px); border: 1px solid rgba(212, 175, 55, 0.15); border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4); }
        .input-pro { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 12px; color: white; width: 100%; transition: all 0.3s; }
        .input-pro:focus { border-color: var(--gold-primary); box-shadow: 0 0 15px rgba(212, 175, 55, 0.15); outline: none; }
        .btn-royal { background: var(--gold-gradient); color: #0f172a; font-weight: bold; padding: 10px 24px; border-radius: 6px; transition: 0.3s; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Amiri', serif; font-size: 1.1em; }
        .btn-royal:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(191, 149, 63, 0.4); }
        .btn-royal:disabled { opacity: 0.7; cursor: wait; filter: grayscale(1); }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body>

<div id="lock-screen" class="fixed inset-0 z-[9999] bg-[#020617] flex items-center justify-center p-4">
    <div class="glass-panel p-10 max-w-md w-full text-center border-t-2 border-yellow-600 shadow-2xl">
        <div class="mb-6"><i class="fas fa-scale-balanced text-6xl gold-text"></i></div>
        <h2 class="text-3xl font-bold text-white mb-2 serif-font">المستشار | Groq System</h2>
        <input type="password" id="adminPass" placeholder="كلمة المرور" class="input-pro text-center text-xl mb-6">
        <button onclick="checkPass()" class="btn-royal w-full py-2">تسجيل الدخول</button>
    </div>
</div>

<div id="dashboard" class="hidden flex flex-col min-h-screen">
    <header class="border-b border-white/5 bg-[#0f172a]/95 backdrop-blur-md sticky top-0 z-50 shadow-lg">
        <div class="max-w-[1800px] mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-gavel text-yellow-500 text-xl"></i>
                <div>
                    <h1 class="font-bold text-lg text-white serif-font">مؤسسة محمود عبد الحميد</h1>
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-orange-500 animate-pulse"></span>
                        <span class="text-[10px] text-gray-400">Groq Llama-3 Connected</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleSettings()" class="bg-slate-800 hover:bg-slate-700 text-gray-300 px-3 py-2 rounded text-xs transition border border-white/10"><i class="fas fa-key"></i> الإعدادات</button>
                <button onclick="saveToGitHub(true)" id="publish-btn" class="btn-royal text-sm px-6"><i class="fas fa-globe"></i> نشر</button>
            </div>
        </div>
    </header>

    <div id="settings-panel" class="hidden fixed inset-0 z-40 bg-black/80 backdrop-blur-sm flex justify-end">
        <div class="w-full max-w-md bg-[#1e293b] h-full p-8 shadow-2xl border-l border-yellow-500/20 overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xl font-bold text-white">إعدادات الربط</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-6">
                <div class="p-4 bg-black/20 rounded border border-white/5">
                    <input type="text" id="repoOwner" placeholder="Repo Owner" class="input-pro text-xs mb-3" value="malegal">
                    <input type="text" id="repoName" placeholder="Repo Name" class="input-pro text-xs" value="mahmoud-legal">
                </div>
                <!-- تغيير: هنا نطلب مفتاح Groq -->
                <div><label class="block text-xs text-orange-500 mb-2 font-bold">Groq API Key (يبدأ بـ gsk_):</label><input type="password" id="groqKey" placeholder="gsk_..." class="input-pro font-mono text-xs"></div>
                <div><label class="block text-xs text-yellow-500 mb-2 font-bold">GitHub Token:</label><input type="password" id="ghToken" class="input-pro font-mono text-xs"></div>
                <div>
                    <label class="block text-xs text-gray-400 mb-2">معرف النموذج (Groq Model):</label>
                    <!-- النموذج الافتراضي Llama 3 القوي -->
                    <input type="text" id="modelId" value="llama3-70b-8192" class="input-pro font-mono text-xs text-orange-400">
                    <p class="text-[9px] text-gray-500 mt-1">مقترح: <code>llama3-70b-8192</code> أو <code>llama-3.1-70b-versatile</code></p>
                </div>
                <button onclick="saveKeys()" class="btn-royal w-full py-2 mt-4">حفظ</button>
            </div>
        </div>
    </div>

    <main class="flex-grow p-6 max-w-[1800px] mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div class="lg:col-span-9 space-y-4">
            <div class="glass-panel p-6 relative min-h-[85vh]">
                <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                    <input type="text" id="postTitle" placeholder="موضوع البحث القانوني المقارن..." class="w-full bg-transparent text-3xl font-bold text-white border-b border-gray-700 focus:border-yellow-500 outline-none pb-3 serif-font">
                    <button onclick="aiLegalDraft()" id="ai-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-lg text-sm shadow-xl transition flex items-center gap-2 whitespace-nowrap border border-indigo-400/30">
                        <i class="fas fa-brain text-lg"></i> 
                        <div class="text-right"><span class="block font-bold">المحامي الآلي</span><span class="block text-[9px] opacity-80">Llama-3 via Groq</span></div>
                    </button>
                </div>
                <div class="bg-white rounded-b-lg overflow-hidden shadow-2xl h-full border-t-4 border-yellow-500"><div id="editor"></div></div>
            </div>
        </div>
        <div class="lg:col-span-3 space-y-4">
            <div class="glass-panel p-5">
                <h3 class="text-sm font-bold text-yellow-500 mb-4 border-b border-white/10 pb-2">بيانات النشر</h3>
                <div class="space-y-4">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('imgInput').click()">
                        <input type="file" id="imgInput" class="hidden" accept="image/*">
                        <div class="h-40 w-full border-2 border-dashed border-gray-600 rounded-lg flex flex-col items-center justify-center text-gray-500 hover:border-yellow-500 transition bg-black/20 overflow-hidden">
                            <img id="previewImg" class="absolute inset-0 w-full h-full object-cover hidden">
                            <i class="fas fa-image text-3xl mb-2"></i>
                        </div>
                    </div>
                    <input type="text" id="slug" placeholder="الرابط (Slug)" class="input-pro text-xs text-left" dir="ltr">
                    <textarea id="excerpt" rows="4" placeholder="ملخص المذكرة..." class="input-pro text-xs"></textarea>
                </div>
            </div>
            <div class="glass-panel p-5 flex flex-col h-[400px]">
                <div class="flex justify-between items-center mb-4"><h3 class="text-sm font-bold text-white">الأرشيف</h3><button onclick="loadArticles()" class="text-yellow-500"><i class="fas fa-sync-alt"></i></button></div>
                <div id="articlesList" class="flex-grow overflow-y-auto space-y-2 pr-1 custom-scroll"></div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    const DEFAULT_OWNER = "malegal";
    const DEFAULT_REPO = "mahmoud-legal";
    // استخدام نموذج لاما 3 القوي
    const DEFAULT_MODEL = "llama3-70b-8192";

    let ghToken, groqKey, aiModelId, repoOwner, repoName;
    let isEditing = false;
    let currentSha = null;
    let imageBase64 = null;

    const quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'حيثيات المذكرة القانونية...',
        modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], [{ 'align': [] }, { 'direction': 'rtl' }], ['link', 'clean']] }
    });
    quill.format('direction', 'rtl');
    quill.format('align', 'right');

    function checkPass() {
        if(document.getElementById('adminPass').value === "mahmoud237") {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('dashboard').classList.remove('hidden');
            loadSettings();
            if(ghToken) loadArticles();
        } else { alert("❌ كلمة المرور غير صحيحة"); }
    }

    function loadSettings() {
        ghToken = localStorage.getItem('mahmoud_gh') || "";
        groqKey = localStorage.getItem('mahmoud_groq') || ""; // مفتاح Groq
        aiModelId = localStorage.getItem('mahmoud_model') || DEFAULT_MODEL;
        repoOwner = localStorage.getItem('mahmoud_owner') || DEFAULT_OWNER;
        repoName = localStorage.getItem('mahmoud_repo') || DEFAULT_REPO;

        document.getElementById('ghToken').value = ghToken;
        document.getElementById('groqKey').value = groqKey;
        document.getElementById('modelId').value = aiModelId;
        document.getElementById('repoOwner').value = repoOwner;
        document.getElementById('repoName').value = repoName;
    }

    function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }

    function saveKeys() {
        ghToken = document.getElementById('ghToken').value.trim();
        groqKey = document.getElementById('groqKey').value.trim();
        aiModelId = document.getElementById('modelId').value.trim();
        repoOwner = document.getElementById('repoOwner').value.trim();
        repoName = document.getElementById('repoName').value.trim();

        localStorage.setItem('mahmoud_gh', ghToken);
        localStorage.setItem('mahmoud_groq', groqKey);
        localStorage.setItem('mahmoud_model', aiModelId);
        localStorage.setItem('mahmoud_owner', repoOwner);
        localStorage.setItem('mahmoud_repo', repoName);

        alert("✅ تم الحفظ (Groq & GitHub)");
        toggleSettings();
        if(ghToken) loadArticles();
    }

    // --- قلب النظام: المحامي الآلي (نسخة Groq Llama) ---
    async function aiLegalDraft() {
        const title = document.getElementById('postTitle').value;
        if(!groqKey || !title) return alert("⚠️ تأكد من إدخال مفتاح Groq وعنوان البحث.");

        const btn = document.getElementById('ai-btn');
        const oldHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-bolt fa-spin"></i> Groq Llama يكتب...';
        btn.disabled = true;

        // هندسة الأوامر المتقدمة (Prompt Engineering) للمحامي المصري المقارن
        const systemPrompt = `
        أنت محامٍ مصري ضليع ومستشار قانوني رفيع المستوى أمام محكمة النقض.
        
        المهمة المطلوبة:
        كتابة بحث قانوني معمق وإبداعي حول: "${title}".

        قواعد الصياغة الصارمة:
        1. **الهوية:** أنت تفكر بعقلية الفقه اللاتيني، وتحديداً المدرسة المصرية والفرنسية.
        2. **اللغة:** لغة عربية فصحى، جزلة، رصينة، خالية من التكرار والحشو.
        3. **الاستدلال:**
           - ابدأ بتأصيل المبدأ في القانون المصري (اذكر أرقام المواد بوضوح).
           - استشهد بأحكام محكمة النقض المصرية (أرقام طعون وسنوات إن أمكن، أو المبادئ المستقرة).
        4. **المقارنة (الإبداع):** قارن هذا الوضع بما يقابله في القانون المدني الفرنسي (Code civil des Français). أبرز مواضع الاتفاق والاختلاف بفكر تحليلي.
        5. **التنسيق:** استخدم HTML فقط (h2 للعناوين، p للفقرات)، وتجنب Markdown.

        الهيكل الإلزامي:
        <h2>مقدمة وتأصيل فقهي</h2>
        <h2>موقف المشرع المصري (نصوص ومواد)</h2>
        <h2>النظرة المقارنة في الفقه الفرنسي</h2>
        <h2>تطبيقات محكمة النقض المصرية</h2>
        <h2>الخاتمة والرأي القانوني</h2>
        `;

        try {
            // الاتصال المباشر بـ Groq API
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${groqKey}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: aiModelId,
                    messages: [
                        {"role": "system", "content": systemPrompt},
                        {"role": "user", "content": `ابدأ صياغة البحث بعنوان: ${title}`}
                    ],
                    temperature: 0.6, // توازن بين الدقة القانونية والإبداع
                    max_tokens: 4096 // Llama 3 يدعم سياق كبير
                })
            });

            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);
            
            let content = data.choices[0].message.content.replace(/```html/g, '').replace(/```/g, '').trim();
            quill.root.innerHTML = content;
            
            // توليد الـ Slug تلقائياً
            document.getElementById('slug').value = title.trim().replace(/\s+/g, '-');
            alert("✅ تمت الصياغة بسرعة البرق (LPU Speed).");

        } catch (e) {
            alert(`❌ خطأ Groq: ${e.message}`);
        } finally {
            btn.innerHTML = oldHTML;
            btn.disabled = false;
        }
    }

    // --- وظائف GitHub (كما هي) ---
    async function saveToGitHub() {
        if(!ghToken) return alert("أدخل توكن GitHub");
        const title = document.getElementById('postTitle').value;
        const slug = document.getElementById('slug').value;
        const content = quill.root.innerHTML;
        if(!title || !slug) return alert("البيانات ناقصة");

        const btn = document.getElementById('publish-btn');
        btn.innerHTML = 'جاري الرفع...';
        btn.disabled = true;

        try {
            let imgPath = "images/default-law.jpg";
            if(imageBase64) {
                const imgName = `post-${Date.now()}.jpg`;
                await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/images/posts/${imgName}`, {
                    method: 'PUT', headers: { 'Authorization': `token ${ghToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "img", content: imageBase64 })
                });
                imgPath = `images/posts/${imgName}`;
            }

            const md = `---
title: "${title}"
date: "${new Date().toISOString()}"
description: "${document.getElementById('excerpt').value}"
image: "${imgPath}"
layout: post
---
${content}`;

            const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/blog/articles/${slug}.md`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${ghToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    message: "New Post via Groq Admin", 
                    content: btoa(unescape(encodeURIComponent(md))), 
                    sha: isEditing ? currentSha : undefined 
                })
            });

            if(res.ok) { alert("✅ تم النشر"); resetEditor(); loadArticles(); } 
            else { throw new Error("GitHub Error"); }
        } catch (e) { alert(`❌ فشل: ${e.message}`); }
        btn.innerHTML = '<i class="fas fa-globe"></i> نشر';
        btn.disabled = false;
    }

    async function loadArticles() {
        const list = document.getElementById('articlesList');
        try {
            const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/blog/articles`, { headers: { 'Authorization': `token ${ghToken}` } });
            const files = await res.json();
            list.innerHTML = files.filter(f => f.name.endsWith('.md')).map(f => `<div class="flex justify-between bg-white/5 p-2 rounded mb-2"><span class="truncate w-3/4 text-xs text-gray-300">${decodeURIComponent(f.name.replace('.md','').replace(/-/g,' '))}</span><button onclick="editArticle('${f.path}','${f.sha}')" class="text-orange-500"><i class="fas fa-pen"></i></button></div>`).join('');
        } catch (e) { list.innerHTML = `<p class="text-center text-red-400 text-xs">خطأ تحميل</p>`; }
    }

    async function editArticle(path, sha) {
        const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, { headers: { 'Authorization': `token ${ghToken}` } });
        const data = await res.json();
        const content = decodeURIComponent(escape(atob(data.content)));
        const parts = content.split('---');
        document.getElementById('postTitle').value = parts[1].match(/title:\s*"(.*)"/)[1];
        document.getElementById('slug').value = data.name.replace('.md', '');
        quill.root.innerHTML = parts.slice(2).join('---');
        isEditing = true; currentSha = sha;
    }

    function resetEditor() { document.getElementById('postTitle').value = ''; quill.setContents([]); isEditing = false; currentSha = null; }
    document.getElementById('imgInput').addEventListener('change', function(e) { const r = new FileReader(); r.onload = function(evt) { imageBase64 = evt.target.result.split(',')[1]; document.getElementById('previewImg').src = evt.target.result; document.getElementById('previewImg').classList.remove('hidden'); }; r.readAsDataURL(e.target.files[0]); });
</script>
</body>
</html>
