<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="robots" content="noindex, nofollow">
    <title>لوحة المستشار | إدارة المحتوى القانوني</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root { --bg-dark: #0f172a; --panel-bg: rgba(30, 41, 59, 0.95); --gold-primary: #d4af37; --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c); }
        body { font-family: 'Tajawal', sans-serif; background-color: #020617; color: #e2e8f0; overflow-x: hidden; background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 80%); }
        .serif-font { font-family: 'Amiri', serif; }
        .gold-text { background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        .ql-toolbar { background: #1e293b !important; border-radius: 8px 8px 0 0 !important; border: 1px solid rgba(255,255,255,0.1) !important; direction: ltr; }
        .ql-toolbar .ql-stroke { stroke: #9ca3af; } .ql-toolbar .ql-fill { fill: #9ca3af; } .ql-toolbar .ql-picker-label { color: #9ca3af; }
        .ql-container { background: #ffffff !important; color: #000 !important; border-radius: 0 0 8px 8px !important; min-height: 600px; font-size: 1.25rem; border: none !important; }
        .ql-editor { text-align: right; direction: rtl; font-family: 'Amiri', serif; line-height: 2.2; padding: 3rem; }
        .ql-editor h2 { color: #1e3a8a; border-bottom: 2px solid #d4af37; padding-bottom: 8px; margin-top: 35px; margin-bottom: 15px; font-weight: bold; font-size: 1.6em; }
        .ql-editor p { margin-bottom: 15px; text-align: justify; }
        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(12px); border: 1px solid rgba(212, 175, 55, 0.15); border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4); }
        .input-pro { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 12px; color: white; width: 100%; transition: all 0.3s; }
        .input-pro:focus { border-color: var(--gold-primary); box-shadow: 0 0 15px rgba(212, 175, 55, 0.15); outline: none; }
        .btn-royal { background: var(--gold-gradient); color: #0f172a; font-weight: bold; padding: 10px 24px; border-radius: 6px; transition: 0.3s; border: none; cursor: pointer; display: inline-flex; align-items-center; justify-content: center; gap: 8px; font-family: 'Amiri', serif; font-size: 1.1em; }
        .btn-royal:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(191, 149, 63, 0.4); }
        .btn-royal:disabled, .btn-secondary:disabled { opacity: 0.7; cursor: wait; filter: grayscale(1); }
        .btn-secondary { background-color: #334155; color: #e2e8f0; border: 1px solid #475569; } .btn-secondary:hover { background-color: #475569; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body>

<div id="lock-screen" class="fixed inset-0 z-[9999] bg-[#020617] flex items-center justify-center p-4">
    <div class="glass-panel p-10 max-w-md w-full text-center border-t-2 border-yellow-600 shadow-2xl">
        <div class="mb-6"><i class="fas fa-scale-balanced text-6xl gold-text"></i></div>
        <h2 class="text-3xl font-bold text-white mb-2 serif-font">المستشار | لوحة الإدارة</h2>
        <input type="password" id="adminPass" placeholder="كلمة المرور" class="input-pro text-center text-xl mb-6">
        <button onclick="checkPass()" class="btn-royal w-full py-2">تسجيل الدخول</button>
    </div>
</div>

<div id="dashboard" class="hidden flex flex-col min-h-screen">
    <header class="border-b border-white/5 bg-[#0f172a]/95 backdrop-blur-md sticky top-0 z-50 shadow-lg">
        <div class="max-w-[1800px] mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-university text-yellow-500 text-xl"></i>
                <h1 class="font-bold text-lg text-white serif-font">مؤسسة محمود عبد الحميد</h1>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleSettings()" class="bg-slate-800 hover:bg-slate-700 text-gray-300 px-3 py-2 rounded text-xs transition border border-white/10"><i class="fas fa-key"></i> المفاتيح</button>
                <button onclick="saveToGitHub(true)" id="publish-btn" class="btn-royal text-sm px-6"><i class="fas fa-globe"></i> نشر</button>
            </div>
        </div>
    </header>

    <div id="settings-panel" class="hidden fixed inset-0 z-40 bg-black/80 backdrop-blur-sm flex justify-end">
        <div class="w-full max-w-md bg-[#1e293b] h-full p-8 shadow-2xl border-l border-yellow-500/20 overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xl font-bold text-white">الإعدادات</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-6">
                <div class="p-4 bg-black/20 rounded border border-white/5">
                    <input type="text" id="repoOwner" placeholder="Repo Owner" class="input-pro text-xs mb-3" value="malegal">
                    <input type="text" id="repoName" placeholder="Repo Name" class="input-pro text-xs" value="mahmoud-legal">
                </div>
                <div><label class="block text-xs text-yellow-500 mb-2 font-bold">OpenRouter Key:</label><input type="password" id="orKey" class="input-pro font-mono text-xs"></div>
                <div><label class="block text-xs text-yellow-500 mb-2 font-bold">GitHub Token:</label><input type="password" id="ghToken" class="input-pro font-mono text-xs"></div>
                <div>
                    <label class="block text-xs text-gray-400 mb-2">معرف النموذج (Model ID):</label>
                    <input type="text" id="modelId" value="google/gemini-flash-1.5:free" class="input-pro font-mono text-xs text-green-400">
                    <p class="text-[9px] text-gray-500 mt-1">تم ضبطه تلقائياً على Gemini Flash (مجاني وسريع)</p>
                </div>
                <button onclick="saveKeys()" class="btn-royal w-full py-2 mt-4">حفظ الإعدادات</button>
            </div>
        </div>
    </div>

    <main class="flex-grow p-6 max-w-[1800px] mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div class="lg:col-span-9 space-y-4">
            <div class="glass-panel p-6 relative min-h-[85vh]">
                <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                    <input type="text" id="postTitle" placeholder="عنوان البحث القانوني..." class="w-full bg-transparent text-3xl font-bold text-white border-b border-gray-700 focus:border-yellow-500 outline-none pb-3 serif-font">
                    <button onclick="aiLegalDraft()" id="ai-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-lg text-sm shadow-xl transition flex items-center gap-2 whitespace-nowrap border border-indigo-400/30">
                        <i class="fas fa-robot text-lg"></i> 
                        <div class="text-right"><span class="block font-bold">المحامي الآلي</span><span id="model-name-display" class="block text-[9px] opacity-80">Gemini Flash</span></div>
                    </button>
                </div>
                <div class="bg-white rounded-b-lg overflow-hidden shadow-2xl h-full border-t-4 border-yellow-500"><div id="editor"></div></div>
            </div>
        </div>
        <div class="lg:col-span-3 space-y-4">
            <div class="glass-panel p-5">
                <h3 class="text-sm font-bold text-yellow-500 mb-4 border-b border-white/10 pb-2">خيارات الحفظ والنشر</h3>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="saveToGitHub(false)" class="btn-secondary text-xs py-3"><i class="fas fa-save mr-2"></i>حفظ كمسودة</button>
                    <button onclick="previewArticle()" class="btn-secondary text-xs py-3"><i class="fas fa-eye mr-2"></i>معاينة</button>
                </div>
                <h3 class="text-sm font-bold text-yellow-500 mb-4 border-b border-white/10 pb-2">بيانات النشر</h3>
                <div class="space-y-4">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('imgInput').click()">
                        <input type="file" id="imgInput" class="hidden" accept="image/*">
                        <div id="img-placeholder" class="h-40 w-full border-2 border-dashed border-gray-600 rounded-lg flex flex-col items-center justify-center text-gray-500 hover:border-yellow-500 transition bg-black/20 overflow-hidden">
                            <img id="previewImg" class="absolute inset-0 w-full h-full object-cover hidden">
                            <i class="fas fa-image text-3xl mb-2"></i><span>صورة المقال</span>
                        </div>
                    </div>
                    <input type="text" id="slug" placeholder="الرابط (slug)" class="input-pro text-xs text-left" dir="ltr">
                    <textarea id="excerpt" rows="4" placeholder="وصف الميتا (للسيو)..." class="input-pro text-xs"></textarea>
                </div>
            </div>
            <div class="glass-panel p-5 flex flex-col h-[400px]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-white">الأرشيف</h3>
                    <button onclick="loadArticles()" class="text-yellow-500 hover:text-yellow-300 transition"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div id="articlesList" class="flex-grow overflow-y-auto space-y-2 pr-1"></div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    // --- الإعدادات الافتراضية ---
    const DEFAULT_OWNER = "malegal";
    const DEFAULT_REPO = "mahmoud-legal";
    const DEFAULT_MODEL = "google/gemini-flash-1.5:free";

    // --- متغيرات الحالة العامة ---
    let ghToken, orKey, aiModelId, repoOwner, repoName;
    let isEditing = false;
    let currentSha = null;
    let currentPath = null;
    let imageBase64 = null;

    // --- تهيئة محرر النصوص Quill ---
    const quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'ابدأ الصياغة القانونية هنا...',
        modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], [{ 'align': [] }, { 'direction': 'rtl' }], ['link', 'clean']] }
    });
    quill.format('direction', 'rtl');
    quill.format('align', 'right');

    // --- وظائف المصادقة والتحميل الأولي ---
    function checkPass() {
        if (document.getElementById('adminPass').value === "mahmoud237") {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('dashboard').classList.remove('hidden');
            loadSettings();
            if (ghToken) loadArticles();
        } else {
            alert("❌ كلمة المرور غير صحيحة.");
        }
    }

    function loadSettings() {
        ghToken = localStorage.getItem('mahmoud_gh') || "";
        orKey = localStorage.getItem('mahmoud_or') || "";
        aiModelId = localStorage.getItem('mahmoud_model') || DEFAULT_MODEL;
        repoOwner = localStorage.getItem('mahmoud_owner') || DEFAULT_OWNER;
        repoName = localStorage.getItem('mahmoud_repo') || DEFAULT_REPO;

        document.getElementById('ghToken').value = ghToken;
        document.getElementById('orKey').value = orKey;
        document.getElementById('modelId').value = aiModelId;
        document.getElementById('repoOwner').value = repoOwner;
        document.getElementById('repoName').value = repoName;
        document.getElementById('model-name-display').textContent = aiModelId.split('/')[1].split(':')[0];
    }

    // --- وظائف الإعدادات ---
    function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }

    function saveKeys() {
        ghToken = document.getElementById('ghToken').value.trim();
        orKey = document.getElementById('orKey').value.trim();
        aiModelId = document.getElementById('modelId').value.trim();
        repoOwner = document.getElementById('repoOwner').value.trim();
        repoName = document.getElementById('repoName').value.trim();
        
        localStorage.setItem('mahmoud_gh', ghToken);
        localStorage.setItem('mahmoud_or', orKey);
        localStorage.setItem('mahmoud_model', aiModelId);
        localStorage.setItem('mahmoud_owner', repoOwner);
        localStorage.setItem('mahmoud_repo', repoName);
        
        document.getElementById('model-name-display').textContent = aiModelId.split('/')[1].split(':')[0];
        alert("✅ تم حفظ الإعدادات بنجاح.");
        toggleSettings();
        if (ghToken) loadArticles();
    }

    // --- وظيفة الذكاء الاصطناعي ---
    async function aiLegalDraft() {
        const title = document.getElementById('postTitle').value;
        if (!orKey || !title) return alert("⚠️ يرجى التأكد من إدخال مفتاح OpenRouter وعنوان للمقال.");
        
        const btn = document.getElementById('ai-btn');
        const oldHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الصياغة...';
        btn.disabled = true;

        const systemPrompt = `أنت مستشار قانوني مصري ومحام بالنقض. مهمتك هي كتابة "بحث قانوني مقارن" رصين.
        1. استخدم لغة عربية فصحى قانونية وجزلة.
        2. قم بإجراء مقارنة بين القانون المصري والقانون الفرنسي (Code civil) إن أمكن.
        3. استشهد بأرقام المواد وأحكام محكمة النقض المصرية ذات الصلة.
        4. قم بتنسيق الإخراج باستخدام HTML فقط بالهيكل التالي:
        <h2>مقدمة وتأصيل</h2><p>...</p><h2>موقف المشرع المصري</h2><p>...</p><h2>النظرة المقارنة في القانون الفرنسي</h2><p>...</p><h2>تطبيقات محكمة النقض</h2><p>...</p><h2>الخاتمة</h2><p>...</p>`;

        try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${orKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: aiModelId,
                    messages: [{"role": "system", "content": systemPrompt}, {"role": "user", "content": `اكتب بحثاً قانونياً بعنوان: ${title}`}],
                    temperature: 0.6
                })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            
            let content = data.choices[0].message.content.replace(/```html/g, '').replace(/```/g, '').trim();
            quill.root.innerHTML = content;
            document.getElementById('slug').value = title.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');
            alert("✅ تمت صياغة المسودة الأولية بنجاح.");
        } catch (e) {
            alert(`❌ حدث خطأ أثناء الاتصال بالذكاء الاصطناعي: ${e.message}`);
        } finally {
            btn.innerHTML = oldHTML;
            btn.disabled = false;
        }
    }

    // --- وظائف إدارة المقالات (حفظ، تحميل، حذف) ---
    async function saveToGitHub(isPublishing) {
        if (!ghToken) return alert("⚠️ يرجى إدخال توكن GitHub في الإعدادات أولاً.");
        
        const title = document.getElementById('postTitle').value;
        const slug = document.getElementById('slug').value;
        const content = quill.root.innerHTML;

        if (!title || !slug || content.length < 20) return alert("⚠️ البيانات غير مكتملة. تأكد من وجود عنوان، رابط، ومحتوى.");

        const btn = isPublishing ? document.getElementById('publish-btn') : event.target;
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        try {
            let imgPath = document.getElementById('previewImg').dataset.path || "images/default-law.jpg";
            if (imageBase64) {
                const imgName = `post-${Date.now()}.jpg`;
                const uploadPath = `images/posts/${imgName}`;
                await uploadFileToGitHub(uploadPath, imageBase64);
                imgPath = uploadPath;
            }

            const folder = isPublishing ? 'blog/articles' : 'blog/drafts';
            const filePath = `${folder}/${slug}.md`;
            
            const mdContent = `---
title: "${title.replace(/"/g, '\\"')}"
date: "${new Date().toISOString()}"
description: "${document.getElementById('excerpt').value.replace(/"/g, '\\"')}"
image: "${imgPath}"
layout: ${isPublishing ? 'post' : 'draft'}
---
${content}`;

            const fileContentBase64 = btoa(unescape(encodeURIComponent(mdContent)));
            const commitMessage = `${isPublishing ? 'نشر' : 'حفظ مسودة'}: ${title}`;
            
            const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${ghToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: commitMessage,
                    content: fileContentBase64,
                    sha: (isEditing && currentPath === filePath) ? currentSha : undefined
                })
            });

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || "فشل الرفع إلى GitHub.");
            }
            
            alert(`✅ تم ${isPublishing ? 'نشر' : 'حفظ'} المقال بنجاح!`);
            resetEditor();
            loadArticles();

        } catch (e) {
            alert(`❌ فشل: ${e.message}`);
        } finally {
            btn.innerHTML = oldText;
            btn.disabled = false;
        }
    }

    async function uploadFileToGitHub(path, base64Content) {
        const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${ghToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: `upload: ${path}`, content: base64Content })
        });
        if (!res.ok) throw new Error(`فشل رفع الصورة ${path}.`);
        const data = await res.json();
        return data.content.path;
    }

    async function loadArticles() {
        const listEl = document.getElementById('articlesList');
        listEl.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i></div>';
        if (!ghToken) {
            listEl.innerHTML = '<p class="text-center text-xs text-yellow-400">أدخل توكن GitHub لعرض الأرشيف.</p>';
            return;
        }
        try {
            const [articlesRes, draftsRes] = await Promise.all([
                fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/blog/articles`, { headers: { 'Authorization': `token ${ghToken}` } }),
                fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/blog/drafts`, { headers: { 'Authorization': `token ${ghToken}` } })
            ]);

            const articles = articlesRes.ok ? await articlesRes.json() : [];
            const drafts = draftsRes.ok ? await draftsRes.json() : [];

            let html = '';
            if (articles.length > 0) {
                html += '<h4 class="text-xs font-bold text-gray-400 my-2">المنشور</h4>';
                html += articles.filter(f => f.name.endsWith('.md')).map(f => createArticleItem(f, false)).join('');
            }
            if (drafts.length > 0) {
                html += '<h4 class="text-xs font-bold text-gray-400 my-2">المسودات</h4>';
                html += drafts.filter(f => f.name.endsWith('.md')).map(f => createArticleItem(f, true)).join('');
            }
            
            listEl.innerHTML = html || '<p class="text-center text-xs text-gray-500">الأرشيف فارغ.</p>';
        } catch (e) {
            listEl.innerHTML = `<p class="text-center text-red-400 text-xs">فشل تحميل الأرشيف. تأكد من صحة مفاتيح GitHub.</p>`;
        }
    }

    function createArticleItem(file, isDraft) {
        const title = decodeURIComponent(file.name.replace('.md', '').replace(/-/g, ' '));
        const icon = isDraft ? 'fa-file-alt' : 'fa-check-circle';
        const color = isDraft ? 'text-gray-400' : 'text-green-400';
        return `
            <div class="flex justify-between items-center bg-white/5 p-2 rounded mb-2 text-sm">
                <span class="truncate w-2/3 text-gray-300"><i class="fas ${icon} ${color} ml-2"></i>${title}</span>
                <div class="flex gap-3">
                    <button onclick="editArticle('${file.path}')" class="text-yellow-500 hover:text-yellow-300"><i class="fas fa-pen"></i></button>
                    <button onclick="deleteArticle('${file.path}', '${file.sha}')" class="text-red-500 hover:text-red-300"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
    }

    async function editArticle(path) {
        resetEditor();
        alert("جاري تحميل المقال للتعديل...");
        try {
            const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, { headers: { 'Authorization': `token ${ghToken}` } });
            if (!res.ok) throw new Error("لم يتم العثور على الملف.");
            
            const data = await res.json();
            const rawContent = decodeURIComponent(escape(atob(data.content)));
            const parts = rawContent.split('---');
            
            if (parts.length < 3) throw new Error("تنسيق الملف غير صحيح.");

            const frontmatter = parts[1];
            const bodyContent = parts.slice(2).join('---');

            document.getElementById('postTitle').value = frontmatter.match(/title:\s*"(.*)"/)?.[1] || '';
            document.getElementById('excerpt').value = frontmatter.match(/description:\s*"(.*)"/)?.[1] || '';
            const imgPath = frontmatter.match(/image:\s*"(.*)"/)?.[1] || '';
            
            const previewImg = document.getElementById('previewImg');
            if (imgPath) {
                previewImg.src = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${imgPath}`;
                previewImg.dataset.path = imgPath;
                previewImg.classList.remove('hidden');
            }

            document.getElementById('slug').value = data.name.replace('.md', '');
            quill.root.innerHTML = bodyContent;

            isEditing = true;
            currentSha = data.sha;
            currentPath = data.path;
            window.scrollTo(0, 0);
            alert("✅ تم تحميل المقال. يمكنك الآن التعديل.");
        } catch (e) {
            alert(`❌ فشل تحميل المقال: ${e.message}`);
        }
    }

    async function deleteArticle(path, sha) {
        if (!confirm(`هل أنت متأكد من رغبتك في حذف المقال "${path}"؟ لا يمكن التراجع عن هذا الإجراء.`)) return;

        try {
            const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, {
                method: 'DELETE',
                headers: { 'Authorization': `token ${ghToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `حذف: ${path}`, sha: sha })
            });
            if (!res.ok) throw new Error("فشل الحذف من GitHub.");
            alert("✅ تم حذف المقال بنجاح.");
            loadArticles();
        } catch (e) {
            alert(`❌ فشل الحذف: ${e.message}`);
        }
    }

    // --- وظائف مساعدة وواجهة المستخدم ---
    function resetEditor() {
        quill.setContents([]);
        document.getElementById('postTitle').value = '';
        document.getElementById('slug').value = '';
        document.getElementById('excerpt').value = '';
        document.getElementById('imgInput').value = '';
        const previewImg = document.getElementById('previewImg');
        previewImg.src = '';
        previewImg.classList.add('hidden');
        previewImg.removeAttribute('data-path');
        
        isEditing = false;
        currentSha = null;
        currentPath = null;
        imageBase64 = null;
    }

    function previewArticle() {
        const title = document.getElementById('postTitle').value;
        const content = quill.root.innerHTML;
        const previewWindow = window.open('', '_blank');
        previewWindow.document.write(`
            <html>
                <head>
                    <title>معاينة: ${title}</title>
                    <style>
                        body { font-family: 'Amiri', serif; direction: rtl; text-align: right; max-width: 800px; margin: 40px auto; line-height: 2; color: #333; }
                        h1 { color: #1e3a8a; }
                        h2 { color: #1e3a8a; border-bottom: 2px solid #d4af37; padding-bottom: 8px; margin-top: 35px; }
                        p { text-align: justify; }
                    </style>
                </head>
                <body><h1>${title}</h1>${content}</body>
            </html>
        `);
        previewWindow.document.close();
    }

    document.getElementById('imgInput').addEventListener('change', function(e) {
        if (!e.target.files[0]) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            imageBase64 = evt.target.result.split(',')[1];
            document.getElementById('previewImg').
