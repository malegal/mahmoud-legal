<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ PRO | Groq & GitHub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root { --gold: #d4af37; --dark: #020617; }
        body { font-family: 'Tajawal', sans-serif; background: var(--dark); color: #e2e8f0; }
        .serif-font { font-family: 'Amiri', serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(212,175,55,0.1); }
        .ql-container { font-size: 1.2rem; height: 500px !important; background: white; color: black; border-radius: 0 0 8px 8px; }
        .ql-editor { text-align: right; direction: rtl; font-family: 'Amiri', serif; }
        .btn-gold { background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728); color: #020617; font-weight: bold; transition: 0.3s; }
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(212,175,55,0.3); }
        
        /* Modal Style */
        #previewModal { display: none; position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.9); padding: 20px; overflow-y: auto; }
    </style>
</head>
<body class="bg-slate-950">

<!-- Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© -->
<div id="lock-screen" class="fixed inset-0 z-[9999] bg-[#020617] flex items-center justify-center">
    <div class="glass p-10 rounded-2xl max-w-md w-full text-center border-t-4 border-yellow-600">
        <i class="fas fa-shield-halved text-5xl text-yellow-500 mb-4"></i>
        <h2 class="text-2xl font-bold mb-6">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ</h2>
        <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-3 rounded bg-slate-900 border border-slate-700 text-center mb-4 focus:border-yellow-500 outline-none">
        <button onclick="checkPass()" class="btn-gold w-full py-3 rounded-lg">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>
</div>

<!-- Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
<div id="previewModal">
    <div class="max-w-4xl mx-auto bg-white text-black p-8 rounded-lg shadow-2xl relative mt-10">
        <button onclick="closePreview()" class="absolute top-4 left-4 text-red-600 text-2xl"><i class="fas fa-times-circle"></i></button>
        <div id="previewContent" class="ql-editor"></div>
    </div>
</div>

<div id="dashboard" class="hidden min-h-screen flex flex-col">
    <header class="glass sticky top-0 z-50 p-4 border-b border-white/5">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-balance-scale text-yellow-500 text-2xl"></i>
                <h1 class="font-bold text-xl serif-font hidden md:block">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleSettings()" class="bg-slate-800 p-2 px-4 rounded text-sm"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                <button onclick="showPreview()" class="bg-blue-600 p-2 px-4 rounded text-sm"><i class="fas fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                <button onclick="saveToGitHub()" id="publish-btn" class="btn-gold p-2 px-6 rounded text-sm">Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto w-full p-4 grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø±Ø± -->
        <div class="lg:col-span-3 space-y-4">
            <input type="text" id="postTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø°ÙƒØ±Ø© Ø£Ùˆ Ø§Ù„Ø¨Ø­Ø«..." class="w-full bg-transparent text-3xl font-bold border-b-2 border-slate-700 focus:border-yellow-500 outline-none py-2 serif-font">
            
            <div class="flex gap-2 items-center bg-slate-900 p-3 rounded-lg border border-indigo-500/30">
                <button onclick="aiLegalDraft()" id="ai-btn" class="bg-indigo-600 hover:bg-indigo-500 p-2 px-4 rounded flex items-center gap-2">
                    <i class="fas fa-robot"></i> ØµÙŠØ§ØºØ© Ø°ÙƒÙŠØ© (Groq)
                </button>
                <span class="text-xs text-slate-400">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„ÙƒØªØ§Ø¨Ø© Ù…Ø³ÙˆØ¯Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ù…Ù‚Ø§Ø±Ù†Ø©</span>
            </div>

            <div id="editor-container" class="bg-white rounded-lg shadow-inner">
                <div id="editor"></div>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
        <div class="space-y-4">
            <div class="glass p-4 rounded-xl">
                <h3 class="text-yellow-500 font-bold mb-4 border-b border-white/10 pb-2">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©</h3>
                <div class="space-y-4">
                    <label class="block">
                        <span class="text-xs text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù (Slug)</span>
                        <input type="text" id="slug" placeholder="legal-article-1" class="w-full bg-black/40 border border-white/10 p-2 rounded text-xs mt-1">
                    </label>
                    <label class="block">
                        <span class="text-xs text-gray-400">ØµÙˆØ±Ø© Ø§Ù„Ù…Ù‚Ø§Ù„</span>
                        <input type="file" id="imgInput" class="hidden" accept="image/*">
                        <div onclick="document.getElementById('imgInput').click()" class="h-32 border-2 border-dashed border-slate-700 rounded-lg flex items-center justify-center cursor-pointer hover:border-yellow-500">
                            <img id="previewImg" class="h-full w-full object-cover hidden">
                            <span id="imgPlaceholder"><i class="fas fa-image text-2xl"></i></span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="glass p-4 rounded-xl flex-grow h-[400px] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold">Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</h3>
                    <button onclick="loadArticles()" class="text-blue-400"><i class="fas fa-sync"></i></button>
                </div>
                <div id="articlesList" class="overflow-y-auto space-y-2 text-sm"></div>
            </div>
        </div>
    </main>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
<div id="settings-panel" class="hidden fixed inset-0 z-[100] bg-black/80 flex justify-center items-center">
    <div class="glass p-8 rounded-2xl w-full max-w-md">
        <h3 class="text-xl font-bold mb-6">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø¨Ø·</h3>
        <div class="space-y-4 text-sm">
            <input type="password" id="ghToken" placeholder="GitHub Token" class="w-full p-3 bg-slate-900 rounded">
            <input type="password" id="groqKey" placeholder="Groq API Key" class="w-full p-3 bg-slate-900 rounded">
            <input type="text" id="repoOwner" placeholder="Username (malegal)" class="w-full p-3 bg-slate-900 rounded">
            <input type="text" id="repoName" placeholder="Repo Name" class="w-full p-3 bg-slate-900 rounded">
            <div class="flex gap-2 mt-6">
                <button onclick="saveSettings()" class="btn-gold flex-grow py-2 rounded">Ø­ÙØ¸</button>
                <button onclick="toggleSettings()" class="bg-red-900 px-4 rounded">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    let ghToken, groqKey, repoOwner, repoName, currentSha = null, isEditing = false, imageBase64 = null;

    const quill = new Quill('#editor', {
        theme: 'snow',
        modules: { toolbar: [[{'header': [1, 2, 3, false]}], ['bold', 'italic', 'underline'], [{'list': 'ordered'}, {'list': 'bullet'}], [{'align': []}, {'direction': 'rtl'}], ['link', 'image', 'clean']] }
    });
    quill.format('direction', 'rtl');

    function checkPass() {
        if(document.getElementById('adminPass').value === "mahmoud237") {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('dashboard').classList.remove('hidden');
            loadLocalSettings();
        } else alert("âŒ Ø®Ø·Ø£!");
    }

    function loadLocalSettings() {
        ghToken = localStorage.getItem('ghToken');
        groqKey = localStorage.getItem('groqKey');
        repoOwner = localStorage.getItem('repoOwner') || 'malegal';
        repoName = localStorage.getItem('repoName') || 'mahmoud-legal';
        
        document.getElementById('ghToken').value = ghToken;
        document.getElementById('groqKey').value = groqKey;
        document.getElementById('repoOwner').value = repoOwner;
        document.getElementById('repoName').value = repoName;

        if(ghToken) loadArticles();
    }

    function saveSettings() {
        localStorage.setItem('ghToken', document.getElementById('ghToken').value);
        localStorage.setItem('groqKey', document.getElementById('groqKey').value);
        localStorage.setItem('repoOwner', document.getElementById('repoOwner').value);
        localStorage.setItem('repoName', document.getElementById('repoName').value);
        alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
        location.reload();
    }

    function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }

    // --- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ ---
    function showPreview() {
        document.getElementById('previewContent').innerHTML = `<h1>${document.getElementById('postTitle').value}</h1>${quill.root.innerHTML}`;
        document.getElementById('previewModal').style.display = 'block';
    }
    function closePreview() { document.getElementById('previewModal').style.display = 'none'; }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ---
    async function aiLegalDraft() {
        const title = document.getElementById('postTitle').value;
        if(!groqKey || !title) return alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆÙ…ÙØªØ§Ø­ Groq");
        
        const btn = document.getElementById('ai-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØµÙŠØ§ØºØ©...';

        try {
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${groqKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: "llama3-70b-8192",
                    messages: [{ role: "system", content: "Ø£Ù†Øª Ù…Ø³ØªØ´Ø§Ø± Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ù…ØµØ±ÙŠ Ø®Ø¨ÙŠØ±. Ø§ÙƒØªØ¨ Ù…Ù‚Ø§Ù„Ø§Ù‹ Ø¨ØµÙŠØºØ© HTML (Ø§Ø³ØªØ®Ø¯Ù… h2 Ùˆ p) ÙŠØªØ¶Ù…Ù† ØªØ£ØµÙŠÙ„Ø§Ù‹ Ù‚Ø§Ù†ÙˆÙ†ÙŠØ§Ù‹ Ù…ØµØ±ÙŠØ§Ù‹ ÙˆÙ…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„ÙØ±Ù†Ø³ÙŠ." },
                               { role: "user", content: `Ø§ÙƒØªØ¨ Ø¨Ø­Ø«Ø§Ù‹ Ø¹Ù†: ${title}` }]
                })
            });
            const data = await response.json();
            const content = data.choices[0].message.content.replace(/```html|```/g, '');
            quill.root.innerHTML = content;
            document.getElementById('slug').value = title.trim().replace(/\s+/g, '-').toLowerCase();
        } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Groq"); }
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-robot"></i> ØµÙŠØ§ØºØ© Ø°ÙƒÙŠØ© (Groq)';
    }

    // --- ÙˆØ¸Ø§Ø¦Ù GitHub (Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø­Ø°Ù) ---
    
    // ÙˆØ¸ÙŠÙØ© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ù„Ù€ Base64 ØªØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
    function toUTF8Base64(str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
    }

    async function saveToGitHub() {
        if(!ghToken) return alert("âš ï¸ ÙŠÙ†Ù‚ØµÙƒ ØªÙˆÙƒÙ† GitHub");
        const title = document.getElementById('postTitle').value;
        const slug = document.getElementById('slug').value || Date.now();
        const content = quill.root.innerHTML;
        const path = `blog/articles/${slug}.md`;

        const btn = document.getElementById('publish-btn');
        btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...";

        const frontmatter = `---
title: "${title}"
date: "${new Date().toISOString()}"
layout: post
---
${content}`;

        try {
            const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, {
                method: "PUT",
                headers: { "Authorization": `token ${ghToken}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: isEditing ? `Update ${slug}` : `Create ${slug}`,
                    content: toUTF8Base64(frontmatter),
                    sha: isEditing ? currentSha : undefined
                })
            });

            if(res.ok) {
                alert("âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ GitHub!");
                resetEditor();
                loadArticles();
            } else {
                const err = await res.json();
                alert(`âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±: ${err.message}`);
            }
        } catch (e) { alert("âŒ Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ: " + e.message); }
        btn.disabled = false; btn.innerText = "Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„";
    }

    async function loadArticles() {
        const list = document.getElementById('articlesList');
        list.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        try {
            const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/blog/articles`, {
                headers: { "Authorization": `token ${ghToken}` }
            });
            const files = await res.json();
            list.innerHTML = files.map(f => `
                <div class="flex items-center justify-between bg-slate-900 p-2 rounded border border-white/5">
                    <span class="truncate w-32">${f.name}</span>
                    <div class="flex gap-2">
                        <button onclick="editArticle('${f.path}', '${f.sha}')" class="text-blue-400"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteArticle('${f.path}', '${f.sha}')" class="text-red-400"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        } catch (e) { list.innerHTML = "Ø§Ù„Ù…Ø¬Ù„Ø¯ ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯."; }
    }

    async function deleteArticle(path, sha) {
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
        try {
            const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, {
                method: "DELETE",
                headers: { "Authorization": `token ${ghToken}`, "Content-Type": "application/json" },
                body: JSON.stringify({ message: "Delete post", sha: sha })
            });
            if(res.ok) { alert("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù"); loadArticles(); }
        } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù"); }
    }

    async function editArticle(path, sha) {
        const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, {
            headers: { "Authorization": `token ${ghToken}` }
        });
        const data = await res.json();
        // ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
        const rawContent = decodeURIComponent(atob(data.content).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        
        const parts = rawContent.split('---');
        document.getElementById('postTitle').value = parts[1].match(/title:\s*"(.*)"/)[1];
        quill.root.innerHTML = parts.slice(2).join('---');
        document.getElementById('slug').value = path.split('/').pop().replace('.md', '');
        currentSha = sha;
        isEditing = true;
        window.scrollTo(0,0);
    }

    function resetEditor() {
        document.getElementById('postTitle').value = "";
        quill.root.innerHTML = "";
        document.getElementById('slug').value = "";
        isEditing = false;
        currentSha = null;
    }

    // ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    document.getElementById('imgInput').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function() {
            document.getElementById('previewImg').src = reader.result;
            document.getElementById('previewImg').classList.remove('hidden');
            document.getElementById('imgPlaceholder').classList.add('hidden');
        }
        reader.readAsDataURL(e.target.files[0]);
    });
</script>
</body>
</html>
