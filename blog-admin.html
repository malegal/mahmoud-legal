<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>المستشار الذكي | Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root { --gold: #d4af37; --dark-blue: #020617; }
        body { font-family: 'Tajawal', sans-serif; background: var(--dark-blue); color: #e2e8f0; margin: 0; padding: 0; }
        .serif-font { font-family: 'Amiri', serif; }
        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(212,175,55,0.1); }
        .ql-container { background: #fff !important; color: #000 !important; min-height: 400px; font-size: 1.1rem; border-radius: 0 0 8px 8px; }
        .ql-editor { text-align: right; direction: rtl; font-family: 'Amiri', serif; }
        .btn-gold { background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728); color: #020617; font-weight: 700; transition: 0.3s; }
        
        /* تحسين للموبايل */
        @media (max-width: 768px) {
            .ql-container { min-height: 300px; }
            header h1 { font-size: 1rem; }
            .main-content { padding: 10px; }
        }

        #previewModal { display: none; position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.95); }
    </style>
</head>
<body>

<!-- شاشة القفل -->
<div id="lock-screen" class="fixed inset-0 z-[3000] bg-slate-950 flex items-center justify-center p-6">
    <div class="glass p-8 rounded-2xl w-full max-w-sm text-center border-t-4 border-yellow-600">
        <i class="fas fa-balance-scale text-5xl text-yellow-500 mb-4"></i>
        <h2 class="text-xl font-bold mb-6">نظام المستشار القانوني</h2>
        <input type="password" id="adminPass" placeholder="كلمة المرور" class="w-full p-3 rounded bg-slate-900 border border-slate-700 text-center mb-4 text-white">
        <button onclick="checkPass()" class="btn-gold w-full py-3 rounded-lg">دخول</button>
    </div>
</div>

<!-- المعاينة -->
<div id="previewModal" class="overflow-y-auto p-4">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-2xl relative">
        <div class="sticky top-0 bg-gray-100 p-4 flex justify-between items-center border-b">
            <span class="font-bold text-black">معاينة قبل النشر</span>
            <button onclick="closePreview()" class="text-red-600 text-2xl"><i class="fas fa-times-circle"></i></button>
        </div>
        <div id="previewBody" class="p-6 text-black ql-editor"></div>
    </div>
</div>

<div id="dashboard" class="hidden min-h-screen flex flex-col">
    <!-- الهيدر -->
    <header class="glass sticky top-0 z-50 p-3 md:p-4 border-b border-white/10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-gavel text-yellow-500"></i>
                <h1 class="font-bold text-white serif-font truncate max-w-[150px] md:max-w-none">محمود عبد الحميد</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleSettings()" class="bg-slate-800 p-2 px-3 rounded text-sm"><i class="fas fa-cog"></i></button>
                <button onclick="openPreview()" class="bg-blue-600 p-2 px-3 rounded text-sm"><i class="fas fa-eye"></i></button>
                <button onclick="saveToGitHub(false)" id="publish-btn" class="btn-gold p-2 px-4 rounded text-sm">نشر</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto w-full p-3 md:p-6 grid grid-cols-1 lg:grid-cols-4 gap-6 main-content">
        <!-- منطقة المحرر -->
        <div class="lg:col-span-3 space-y-4">
            <input type="text" id="postTitle" placeholder="عنوان البحث القانوني..." class="w-full bg-transparent text-2xl md:text-3xl font-bold border-b border-slate-700 focus:border-yellow-500 outline-none py-2 serif-font">
            
            <div class="glass p-3 rounded-xl space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] text-yellow-500 block mb-1">موديل الذكاء الاصطناعي (Groq Model):</label>
                        <input type="text" id="modelId" placeholder="مثال: llama-3.3-70b-versatile" class="w-full bg-black/40 border border-white/10 p-2 rounded text-xs text-white">
                    </div>
                    <div class="flex items-end">
                        <button onclick="aiLegalDraft()" id="ai-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 p-2 rounded text-sm flex items-center justify-center gap-2">
                            <i class="fas fa-robot"></i> صياغة بواسطة الذكاء الاصطناعي
                        </button>
                    </div>
                </div>
            </div>

            <div id="editor" class="shadow-xl"></div>
        </div>

        <!-- الشريط الجانبي -->
        <div class="space-y-4">
            <div class="glass p-4 rounded-xl">
                <h3 class="text-yellow-500 font-bold mb-4 text-sm border-b border-white/10 pb-2">بيانات النشر</h3>
                <div class="space-y-3">
                    <input type="text" id="slug" placeholder="اسم الرابط (slug)" class="w-full bg-black/40 border border-white/10 p-2 rounded text-xs">
                    <textarea id="excerpt" rows="3" placeholder="ملخص قصير..." class="w-full bg-black/40 border border-white/10 p-2 rounded text-xs"></textarea>
                    <button onclick="saveToGitHub(true)" id="draft-btn" class="w-full bg-slate-700 p-2 rounded text-xs"><i class="fas fa-save"></i> حفظ كمسودة</button>
                </div>
            </div>

            <div class="glass p-4 rounded-xl flex flex-col h-[300px] md:h-[450px]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-sm">المقالات والمسودات</h3>
                    <button onclick="loadArticles()" class="text-blue-400 text-xs"><i class="fas fa-sync"></i> تحديث</button>
                </div>
                <div id="articlesList" class="overflow-y-auto space-y-2 text-xs flex-grow"></div>
            </div>
        </div>
    </main>
</div>

<!-- لوحة الإعدادات -->
<div id="settings-panel" class="hidden fixed inset-0 z-[4000] bg-black/90 flex justify-center items-center p-4">
    <div class="glass p-6 rounded-2xl w-full max-w-md">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold">إعدادات الربط</h3>
            <button onclick="toggleSettings()" class="text-gray-400"><i class="fas fa-times"></i></button>
        </div>
        <div class="space-y-4">
            <div>
                <label class="text-[10px] text-gray-400">GitHub Token</label>
                <input type="password" id="ghToken" class="w-full p-2 bg-slate-900 rounded border border-white/5 text-sm">
            </div>
            <div>
                <label class="text-[10px] text-gray-400">Groq API Key</label>
                <input type="password" id="groqKey" class="w-full p-2 bg-slate-900 rounded border border-white/5 text-sm">
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="text-[10px] text-gray-400">Repo Owner</label>
                    <input type="text" id="repoOwner" class="w-full p-2 bg-slate-900 rounded border border-white/5 text-sm">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400">Repo Name</label>
                    <input type="text" id="repoName" class="w-full p-2 bg-slate-900 rounded border border-white/5 text-sm">
                </div>
            </div>
            <button onclick="saveKeys()" class="btn-gold w-full py-3 rounded-lg mt-4">حفظ وإغلاق</button>
        </div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    let ghToken, groqKey, repoOwner, repoName, currentSha = null, isEditing = false;

    const quill = new Quill('#editor', {
        theme: 'snow',
        modules: { toolbar: [[{'header': [1, 2, 3, false]}], ['bold', 'italic'], [{'list': 'ordered'}, {'list': 'bullet'}], [{'direction': 'rtl'}, {'align': []}], ['link', 'clean']] }
    });

    function checkPass() {
        if(document.getElementById('adminPass').value === "mahmoud237") {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('dashboard').classList.remove('hidden');
            loadSettings();
        } else alert("كلمة المرور خاطئة");
    }

    function loadSettings() {
        ghToken = localStorage.getItem('m_gh') || "";
        groqKey = localStorage.getItem('m_groq') || "";
        repoOwner = localStorage.getItem('m_owner') || "malegal";
        repoName = localStorage.getItem('m_repo') || "mahmoud-legal";
        
        document.getElementById('ghToken').value = ghToken;
        document.getElementById('groqKey').value = groqKey;
        document.getElementById('repoOwner').value = repoOwner;
        document.getElementById('repoName').value = repoName;
        
        if(ghToken) loadArticles();
    }

    function saveKeys() {
        ghToken = document.getElementById('ghToken').value.trim();
        groqKey = document.getElementById('groqKey').value.trim();
        repoOwner = document.getElementById('repoOwner').value.trim();
        repoName = document.getElementById('repoName').value.trim();

        localStorage.setItem('m_gh', ghToken);
        localStorage.setItem('m_groq', groqKey);
        localStorage.setItem('m_owner', repoOwner);
        localStorage.setItem('m_repo', repoName);

        alert("✅ تم الحفظ بنجاح");
        toggleSettings(); // إغلاق النافذة فقط دون إعادة تحميل
    }

    function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }

    function openPreview() {
        const body = `<h1>${document.getElementById('postTitle').value}</h1>${quill.root.innerHTML}`;
        document.getElementById('previewBody').innerHTML = body;
        document.getElementById('previewModal').style.display = 'block';
    }
    function closePreview() { document.getElementById('previewModal').style.display = 'none'; }

    // تحويل النص لـ Base64 مع دعم العربية
    function toUTF8Base64(str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
    }

    async function aiLegalDraft() {
        const title = document.getElementById('postTitle').value;
        const model = document.getElementById('modelId').value;
        if(!groqKey || !title || !model) return alert("⚠️ أكمل: العنوان + مفتاح Groq + اسم النموذج");

        const btn = document.getElementById('ai-btn');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الكتابة...';

        try {
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${groqKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: "system", content: "أنت مستشار قانوني مصري خبير. اكتب مقالاً قانونياً بـ HTML يتضمن مواد القانون المصري ومقارنة بالفرنسي." },
                               { role: "user", content: `اكتب عن: ${title}` }]
                })
            });
            const data = await res.json();
            quill.root.innerHTML = data.choices[0].message.content.replace(/```html|```/g, '');
            document.getElementById('slug').value = title.trim().replace(/\s+/g, '-');
        } catch (e) { alert("خطأ في الاتصال"); }
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-robot"></i> صياغة بواسطة الذكاء الاصطناعي';
    }

    async function saveToGitHub(isDraft) {
        if(!ghToken) return alert("إعدادات GitHub ناقصة");
        const title = document.getElementById('postTitle').value;
        const slug = document.getElementById('slug').value;
        if(!title || !slug) return alert("العنوان والرابط مطلوبان");

        const path = isDraft ? `blog/drafts/${slug}.md` : `blog/articles/${slug}.md`;
        const content = `---
title: "${title}"
date: "${new Date().toISOString()}"
description: "${document.getElementById('excerpt').value}"
layout: post
---
${quill.root.innerHTML}`;

        try {
            const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${ghToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Update via Admin",
                    content: toUTF8Base64(content),
                    sha: isEditing ? currentSha : undefined
                })
            });
            if(res.ok) { alert("✅ تم الحفظ"); resetEditor(); loadArticles(); }
            else alert("❌ فشل النشر");
        } catch (e) { alert("خطأ تقني"); }
    }

    async function loadArticles() {
        const list = document.getElementById('articlesList');
        list.innerHTML = "جاري التحميل...";
        try {
            let html = '';
            for (let folder of ['blog/articles', 'blog/drafts']) {
                const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${folder}`, {
                    headers: { 'Authorization': `token ${ghToken}` }
                });
                if(!res.ok) continue;
                const files = await res.json();
                files.forEach(f => {
                    if(!f.name.endsWith('.md')) return;
                    html += `
                    <div class="flex items-center justify-between bg-slate-900 p-2 rounded border border-white/5">
                        <span class="truncate w-3/4">${f.name}</span>
                        <div class="flex gap-2">
                            <button onclick="editArticle('${f.path}', '${f.sha}')" class="text-blue-400"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteArticle('${f.path}', '${f.sha}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                });
            }
            list.innerHTML = html || "لا يوجد مقالات";
        } catch (e) { list.innerHTML = "خطأ في التحميل"; }
    }

    async function deleteArticle(path, sha) {
        if(!confirm("حذف نهائي؟")) return;
        const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, {
            method: 'DELETE',
            headers: { 'Authorization': `token ${ghToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: "Delete", sha: sha })
        });
        if(res.ok) { alert("تم الحذف"); loadArticles(); }
    }

    async function editArticle(path, sha) {
        const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, {
            headers: { 'Authorization': `token ${ghToken}` }
        });
        const data = await res.json();
        const raw = decodeURIComponent(atob(data.content).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        const parts = raw.split('---');
        document.getElementById('postTitle').value = parts[1].match(/title:\s*"(.*)"/)[1];
        quill.root.innerHTML = parts.slice(2).join('---');
        document.getElementById('slug').value = data.name.replace('.md', '');
        currentSha = sha; isEditing = true;
        window.scrollTo(0,0);
    }

    function resetEditor() {
        document.getElementById('postTitle').value = '';
        document.getElementById('slug').value = '';
        quill.root.innerHTML = '';
        isEditing = false; currentSha = null;
    }
</script>
</body>
</html>
