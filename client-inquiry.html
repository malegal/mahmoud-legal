<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù‚Ø¶ÙŠØ© - Ù…Ø¤Ø³Ø³Ø© Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ù…ÙŠØ¯</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --gold: #bf953f;
            --gold-light: #fcf6ba;
            --dark: #020617;
            --dark-2: #0f172a;
            --gray: #94a3b8;
            --light: #f8fafc;
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-2) 100%);
            color: var(--light);
            min-height: 100vh;
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }

        .header {
            background: rgba(0,0,0,0.9);
            border-bottom: 2px solid var(--gold);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 12px 0;
        }

        .navbar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--gold);
            text-decoration: none;
        }

        .logo-img { width: 54px; height: 54px; object-fit: contain; border-radius: 8px; }

        .logo-text h1 { font-size: 1.4rem; margin: 0; color: var(--gold-light); font-family: 'Amiri', serif; }
        .logo-text h2 { font-size: 0.95rem; margin: 0; color: var(--gold); }

        .btn {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            color: var(--dark);
            padding: 10px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(191,149,63,0.3); }

        .inquiry-box {
            background: rgba(0,0,0,0.75);
            border: 1px solid rgba(191,149,63,0.25);
            border-radius: 20px;
            padding: 32px;
            margin: 40px auto;
            max-width: 780px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        }

        h1 { color: var(--gold); text-align: center; margin-bottom: 1.2rem; font-size: 1.9rem; }

        .form-group { margin-bottom: 1.6rem; text-align: right; }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gold);
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255,255,255,0.06);
            border: 1.5px solid rgba(191,149,63,0.35);
            border-radius: 10px;
            color: white;
            font-size: 1.05rem;
            transition: 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(191,149,63,0.18);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            color: var(--dark);
            width: 100%;
            padding: 16px;
            font-size: 1.15rem;
            margin-top: 0.8rem;
        }

        .result-box {
            display: none;
            background: rgba(0,0,0,0.4);
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 24px;
            margin-top: 2rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .info-item {
            background: rgba(191,149,63,0.08);
            padding: 14px;
            border-radius: 10px;
            border: 1px solid rgba(191,149,63,0.2);
        }

        .info-label { color: var(--gray); font-size: 0.9rem; margin-bottom: 0.4rem; }
        .info-value { color: var(--gold-light); font-weight: 600; font-size: 1.1rem; }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            display: none;
        }

        .error   { background: rgba(239,68,68,0.2); color: #f87171; border: 1px solid #f87171; }
        .success { background: rgba(34,197,94,0.2); color: #4ade80; border: 1px solid #4ade80; }

        .loading {
            pointer-events: none;
            opacity: 0.75;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            inset: 0;
            margin: auto;
            width: 24px; height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 640px) {
            .inquiry-box { padding: 20px; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header class="header">
    <div class="container">
        <nav class="navbar">
            <a href="#" class="logo">
                <img src="https://raw.githubusercontent.com/malegal/mahmoud-legal/main/logo.png" class="logo-img" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙƒØªØ¨" onerror="this.src='https://via.placeholder.com/54?text=âš–ï¸'">
                <div class="logo-text">
                    <h1>Ù…Ø¤Ø³Ø³Ø© Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ù…ÙŠØ¯</h1>
                    <h2>Ø§Ù„Ù…Ø­Ø§Ù…Ø§Ø© â€“ Ø§Ù„Ù†Ù‚Ø¶ ÙˆØ§Ù„Ø¯Ø³ØªÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ù„ÙŠØ§</h2>
                </div>
            </a>
            <a href="index.html" class="btn"><i class="fas fa-home"></i> Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </nav>
    </div>
</header>

<main class="container">
    <div class="inquiry-box">
        <h1><i class="fas fa-balance-scale"></i> Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù‚Ø¶ÙŠØ©</h1>

        <!-- Ø®Ø·ÙˆØ© 1 â€“ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­Ù‚Ù‚ -->
        <div id="step-method">
            <h3 style="color:var(--gold); margin:1.5rem 0 1rem; text-align:right;">
                <i class="fas fa-shield-halved"></i> Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªØ­Ù‚Ù‚
            </h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:2rem;">
                <button class="btn verification-btn active" data-method="email">
                    <i class="fas fa-envelope"></i> Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                </button>
                <button class="btn verification-btn" data-method="telegram">
                    <i class="fab fa-telegram-plane"></i> Telegram
                </button>
            </div>
        </div>

        <!-- Ø®Ø·ÙˆØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ -->
        <div id="step-email" style="display:block;">
            <div class="form-group">
                <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„</label>
                <input type="email" id="email" class="form-control" placeholder="example@domain.com" autocomplete="email">
            </div>
            <button id="btn-send-email" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</button>
        </div>

        <!-- Ø®Ø·ÙˆØ© Telegram -->
        <div id="step-telegram" style="display:none;">
            <div class="form-group">
                <label for="telegram">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù€ Telegram</label>
                <input type="tel" id="telegram" class="form-control" placeholder="201xxxxxxxxx" autocomplete="tel">
            </div>
            <div style="background:rgba(191,149,63,0.12); padding:1rem; border-radius:10px; margin:1.2rem 0; font-size:0.95rem;">
                <strong>Ù…Ù‡Ù…:</strong> ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‚Ø¯ Ø¨Ø¯Ø£Øª Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙˆØª @Lawyer_OTP_Bot ÙˆØ§Ø¶ØºØ·Øª Start<br>
                <a href="https://t.me/Lawyer_OTP_Bot" target="_blank" style="color:var(--gold); font-weight:600; display:inline-flex; align-items:center; gap:8px; margin-top:0.6rem;">
                    <i class="fab fa-telegram-plane"></i> Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙˆØª
                </a>
            </div>
            <button id="btn-send-telegram" class="btn btn-primary"><i class="fab fa-telegram-plane"></i> Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</button>
        </div>

        <!-- Ø®Ø·ÙˆØ© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ -->
        <div id="step-otp" style="display:none;">
            <div class="form-group">
                <label for="otp">ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (6 Ø£Ø±Ù‚Ø§Ù…)</label>
                <input type="text" id="otp" class="form-control" maxlength="6" inputmode="numeric" pattern="[0-9]*" placeholder="______">
            </div>
            <button id="btn-verify-otp" class="btn btn-primary"><i class="fas fa-check-circle"></i> Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯</button>
            <div style="margin-top:1.2rem; font-size:0.9rem; color:var(--gray); text-align:center;">
                <a href="#" id="link-resend" style="color:var(--gold);">Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯</a>
                <span id="resend-countdown"></span>
            </div>
        </div>

        <!-- Ø®Ø·ÙˆØ© ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¶ÙŠØ© -->
        <div id="step-case" style="display:none;">
            <div class="form-group">
                <label for="caseCode">ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¶ÙŠØ© (Ù…Ø«Ø§Ù„: MA-123456)</label>
                <input type="text" id="caseCode" class="form-control" placeholder="MA-123456" autocomplete="off" style="text-transform:uppercase;">
            </div>
            <button id="btn-search-case" class="btn btn-primary"><i class="fas fa-search"></i> Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù‚Ø¶ÙŠØ©</button>
        </div>

        <div id="msg-error" class="message error"></div>
        <div id="msg-success" class="message success"></div>

        <!-- Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… -->
        <div id="result-box" class="result-box">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ -->
        </div>
    </div>
</main>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â€“ ÙŠÙÙØ¶Ù„ Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CONFIG = {
    SUPABASE_URL:    'https://iyhfafodhptcdwrjywek.supabase.co',
    SUPABASE_KEY:    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ',
    EMAILJS_SERVICE: 'service_kpadqtp',
    EMAILJS_TEMPLATE:'template_vnftwza',
    EMAILJS_PUBLIC:  'RCaH1Upo_Fep1Rorw',
    TELEGRAM_TOKEN:  '8540084389:AAF3nRVjtzFwhGgLz0qryp-WCstGkeUlORU',
    SESSION_HOURS:   24,
    OTP_EXPIRY_MIN:  15,
    RESEND_SECONDS:  60
};

const supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
emailjs.init(CONFIG.EMAILJS_PUBLIC);

let currentMethod = 'email';
let userIdentifier = '';
let resendTimer = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© UI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showStep(id) {
    document.querySelectorAll('[id^="step-"]').forEach(el => el.style.display = 'none');
    document.getElementById(id).style.display = 'block';
}

function showMessage(type, text) {
    const el = document.getElementById(`msg-${type}`);
    el.textContent = text;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 7000);
}

function setLoading(btnId, loading = true) {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    btn.classList.toggle('loading', loading);
    btn.disabled = loading;
}

function startResendCountdown() {
    let sec = CONFIG.RESEND_SECONDS;
    const link = document.getElementById('link-resend');
    const count = document.getElementById('resend-countdown');

    link.style.pointerEvents = 'none';
    link.style.opacity = '0.5';

    resendTimer = setInterval(() => {
        sec--;
        count.textContent = ` (${sec})`;
        if (sec <= 0) {
            clearInterval(resendTimer);
            link.style.pointerEvents = 'auto';
            link.style.opacity = '1';
            count.textContent = '';
        }
    }, 1000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù„Ø³Ø© Ø³Ø§Ø¨Ù‚Ø©
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkSession() {
    const data = localStorage.getItem('inquirySession');
    if (!data) return;

    try {
        const session = JSON.parse(data);
        if (Date.now() < session.expires) {
            userIdentifier = session.identifier;
            currentMethod = session.method;
            showStep('step-case');
            showMessage('success', 'ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­');
        } else {
            localStorage.removeItem('inquirySession');
        }
    } catch {}
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Ø­ÙØ¸ Ø¬Ù„Ø³Ø©
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveSession() {
    const session = {
        identifier: userIdentifier,
        method: currentMethod,
        expires: Date.now() + CONFIG.SESSION_HOURS * 60 * 60 * 1000
    };
    localStorage.setItem('inquirySession', JSON.stringify(session));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Ø¥Ø±Ø³Ø§Ù„ OTP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendOTP(method) {
    const inputId = method === 'email' ? 'email' : 'telegram';
    const btnId   = method === 'email' ? 'btn-send-email' : 'btn-send-telegram';

    const value = document.getElementById(inputId).value.trim();
    if (!value) {
        showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ' + (method === 'email' ? 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' : 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'));
        return;
    }

    setLoading(btnId, true);

    try {
        // 1. ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ OTP
        const code = String(Math.floor(100000 + Math.random() * 900000));

        // 2. Ø­ÙØ¸ ÙÙŠ Supabase (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€“ Ù„Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù„Ø§Ø­Ù‚)
        const { error } = await supabase
            .from('otp_codes')
            .insert({
                [method === 'email' ? 'email' : 'phone_number']: value,
                otp_code: code,
                expires_at: new Date(Date.now() + CONFIG.OTP_EXPIRY_MIN * 60000).toISOString(),
                is_used: false
            });

        if (error) console.warn('Supabase OTP save failed:', error);

        let success = false;
        let errorMsg = '';

        if (method === 'email') {
            const params = {
                to_email: value,
                verification_code: code,
                client_name: 'Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„ÙƒØ±ÙŠÙ…',
                office_name: 'Ù…Ø¤Ø³Ø³Ø© Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ù…ÙŠØ¯',
                expiry_time: new Date(Date.now() + CONFIG.OTP_EXPIRY_MIN * 60000).toLocaleTimeString('ar-EG')
            };

            const res = await emailjs.send(
                CONFIG.EMAILJS_SERVICE,
                CONFIG.EMAILJS_TEMPLATE,
                params
            );

            success = res.status === 200;
            if (!success) errorMsg = 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';
        } else {
            // Telegram
            let phone = value.replace(/\D/g, '');
            if (!phone.startsWith('20')) phone = '20' + phone;

            const msg = `
ğŸ” ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚: *${code}*

ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© ${CONFIG.OTP_EXPIRY_MIN} Ø¯Ù‚ÙŠÙ‚Ø©
Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø£Ø­Ø¯

Ù…Ø¤Ø³Ø³Ø© Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ù…ÙŠØ¯ Ù„Ù„Ù…Ø­Ø§Ù…Ø§Ø©
            `;

            const res = await fetch(`https://api.telegram.org/bot${CONFIG.TELEGRAM_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chat_id: phone,
                    text: msg,
                    parse_mode: 'Markdown'
                })
            });

            const data = await res.json();
            success = data.ok;

            if (!success) {
                if (data.description?.includes('chat not found')) {
                    errorMsg = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©. ÙŠØ±Ø¬Ù‰ ÙØªØ­ @Lawyer_OTP_Bot ÙˆØ§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Start Ø£ÙˆÙ„Ø§Ù‹.';
                } else if (data.description?.includes('blocked')) {
                    errorMsg = 'ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¨ÙˆØª Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±.';
                } else {
                    errorMsg = 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± Telegram';
                }
            }
        }

        if (success) {
            userIdentifier = value;
            currentMethod = method;
            showStep('step-otp');
            showMessage('success', `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ ${method === 'email' ? 'Ø¨Ø±ÙŠØ¯Ùƒ' : 'Telegram'}`);
            startResendCountdown();
            saveSession();
        } else {
            showMessage('error', errorMsg || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
        }

    } catch (err) {
        showMessage('error', 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ' + err.message);
    } finally {
        setLoading(btnId, false);
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function verifyOTP() {
    const code = document.getElementById('otp').value.trim();
    if (code.length !== 6 || !/^\d{6}$/.test(code)) {
        showMessage('error', 'Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 6 Ø£Ø±Ù‚Ø§Ù…');
        return;
    }

    setLoading('btn-verify-otp', true);

    try {
        const { data, error } = await supabase
            .from('otp_codes')
            .select('*')
            .eq('otp_code', code)
            .eq(currentMethod === 'email' ? 'email' : 'phone_number', userIdentifier)
            .eq('is_used', false)
            .gt('expires_at', new Date().toISOString())
            .maybeSingle();

        if (error || !data) {
            showMessage('error', 'Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
            return;
        }

        // mark as used
        await supabase.from('otp_codes').update({ is_used: true }).eq('id', data.id);

        showStep('step-case');
        showMessage('success', 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­! Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¶ÙŠØ©');

    } catch (err) {
        showMessage('error', 'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚');
    } finally {
        setLoading('btn-verify-otp', false);
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚Ø¶ÙŠØ© (Ù…Ø«Ø§Ù„ Ù…Ø¨Ø³Ø· â€“ ÙŠØ­ØªØ§Ø¬ ØªØ·ÙˆÙŠØ± Ø­Ø³Ø¨ Ù‡ÙŠÙƒÙ„ Ø¬Ø¯ÙˆÙ„Ùƒ)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function searchCase() {
    const code = document.getElementById('caseCode').value.trim().toUpperCase();
    if (!code) {
        showMessage('error', 'Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¶ÙŠØ©');
        return;
    }

    setLoading('btn-search-case', true);

    try {
        const { data, error } = await supabase
            .from('cases')
            .select('*, sessions(*)')
            .eq('case_code', code)
            .single();

        if (error || !data) {
            showMessage('error', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø¶ÙŠØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯');
            return;
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙŠÙ…ÙƒÙ† ØªÙˆØ³ÙŠØ¹Ù‡Ø§)
        document.getElementById('result-box').innerHTML = `
            <h2 style="color:var(--gold);">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ø¶ÙŠØ© ${data.case_code}</h2>
            <div class="info-grid">
                <div class="info-item"><div class="info-label">Ø§Ù„Ø¹Ù…ÙŠÙ„</div><div class="info-value">${data.client_name || '-'}</div></div>
                <div class="info-item"><div class="info-label">Ø§Ù„Ù…Ø­ÙƒÙ…Ø©</div><div class="info-value">${data.court || '-'}</div></div>
                <div class="info-item"><div class="info-label">Ø§Ù„Ø­Ø§Ù„Ø©</div><div class="info-value">${data.status || '-'}</div></div>
            </div>
            <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ ... -->
        `;
        document.getElementById('result-box').style.display = 'block';

    } catch (err) {
        showMessage('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«');
    } finally {
        setLoading('btn-search-case', false);
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Events
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
    checkSession();

    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
    document.querySelectorAll('.verification-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentMethod = btn.dataset.method;
            document.querySelectorAll('.verification-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            showStep(`step-${currentMethod}`);
        });
    });

    document.getElementById('btn-send-email').onclick    = () => sendOTP('email');
    document.getElementById('btn-send-telegram').onclick = () => sendOTP('telegram');
    document.getElementById('btn-verify-otp').onclick    = verifyOTP;
    document.getElementById('btn-search-case').onclick   = searchCase;

    document.getElementById('link-resend').onclick = (e) => {
        e.preventDefault();
        if (resendTimer) clearInterval(resendTimer);
        sendOTP(currentMethod);
    };
});
</script>
</body>
</html>
