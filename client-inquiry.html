<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استعلام عن القضية - مؤسسة محمود عبد الحميد</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --gold: #bf953f;
            --gold-light: #fcf6ba;
            --dark: #020617;
            --dark-2: #0f172a;
            --gray: #94a3b8;
            --light: #f8fafc;
            --red: #ef4444;
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-2) 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* العلامة المائية */
        .watermark {
            position: fixed;
            pointer-events: none;
            opacity: 0.03;
            z-index: 9999;
            color: var(--gold);
            font-size: 20px;
            transform: rotate(-45deg);
            display: none; /* تظهر فقط عند وجود نتيجة */
        }
        .wm-1 { top: 20%; left: 10%; }
        .wm-2 { top: 50%; left: 40%; }
        .wm-3 { top: 80%; left: 70%; }

        .container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }

        .header {
            background: rgba(0,0,0,0.95);
            border-bottom: 2px solid var(--gold);
            padding: 10px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar { display: flex; justify-content: space-between; align-items: center; }
        
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; }
        .logo-img { width: 50px; height: 50px; border-radius: 5px; }
        .logo-text h1 { font-family: 'Amiri', serif; font-size: 20px; color: var(--gold-light); margin: 0; }
        .logo-text h2 { font-size: 13px; color: var(--gold); margin: 0; }

        .inquiry-box {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(191, 149, 63, 0.2);
            padding: 30px;
            border-radius: 20px;
            margin: 40px auto;
            max-width: 800px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        h1 { color: var(--gold); text-align: center; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        .form-group { margin-bottom: 20px; text-align: right; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--gold); font-weight: bold; }
        .form-control {
            width: 100%; padding: 15px; background: rgba(255,255,255,0.05);
            border: 2px solid rgba(191,149,63,0.3); border-radius: 10px;
            color: white; font-size: 16px; transition: 0.3s;
        }
        .form-control:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 10px rgba(191,149,63,0.2); }

        .btn-inquiry {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            color: var(--dark); width: 100%; padding: 16px; border-radius: 10px;
            border: none; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-inquiry:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(191,149,63,0.3); }

        /* نتائج الاستعلام */
        .result-box {
            display: none; margin-top: 30px; animation: fadeIn 0.5s ease;
        }

        .session-timer-box {
            background: rgba(239, 68, 68, 0.1); border: 1px solid var(--red);
            padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 20px;
            color: var(--red); font-weight: bold;
        }

        .info-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; margin-bottom: 25px;
        }
        .info-item {
            background: rgba(255, 255, 255, 0.03); padding: 15px;
            border-radius: 10px; border: 1px solid rgba(191, 149, 63, 0.2);
        }
        .info-label { color: var(--gray); font-size: 13px; margin-bottom: 5px; }
        .info-value { color: var(--gold-light); font-weight: bold; }

        .session-item {
            background: rgba(191, 149, 63, 0.05); padding: 15px;
            border-radius: 10px; margin-bottom: 10px; border-right: 4px solid var(--gold);
        }

        .legal-notice {
            background: rgba(191, 149, 63, 0.05); border: 1px dashed var(--gold);
            padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 13px; color: var(--gray);
        }

        .loading-spinner { display: none; margin-left: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 600px) {
            .inquiry-box { padding: 20px; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="watermark wm-1">مؤسسة محمود عبد الحميد</div>
<div class="watermark wm-2">مؤسسة محمود عبد الحميد</div>
<div class="watermark wm-3">مؤسسة محمود عبد الحميد</div>

<header class="header">
    <div class="container navbar">
        <a href="#" class="logo">
            <img src="https://raw.githubusercontent.com/malegal/mahmoud-legal/main/logo.png" alt="Logo" class="logo-img" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>⚖️</text></svg>'">
            <div class="logo-text">
                <h1>محمود عبد الحميد</h1>
                <h2>المحامي بالنقض والدستورية العليا</h2>
            </div>
        </a>
        <button onclick="location.reload()" class="btn-inquiry" style="width: auto; padding: 8px 15px; font-size: 14px;">
            <i class="fas fa-sync"></i> تحديث
        </button>
    </div>
</header>

<main class="container">
    <div class="inquiry-box" id="mainContainer">
        <div id="searchSection">
            <h1><i class="fas fa-search"></i> استعلام عن القضية</h1>
            <p style="text-align: center; color: var(--gray); margin-bottom: 25px;">أدخل البيانات المسجلة لتتبع حالة قضيتك</p>
            
            <form id="inquiryForm">
                <div class="form-group">
                    <label><i class="fas fa-phone"></i> رقم الهاتف المسجل</label>
                    <input type="tel" id="phone" class="form-control" placeholder="01xxxxxxxxx" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-key"></i> كود القضية</label>
                    <input type="text" id="caseCode" class="form-control" placeholder="MA-XXXXXX" required style="text-transform: uppercase;">
                </div>
                <button type="submit" class="btn-inquiry" id="submitBtn">
                    <span>اطلع على القضية</span>
                    <i class="fas fa-spinner fa-spin loading-spinner" id="spinner"></i>
                </button>
            </form>
        </div>

        <div id="resultSection" class="result-box">
            <div class="session-timer-box">
                <i class="fas fa-clock"></i> تنتهي هذه الجلسة وتُمسح البيانات خلال: <span id="timer">15:00</span>
            </div>

            <h2 style="color: var(--gold); margin-bottom: 20px; border-bottom: 1px solid rgba(191,149,63,0.3); padding-bottom: 10px;">
                <i class="fas fa-file-invoice"></i> تفاصيل القضية
            </h2>

            <div class="info-grid" id="caseDetails">
                </div>

            <h3 style="color: var(--gold); margin: 20px 0 15px 0;"><i class="fas fa-gavel"></i> آخر الجلسات والقرارات</h3>
            <div id="sessionsList">
                </div>

            <div class="legal-notice">
                <i class="fas fa-shield-alt"></i> <b>تنبيه أمني:</b> سيتم مسح هذه البيانات فوراً إذا قمت بتحديث الصفحة أو إغلاقها أو عند انتهاء العداد. المعلومات المعروضة سرية وللاستخدام الشخصي فقط.
            </div>
        </div>
    </div>
</main>

<script>
    // إعدادات Supabase
    const SUPABASE_URL = 'https://iyhfafodhptcdwrjywek.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let countdownInterval;

    // منع التحديث العشوائي
    window.addEventListener('beforeunload', (event) => {
        if (document.getElementById('resultSection').style.display === 'block') {
            event.preventDefault();
            event.returnValue = '';
        }
    });

    // دالة بدء العداد
    function startTimer(durationInSeconds) {
        let timer = durationInSeconds;
        const display = document.getElementById('timer');
        
        countdownInterval = setInterval(() => {
            let minutes = Math.floor(timer / 60);
            let seconds = timer % 60;

            display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            if (--timer < 0) {
                clearInterval(countdownInterval);
                location.reload(); // مسح كل شيء
            }
        }, 1000);
    }

    // فورم الاستعلام
    document.getElementById('inquiryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const phone = document.getElementById('phone').value.trim();
        const code = document.getElementById('caseCode').value.trim().toUpperCase();
        const submitBtn = document.getElementById('submitBtn');
        const spinner = document.getElementById('spinner');

        // حالة التحميل
        submitBtn.disabled = true;
        spinner.style.display = 'inline-block';

        try {
            // 1. البحث عن القضية
            const { data: caseData, error: caseError } = await supabase
                .from('cases')
                .select('*')
                .eq('client_phone', phone)
                .eq('case_code', code)
                .single();

            if (caseError || !caseData) {
                Swal.fire({ icon: 'error', title: 'عذراً', text: 'بيانات غير مطابقة. تأكد من الكود ورقم الهاتف.', confirmButtonColor: '#bf953f' });
                return;
            }

            // 2. جلب الجلسات
            const { data: sessions, error: sessionError } = await supabase
                .from('sessions')
                .select('*')
                .eq('case_id', caseData.id)
                .order('session_date', { ascending: false });

            // 3. عرض النتائج
            showResults(caseData, sessions);

        } catch (err) {
            Swal.fire({ icon: 'error', title: 'خطأ', text: 'حدث خطأ في الاتصال بالنظام.' });
        } finally {
            submitBtn.disabled = false;
            spinner.style.display = 'none';
        }
    });

    function showResults(caseData, sessions) {
        document.getElementById('searchSection').style.display = 'none';
        document.getElementById('resultSection').style.display = 'block';
        document.querySelectorAll('.watermark').forEach(w => w.style.display = 'block');

        // تفاصيل القضية
        const detailsContainer = document.getElementById('caseDetails');
        detailsContainer.innerHTML = `
            <div class="info-item"><div class="info-label">اسم العميل</div><div class="info-value">${caseData.client_name}</div></div>
            <div class="info-item"><div class="info-label">رقم القضية</div><div class="info-value">${caseData.case_number || 'غير متوفر'}</div></div>
            <div class="info-item"><div class="info-label">السنة</div><div class="info-value">${caseData.case_year || '-'}</div></div>
            <div class="info-item"><div class="info-label">المحكمة</div><div class="info-value">${caseData.court_name || '-'}</div></div>
            <div class="info-item"><div class="info-label">اسم الخصم</div><div class="info-value">${caseData.opponent_name || '-'}</div></div>
            <div class="info-item"><div class="info-label">كود القضية</div><div class="info-value" style="color:var(--gold)">${caseData.case_code}</div></div>
        `;

        // الجلسات
        const sessionContainer = document.getElementById('sessionsList');
        if (sessions && sessions.length > 0) {
            sessionContainer.innerHTML = sessions.map(s => `
                <div class="session-item">
                    <div style="font-weight: bold; color: var(--gold-light); margin-bottom: 5px;">
                        <i class="far fa-calendar-alt"></i> تاريخ الجلسة: ${new Date(s.session_date).toLocaleDateString('ar-EG')}
                    </div>
                    <div style="font-size: 15px;">
                        <i class="fas fa-info-circle"></i> القرار: ${s.decision || 'بانتظار القرار'}
                    </div>
                </div>
            `).join('');
        } else {
            sessionContainer.innerHTML = '<p style="color:var(--gray)">لا توجد جلسات مسجلة حالياً.</p>';
        }

        // بدء عداد الـ 15 دقيقة (900 ثانية)
        startTimer(900);
    }
</script>

</body>
</html>
