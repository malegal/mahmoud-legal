<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استعلام عن القضية - مؤسسة محمود عبد الحميد للمحاماة</title>
    </head>
<body>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // 1. إعدادات Firebase (انسخها من الصورة التي كانت لديك 14269.jpg)
        const firebaseConfig = {
            apiKey: "AIzaSy...", 
            authDomain: "lawofficeotp.firebaseapp.com",
            projectId: "lawofficeotp",
            // ... باقي البيانات من صورتك
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // 2. إعدادات Supabase
        const SUPABASE_URL = 'https://iyhfafodhptcdwrjywek.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // كودك الموجود بالملف
        const supabase = sacrament.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // إعداد Recaptcha (ضروري لـ Firebase)
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('submitBtn', {
            'size': 'invisible'
        });

        // معالجة إرسال النموذج
        document.getElementById('inquiryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const caseCode = document.getElementById('caseCode').value.trim();
            
            showLoading();
            hideAlert();

            try {
                // الخطوة الأولى: التأكد من وجود الكود في Supabase وجلب رقم الهاتف
                const { data: caseData, error: caseError } = await supabase
                    .from('cases')
                    .select('client_phone')
                    .eq('case_code', caseCode)
                    .single();

                if (caseError || !caseData) {
                    throw new Error('كود القضية هذا غير مسجل لدينا. يرجى مراجعة المكتب.');
                }

                const phoneNumber = caseData.client_phone;

                // الخطوة الثانية: إرسال الـ OTP عبر Firebase
                // ملاحظة: تأكد أن رقم الهاتف في Supabase يبدأ بـ + كود الدولة
                const confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier);
                
                // حفظ البيانات مؤقتاً للانتقال لصفحة التحقق
                window.confirmationResult = confirmationResult;
                sessionStorage.setItem('pendingPhone', phoneNumber);
                sessionStorage.setItem('pendingCaseCode', caseCode);

                showAlert('تم إرسال رمز التحقق إلى هاتفك المسجل لدينا', 'success');

                // الانتقال لصفحة إدخال الرمز (Verify) بعد ثانيتين
                setTimeout(() => {
                    // هنا نفتح نافذة تطلب الرمز أو ننتقل لصفحة أخرى
                    const code = prompt("أدخل رمز التحقق الذي وصلك:");
                    if (code) verifyCode(code);
                }, 2000);

            } catch (error) {
                showAlert(error.message);
            } finally {
                hideLoading();
            }
        });

        async function verifyCode(code) {
            try {
                const result = await window.confirmationResult.confirm(code);
                // إذا نجح التحقق
                showAlert('تم التحقق بنجاح، جاري جلب بيانات القضية...', 'success');
                // توجيه العميل لصفحة عرض النتائج مع كود القضية
                window.location.href = `case_details.html?code=${sessionStorage.getItem('pendingCaseCode')}`;
            } catch (error) {
                showAlert('رمز التحقق غير صحيح، حاول مجدداً');
            }
        }

        // دالة المساعدة لإظهار التنبيهات (الموجودة في كودك الأصلي)
        function showAlert(msg, type='error') {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.style.display = 'block';
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = msg;
        }
        function showLoading() { document.getElementById('loading').style.display = 'block'; }
        function hideLoading() { document.getElementById('loading').style.display = 'none'; }
    </script>
</body>
</html>
