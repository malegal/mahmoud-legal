<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>استعلام العملاء | مؤسسة محمود عبد الحميد</title>
    
    <!-- المكتبات -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary-bg: #020617;
            --gold-gradient: linear-gradient(135deg, #bf953f 0%, #fcf6ba 45%, #b38728 50%, #fbf5b7 55%, #aa771c 100%);
            --gold-solid: #bf953f;
            --glass-bg: rgba(15, 23, 42, 0.7);
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--primary-bg);
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 90%);
            color: #f8fafc;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- الهيدر القديم (كما في صفحة الاستعلام القديمة) --- */
        .header {
            position: fixed; top: 0; width: 100%; height: 70px;
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--gold-solid);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            z-index: 1050;
        }
        .header-logo { font-family: 'Amiri', serif; font-size: 1.4rem; color: #fff; display: flex; align-items: center; gap: 10px; }
        .header-logo i { color: var(--gold-solid); font-size: 1.6rem; }
        
        /* زر الصفحة الرئيسية ذهبي ملكي */
        .home-link {
            color: var(--gold-solid);
            font-size: 1.5rem;
            transition: 0.3s;
            text-decoration: none;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
            filter: drop-shadow(0 0 5px rgba(191,149,63,0.5));
        }
        .home-link:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 15px gold);
        }

        /* --- المحتوى الرئيسي (فورم البحث) --- */
        .main-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin-top: 70px;
            transition: opacity 0.3s ease;
        }
        /* في البداية يكون مخفياً */
        .main-container.hidden {
            display: none;
        }

        /* خلفية سوداء بتأثير زجاجي */
        .search-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(191, 149, 63, 0.3);
            border-radius: 20px;
            padding: 40px 30px;
            width: 100%;
            max-width: 480px;
            text-align: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            position: relative;
        }
        .search-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: var(--gold-gradient); }

        /* --- حقول الإدخال مع البادئات الثابتة --- */
        .input-group-custom {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(191,149,63,0.3);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: 0.3s;
        }
        .input-group-custom:focus-within {
            border-color: var(--gold-solid);
            box-shadow: 0 0 15px rgba(191,149,63,0.2);
        }
        .fixed-prefix {
            background: rgba(0,0,0,0.3);
            color: var(--gold-solid);
            padding: 12px 15px;
            font-weight: bold;
            font-family: monospace;
            font-size: 1.1rem;
            border-left: 1px solid rgba(191,149,63,0.2);
        }
        .form-control-custom {
            background: transparent;
            border: none;
            color: white;
            padding: 12px;
            width: 100%;
            font-size: 1.1rem;
            outline: none;
            text-align: right;
        }
        .form-control-custom::placeholder { color: #64748b; }

        .btn-gold {
            background: var(--gold-gradient); color: #020617; font-weight: 800; border: none;
            width: 100%; padding: 12px; border-radius: 12px; font-size: 1.1rem; cursor: pointer;
            transition: 0.3s; box-shadow: 0 5px 20px rgba(191, 149, 63, 0.3);
        }
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(191, 149, 63, 0.5); }

        /* --- الفوتير --- */
        .footer {
            text-align: center; padding: 20px; color: #64748b; font-size: 0.8rem;
            border-top: 1px solid rgba(255,255,255,0.05); background: rgba(2, 6, 23, 0.95);
        }

        /* ========================================= */
        /* تصميم المودالات (المنسدلة من الهيدر) */
        /* ========================================= */
        
        @keyframes dropFromHeader {
            0% { transform: translateY(-100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .modal.fade .modal-dialog {
            transition: transform 0.4s ease-out;
            transform: translateY(-100px);
        }
        .modal.show .modal-dialog {
            transform: translateY(0);
        }

        .modal-content.glass-theme {
            background: rgba(2, 6, 23, 0.98);
            border: 2px solid var(--gold-solid);
            box-shadow: 0 10px 60px rgba(191, 149, 63, 0.2);
            border-radius: 0 0 20px 20px;
            margin-top: 70px;
        }

        .warning-content { text-align: center; padding: 20px; }
        .legal-box {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(191,149,63,0.2);
            padding: 15px; border-radius: 10px; margin: 20px 0; text-align: right;
            font-size: 0.9rem; color: #cbd5e1;
        }
        .legal-box li { margin-bottom: 8px; list-style: none; position: relative; padding-right: 20px; }
        .legal-box li::before { content: '•'; color: var(--gold-solid); position: absolute; right: 0; font-weight: bold; }

        .info-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0;
        }
        .info-item {
            background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);
        }
        .info-label { display: block; font-size: 0.75rem; color: #94a3b8; }
        .info-value { font-weight: bold; color: #fff; font-size: 0.95rem; }

        .last-session-box {
            background: rgba(191, 149, 63, 0.1); border-right: 4px solid var(--gold-solid);
            padding: 15px; border-radius: 8px; margin-top: 20px;
        }

        .modal-actions {
            display: flex; gap: 10px; justify-content: center; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;
        }
        .btn-action {
            flex: 1; padding: 10px; border-radius: 8px; border: 1px solid transparent; font-weight: bold; font-size: 0.9rem; cursor: pointer; transition: 0.3s;
        }
        .btn-print { border-color: var(--gold-solid); color: var(--gold-solid); background: transparent; }
        .btn-print:hover { background: var(--gold-solid); color: #000; }
        .btn-new { background: #fff; color: #000; }
        .btn-exit { background: #ef4444; color: #fff; }

        @media (max-width: 768px) {
            .info-grid { grid-template-columns: 1fr; }
        }
        
        @media print {
            body * { visibility: hidden; }
            #resultModal, #resultModal * { visibility: visible; }
            .modal-content { border: none !important; box-shadow: none !important; position: absolute; left: 0; top: 0; width: 100%; }
            .modal-actions, .btn-close { display: none !important; }
        }
    </style>
</head>
<body>

    <!-- الهيدر القديم (كما في صفحة الاستعلام القديمة) -->
    <header class="header">
        <div class="header-logo">
            <i class="bi bi-bank"></i> مؤسسة محمود عبد الحميد
        </div>
        <a href="https://almostshar.vercel.app/index.html" class="home-link" title="الرئيسية">
            <i class="bi bi-house-door-fill"></i>
        </a>
    </header>

    <!-- المحتوى الرئيسي (مخفي في البداية) -->
    <main class="main-container hidden" id="mainContent">
        <div class="search-card">
            <h1 style="font-family: 'Amiri'; color: var(--gold-solid); margin-bottom: 10px;">استعلام القضايا</h1>
            <p style="color: #94a3b8; margin-bottom: 30px;">أدخل بيانات القضية للاطلاع على آخر المستجدات</p>

            <form id="searchForm" onsubmit="handleSearch(event)">
                <!-- حقل الهاتف مع معالجة البادئة 20 -->
                <div class="input-group-custom">
                    <input type="tel" id="phoneInput" class="form-control-custom" placeholder="رقم الهاتف" required>
                    <span class="fixed-prefix">20</span>
                </div>

                <!-- حقل الكود مع معالجة البادئة MA- -->
                <div class="input-group-custom">
                    <input type="text" id="codeInput" class="form-control-custom" placeholder="كود القضية" required style="text-transform: uppercase;">
                    <span class="fixed-prefix">MA-</span>
                </div>
                
                <button type="submit" class="btn-gold" id="searchBtn">
                    <i class="bi bi-search"></i> الاطلاع
                </button>
            </form>
        </div>
    </main>

    <!-- الفوتير -->
    <footer class="footer">
        جميع الحقوق محفوظة © 2024 مؤسسة محمود عبد الحميد للمحاماة
    </footer>

    <!-- مودال التحذير (ينسدل من الهيدر) -->
    <div class="modal fade" id="warningModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content glass-theme">
                <div class="warning-content">
                    <i class="bi bi-shield-lock-fill" style="font-size: 3rem; color: var(--gold-solid);"></i>
                    <h3 class="mt-2 text-white" style="font-family: 'Amiri';">تحذير قانوني</h3>
                    
                    <div class="legal-box">
                        <ul>
                            <li>هذا النظام مخصص فقط لعملاء المكتب المصرح لهم.</li>
                            <li>بيانات القضايا المعروضة سرية ومحمية قانونياً.</li>
                            <li>يتم تسجيل بيانات الدخول (IP) لأغراض الحماية.</li>
                            <li>الدخول غير المصرح به يعرضك للمساءلة القانونية.</li>
                        </ul>
                    </div>

                    <button class="btn-gold" onclick="acceptWarning()">
                        <i class="bi bi-check-circle-fill"></i> أوافق وأتابع
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال النتيجة (ينسدل من الهيدر) -->
    <div class="modal fade" id="resultModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content glass-theme text-white">
                <div class="modal-body p-4">
                    <div class="text-center border-bottom border-secondary border-opacity-25 pb-3 mb-3">
                        <h2 id="r_clientName" style="font-family: 'Amiri'; color: var(--gold-solid); margin: 0;">-</h2>
                        <span id="r_clientRole" class="badge bg-light text-dark mt-2">-</span>
                    </div>

                    <div class="info-grid">
                        <div class="info-item"><span class="info-label">اسم الخصم</span><span class="info-value" id="r_opponent">-</span></div>
                        <div class="info-item"><span class="info-label">المحكمة</span><span class="info-value" id="r_court">-</span></div>
                        <div class="info-item"><span class="info-label">رقم القضية</span><span class="info-value" id="r_caseNum">-</span></div>
                        <div class="info-item"><span class="info-label">الدائرة</span><span class="info-value" id="r_circle">-</span></div>
                        <div class="info-item"><span class="info-label">موضوع الدعوى</span><span class="info-value" id="r_subject">-</span></div>
                        <div class="info-item"><span class="info-label">حالة القضية</span><span class="info-value text-warning" id="r_status">-</span></div>
                    </div>

                    <div class="last-session-box">
                        <h5 class="text-white mb-2" style="font-size: 1rem;"><i class="bi bi-clock-history text-warning"></i> آخر جلسة مسجلة</h5>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="r_lastDate" style="color: var(--gold-solid); font-weight: bold;">-</span>
                        </div>
                        <p id="r_lastDecision" class="mb-0 text-white-50" style="font-size: 0.95rem;">-</p>
                    </div>

                    <div class="modal-actions">
                        <button class="btn-action btn-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
                        <button class="btn-action btn-new" onclick="newSearch()"><i class="bi bi-search"></i> بحث جديد</button>
                        <button class="btn-action btn-exit" onclick="exitSystem()"><i class="bi bi-box-arrow-right"></i> خروج</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // إعدادات Supabase
        const SB_URL = "https://iyhfafodhptcdwrjywek.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ";
        const db = supabase.createClient(SB_URL, SB_KEY);
        
        let warningModal, resultModal;
        const mainContent = document.getElementById('mainContent');
        const phoneInput = document.getElementById('phoneInput');
        const codeInput = document.getElementById('codeInput');

        // دالة لإزالة البادئات تلقائياً
        function removePrefix(input, prefix) {
            let value = input.value.trim();
            if (value.startsWith(prefix)) {
                input.value = value.substring(prefix.length).trim();
            }
        }

        // مراقبة حقل الهاتف لإزالة "20" منه
        phoneInput.addEventListener('input', function() {
            removePrefix(this, '20');
        });
        phoneInput.addEventListener('paste', function() {
            setTimeout(() => removePrefix(this, '20'), 10);
        });

        // مراقبة حقل الكود لإزالة "MA-" منه (مع مراعاة حالة الأحرف)
        codeInput.addEventListener('input', function() {
            let val = this.value.trim().toUpperCase();
            if (val.startsWith('MA-')) {
                this.value = val.substring(3).trim();
            } else {
                this.value = val; // تحويل إلى uppercase دائماً
            }
        });
        codeInput.addEventListener('paste', function() {
            setTimeout(() => {
                let val = this.value.trim().toUpperCase();
                if (val.startsWith('MA-')) {
                    this.value = val.substring(3).trim();
                } else {
                    this.value = val;
                }
            }, 10);
        });

        // عند التحميل
        document.addEventListener('DOMContentLoaded', () => {
            const warningEl = document.getElementById('warningModal');
            warningModal = new bootstrap.Modal(warningEl);
            
            const resultEl = document.getElementById('resultModal');
            resultModal = new bootstrap.Modal(resultEl);

            warningModal.show();
        });

        function acceptWarning() {
            warningModal.hide();
            mainContent.classList.remove('hidden');
        }

        async function handleSearch(e) {
            e.preventDefault();
            const btn = document.getElementById('searchBtn');
            const originalText = btn.innerHTML;
            
            // تنظيف المدخلات مرة أخرى (احتياطاً)
            let phoneVal = phoneInput.value.trim();
            let codeVal = codeInput.value.trim().toUpperCase();
            
            // إزالة أي بادئة متبقية
            if (phoneVal.startsWith('20')) phoneVal = phoneVal.substring(2).trim();
            if (codeVal.startsWith('MA-')) codeVal = codeVal.substring(3).trim();

            if(!phoneVal || !codeVal) return;

            const fullPhone = "20" + phoneVal;
            const fullCode = "MA-" + codeVal;

            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> جاري التحقق...';
            btn.disabled = true;

            try {
                const { data: cases, error } = await db
                    .from('cases')
                    .select('*')
                    .eq('case_code', fullCode)
                    .limit(1);

                if (error) throw error;
                
                const targetCase = cases.length > 0 ? cases[0] : null;

                if (!targetCase || !targetCase.client_phone.includes(fullPhone)) {
                    throw new Error("NOT_FOUND");
                }

                const { data: sessions } = await db
                    .from('sessions')
                    .select('*')
                    .eq('case_id', targetCase.id)
                    .order('session_date', { ascending: false })
                    .limit(1);

                const lastSession = sessions && sessions.length > 0 ? sessions[0] : null;

                showResult(targetCase, lastSession);

            } catch (err) {
                console.error(err);
                Swal.fire({
                    icon: 'error',
                    title: 'عذراً',
                    text: 'بيانات الدخول غير صحيحة. يرجى التأكد من الكود ورقم الهاتف.',
                    confirmButtonColor: '#bf953f',
                    background: '#020617',
                    color: '#fff'
                });
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function showResult(c, s) {
            document.getElementById('r_clientName').innerText = c.client_name;
            document.getElementById('r_clientRole').innerText = c.client_role;
            document.getElementById('r_opponent').innerText = c.opponent_name || '-';
            document.getElementById('r_court').innerText = c.court_name;
            document.getElementById('r_caseNum').innerText = c.case_number + ' / ' + c.case_year;
            document.getElementById('r_circle').innerText = c.circle || '-';
            document.getElementById('r_subject').innerText = c.case_subject || 'غير محدد';
            
            if (s) {
                document.getElementById('r_status').innerText = s.case_status;
                const d = new Date(s.session_date);
                document.getElementById('r_lastDate').innerText = d.toLocaleDateString('ar-EG', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
                document.getElementById('r_lastDecision').innerText = s.decision || 'لم يسجل قرار';
            } else {
                document.getElementById('r_status').innerText = 'جديدة';
                document.getElementById('r_lastDate').innerText = 'لا توجد جلسات مسجلة';
                document.getElementById('r_lastDecision').innerText = '';
            }

            resultModal.show();
        }

        function newSearch() {
            resultModal.hide();
            document.getElementById('searchForm').reset();
            // إعادة تعيين الحقول يدوياً بعد المسح
            phoneInput.value = '';
            codeInput.value = '';
        }

        function exitSystem() {
            resultModal.hide();
            Swal.fire({
                icon: 'success',
                title: 'شكراً لك',
                text: 'شكراً لاستخدامكم نظام الاستعلام الإلكتروني لمؤسسة محمود عبد الحميد.',
                background: '#020617',
                color: '#fff',
                confirmButtonColor: '#bf953f',
                confirmButtonText: 'إغلاق',
                timer: 3000
            }).then(() => {
                window.location.href = "https://almostshar.vercel.app/index.html";
            });
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
