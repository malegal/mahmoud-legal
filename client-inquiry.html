<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استعلام عن القضية - مؤسسة محمود عبد الحميد</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- استيراد Supabase مسبقاً لتجنب مشاكل التحميل الديناميكي -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        window.firebaseInit = { initializeApp, getAuth, RecaptchaVerifier, signInWithPhoneNumber };
    </script>

    <style>
        /* ... (نفس التنسيقات الرائعة التي وضعتها في كودك) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        body { background: #020617; color: #f8fafc; min-height: 100vh; background: linear-gradient(135deg, #020617 0%, #0f172a 100%); overflow-x: hidden; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header { background: rgba(0, 0, 0, 0.95); border-bottom: 2px solid #bf953f; padding: 8px 0; position: sticky; top: 0; z-index: 100; }
        .navbar { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: #bf953f; }
        .logo-img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
        .inquiry-box { background: rgba(0, 0, 0, 0.85); border: 1px solid rgba(191, 149, 63, 0.2); padding: 30px; border-radius: 20px; width: 100%; max-width: 800px; text-align: center; margin: 40px auto; }
        .form-control { width: 100%; padding: 15px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(191, 149, 63, 0.3); border-radius: 10px; color: white; font-size: 16px; margin-bottom: 15px; text-align: center; }
        .btn-inquiry { background: linear-gradient(135deg, #bf953f 0%, #fcf6ba 100%); color: #020617; padding: 16px 40px; font-size: 18px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .result-box { display: none; text-align: right; margin-top: 30px; padding: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 15px; border: 3px solid #bf953f; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .info-item { background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(191, 149, 63, 0.2); }
        .message { padding: 12px; border-radius: 8px; margin: 10px 0; display: none; }
        .error { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid #f87171; }
        .success { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid #4ade80; }
        .loading-spinner { display: inline-block; width: 15px; height: 15px; border: 2px solid white; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="#" class="logo">
                    <img src="https://raw.githubusercontent.com/malegal/mahmoud-legal/main/logo.png" alt="Logo" class="logo-img">
                    <div class="logo-text">
                        <h1 style="font-family: 'Amiri';">محمود عبد الحميد</h1>
                        <h2 style="font-size: 14px; color: #bf953f;">المحامي بالنقض والدستورية العليا</h2>
                    </div>
                </a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="inquiry-box">
            <h1><i class="fas fa-search"></i> استعلام عن القضية</h1>
            <p style="margin-bottom: 20px; color: #cbd5e1;">أدخل بياناتك للاطلاع على آخر التطورات</p>

            <!-- Step 1 -->
            <div id="phone-step">
                <input type="tel" id="phone" class="form-control" placeholder="رقم الهاتف (مثال: 01115821523)">
                <div id="recaptcha-container"></div>
                <button id="send-otp-btn" class="btn-inquiry">احصل على كود التحقق</button>
            </div>

            <!-- Step 2 -->
            <div id="otp-step" style="display:none;">
                <input type="text" id="otp" class="form-control" placeholder="أدخل الكود المكون من 6 أرقام">
                <button id="verify-otp-btn" class="btn-inquiry">تحقق الآن</button>
            </div>

            <!-- Step 3 -->
            <div id="case-step" style="display:none;">
                <input type="text" id="caseCode" class="form-control" placeholder="كود القضية (مثال: MA-100)">
                <button id="search-case-btn" class="btn-inquiry">بحث عن القضية</button>
            </div>

            <div id="errorMessage" class="message error"></div>
            <div id="successMessage" class="message success"></div>

            <!-- Results -->
            <div id="inquiryResult" class="result-box">
                <h3 style="color: #bf953f; margin-bottom: 15px;">تفاصيل القضية:</h3>
                <div class="info-grid">
                    <div class="info-item"><div>اسم العميل</div><div id="r-name" style="color: #fcf6ba; font-weight: bold;">-</div></div>
                    <div class="info-item"><div>رقم القضية</div><div id="r-num" style="color: #fcf6ba; font-weight: bold;">-</div></div>
                    <div class="info-item"><div>المحكمة</div><div id="r-court" style="color: #fcf6ba; font-weight: bold;">-</div></div>
                    <div class="info-item"><div>آخر قرار</div><div id="r-decision" style="color: #fcf6ba; font-weight: bold;">-</div></div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyDMkk2HBsa1KAsyDYWSfkgGyqMYzZzXmz0",
            authDomain: "lawofficeotp.firebaseapp.com",
            projectId: "lawofficeotp",
            storageBucket: "lawofficeotp.firebasestorage.app",
            messagingSenderId: "463230643152",
            appId: "1:463230643152:web:00adf4d3c005de13d027d5"
        };

        const { initializeApp } = window.firebaseInit;
        const { getAuth, RecaptchaVerifier, signInWithPhoneNumber } = window.firebaseInit;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        auth.languageCode = 'ar';

        const SUPABASE_URL = 'https://iyhfafodhptcdwrjywek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let confirmationResult = null;

        function msg(type, text) {
            const el = document.getElementById(type === 'err' ? 'errorMessage' : 'successMessage');
            el.textContent = text;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        // إرسال الكود
        document.getElementById('send-otp-btn').onclick = async () => {
            const phone = document.getElementById('phone').value.trim();
            if (!/^01[0-9]{9}$/.test(phone)) return msg('err', 'رقم هاتف غير صحيح');

            const btn = document.getElementById('send-otp-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> جاري الإرسال...';

            try {
                const verifier = new RecaptchaVerifier(auth, 'recaptcha-container', { size: 'invisible' });
                confirmationResult = await signInWithPhoneNumber(auth, `+20${phone.substring(1)}`, verifier);
                document.getElementById('phone-step').style.display = 'none';
                document.getElementById('otp-step').style.display = 'block';
                msg('ok', 'تم إرسال الكود');
            } catch (e) {
                msg('err', 'فشل الإرسال. تأكد من جودة الإنترنت.');
                btn.disabled = false;
                btn.textContent = 'إعادة المحاولة';
            }
        };

        // التحقق من الكود
        document.getElementById('verify-otp-btn').onclick = async () => {
            const otp = document.getElementById('otp').value.trim();
            try {
                await confirmationResult.confirm(otp);
                document.getElementById('otp-step').style.display = 'none';
                document.getElementById('case-step').style.display = 'block';
                msg('ok', 'تم التحقق بنجاح');
            } catch (e) {
                msg('err', 'كود غير صحيح');
            }
        };

        // البحث في Supabase (تم ملء الدالة وتصحيحها)
        document.getElementById('search-case-btn').onclick = async () => {
            const code = document.getElementById('caseCode').value.trim().toUpperCase();
            if (!code) return msg('err', 'أدخل كود القضية');

            // جلب رقم الهاتف الموثق من Firebase لضمان الأمان
            const verifiedPhone = auth.currentUser.phoneNumber.replace('+20', '0');

            try {
                const { data, error } = await supabase
                    .from('cases')
                    .select('*')
                    .eq('case_code', code)
                    .eq('client_phone', verifiedPhone)
                    .single();

                if (error || !data) {
                    return msg('err', 'لم يتم العثور على القضية أو أن الرقم غير مطابق');
                }

                // عرض البيانات
                document.getElementById('r-name').innerText = data.client_name;
                document.getElementById('r-num').innerText = data.case_number;
                document.getElementById('r-court').innerText = data.court_name;
                document.getElementById('r-decision').innerText = data.last_decision || 'قيد المعالجة';
                document.getElementById('inquiryResult').style.display = 'block';
                msg('ok', 'تم جلب البيانات بنجاح');
            } catch (e) {
                msg('err', 'خطأ في الاتصال بقاعدة البيانات');
            }
        };
    </script>
</body>
</html>

