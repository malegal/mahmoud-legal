<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام إدارة القضايا | محمود عبد الحميد للمحاماة</title>
    <meta name="theme-color" content="#bf953f">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href='data:application/manifest+json,{"name":"نظام إدارة القضايا","short_name":"القضايا","start_url":".","display":"standalone","background_color":"#020617","theme_color":"#bf953f","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/1048/1048953.png","sizes":"512x512","type":"image/png"}]}'>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700;900&family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Scripts from v1 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary-dark: #020617;
            --gold-gradient: linear-gradient(135deg, #bf953f 0%, #fcf6ba 45%, #b38728 50%, #fbf5b7 55%, #aa771c 100%);
            --gold-solid: #bf953f;
            --gold-glow: rgba(191, 149, 63, 0.5);
            --header-height: 70px;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--primary-dark);
            color: #f8fafc;
            padding-top: var(--header-height);
            -webkit-tap-highlight-color: transparent;
        }

        .gold-text { background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        .gold-btn {
            background: var(--gold-gradient); color: #1a1a1a; font-weight: 800; border: none;
            box-shadow: 0 0 15px var(--gold-glow); transition: 0.3s;
        }
        .gold-btn:hover { transform: translateY(-2px); box-shadow: 0 0 25px var(--gold-glow); }

        .card-glass {
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px);
            border: 1px solid rgba(191, 149, 63, 0.2); border-radius: 1.2rem;
        }

        .gold-border { border: 1px solid var(--gold-solid) !important; }

        .admin-toolbar {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--gold-solid); z-index: 1100;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }

        .nav-tabs .nav-link { color: #ccc; border: none; border-bottom: 2px solid transparent; }
        .nav-tabs .nav-link.active { color: var(--gold-solid); border-bottom: 2px solid var(--gold-solid); background: transparent; }

        .form-control, .form-select {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(191,149,63,0.3);
            color: white; border-radius: 0.8rem;
        }
        .form-control:focus { background: rgba(255,255,255,0.1); border-color: var(--gold-solid); color: white; }

        @media (max-width: 768px) {
            .admin-toolbar h1 { font-size: 0.9rem !important; }
            .nav-tabs .nav-link { font-size: 0.75rem; padding: 8px 5px; }
            .card-glass { padding: 15px !important; }
            .gold-btn { width: 100%; }
        }
    </style>
</head>
<body>

<div class="admin-toolbar">
    <div class="d-flex align-items-center gap-2">
        <i class="bi bi-shield-check text-warning fs-5"></i>
        <h1 class="gold-text fs-5 fw-bold mb-0">نظام إدارة القضايا</h1>
    </div>
    <button class="gold-btn btn btn-sm px-3" onclick="installPWA()" id="installBtn" style="display:none">تثبيت التطبيق</button>
</div>

<div id="loginPage" class="container mt-5" style="max-width:400px">  
    <div class="form-section text-center">  
        <i class="bi bi-shield-lock-fill" style="font-size: 3rem; color: var(--gold);"></i>  
        <h4 class="mt-3">دخول النظام</h4>  
        <input type="password" id="password" class="form-control my-3" placeholder="كلمة المرور">  
        <button class="gold-btn btn w-100" onclick="login()">دخول</button>  
    </div>  
</div>  
  
<div id="mainContent" style="display:none">  
      
  
    <div class="container-fluid px-3 mt-4">  
        <ul class="nav nav-tabs mb-3" id="mainTabs">  
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cases">القضايا</button></li>  
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sessions">الجلسات</button></li>  
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#search">بحث وتقارير</button></li>  
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#securityLogs">سجل الاستعلامات</button></li>  
        </ul>  
  
        <div class="tab-content">  
            <!-- تبويب القضايا -->  
            <div class="tab-pane fade show active" id="cases">  
                <form id="caseForm" class="card-glass p-3 p-md-4 mb-4">  
                    <h5>تسجيل قضية جديدة</h5>  
                    <hr>  
                    <div class="row g-3">  
                        <div class="col-md-4">
                            <label>اسم العميل</label>
                            <input id="client_name" class="form-control" required>
                        </div>  
                        <div class="col-md-4">
                            <label>هاتف العميل</label>
                            <input id="client_phone" class="form-control" required>
                        </div>  
                        <div class="col-md-4">
                            <label>إيميل العميل</label>
                            <input type="email" id="client_email" class="form-control">
                        </div>  
                        <div class="col-md-4">  
                            <label>صفة العميل</label>  
                            <select id="client_role" class="form-select" required>  
                                <option value="">اختر الصفة...</option>  
                                <option>مدعي</option><option>مدعى عليه</option><option>مستأنف</option><option>مستأنف ضده</option><option>طاعن</option><option>مطعون ضده</option><option>مجني عليه</option><option>متهم</option>  
                            </select>  
                        </div>  
                        <div class="col-md-4">
                            <label>اسم الخصم</label>
                            <input id="opponent_name" class="form-control">
                        </div>  
                        <div class="col-md-4">
                            <label>رقم القضية</label>
                            <input id="case_number" class="form-control" required>
                        </div>  
                        <div class="col-md-4">
                            <label>سنة القضية</label>
                            <input id="case_year" class="form-control" required>
                        </div>  
                        <div class="col-md-6">  
                            <label>المحكمة</label>  
                            <select id="court_name" class="form-select" required>  
                                <option value="">اختر المحكمة...</option>  
                                <option>محكمة الأسرة</option><option>المحكمة الجزئية</option><option>المحكمة الابتدائية</option>  
                                <option>محكمة الاستئناف</option><option>المحكمة العمالية</option><option>المحكمة الاقتصادية</option><option>المحكمة الادارية</option><option>محكمة القضاء الاداري</option><option>المحكمة الادارية العليا</option><option>محكمة النقض</option>  
                            </select>  
                        </div>  
                        <div class="col-md-6">
                            <label>الدائرة</label>
                            <input id="circle" class="form-control">
                        </div>  
                        <div class="col-md-6">
                            <label>نوع القضية</label>
                            <select id="case_type" class="form-select" required>
                                <option value="">اختر نوع القضية...</option>
                                <option value="مدنية">مدنية</option>
                                <option value="جنائية">جنائية</option>
                                <option value="تجارية">تجارية</option>
                                <option value="عمالية">عمالية</option>
                                <option value="أحوال شخصية">أحوال شخصية</option>
                                <option value="إدارية">إدارية</option>
                                <option value="دستورية">دستورية</option>
                                <option value="ضريبية">ضريبية</option>
                            </select>
                        </div>  
                        <div class="col-md-12">
                            <label>موضوع القضية</label>
                            <textarea id="case_subject" class="form-control" rows="2"></textarea>
                        </div>  
                        <div class="col-md-12">
                            <label>ملاحظات</label>
                            <textarea id="notes" class="form-control" rows="3" placeholder="ملاحظات إضافية عن القضية..."></textarea>
                        </div>  
                    </div>  
                    <div class="d-flex gap-2 mt-3">  
                        <button type="submit" class="gold-btn btn flex-grow-1">حفظ القضية</button>  
                        <button type="button" class="btn btn-outline-secondary w-25" onclick="clearForm()">جديد</button>  
                    </div>  
                    <div id="caseCodeResult" class="mt-3 text-center"></div>  
                </form>  
            </div>  
  
            <!-- تبويب الجلسات -->  
            <div class="tab-pane fade" id="sessions">  
                <div class="card-glass p-3 p-md-4 mb-4">  
                    <h5>تسجيل جلسة <span class="auto-fill-badge">الجلب تلقائي</span></h5>  
                    <hr>  
                    <div class="row g-3">  
                        <div class="col-md-12 mb-3">
                            <div class="admin-code-display">
                                <strong>تنسيق كود القضية:</strong> MA-26001Y7U9K5
                                <small class="text-muted d-block">(001 هو الرقم الإداري)</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">  
                            <label>الرقم الإداري (مثل: 001)</label>  
                            <div class="input-group">  
                                <input id="admin_search" class="form-control admin-search-input" placeholder="أدخل الرقم الإداري (001)" onkeyup="searchByAdminNumber(this.value)">  
                                <button class="gold-btn btn" type="button" onclick="searchByAdminNumber(admin_search.value)">  
                                    <i class="bi bi-search"></i>  
                                </button>  
                            </div>  
                        </div>
                        
                        <div class="col-md-6">  
                            <label>بحث بالرقم أو الاسم</label>  
                            <div class="input-group">  
                                <input id="s_search" class="form-control" placeholder="رقم القضية أو اسم العميل" onkeyup="searchCasesForSession(this.value)">  
                                <button class="btn btn-outline-secondary" type="button" onclick="searchCasesForSession(s_search.value)">  
                                    <i class="bi bi-search"></i>  
                                </button>  
                            </div>  
                        </div>
                        
                        <div id="caseSearchResults" class="col-md-12 mt-2" style="max-height:200px;overflow-y:auto;display:none;"></div>  
                        
                        <div class="col-md-4">
                            <label>كود القضية الكامل</label>
                            <input id="s_case_code" class="form-control" readonly>
                        </div>
                        <div class="col-md-4">
                            <label>رقم القضية</label>
                            <input id="s_case_number" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>سنة القضية</label>
                            <input id="s_case_year" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>المحكمة</label>
                            <input id="s_court" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>اسم العميل</label>
                            <input id="s_client" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>هاتف العميل</label>
                            <input id="s_client_phone" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>إيميل العميل</label>
                            <input id="s_client_email" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>اسم الخصم</label>
                            <input id="s_opponent" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>صفة العميل</label>
                            <input id="s_client_role" class="form-control" readonly>
                        </div>  
                        <div class="col-md-4">
                            <label>نوع القضية</label>
                            <input id="s_case_type" class="form-control" readonly>
                        </div>  
                        <div class="col-md-6">
                            <label>تاريخ الجلسة</label>
                            <input type="datetime-local" id="s_date" class="form-control">
                        </div>  
                        <div class="col-md-6">
                            <label>حالة القضية</label>
                            <select id="s_case_status" class="form-select">
                                <option value="جديدة">جديدة</option>
                                <option value="مؤجلة">مؤجلة</option>
                                <option value="مشطوبة">مشطوبة</option>
                                <option value="موقوفة">موقوفة</option>
                                <option value="محجوزة للحكم">محجوزة للحكم</option>
                                <option value="محكوم فيها">محكوم فيها</option>
                            </select>
                        </div>  
                        <div class="col-md-12">
                            <label>القرار</label>
                            <textarea id="s_decision" class="form-control" rows="3"></textarea>
                        </div>  
                        <div class="col-md-12">
                            <label>ملاحظات القضية</label>
                            <textarea id="s_notes" class="form-control" rows="2" readonly></textarea>
                        </div>  
                    </div>  
                    <div class="d-flex gap-2 mt-3">  
                        <button class="gold-btn btn flex-grow-1" onclick="saveSession()">حفظ الجلسة</button>  
                        <button class="btn btn-outline-success" onclick="addToGoogleCalendar()" id="calendarBtn" disabled>  
                            <i class="bi bi-calendar-plus"></i> إضافة للتقويم  
                        </button>  
                    </div>  
                </div>  
  
                <div class="card-glass p-3 p-md-4 mb-4">  
                    <h5>جلسات قادمة</h5>  
                    <div class="btn-group w-100 mb-3">  
                        <button type="button" class="btn btn-outline-secondary active" onclick="loadUpcoming('week', this)">الأسبوع الحالي</button>  
                        <button type="button" class="btn btn-outline-secondary" onclick="loadUpcoming('month', this)">الشهر الحالي</button>  
                        <button type="button" class="btn btn-outline-secondary" onclick="enableNotifications()">  
                            <i class="bi bi-bell"></i> تفعيل التنبيهات  
                        </button>  
                    </div>  
                    <div id="upcomingSessions"></div>  
                </div>  
            </div>  
  
            <!-- تبويب البحث والتقارير -->  
            <div class="tab-pane fade" id="search">
                    <!-- قسم الإحصائيات الجديد -->
                    <div class='row g-3 mb-4'>
                        <div class='col-6 col-md-4'>
                            <div class='card-glass p-3 text-center gold-border'>
                                <i class='bi bi-briefcase gold-text fs-3'></i>
                                <div class='fs-4 fw-bold mt-2 gold-text' id='totalCasesCount'>0</div>
                                <div class='text-white-50 small'>إجمالي القضايا</div>
                            </div>
                        </div>
                        <div class='col-6 col-md-4'>
                            <div class='card-glass p-3 text-center gold-border'>
                                <i class='bi bi-people gold-text fs-3'></i>
                                <div class='fs-4 fw-bold mt-2 gold-text' id='totalClientsCount'>0</div>
                                <div class='text-white-50 small'>عدد العملاء (بالهاتف)</div>
                            </div>
                        </div>
                    </div>
  
                <div class="card-glass p-3 p-md-4 mb-4">  
                    <h5>البحث المتقدم</h5>  
                    <hr>  
                    <div class="row g-2 mb-3">  
                        <div class="col-md-8"><input id="searchInput" class="form-control" placeholder="كود القضية، الرقم الإداري، اسم العميل، رقم الهاتف"></div>  
                        <div class="col-md-4"><button class="gold-btn btn w-100" onclick="searchCases()">بحث</button></div>  
                    </div>  
                    
                    <div class="row g-2 mb-3">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <strong>ملاحظة:</strong> للبحث بالرقم الإداري فقط، استخدم الزر المخصص للبحث بالرقم الإداري
                            </div>
                        </div>
                    </div>
                      
                    <div class="row g-3 mb-3">  
                        <div class="col-md-5"><label>من تاريخ</label><input type="date" id="searchFrom" class="form-control"></div>  
                        <div class="col-md-5"><label>إلى تاريخ</label><input type="date" id="searchTo" class="form-control"></div>  
                        <div class="col-md-2 d-flex align-items-end">  
                            <button class="btn btn-outline-dark w-100" onclick="searchByDateRange()">بحث بالتاريخ</button>  
                        </div>  
                    </div>  
                      
                    <div class="d-flex flex-wrap gap-2">  
                        <button class="btn btn-sm btn-outline-dark" onclick="filterSessions('week')">جلسات الأسبوع</button>  
                        <button class="btn btn-sm btn-outline-dark" onclick="filterSessions('month')">جلسات الشهر</button>  
                        <button class="btn btn-sm btn-outline-dark" onclick="searchByAdminNumberInSearch()">بحث بالرقم الإداري</button>  
                        <button class="btn btn-sm btn-outline-dark" onclick="searchByPhone()">بحث برقم الهاتف</button>  
                        <button class="btn btn-sm btn-outline-dark" onclick="exportToPDF()">تصدير PDF</button>  
                    </div>  
                </div>  
                <div id="searchResults"></div>  
            </div>  
            
            <!-- تبويب جديد: سجل الاستعلامات -->  
            <div class="tab-pane fade" id="securityLogs">  
                <div class="card-glass p-3 p-md-4 mb-4">  
                    <h5><i class="bi bi-shield-lock"></i> نظام المراقبة الأمنية</h5>  
                    <hr>  
                    
                    <!-- إحصائيات سريعة -->  
                    <div class="row mb-4">  
                        <div class="col-md-3">  
                            <div class="stats-card">  
                                <div class="stats-number" id="totalLogs">0</div>  
                                <div class="stats-label">إجمالي المحاولات</div>  
                            </div>  
                        </div>  
                        <div class="col-md-3">  
                            <div class="stats-card">  
                                <div class="stats-number" id="failedAttempts">0</div>  
                                <div class="stats-label">محاولات فاشلة</div>  
                            </div>  
                        </div>  
                        <div class="col-md-3">  
                            <div class="stats-card">  
                                <div class="stats-number" id="blockedIPs">0</div>  
                                <div class="stats-label">عناوين IP محظورة</div>  
                            </div>  
                        </div>  
                        <div class="col-md-3">  
                            <div class="stats-card">  
                                <div class="stats-number" id="successfulSearches">0</div>  
                                <div class="stats-label">بحث ناجح</div>  
                            </div>  
                        </div>  
                    </div>  
                      
                    <!-- أدوات البحث والتصفية -->  
                    <div class="row g-3 mb-3">  
                        <div class="col-md-4">  
                            <label>بحث برقم الهاتف</label>  
                            <input type="text" id="logPhoneSearch" class="form-control" placeholder="رقم الهاتف">  
                        </div>  
                        <div class="col-md-4">  
                            <label>بحث بعنوان IP</label>  
                            <input type="text" id="logIPSearch" class="form-control" placeholder="عنوان IP">  
                        </div>  
                        <div class="col-md-4">  
                            <label>نوع النشاط</label>  
                            <select id="logActionFilter" class="form-select">  
                                <option value="">جميع الأنشطة</option>  
                                <option value="entry_warning_accepted">قبول تحذير الدخول</option>  
                                <option value="entry_warning_rejected">رفض تحذير الدخول</option>  
                                <option value="search_attempt">محاولة بحث</option>  
                                <option value="search_success">بحث ناجح</option>  
                                <option value="search_failed">بحث فاشل</option>  
                                <option value="search_error">خطأ في البحث</option>  
                                <option value="session_started">بدء جلسة</option>  
                                <option value="session_ended">انتهاء جلسة</option>  
                                <option value="print_request">طلب طباعة</option>  
                                <option value="whatsapp_click">نقر على واتساب</option>  
                                <option value="email_click">نقر على إيميل</option>  
                                <option value="appointment_request">طلب موعد</option>  
                            </select>  
                        </div>  
                    </div>  
                      
                    <div class="row g-3 mb-3">  
                        <div class="col-md-4">  
                            <label>من تاريخ</label>  
                            <input type="date" id="logDateFrom" class="form-control">  
                        </div>  
                        <div class="col-md-4">  
                            <label>إلى تاريخ</label>  
                            <input type="date" id="logDateTo" class="form-control">  
                        </div>  
                        <div class="col-md-4 d-flex align-items-end">  
                            <div class="btn-group w-100">  
                                <button class="gold-btn btn w-50" onclick="loadSecurityLogs()">بحث</button>  
                                <button class="btn btn-outline-secondary w-50" onclick="resetLogFilters()">تفريغ</button>  
                            </div>  
                        </div>  
                    </div>  
                      
                    <!-- أزرار إضافية -->  
                    <div class="d-flex flex-wrap gap-2 mb-3">  
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAllFailedLogs()">  
                            <i class="bi bi-trash"></i> حذف جميع المحاولات الفاشلة  
                        </button>  
                        <button class="btn btn-sm btn-outline-warning" onclick="exportSecurityLogsPDF()">  
                            <i class="bi bi-file-earmark-pdf"></i> تصدير إلى PDF  
                        </button>  
                        <button class="btn btn-sm btn-outline-info" onclick="refreshSecurityStats()">  
                            <i class="bi bi-arrow-clockwise"></i> تحديث الإحصائيات  
                        </button>  
                        <button class="btn btn-sm btn-outline-primary" onclick="testSecurityLogsDirect()">  
                            <i class="bi bi-bug"></i> اختبار الاتصال  
                        </button>  
                    </div>  
                      
                    <!-- نتائج البحث -->  
                    <div id="securityLogsResults">  
                        <div class="text-center text-muted py-4">  
                            <i class="bi bi-search" style="font-size: 2rem;"></i>  
                            <p class="mt-2">استخدم أدوات البحث لعرض سجلات الاستعلامات</p>  
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadSecurityLogs()">  
                                <i class="bi bi-arrow-clockwise"></i> تحميل السجلات  
                            </button>  
                        </div>  
                    </div>  
                </div>  
            </div>  
        </div>  
    </div>  
</div>  
  
<!-- Modal لعرض تفاصيل القضية -->  
<div class="modal fade" id="caseModal" tabindex="-1">  
    <div class="modal-dialog modal-lg">  
        <div class="modal-content">  
            <div class="modal-header">  
                <h5 class="modal-title">تفاصيل القضية</h5>  
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>  
            </div>  
            <div class="modal-body" id="caseDetails">  
                <!-- سيتم تعبئته ديناميكياً -->  
            </div>  
            <div class="modal-footer">  
                <button class="gold-btn btn" onclick="printCasePDF()"><i class="bi bi-printer"></i> طباعة PDF</button>  
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>  
            </div>  
        </div>  
    </div>  
</div>  
  
<!-- Modal لتعديل القضية -->  
<div class="modal fade" id="editCaseModal" tabindex="-1">  
    <div class="modal-dialog modal-lg">  
        <div class="modal-content">  
            <div class="modal-header">  
                <h5 class="modal-title">تعديل القضية</h5>  
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>  
            </div>  
            <div class="modal-body">  
                <form id="editCaseForm">  
                    <div class="row g-3">  
                        <div class="col-md-4">
                            <label>اسم العميل</label>
                            <input id="edit_client_name" class="form-control" required>
                        </div>  
                        <div class="col-md-4">
                            <label>هاتف العميل</label>
                            <input id="edit_client_phone" class="form-control" required>
                        </div>  
                        <div class="col-md-4">
                            <label>إيميل العميل</label>
                            <input type="email" id="edit_client_email" class="form-control">
                        </div>  
                        <div class="col-md-4">  
                            <label>صفة العميل</label>  
                            <select id="edit_client_role" class="form-select" required>  
                                <option value="">اختر الصفة...</option>  
                                <option>مدعي</option><option>مدعى عليه</option><option>مجني عليه</option><option>متهم</option>  
                            </select>  
                        </div>  
                        <div class="col-md-4">
                            <label>اسم الخصم</label>
                            <input id="edit_opponent_name" class="form-control">
                        </div>  
                        <div class="col-md-4">
                            <label>رقم القضية</label>
                            <input id="edit_case_number" class="form-control" required>
                        </div>  
                        <div class="col-md-4">
                            <label>سنة القضية</label>
                            <input id="edit_case_year" class="form-control" required>
                        </div>  
                        <div class="col-md-6">  
                            <label>المحكمة</label>  
                            <select id="edit_court_name" class="form-select" required>  
                                <option value="">اختر المحكمة...</option>  
                                <option>محكمة الأسرة</option><option>المحكمة الجزئية</option><option>المحكمة الابتدائية</option>  
                                <option>محكمة الاستئناف</option><option>محكمة النقض</option>  
                            </select>  
                        </div>  
                        <div class="col-md-6">
                            <label>الدائرة</label>
                            <input id="edit_circle" class="form-control">
                        </div>  
                        <div class="col-md-6">
                            <label>نوع القضية</label>
                            <select id="edit_case_type" class="form-select" required>
                                <option value="">اختر نوع القضية...</option>
                                <option value="مدنية">مدنية</option>
                                <option value="جنائية">جنائية</option>
                                <option value="تجارية">تجارية</option>
                                <option value="عمالية">عمالية</option>
                                <option value="أحوال شخصية">أحوال شخصية</option>
                                <option value="إدارية">إدارية</option>
                                <option value="دستورية">دستورية</option>
                                <option value="ضريبية">ضريبية</option>
                            </select>
                        </div>  
                        <div class="col-md-12">
                            <label>موضوع القضية</label>
                            <textarea id="edit_case_subject" class="form-control" rows="2"></textarea>
                        </div>  
                        <div class="col-md-12">
                            <label>ملاحظات</label>
                            <textarea id="edit_notes" class="form-control" rows="3"></textarea>
                        </div>  
                    </div>  
                </form>  
            </div>  
            <div class="modal-footer">  
                <button class="btn btn-success" onclick="updateCase()">تحديث</button>  
                <button class="btn btn-danger" onclick="confirmDeleteCase()">حذف القضية</button>  
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>  
            </div>  
        </div>  
    </div>  
</div>  
  
<!-- Modal لتعديل الجلسة -->  
<div class="modal fade" id="editSessionModal" tabindex="-1">  
    <div class="modal-dialog">  
        <div class="modal-content">  
            <div class="modal-header">  
                <h5 class="modal-title">تعديل الجلسة</h5>  
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>  
            </div>  
            <div class="modal-body">  
                <form id="editSessionForm">  
                    <div class="mb-3">  
                        <label>تاريخ الجلسة</label>  
                        <input type="datetime-local" id="edit_session_date" class="form-control" required>  
                    </div>  
                    <div class="mb-3">  
                        <label>القرار</label>  
                        <textarea id="edit_decision" class="form-control" rows="3"></textarea>  
                    </div>  
                    <div class="mb-3">
                        <label>حالة القضية</label>
                        <select id="edit_session_case_status" class="form-select">
                            <option value="جديدة">جديدة</option>
                            <option value="مؤجلة">مؤجلة</option>
                            <option value="مشطوبة">مشطوبة</option>
                            <option value="موقوفة">موقوفة</option>
                            <option value="محجوزة للحكم">محجوزة للحكم</option>
                            <option value="محكوم فيها">محكوم فيها</option>
                        </select>
                    </div>  
                </form>  
            </div>  
            <div class="modal-footer">  
                <button class="btn btn-success" onclick="updateSession()">تحديث الجلسة</button>  
                <button class="btn btn-danger" onclick="confirmDeleteSession()">حذف الجلسة</button>  
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>  
            </div>  
        </div>  
    </div>  
</div>  
  
<!-- Modal لعرض تفاصيل سجل الأمان -->  
<div class="modal fade" id="securityLogModal" tabindex="-1">  
    <div class="modal-dialog modal-lg">  
        <div class="modal-content">  
            <div class="modal-header">  
                <h5 class="modal-title">تفاصيل سجل الاستعلام</h5>  
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>  
            </div>  
            <div class="modal-body" id="securityLogDetails">  
                <!-- سيتم تعبئته ديناميكياً -->  
            </div>  
            <div class="modal-footer">  
                <button class="btn btn-danger" onclick="deleteSecurityLog()" id="deleteLogBtn">  
                    <i class="bi bi-trash"></i> حذف السجل  
                </button>  
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>  
            </div>  
        </div>  
    </div>  
</div>  
  
<script>  
const SB_URL="https://iyhfafodhptcdwrjywek.supabase.co";  
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5aGZhZm9kaHB0Y2R3cmp5d2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMzUzODYsImV4cCI6MjA4MjcxMTM4Nn0.YmeMSDkQ3Z_vpyMTyZ-3jbKLFzVZzwcLeDsdczrErHQ";  
const db=supabase.createClient(SB_URL,SB_KEY);  
  
let currentCaseId = null;  
let selectedCaseForCalendar = null;  
let deferredPrompt = null;  
let currentSecurityLogId = null; // لتخزين معرف سجل الأمان الحالي
let blockedIPsCache = {}; // لتخزين عناوين IP المحظورة مؤقتاً

// إلغاء تسجيل Service Workers لمنع مشاكل الاتصال
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
            registration.unregister();
        }
        console.log('تم إلغاء تسجيل Service Workers');
    });
}
  
// PWA Setup  
window.addEventListener('beforeinstallprompt', (e) => {  
    e.preventDefault();  
    deferredPrompt = e;  
    document.getElementById('installBtn').style.display = 'block';  
});  
  
function installPWA() {  
    if (deferredPrompt) {  
        deferredPrompt.prompt();  
        deferredPrompt.userChoice.then((choiceResult) => {  
            if (choiceResult.outcome === 'accepted') {  
                console.log('تم تثبيت التطبيق');  
            }  
            deferredPrompt = null;  
        });  
    }  
}  
  
// إنشاء Manifest ديناميكياً  
const manifest = {  
    "name": "نظام إدارة القضايا",  
    "short_name": "القضايا",  
    "description": "نظام إدارة القضايا للمحامين",  
    "start_url": ".",  
    "display": "standalone",  
    "background_color": "#F8F5E6",  
    "theme_color": "#D4AF37",  
    "icons": [  
        {  
            "src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>",  
            "sizes": "192x192",  
            "type": "image/svg+xml"  
        }  
    ]  
};  
  
document.getElementById('app-manifest').setAttribute('href',   
    'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifest))  
);  

// اختبار اتصال Supabase
async function testSupabaseConnection() {
    try {
        console.log('اختبار اتصال Supabase...');
        const { data, error } = await db
            .from('cases')
            .select('count', { count: 'exact', head: true });
        
        if (error) {
            console.error('خطأ في Supabase:', error);
            return false;
        }
        
        console.log('✅ اتصال Supabase ناجح!');
        return true;
    } catch (err) {
        console.error('❌ خطأ في الاتصال:', err);
        return false;
    }
}

// الدوال الأساسية  
function login(){  
    if(document.getElementById('password').value==="mahmoud237"){  
        loginPage.style.display="none";   
        mainContent.style.display="block";  
        today.innerText=new Date().toLocaleDateString('ar-EG', {   
            weekday: 'long',   
            year: 'numeric',   
            month: 'long',   
            day: 'numeric'   
        });  
        loadUpcoming('week');  
        requestNotificationPermission();  
        testSupabaseConnection();
        refreshSecurityStats(); // تحميل الإحصائيات الأمنية عند الدخول
        
        // إضافة مستمع لتبويب سجل الاستعلامات
        setupSecurityLogsTab();
    } else {  
        Swal.fire("خطأ","كلمة المرور غير صحيحة","error");  
    }  
}

// إعداد مستمع لتبويب سجل الاستعلامات
function setupSecurityLogsTab() {
    const securityTab = document.querySelector('[data-bs-target="#securityLogs"]');
    if (securityTab) {
        securityTab.addEventListener('shown.bs.tab', function() {
            console.log('تم فتح تبويب سجل الاستعلامات');
            setTimeout(() => {
                loadSecurityLogs();
            }, 300);
        });
    }
}
  
// دالة مسح النموذج  
function clearForm() {  
    caseForm.reset();  
    document.getElementById('caseCodeResult').innerHTML = '';  
    currentCaseId = null;  
}  

// دالة استخراج الرقم الإداري من كود القضية (معدلة)
function extractAdminNumber(caseCode) {
    if (!caseCode) return null;
    
    // التنسيق القديم: MA-26-001-H7G4D9
    const oldFormat = caseCode.match(/^[A-Z]+-\d{2}-(\d{3})-/);
    if (oldFormat) return oldFormat[1];
    
    // التنسيق الجديد (الفعلي): MA-26001Y7U9K5
    const newFormat = caseCode.match(/^[A-Z]+-(\d{2})(\d{3})/);
    if (newFormat) return newFormat[2]; // الرقم الإداري
    
    // fallback: أي ثلاثة أرقام متتالية
    const digits = caseCode.match(/\d{3}/);
    return digits ? digits[0] : null;
}

// ============================
// دوال نظام المراقبة الأمنية
// ============================

// تحميل سجلات الأمان
async function loadSecurityLogs() {
    console.log('بدء تحميل سجلات الأمان...');
    
    try {
        // اختبار بسيط أولاً: جلب عدد السجلات فقط
        const { count, error: countError } = await db
            .from('security_logs')
            .select('*', { count: 'exact', head: true });
        
        if (countError) {
            console.error('❌ خطأ في العد:', countError);
            showError(countError.message);
            return;
        }
        
        console.log(`✅ عدد السجلات في الجدول: ${count}`);
        
        if (count === 0) {
            document.getElementById('securityLogsResults').innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> لا توجد سجلات استعلام في قاعدة البيانات
                </div>
            `;
            return;
        }
        
        // جلب البيانات مع جميع الأعمدة
        const { data, error } = await db
            .from('security_logs')
            .select(`
                id,
                phone,
                case_code,
                case_id,
                ip_address,
                user_agent,
                action_type,
                is_success,
                error_message,
                country,
                city,
                details,
                created_at,
                updated_at
            `)
            .order('created_at', { ascending: false })
            .limit(50);
        
        if (error) {
            console.error('❌ خطأ في جلب البيانات:', error);
            showError(error.message);
            return;
        }
        
        console.log(`✅ تم جلب ${data.length} سجل`);
        
        displaySecurityLogs(data);
        refreshSecurityStats(); // تحديث الإحصائيات
        
    } catch (err) {
        console.error('❌ خطأ غير متوقع:', err);
        showError(err.message);
    }
}

function showError(message) {
    document.getElementById('securityLogsResults').innerHTML = `
        <div class="alert alert-danger">
            <h6><i class="bi bi-exclamation-triangle"></i> خطأ في تحميل البيانات</h6>
            <p>${message}</p>
            <button class="btn btn-sm btn-primary mt-2" onclick="testSecurityLogsDirect()">
                <i class="bi bi-bug"></i> اختبار الاتصال المباشر
            </button>
        </div>
    `;
}

// اختبار اتصال مباشر
async function testSecurityLogsDirect() {
    console.clear();
    console.log('=== اختبار اتصال مباشر بـ security_logs ===');
    
    try {
        // محاولة 1: جلب 5 سجلات بسيطة
        console.log('1. محاولة جلب 5 سجلات...');
        const { data, error } = await db
            .from('security_logs')
            .select('id, phone, action_type, created_at')
            .limit(5)
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('❌ فشل الاستعلام:', error);
            
            // محاولة 2: جلب بدون ترتيب
            console.log('2. محاولة استعلام أبسط...');
            const { data: data2, error: error2 } = await db
                .from('security_logs')
                .select('id, phone')
                .limit(3);
            
            if (error2) {
                console.error('❌ فشل الاستعلام البسيط:', error2);
                
                // عرض تفاصيل الخطأ للمستخدم
                Swal.fire({
                    title: 'خطأ في الاتصال',
                    html: `
                        <div class="text-right">
                            <p>فشل الاتصال بجدول security_logs:</p>
                            <pre class="text-left bg-dark text-light p-2">${JSON.stringify(error2, null, 2)}</pre>
                            <p class="mt-2">الرجاء التحقق من:</p>
                            <ol>
                                <li>سياسات RLS للجدول</li>
                                <li>اسم الجدول وتهجئته</li>
                                <li>صلاحيات المفتاح Anon</li>
                            </ol>
                        </div>
                    `,
                    width: 700
                });
                return;
            }
            
            console.log('✅ نجاح الاستعلام البسيط:', data2);
        } else {
            console.log('✅ نجاح الاستعلام:', data);
        }
        
        // عرض النتائج
        if (data && data.length > 0) {
            let html = `<div class="alert alert-success">
                <h6>✅ تم الاتصال بنجاح</h6>
                <p>تم العثور على ${data.length} سجل:</p>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الهاتف</th>
                            <th>النشاط</th>
                            <th>التاريخ</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            data.forEach((item, i) => {
                html += `<tr>
                    <td>${i+1}</td>
                    <td>${item.phone || 'بدون'}</td>
                    <td>${item.action_type || 'غير محدد'}</td>
                    <td>${new Date(item.created_at).toLocaleString('ar-EG')}</td>
                </tr>`;
            });
            
            html += `</tbody></table></div>`;
            
            document.getElementById('securityLogsResults').innerHTML = html;
            
            // تحميل كل السجلات
            setTimeout(() => loadSecurityLogs(), 2000);
            
        } else {
            document.getElementById('securityLogsResults').innerHTML = `
                <div class="alert alert-warning">
                    <h6>⚠️ جدول security_logs فارغ</h6>
                    <p>تم الاتصال بنجاح ولكن الجدول لا يحتوي على بيانات.</p>
                    <button class="btn btn-sm btn-primary" onclick="addTestLogs()">
                        <i class="bi bi-plus-circle"></i> إضافة بيانات اختبار
                    </button>
                </div>
            `;
        }
        
    } catch (err) {
        console.error('❌ خطأ غير متوقع:', err);
        document.getElementById('securityLogsResults').innerHTML = `
            <div class="alert alert-danger">
                <h6>❌ خطأ غير متوقع</h6>
                <pre>${err.message}</pre>
            </div>
        `;
    }
}

// عرض سجلات الأمان
async function displaySecurityLogs(logs) {
    const container = document.getElementById('securityLogsResults');
    
    if (!logs || logs.length === 0) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> لا توجد بيانات لعرضها
            </div>
        `;
        return;
    }
    
    // جلب أسماء العملاء من جدول cases إذا كان هناك case_id
    const caseIds = logs.filter(log => log.case_id).map(log => log.case_id);
    const clientNames = {};
    
    if (caseIds.length > 0) {
        try {
            const { data: casesData } = await db
                .from('cases')
                .select('id, client_name, case_number, case_year')
                .in('id', [...new Set(caseIds)]);
            
            if (casesData) {
                casesData.forEach(c => {
                    clientNames[c.id] = {
                        name: c.client_name,
                        number: c.case_number,
                        year: c.case_year
                    };
                });
            }
        } catch (err) {
            console.warn('⚠️ لم يتم جلب أسماء العملاء:', err);
        }
    }
    
    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">
                <i class="bi bi-shield-lock"></i> سجلات الاستعلامات (${logs.length})
            </h6>
            <div>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="loadSecurityLogs()" title="تحديث">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteAllFailedLogs()" title="حذف المحاولات الفاشلة">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    logs.forEach((log, index) => {
        const date = new Date(log.created_at);
        const formattedDate = date.toLocaleDateString('ar-EG', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // معلومات العميل إذا كانت متاحة
        let clientInfo = '';
        if (log.case_id && clientNames[log.case_id]) {
            const client = clientNames[log.case_id];
            clientInfo = `
                <div class="mb-1">
                    <strong><i class="bi bi-person"></i> العميل:</strong>
                    <span class="ms-2">${client.name}</span>
                </div>
                <div class="mb-1">
                    <strong>رقم القضية:</strong>
                    <span class="ms-2">${client.number}/${client.year}</span>
                </div>
            `;
        }
        
        // حالة النجاح/الفشل
        const statusBadge = log.is_success 
            ? '<span class="badge bg-success">ناجح</span>' 
            : '<span class="badge bg-danger">فاشل</span>';
        
        // زر حذف المحاولة الفاشلة
        let deleteBtn = '';
        if (!log.is_success) {
            deleteBtn = `
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSingleFailedLog('${log.id}')" title="حذف هذه المحاولة الفاشلة">
                    <i class="bi bi-trash"></i>
                </button>
            `;
        }
        
        html += `
            <div class="security-log-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div style="flex-grow: 1;">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge ${getActionBadgeClass(log.action_type)} me-2">
                                ${getActionText(log.action_type)}
                            </span>
                            ${statusBadge}
                            ${deleteBtn}
                        </div>
                        
                        <div class="mb-1">
                            <strong><i class="bi bi-phone"></i> الهاتف:</strong>
                            <span class="ms-2">${log.phone || 'غير محدد'}</span>
                        </div>
                        
                        ${clientInfo}
                        
                        <div class="mb-1">
                            <strong><i class="bi bi-hash"></i> كود القضية:</strong>
                            <span class="ms-2">${log.case_code || 'غير محدد'}</span>
                        </div>
                        
                        <div class="mb-1">
                            <strong><i class="bi bi-globe"></i> IP:</strong>
                            <span class="ms-2 log-ip-display">${log.ip_address || 'غير معروف'}</span>
                        </div>
                        
                        ${log.country ? `
                        <div class="mb-1">
                            <strong><i class="bi bi-geo-alt"></i> الموقع:</strong>
                            <span class="ms-2">${log.country}${log.city ? ` - ${log.city}` : ''}</span>
                        </div>
                        ` : ''}
                        
                        ${log.error_message ? `
                        <div class="alert alert-danger p-2 mt-2 mb-0">
                            <i class="bi bi-exclamation-triangle"></i> ${log.error_message}
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="text-left" style="min-width: 200px;">
                        <small class="text-muted d-block">${formattedDate}</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-info w-100" onclick="viewLogDetails('${log.id}')">
                                <i class="bi bi-eye"></i> التفاصيل
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// دوال مساعدة
function getActionBadgeClass(actionType) {
    const classes = {
        'search_success': 'bg-success',
        'search_failed': 'bg-danger',
        'search_error': 'bg-warning',
        'entry_warning_accepted': 'bg-info',
        'entry_warning_rejected': 'bg-dark'
    };
    return classes[actionType] || 'bg-secondary';
}

function getActionText(actionType) {
    const texts = {
        'entry_warning_accepted': 'قبول تحذير',
        'entry_warning_rejected': 'رفض تحذير',
        'search_attempt': 'محاولة بحث',
        'search_success': 'بحث ناجح',
        'search_failed': 'بحث فاشل',
        'search_error': 'خطأ في البحث'
    };
    return texts[actionType] || actionType;
}

// عرض تفاصيل سجل
async function viewLogDetails(logId) {
    try {
        const { data, error } = await db
            .from('security_logs')
            .select('*')
            .eq('id', logId)
            .single();
        
        if (error || !data) {
            Swal.fire("خطأ", "لم يتم العثور على السجل", "error");
            return;
        }
        
        currentSecurityLogId = logId;
        
        const logDate = new Date(data.created_at);
        const formattedDate = logDate.toLocaleDateString('ar-EG', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        let detailsHtml = `
            <div class="security-log-details">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="alert ${data.is_success ? 'alert-success' : 'alert-danger'}">
                            <strong>الحالة:</strong> ${data.is_success ? 'ناجح' : 'فاشل'}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <strong>نوع النشاط:</strong> ${getActionText(data.action_type)}
                        </div>
                    </div>
                </div>
                
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <strong><i class="bi bi-phone"></i> رقم الهاتف:</strong>
                        <div class="p-2 bg-light rounded">${data.phone || 'غير محدد'}</div>
                    </div>
                    <div class="col-md-6">
                        <strong><i class="bi bi-hash"></i> كود القضية:</strong>
                        <div class="p-2 bg-light rounded">${data.case_code || 'غير محدد'}</div>
                    </div>
                    <div class="col-md-6">
                        <strong><i class="bi bi-globe"></i> عنوان IP:</strong>
                        <div class="p-2 bg-light rounded">${data.ip_address || 'غير معروف'}</div>
                    </div>
                    <div class="col-md-6">
                        <strong><i class="bi bi-geo-alt"></i> الموقع:</strong>
                        <div class="p-2 bg-light rounded">${data.country || 'غير معروف'} ${data.city ? `- ${data.city}` : ''}</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong><i class="bi bi-calendar"></i> وقت الإنشاء:</strong>
                    <div class="p-2 bg-light rounded">${formattedDate}</div>
                </div>
        `;
        
        if (data.error_message) {
            detailsHtml += `
                <div class="mb-3">
                    <strong><i class="bi bi-exclamation-triangle"></i> رسالة الخطأ:</strong>
                    <div class="p-2 bg-danger text-white rounded">${data.error_message}</div>
                </div>
            `;
        }
        
        if (data.details && Object.keys(data.details).length > 0) {
            detailsHtml += `
                <div class="mb-3">
                    <strong><i class="bi bi-info-circle"></i> تفاصيل إضافية:</strong>
                    <div class="log-details">${JSON.stringify(data.details, null, 2)}</div>
                </div>
            `;
        }
        
        if (data.user_agent) {
            detailsHtml += `
                <div class="mb-3">
                    <strong><i class="bi bi-person-badge"></i> وكيل المستخدم:</strong>
                    <div class="log-details">${data.user_agent}</div>
                </div>
            `;
        }
        
        detailsHtml += `</div>`;
        
        document.getElementById('securityLogDetails').innerHTML = detailsHtml;
        
        // عرض زر حذف السجل
        document.getElementById('deleteLogBtn').style.display = 'block';
        
        const modal = new bootstrap.Modal(document.getElementById('securityLogModal'));
        modal.show();
    } catch (err) {
        console.error('خطأ في عرض تفاصيل السجل:', err);
        Swal.fire("خطأ", "حدث خطأ في عرض تفاصيل السجل", "error");
    }
}

// حذف سجل أمان
async function deleteSecurityLog() {
    if (!currentSecurityLogId) return;
    
    const result = await Swal.fire({
        title: 'هل أنت متأكد؟',
        text: "سيتم حذف سجل الاستعلام هذا!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء'
    });
    
    if (result.isConfirmed) {
        try {
            const { error } = await db
                .from('security_logs')
                .delete()
                .eq('id', currentSecurityLogId);
            
            if (error) {
                Swal.fire("خطأ", error.message, "error");
            } else {
                Swal.fire("تم", "تم حذف السجل بنجاح", "success");
                bootstrap.Modal.getInstance(document.getElementById('securityLogModal')).hide();
                loadSecurityLogs(); // إعادة تحميل السجلات
                refreshSecurityStats(); // تحديث الإحصائيات
            }
        } catch (err) {
            Swal.fire("خطأ", "حدث خطأ أثناء حذف السجل", "error");
        }
    }
}

// حذف جميع السجلات الفاشلة
async function deleteAllFailedLogs() {
    const result = await Swal.fire({
        title: 'هل أنت متأكد؟',
        html: `
            <div class="text-right">
                <p>سيتم حذف جميع سجلات الاستعلامات الفاشلة!</p>
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>تنبيه:</strong> هذا الإجراء لا يمكن التراجع عنه
                </div>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'نعم، احذف الكل',
        cancelButtonText: 'إلغاء'
    });
    
    if (result.isConfirmed) {
        Swal.fire({title: 'جاري الحذف...', didOpen: () => Swal.showLoading()});
        
        try {
            const { error } = await db
                .from('security_logs')
                .delete()
                .eq('is_success', false);
            
            Swal.close();
            
            if (error) {
                Swal.fire("خطأ", error.message, "error");
            } else {
                Swal.fire("تم", "تم حذف جميع السجلات الفاشلة بنجاح", "success");
                loadSecurityLogs(); // إعادة تحميل السجلات
                refreshSecurityStats(); // تحديث الإحصائيات
            }
        } catch (err) {
            Swal.close();
            Swal.fire("خطأ", "حدث خطأ أثناء حذف السجلات", "error");
        }
    }
}

// حذف محاولة فاشلة واحدة
async function deleteSingleFailedLog(logId) {
    const result = await Swal.fire({
        title: 'هل أنت متأكد؟',
        text: 'سيتم حذف هذه المحاولة الفاشلة فقط',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء'
    });
    
    if (result.isConfirmed) {
        try {
            const { error } = await db
                .from('security_logs')
                .delete()
                .eq('id', logId);
            
            if (error) {
                Swal.fire('خطأ', error.message, 'error');
            } else {
                Swal.fire('تم', 'تم حذف المحاولة الفاشلة', 'success');
                loadSecurityLogs(); // إعادة التحميل
            }
        } catch (err) {
            Swal.fire('خطأ', err.message, 'error');
        }
    }
}

// تصدير سجلات الأمان إلى PDF
async function exportSecurityLogsPDF() {
    Swal.fire({title: 'جاري تحضير التقرير...', didOpen: () => Swal.showLoading()});
    
    try {
        // جلب السجلات
        const { data: logs, error } = await db
            .from('security_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(500); // تحديد عدد السجلات للتصدير
        
        if (error) {
            Swal.close();
            Swal.fire("خطأ", "فشل جلب السجلات للتصدير", "error");
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFont('Times', 'normal');
        doc.setFontSize(20);
        doc.text('تقرير سجلات استعلامات العملاء', 105, 15, { align: 'center' });
        
        doc.setFontSize(12);
        doc.text(`تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG')}`, 20, 30);
        doc.text(`عدد السجلات: ${logs.length}`, 20, 40);
        
        let y = 50;
        
        // إحصائيات سريعة
        const totalLogs = logs.length;
        const failedLogs = logs.filter(log => !log.is_success).length;
        const successfulLogs = logs.filter(log => log.is_success).length;
        const uniqueIPs = [...new Set(logs.map(log => log.ip_address).filter(ip => ip))].length;
        
        doc.text('إحصائيات سريعة:', 20, y);
        y += 10;
        doc.text(`• إجمالي المحاولات: ${totalLogs}`, 30, y);
        y += 7;
        doc.text(`• المحاولات الناجحة: ${successfulLogs}`, 30, y);
        y += 7;
        doc.text(`• المحاولات الفاشلة: ${failedLogs}`, 30, y);
        y += 7;
        doc.text(`• عناوين IP فريدة: ${uniqueIPs}`, 30, y);
        y += 15;
        
        // عناوين IP محظورة
        const blockedIPs = await checkForBlockedIPs(logs);
        if (blockedIPs.length > 0) {
            doc.text('عناوين IP محظورة:', 20, y);
            y += 10;
            blockedIPs.forEach(ip => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(`• ${ip.ip} (${ip.count} محاولة فاشلة)`, 30, y);
                y += 7;
            });
            y += 10;
        }
        
        // قائمة السجلات
        doc.text('تفاصيل السجلات:', 20, y);
        y += 10;
        
        logs.forEach((log, index) => {
            if (y > 250) {
                doc.addPage();
                y = 20;
            }
            
            const logDate = new Date(log.created_at);
            const dateStr = logDate.toLocaleDateString('ar-EG');
            
            doc.text(`${index + 1}. ${dateStr} - ${log.phone || 'بدون رقم'}`, 30, y);
            y += 7;
            doc.text(`   IP: ${log.ip_address || 'غير معروف'}`, 30, y);
            y += 7;
            doc.text(`   النشاط: ${log.action_type} - ${log.is_success ? 'ناجح' : 'فاشل'}`, 30, y);
            y += 10;
        });
        
        // توقيع
        doc.text(`تم إنشاء التقرير تلقائياً بواسطة نظام إدارة القضايا`, 105, 280, { align: 'center' });
        
        Swal.close();
        doc.save(`تقرير_سجلات_الاستعلام_${new Date().toISOString().split('T')[0]}.pdf`);
        
    } catch (err) {
        Swal.close();
        console.error('خطأ في تصدير PDF:', err);
        Swal.fire("خطأ", "حدث خطأ أثناء تصدير التقرير", "error");
    }
}

// التحقق من عناوين IP المحظورة
async function checkForBlockedIPs(logs) {
    if (!logs || logs.length === 0) {
        return [];
    }
    
    // تجميع المحاولات الفاشلة حسب IP
    const failedAttemptsByIP = {};
    
    logs.forEach(log => {
        if (!log.is_success && log.ip_address) {
            if (!failedAttemptsByIP[log.ip_address]) {
                failedAttemptsByIP[log.ip_address] = 0;
            }
            failedAttemptsByIP[log.ip_address]++;
        }
    });
    
    // تصفية عناوين IP التي لديها 5 محاولات فاشلة أو أكثر
    const blockedIPs = [];
    
    for (const [ip, count] of Object.entries(failedAttemptsByIP)) {
        if (count >= 5) {
            blockedIPs.push({ ip, count });
            blockedIPsCache[ip] = true;
        } else {
            blockedIPsCache[ip] = false;
        }
    }
    
    return blockedIPs;
}

// تحديث الإحصائيات الأمنية
async function refreshSecurityStats() {
    try {
        // إجمالي السجلات
        const { count: totalLogs } = await db
            .from('security_logs')
            .select('*', { count: 'exact', head: true });
        
        // السجلات الفاشلة
        const { count: failedLogs } = await db
            .from('security_logs')
            .select('*', { count: 'exact', head: true })
            .eq('is_success', false);
        
        // السجلات الناجحة
        const { count: successfulLogs } = await db
            .from('security_logs')
            .select('*', { count: 'exact', head: true })
            .eq('is_success', true);
        
        // عناوين IP فريدة
        const { data: uniqueIPs } = await db
            .from('security_logs')
            .select('ip_address')
            .not('ip_address', 'is', null);
        
        const uniqueIPCount = new Set(uniqueIPs.map(ip => ip.ip_address)).size;
        
        // تحديث العرض
        document.getElementById('totalLogs').textContent = totalLogs || 0;
        document.getElementById('failedAttempts').textContent = failedLogs || 0;
        document.getElementById('successfulSearches').textContent = successfulLogs || 0;
        document.getElementById('blockedIPs').textContent = uniqueIPCount;
        
    } catch (err) {
        console.error('خطأ في تحديث الإحصائيات:', err);
    }
}

// إعادة تعيين فلاتر البحث
function resetLogFilters() {
    document.getElementById('logPhoneSearch').value = '';
    document.getElementById('logIPSearch').value = '';
    document.getElementById('logActionFilter').value = '';
    document.getElementById('logDateFrom').value = '';
    document.getElementById('logDateTo').value = '';
    
    loadSecurityLogs();
}

// ============================
// بقية الدوال الأصلية مع التعديلات المطلوبة
// ============================

// البحث عن قضايا بالرقم الإداري (معدلة)
async function searchByAdminNumber(query) {  
    if (!query || query.length < 1) {  
        document.getElementById('caseSearchResults').style.display = 'none';  
        return;  
    }  
  
    try {
        // استخدام نمط: أي رقمين + الرقم الإداري (مثل __001)
        const searchPattern = `%__${query}%`;
        const { data, error } = await db  
            .from('cases')  
            .select('*')  
            .ilike('case_code', searchPattern)  
            .limit(5);  
    
        if (error) {
            console.error('خطأ في البحث:', error);
            return;
        }
        
        if (data && data.length > 0) {  
            const resultsDiv = document.getElementById('caseSearchResults');  
            resultsDiv.innerHTML = data.map(caseItem => `  
                <div class="case-card p-2 mb-1" onclick="selectCaseForSession('${caseItem.id}')">  
                    <div class="d-flex justify-content-between">  
                        <strong class="case-code">${caseItem.case_code || 'بدون كود'}</strong>  
                        <small>${caseItem.court_name}</small>  
                    </div>  
                    <div>${caseItem.client_name} - ${caseItem.case_number}/${caseItem.case_year}</div>
                    <small class="text-muted">الرقم الإداري: ${extractAdminNumber(caseItem.case_code) || 'غير محدد'}</small>
                </div>  
            `).join('');  
            resultsDiv.style.display = 'block';  
        } else {  
            document.getElementById('caseSearchResults').innerHTML = '<div class="text-center p-2">لا توجد نتائج</div>';  
            document.getElementById('caseSearchResults').style.display = 'block';  
        }  
    } catch (err) {
        console.error('خطأ في البحث:', err);
        document.getElementById('caseSearchResults').innerHTML = '<div class="text-center p-2 text-danger">خطأ في الاتصال</div>';  
        document.getElementById('caseSearchResults').style.display = 'block';  
    }
}

// البحث عن قضايا بالرقم الإداري في تبويب البحث (معدلة)
async function searchByAdminNumberInSearch() {
    const { value: adminNumber } = await Swal.fire({
        title: 'البحث بالرقم الإداري',
        input: 'text',
        inputPlaceholder: 'أدخل الرقم الإداري (مثل: 001)',
        showCancelButton: true,
        confirmButtonText: 'بحث',
        cancelButtonText: 'إلغاء'
    });
    
    if (adminNumber) {
        searchInput.value = adminNumber;
        searchCasesByAdminNumber(adminNumber);
    }
}

async function searchCasesByAdminNumber(adminNumber) {
    Swal.fire({title: 'جاري البحث...', didOpen: () => Swal.showLoading()});
    
    try {
        // استخدام نفس نمط البحث
        const searchPattern = `%__${adminNumber}%`;
        const { data, error } = await db
            .from('cases')
            .select('*')
            .ilike('case_code', searchPattern);
        
        Swal.close();
        if (error) {
            return Swal.fire("خطأ", "فشل البحث: " + error.message, "error");
        }
        
        // جلب الجلسات واخر حالة لكل قضية
        if (data && data.length > 0) {
            for (let caseItem of data) {
                const { data: sessions } = await db
                    .from('sessions')
                    .select('*')
                    .eq('case_id', caseItem.id)
                    .order('session_date', { ascending: false });
                caseItem.sessions = sessions || [];
                
                // الحصول على آخر حالة للقضية من آخر جلسة
                if (sessions && sessions.length > 0) {
                    caseItem.last_case_status = sessions[0].case_status;
                } else {
                    caseItem.last_case_status = 'جديدة';
                }
            }
        }
        
        renderSearchResults(data, "cases");
    } catch (err) {
        Swal.close();
        Swal.fire("خطأ", "حدث خطأ أثناء البحث: " + err.message, "error");
    }
}
  
// البحث عن قضايا لتسجيل الجلسة  
async function searchCasesForSession(query) {  
    if (!query || query.length < 2) {  
        document.getElementById('caseSearchResults').style.display = 'none';  
        return;  
    }  
  
    try {
        const { data, error } = await db  
            .from('cases')  
            .select('*')  
            .or(`case_number.ilike.%${query}%,client_name.ilike.%${query}%,case_code.ilike.%${query}%`)  
            .limit(5);  
    
        if (error) {
            console.error('خطأ في البحث:', error);
            return;
        }
        
        if (data && data.length > 0) {  
            const resultsDiv = document.getElementById('caseSearchResults');  
            resultsDiv.innerHTML = data.map(caseItem => `  
                <div class="case-card p-2 mb-1" onclick="selectCaseForSession('${caseItem.id}')">  
                    <div class="d-flex justify-content-between">  
                        <strong class="case-code">${caseItem.case_code || 'بدون كود'}</strong>  
                        <small>${caseItem.court_name}</small>  
                    </div>  
                    <div>${caseItem.client_name} - ${caseItem.case_number}/${caseItem.case_year}</div>
                    <small class="text-muted">الرقم الإداري: ${extractAdminNumber(caseItem.case_code) || 'غير محدد'}</small>
                </div>  
            `).join('');  
            resultsDiv.style.display = 'block';  
        } else {  
            document.getElementById('caseSearchResults').innerHTML = '<div class="text-center p-2">لا توجد نتائج</div>';  
            document.getElementById('caseSearchResults').style.display = 'block';  
        }  
    } catch (err) {
        console.error('خطأ في البحث:', err);
        document.getElementById('caseSearchResults').innerHTML = '<div class="text-center p-2 text-danger">خطأ في الاتصال</div>';  
        document.getElementById('caseSearchResults').style.display = 'block';  
    }
}  
  
async function selectCaseForSession(caseId) {  
    try {
        const { data, error } = await db  
            .from('cases')  
            .select('*')  
            .eq('id', caseId)  
            .single();  
    
        if (error) {
            Swal.fire("خطأ", "حدث خطأ في جلب بيانات القضية", "error");
            return;
        }
        
        if (data) {  
            currentCaseId = data.id;  
            selectedCaseForCalendar = data;  
              
            // تعبئة جميع بيانات القضية  
            document.getElementById('s_case_code').value = data.case_code || '';  
            document.getElementById('s_case_number').value = data.case_number;  
            document.getElementById('s_case_year').value = data.case_year;  
            document.getElementById('s_court').value = data.court_name;  
            document.getElementById('s_client').value = data.client_name;  
            document.getElementById('s_client_phone').value = data.client_phone;  
            document.getElementById('s_client_email').value = data.client_email || '';  
            document.getElementById('s_opponent').value = data.opponent_name || '';  
            document.getElementById('s_client_role').value = data.client_role;  
            document.getElementById('s_notes').value = data.notes || '';  
            document.getElementById('s_case_type').value = data.case_type || 'مدنية';  
            
            // الحصول على آخر حالة للقضية من الجلسات
            const { data: lastSession } = await db
                .from('sessions')
                .select('case_status')
                .eq('case_id', caseId)
                .order('session_date', { ascending: false })
                .limit(1);
            
            if (lastSession && lastSession.length > 0) {
                document.getElementById('s_case_status').value = lastSession[0].case_status || 'جديدة';
            } else {
                document.getElementById('s_case_status').value = 'جديدة';
            }
              
            document.getElementById('caseSearchResults').style.display = 'none';  
            
            // تعبئة حقول البحث
            if (data.case_code) {
                const adminNumber = extractAdminNumber(data.case_code);
                document.getElementById('admin_search').value = adminNumber || '';
            }
            document.getElementById('s_search').value = `${data.case_number}/${data.case_year}`;  
            
            document.getElementById('calendarBtn').disabled = false;  
              
            // تعيين التاريخ الافتراضي للجلسة (بعد 7 أيام من اليوم)  
            const nextWeek = new Date();  
            nextWeek.setDate(nextWeek.getDate() + 7);  
            const localDateTime = nextWeek.toISOString().slice(0, 16);  
            document.getElementById('s_date').value = localDateTime;  
        }  
    } catch (err) {
        console.error('خطأ في جلب القضية:', err);
        Swal.fire("خطأ", "حدث خطأ في جلب بيانات القضية", "error");
    }
}  
  
// حفظ القضية
caseForm.onsubmit = async e => {  
    e.preventDefault();  
    Swal.fire({ 
        title: 'جاري الحفظ...', 
        didOpen: () => Swal.showLoading(),
        allowOutsideClick: false 
    });  
    
    try {
        // تحقق من أن جميع الحقول المطلوبة مملوءة
        if (!client_name.value || !client_phone.value || !client_role.value || 
            !case_number.value || !case_year.value || !court_name.value || !case_type.value) {
            Swal.fire("خطأ", "يرجى ملء جميع الحقول المطلوبة", "error");
            return;
        }
        
        const caseData = {
            client_name: client_name.value,  
            client_phone: client_phone.value,  
            client_email: client_email.value,  
            client_role: client_role.value,  
            opponent_name: opponent_name.value,  
            case_number: case_number.value,  
            case_year: case_year.value,  
            court_name: court_name.value,  
            circle: circle.value,  
            case_type: case_type.value,
            case_subject: case_subject.value,  
            notes: notes.value
            // لا نرسل case_code، قاعدة البيانات ستنشئه تلقائياً
        };
        
        console.log('بيانات القضية المرسلة:', caseData);
        
        // إرسال البيانات
        const { data, error } = await db
            .from('cases')
            .insert([caseData])
            .select()
            .single();
        
        if (error) {
            console.error("تفاصيل الخطأ:", error);
            
            // محاولة بديلة إذا فشلت المحاولة الأولى
            if (error.code === '23505') { // كود مكرر
                Swal.fire("خطأ", "رقم القضية موجود مسبقاً", "error");
            } else {
                // محاولة مرة أخرى بدون .single()
                const { data: retryData, error: retryError } = await db
                    .from('cases')
                    .insert([caseData])
                    .select();
                
                if (retryError) {
                    Swal.fire("خطأ", retryError.message, "error");  
                } else if (retryData && retryData.length > 0) {
                    const savedCase = retryData[0];
                    showSuccessMessage(savedCase);
                }
            }
        } else if (data) {  
            showSuccessMessage(data);
        } else {
            Swal.fire("خطأ", "لم يتم حفظ القضية، يرجى المحاولة مرة أخرى", "error");
        }
    } catch (err) {
        console.error("خطأ غير متوقع:", err);
        Swal.fire("خطأ", "حدث خطأ غير متوقع أثناء الحفظ", "error");
    }
};

// دالة لعرض رسالة النجاح
function showSuccessMessage(savedCase) {
    const adminNumber = extractAdminNumber(savedCase.case_code);
    
    Swal.fire({  
        title: "تم الحفظ بنجاح",  
        html: `<div class="text-center">
                  <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                  <h4 class="mt-3">تم تسجيل القضية</h4>
                  <p class="case-code mt-2">${savedCase.case_code || `${savedCase.case_number}/${savedCase.case_year}`}</p>
                  ${adminNumber ? `<p><strong>الرقم الإداري:</strong> ${adminNumber}</p>` : ''}
                  <small class="text-muted">يمكنك الآن تسجيل جلسات للقضية</small>
               </div>`,  
        icon: "success",
        confirmButtonText: "تم"
    });  
    caseForm.reset();  
    
    let resultHtml = `
        <div class="alert alert-success">
            <strong>تم حفظ القضية بنجاح</strong>
            <div class="mt-2">
                <strong>كود القضية:</strong> ${savedCase.case_code || `${savedCase.case_number}/${savedCase.case_year}`}
            </div>
    `;
    
    if (adminNumber) {
        resultHtml += `<div><strong>الرقم الإداري:</strong> ${adminNumber}</div>`;
    }
    
    resultHtml += `</div>`;
    document.getElementById('caseCodeResult').innerHTML = resultHtml;
}
  
// حفظ الجلسة  
async function saveSession() {  
    if (!currentCaseId) return Swal.fire("تنبيه", "اختر قضية صحيحة أولاً", "warning");  
    if (!s_date.value) return Swal.fire("تنبيه", "أدخل تاريخ الجلسة", "warning");  
    
    Swal.fire({ title: 'جاري حفظ الجلسة...', didOpen: () => Swal.showLoading() });
    
    try {
        // حفظ الجلسة  
        const { data, error } = await db.from('sessions').insert([{  
            case_id: currentCaseId,  
            session_date: s_date.value,  
            decision: s_decision.value,  
            case_status: document.getElementById('s_case_status').value
        }]).select();  
        
        if (error) {
            console.error('خطأ في حفظ الجلسة:', error);
            
            // محاولة بديلة بدون select
            const { error: retryError } = await db.from('sessions').insert([{  
                case_id: currentCaseId,  
                session_date: s_date.value,  
                decision: s_decision.value,  
                case_status: document.getElementById('s_case_status').value
            }]);
            
            if (retryError) {
                Swal.fire("خطأ", retryError.message, "error");  
            } else {
                showSessionSuccess();
            }
        } else {  
            showSessionSuccess();
        }  
    } catch (err) {
        console.error('خطأ غير متوقع في حفظ الجلسة:', err);
        Swal.fire("خطأ", "حدث خطأ غير متوقع أثناء حفظ الجلسة: " + err.message, "error");
    }
}

function showSessionSuccess() {
    Swal.fire({
        title: "تم الحفظ بنجاح",
        text: "تم إضافة الجلسة إلى القضية",
        icon: "success",
        timer: 2000
    });  
    loadUpcoming('week');  
    
    // مسح الحقول
    document.getElementById('s_decision').value = '';
    document.getElementById('s_case_status').value = 'جديدة';
    
    // تعيين تاريخ جديد بعد 7 أيام
    const nextWeek = new Date();  
    nextWeek.setDate(nextWeek.getDate() + 7);  
    const localDateTime = nextWeek.toISOString().slice(0, 16);  
    document.getElementById('s_date').value = localDateTime;  
}
  
// إضافة إلى تقويم Google  
function addToGoogleCalendar() {  
    if (!selectedCaseForCalendar || !s_date.value) {  
        return Swal.fire("تنبيه", "املأ بيانات الجلسة أولاً", "warning");  
    }  
  
    // تحويل تاريخ الجلسة من الحقل مباشرة  
    const sessionDateTime = new Date(s_date.value);  
      
    // التحقق من صحة التاريخ  
    if (isNaN(sessionDateTime.getTime())) {  
        return Swal.fire("خطأ", "تاريخ الجلسة غير صالح", "error");  
    }  
      
    // إضافة ساعة واحدة للمدة  
    const endDateTime = new Date(sessionDateTime.getTime() + 60 * 60 * 1000);  
      
    const title = `جلسة قضية: ${selectedCaseForCalendar.client_name} ضد ${selectedCaseForCalendar.opponent_name || 'الخصم'}`;  
    const description = `  
القضية: ${selectedCaseForCalendar.case_number}/${selectedCaseForCalendar.case_year}  
كود القضية: ${selectedCaseForCalendar.case_code || 'بدون كود'}  
المحكمة: ${selectedCaseForCalendar.court_name}  
نوع القضية: ${selectedCaseForCalendar.case_type || 'مدنية'}  
القرار: ${s_decision.value || 'لم يتم تحديد قرار'}  
    `.trim();  
  
    // تحويل التواريخ إلى التنسيق المطلوب لـ Google Calendar (YYYYMMDDTHHMMSSZ)  
    const formatDateForGoogle = (date) => {  
        return date.toISOString()  
            .replace(/-/g, '')  
            .replace(/:/g, '')  
            .replace(/\..+/, '') + 'Z';  
    };  
  
    const startStr = formatDateForGoogle(sessionDateTime);  
    const endStr = formatDateForGoogle(endDateTime);  
  
    // إنشاء رابط تقويم Google مع التواريخ الصحيحة  
    const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&details=${encodeURIComponent(description)}&dates=${startStr}/${endStr}`;  
      
    // فتح الرابط في نافذة جديدة  
    window.open(calendarUrl, '_blank');  
      
    // إشعار للمستخدم  
    Swal.fire({  
        title: "تم إنشاء رابط التقويم",  
        text: "سيتم فتح نافذة جديدة لإضافة الجلسة إلى تقويم Google",  
        icon: "info",  
        timer: 3000,  
        showConfirmButton: false  
    });  
}  
  
// البحث بالتاريخ  
async function searchByDateRange() {  
    const from = document.getElementById('searchFrom').value;  
    const to = document.getElementById('searchTo').value;  
      
    if (!from || !to) {  
        return Swal.fire("تنبيه", "أدخل تاريخ البداية والنهاية", "warning");  
    }  
      
    Swal.fire({title: 'جاري البحث...', didOpen: () => Swal.showLoading()});  
      
    try {
        // البحث في الجلسات في النطاق الزمني  
        const { data: sessions, error } = await db  
            .from('sessions')  
            .select('*')  
            .gte('session_date', from)  
            .lte('session_date', to)  
            .order('session_date', { ascending: false });  
          
        if (error) {  
            Swal.close();  
            return Swal.fire("خطأ", "فشل البحث: " + error.message, "error");  
        }  
          
        // جلب بيانات القضايا لكل جلسة  
        if (sessions && sessions.length > 0) {  
            for (let session of sessions) {  
                const { data: caseData } = await db  
                    .from('cases')  
                    .select('*')  
                    .eq('id', session.case_id)  
                    .single();  
                session.cases = caseData || {};  
            }  
        }  
          
        Swal.close();  
        renderSearchResults(sessions, "sessions");  
    } catch (err) {
        Swal.close();
        Swal.fire("خطأ", "حدث خطأ أثناء البحث: " + err.message, "error");
    }
}  
  
// البحث العام  
async function searchCases(){  
    const t = searchInput.value;  
    if(!t.trim()) return Swal.fire("تنبيه","أدخل كلمة للبحث","warning");  
      
    Swal.fire({title: 'جاري البحث...', didOpen: () => Swal.showLoading()});  
      
    try {
        const { data, error } = await db  
            .from('cases')  
            .select('*')  
            .or(`case_number.ilike.%${t}%,client_name.ilike.%${t}%,client_phone.ilike.%${t}%,case_code.ilike.%${t}%,client_email.ilike.%${t}%`);  
          
        Swal.close();  
        if(error) {  
            return Swal.fire("خطأ", "فشل البحث: " + error.message, "error");  
        }  
          
        // جلب الجلسات واخر حالة لكل قضية  
        if(data && data.length > 0) {  
            for(let caseItem of data) {  
                const { data: sessions } = await db  
                    .from('sessions')  
                    .select('*')  
                    .eq('case_id', caseItem.id)  
                    .order('session_date', { ascending: false });  
                caseItem.sessions = sessions || [];  
                
                // الحصول على آخر حالة للقضية من آخر جلسة
                if (sessions && sessions.length > 0) {
                    caseItem.last_case_status = sessions[0].case_status;
                } else {
                    caseItem.last_case_status = 'جديدة';
                }
            }  
        }  
          
        renderSearchResults(data, "cases");  
    } catch (err) {
        Swal.close();
        Swal.fire("خطأ", "حدث خطأ أثناء البحث: " + err.message, "error");
    }
}  
  
async function searchByPhone(){  
    const { value: phone } = await Swal.fire({   
        title: 'البحث برقم الهاتف',   
        input: 'text',   
        inputPlaceholder: 'أدخل رقم الهاتف',  
        showCancelButton: true   
    });  
    if (phone) {   
        searchInput.value = phone;   
        searchCases();   
    }  
}  
  
// فلترة الجلسات  
async function filterSessions(range){  
    Swal.fire({title: 'جاري الجلب...', didOpen: () => Swal.showLoading()});  
      
    const today = new Date();  
    const startDate = today.toISOString().split('T')[0];  
      
    const endDate = new Date();  
    if(range === 'week') {  
        endDate.setDate(today.getDate() + 7);  
    } else {  
        endDate.setMonth(today.getMonth() + 1);  
    }  
      
    const endDateStr = endDate.toISOString().split('T')[0];  
      
    try {
        const { data, error } = await db  
            .from('sessions')  
            .select('*')  
            .gte('session_date', startDate)  
            .lte('session_date', endDateStr)  
            .order('session_date', { ascending: true });  
          
        Swal.close();  
        if(error) {  
            return Swal.fire("خطأ", "فشل جلب الجلسات: " + error.message, "error");  
        }  
          
        if(data && data.length > 0) {  
            for(let session of data) {  
                const { data: caseData } = await db  
                    .from('cases')  
                    .select('*')  
                    .eq('id', session.case_id)  
                    .single();  
                session.cases = caseData || {};  
            }  
        }  
          
        renderSearchResults(data, "sessions");  
    } catch (err) {
        Swal.close();
        Swal.fire("خطأ", "حدث خطأ أثناء جلب الجلسات: " + err.message, "error");
    }
}  
  
// عرض النتائج في بطاقات  
function renderSearchResults(data, type) {  
    if(!data || data.length === 0) {   
        searchResults.innerHTML = '<div class="alert alert-info text-center">لا توجد نتائج</div>';   
        return;   
    }  
      
    let html = `<h6 class="mb-3">نتائج البحث (${data.length}):</h6>`;  
      
    if(type === "sessions") {  
        data.forEach(item => {  
            const caseData = item.cases || {};  
            const sessionDate = new Date(item.session_date);  
            const formattedDate = sessionDate.toLocaleDateString('ar-EG', {  
                weekday: 'long',  
                year: 'numeric',  
                month: 'long',  
                day: 'numeric',  
                hour: '2-digit',  
                minute: '2-digit'  
            });  
              
            const statusClass = getStatusClass(item.case_status);  
              
            html += `  
            <div class="case-card card-glass mb-3 p-3">  
                <div class="d-flex justify-content-between align-items-start">  
                    <div onclick="openCaseDetails('${caseData.id}')" style="cursor:pointer; flex-grow:1;">  
                        <strong class="text-primary">${formattedDate}</strong>  
                        <div class="text-muted small">${caseData.court_name}</div>  
                    </div>  
                    <div class="d-flex align-items-center gap-2">  
                        <span class="case-status ${statusClass}">${item.case_status || 'جديدة'}</span>  
                        <div class="btn-group btn-group-sm">  
                            <button class="btn btn-outline-warning" onclick="loadSessionForEdit('${item.id}')">  
                                <i class="bi bi-pencil"></i>  
                            </button>  
                            <button class="btn btn-outline-danger" onclick="deleteSession('${item.id}')">  
                                <i class="bi bi-trash"></i>  
                            </button>  
                        </div>  
                    </div>  
                </div>  
                <div class="mt-2">  
                    <div><strong>كود القضية:</strong> ${caseData.case_code || 'بدون كود'}</div>
                    ${caseData.case_code ? `<div><strong>الرقم الإداري:</strong> ${extractAdminNumber(caseData.case_code) || 'غير محدد'}</div>` : ''}
                    <div><strong>العميل:</strong> ${caseData.client_name}</div>  
                    <div><strong>الخصم:</strong> ${caseData.opponent_name || 'غير محدد'}</div>  
                    <div><strong>القضية:</strong> ${caseData.case_number}/${caseData.case_year}</div>  
                    <div><strong>نوع القضية:</strong> ${caseData.case_type || 'مدنية'}</div>  
                </div>  
                ${item.decision ? `<div class="mt-2 p-2 bg-light small rounded"><b>القرار:</b> ${item.decision}</div>` : ''}  
            </div>`;  
        });  
    } else {  
        data.forEach(item => {  
            const statusClass = getStatusClass(item.last_case_status);  
            const adminNumber = extractAdminNumber(item.case_code);
              
            html += `  
            <div class="case-card card-glass mb-3 p-3">  
                <div class="d-flex justify-content-between align-items-start">  
                    <div onclick="openCaseDetails('${item.id}')" style="cursor:pointer; flex-grow:1;">  
                        <b class="case-code">${item.case_code || `${item.case_number}/${item.case_year}`}</b>  
                        <div class="text-muted small">${item.court_name}</div>  
                    </div>  
                    <div class="d-flex align-items-center gap-2">  
                        <span class="case-status ${statusClass}">${item.last_case_status || 'جديدة'}</span>  
                        <div class="btn-group btn-group-sm">  
                            <button class="btn btn-outline-warning" onclick="loadCaseForEdit('${item.id}')">  
                                <i class="bi bi-pencil"></i>  
                            </button>  
                            <button class="btn btn-outline-danger" onclick="confirmDeleteCaseFromSearch('${item.id}')">  
                                <i class="bi bi-trash"></i>  
                            </button>  
                        </div>  
                    </div>  
                </div>  
                <div class="mt-2">  
                    ${item.case_code ? `<div><strong>الرقم الإداري:</strong> ${adminNumber || 'غير محدد'}</div>` : ''}
                    <div><strong>العميل:</strong> ${item.client_name} (${item.client_phone})</div>  
                    <div><strong>الإيميل:</strong> ${item.client_email || 'غير محدد'}</div>  
                    <div><strong>الخصم:</strong> ${item.opponent_name || 'غير محدد'}</div>  
                    <div><strong>القضية:</strong> ${item.case_number}/${item.case_year}</div>  
                    <div><strong>نوع القضية:</strong> ${item.case_type || 'مدنية'}</div>  
                    ${item.case_subject ? `<div class="mt-1"><strong>الموضوع:</strong> ${item.case_subject}</div>` : ''}  
                </div>  
                <div class="mt-2 small border-top pt-2">  
                    <strong>آخر جلسة:</strong>  
                    ${item.sessions && item.sessions.length > 0   
                        ? item.sessions.slice(0, 2).map(s =>   
                            `<div class="text-muted">${new Date(s.session_date).toLocaleDateString('ar-EG')}: ${s.decision || 'لا يوجد قرار'}</div>`  
                        ).join('')  
                        : '<div class="text-muted">لا توجد جلسات مسجلة</div>'  
                    }  
                </div>  
            </div>`;  
        });  
    }  
    searchResults.innerHTML = html;  
}  
  
// دالة مساعدة للحصول على فئة الحالة  
function getStatusClass(status) {  
    const statusMap = {  
        'جديدة': 'status-new',  
        'مؤجلة': 'status-postponed',  
        'مشطوبة': 'status-canceled',  
        'موقوفة': 'status-suspended',  
        'محجوزة للحكم': 'status-reserved',  
        'محكوم فيها': 'status-judged'  
    };  
    return statusMap[status] || 'status-new';  
}  
  
// فتح تفاصيل القضية  
async function openCaseDetails(caseId) {  
    try {
        const { data: caseData, error } = await db  
            .from('cases')  
            .select('*')  
            .eq('id', caseId)  
            .single();  
          
        if (error || !caseData) {  
            return Swal.fire("خطأ", "لم يتم العثور على القضية", "error");  
        }  
          
        const { data: sessions } = await db  
            .from('sessions')  
            .select('*')  
            .eq('case_id', caseId)  
            .order('session_date', { ascending: false });  
          
        // الحصول على آخر حالة للقضية من آخر جلسة
        let lastCaseStatus = 'جديدة';
        if (sessions && sessions.length > 0) {
            lastCaseStatus = sessions[0].case_status || 'جديدة';
        }
        
        const statusClass = getStatusClass(lastCaseStatus);  
        const adminNumber = extractAdminNumber(caseData.case_code);
          
        let detailsHTML = `  
            <div class="case-details">  
                <div class="d-flex justify-content-between align-items-start mb-3">  
                    <div>  
                        <h4 class="case-code">${caseData.case_code || `${caseData.case_number}/${caseData.case_year}`}</h4>  
                        ${adminNumber ? `<p class="text-muted"><strong>الرقم الإداري:</strong> ${adminNumber}</p>` : ''}
                        <h5>${caseData.client_name} ضد ${caseData.opponent_name || 'غير محدد'}</h5>  
                    </div>  
                    <span class="case-status ${statusClass}">${lastCaseStatus}</span>  
                </div>  
                  
                <div class="row g-3">  
                    <div class="col-md-6">  
                        <strong>رقم القضية:</strong> ${caseData.case_number}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>سنة القضية:</strong> ${caseData.case_year}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>المحكمة:</strong> ${caseData.court_name}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>الدائرة:</strong> ${caseData.circle || 'غير محدد'}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>نوع القضية:</strong> ${caseData.case_type || 'مدنية'}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>صفة العميل:</strong> ${caseData.client_role}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>هاتف العميل:</strong> ${caseData.client_phone}  
                    </div>  
                    <div class="col-md-6">  
                        <strong>إيميل العميل:</strong> ${caseData.client_email || 'غير محدد'}  
                    </div>  
                </div>  
                  
                ${caseData.case_subject ? `  
                <div class="mt-3">  
                    <strong>موضوع القضية:</strong>  
                    <p class="border p-2 rounded bg-light">${caseData.case_subject}</p>  
                </div>  
                ` : ''}  
                  
                ${caseData.notes ? `  
                <div class="mt-3">  
                    <strong>ملاحظات:</strong>  
                    <p class="border p-2 rounded bg-light">${caseData.notes}</p>  
                </div>  
                ` : ''}  
                  
                <div class="mt-4">  
                    <h6>الجلسات المسجلة (${sessions ? sessions.length : 0})</h6>  
                    <div class="sessions-list" style="max-height: 300px; overflow-y: auto;">  
        `;  
          
        if (sessions && sessions.length > 0) {  
            sessions.forEach(session => {  
                const sessionDate = new Date(session.session_date);  
                const formattedDate = sessionDate.toLocaleDateString('ar-EG', {  
                    weekday: 'long',  
                    year: 'numeric',  
                    month: 'long',  
                    day: 'numeric',  
                    hour: '2-digit',  
                    minute: '2-digit'  
                });  
                  
                const sessionStatusClass = getStatusClass(session.case_status);  
                  
                detailsHTML += `  
                    <div class="session-card mb-2">  
                        <div class="d-flex justify-content-between">  
                            <div>  
                                <strong>${formattedDate}</strong>  
                                <span class="case-status ${sessionStatusClass} ms-2">${session.case_status || 'جديدة'}</span>  
                            </div>  
                            <div class="btn-group btn-group-sm">  
                                <button class="btn btn-outline-warning" onclick="loadSessionForEdit('${session.id}')">  
                                    <i class="bi bi-pencil"></i>  
                                </button>  
                                <button class="btn btn-outline-danger" onclick="deleteSessionFromDetails('${session.id}', '${caseData.id}')">  
                                    <i class="bi bi-trash"></i>  
                                </button>  
                            </div>  
                        </div>  
                        ${session.decision ? `<div class="mt-1"><strong>القرار:</strong> ${session.decision}</div>` : ''}  
                    </div>  
                `;  
            });  
        } else {  
            detailsHTML += '<div class="alert alert-info">لا توجد جلسات مسجلة</div>';  
        }  
          
        detailsHTML += `  
                    </div>  
                </div>  
                <div class="mt-4 d-flex gap-2">  
                    <button class="btn btn-warning" onclick="loadCaseForEdit('${caseData.id}')">  
                        <i class="bi bi-pencil"></i> تعديل القضية  
                    </button>  
                    <button class="btn btn-danger" onclick="confirmDeleteCaseFromDetails('${caseData.id}')">  
                        <i class="bi bi-trash"></i> حذف القضية  
                    </button>  
                </div>  
            </div>  
        `;  
          
        document.getElementById('caseDetails').innerHTML = detailsHTML;  
          
        // تخزين بيانات القضية للطباعة  
        window.currentCaseForPrint = {  
            ...caseData,  
            sessions: sessions || [],
            case_status: lastCaseStatus  
        };  
          
        const caseModal = new bootstrap.Modal(document.getElementById('caseModal'));  
        caseModal.show();  
    } catch (err) {
        Swal.fire("خطأ", "حدث خطأ في جلب تفاصيل القضية", "error");
    }
}  
  
// تحميل القضية للتعديل  
async function loadCaseForEdit(caseId) {  
    try {
        const { data, error } = await db  
            .from('cases')  
            .select('*')  
            .eq('id', caseId)  
            .single();  
    
        if (error || !data) {  
            return Swal.fire("خطأ", "لم يتم العثور على القضية", "error");  
        }  
    
        // تعبئة الحقول  
        document.getElementById('edit_client_name').value = data.client_name;  
        document.getElementById('edit_client_phone').value = data.client_phone;  
        document.getElementById('edit_client_email').value = data.client_email || '';  
        document.getElementById('edit_client_role').value = data.client_role;  
        document.getElementById('edit_opponent_name').value = data.opponent_name || '';  
        document.getElementById('edit_case_number').value = data.case_number;  
        document.getElementById('edit_case_year').value = data.case_year;  
        document.getElementById('edit_court_name').value = data.court_name;  
        document.getElementById('edit_circle').value = data.circle || '';  
        document.getElementById('edit_case_type').value = data.case_type || 'مدنية';  
        document.getElementById('edit_case_subject').value = data.case_subject || '';  
        document.getElementById('edit_notes').value = data.notes || '';  
    
        // حفظ ID القضية للاستخدام لاحقاً  
        window.editingCaseId = caseId;  
    
        // عرض المودال  
        const editModal = new bootstrap.Modal(document.getElementById('editCaseModal'));  
        editModal.show();  
    } catch (err) {
        Swal.fire("خطأ", "حدث خطأ في تحميل القضية للتعديل", "error");
    }
}  
  
// تحديث القضية  
async function updateCase() {  
    if (!window.editingCaseId) return;  
  
    const updatedData = {  
        client_name: document.getElementById('edit_client_name').value,  
        client_phone: document.getElementById('edit_client_phone').value,  
        client_email: document.getElementById('edit_client_email').value,  
        client_role: document.getElementById('edit_client_role').value,  
        opponent_name: document.getElementById('edit_opponent_name').value,  
        case_number: document.getElementById('edit_case_number').value,  
        case_year: document.getElementById('edit_case_year').value,  
        court_name: document.getElementById('edit_court_name').value,  
        circle: document.getElementById('edit_circle').value,  
        case_type: document.getElementById('edit_case_type').value,  
        case_subject: document.getElementById('edit_case_subject').value,  
        notes: document.getElementById('edit_notes').value
    };  

    try {
        const { error } = await db  
            .from('cases')  
            .update(updatedData)  
            .eq('id', window.editingCaseId);  
    
        if (error) {  
            Swal.fire("خطأ", error.message, "error");  
        } else {  
            Swal.fire("تم", "تم تحديث القضية بنجاح", "success");  
            bootstrap.Modal.getInstance(document.getElementById('editCaseModal')).hide();  
              
            // إعادة تحميل البيانات إذا كان في نتائج البحث  
            if (searchInput.value) {  
                searchCases();  
            }  
        }  
    } catch (err) {
        Swal.fire("خطأ", "حدث خطأ أثناء تحديث القضية", "error");
    }
}  
  
// تأكيد حذف القضية  
function confirmDeleteCase() {  
    if (!window.editingCaseId) return;  
  
    Swal.fire({  
        title: 'هل أنت متأكد؟',  
        text: "سيتم حذف القضية وجميع جلساتها!",  
        icon: 'warning',  
        showCancelButton: true,  
        confirmButtonColor: '#d33',  
        cancelButtonColor: '#3085d6',  
        confirmButtonText: 'نعم، احذف',  
        cancelButtonText: 'إلغاء'  
    }).then(async (result) => {  
        if (result.isConfirmed) {  
            await deleteCase(window.editingCaseId);  
        }  
    });  
}  
  
// حذف القضية  
async function deleteCase(caseId) {  
    Swal.fire({ title: 'جاري الحذف...', didOpen: () => Swal.showLoading() });
    
    try {
        // حذف الجلسات أولاً  
        await db.from('sessions').delete().eq('case_id', caseId);  
          
        // حذف القضية  
        const { error } = await db.from('cases').delete().eq('id', caseId);  
          
        if (error) {  
            Swal.fire("خطأ", error.message, "error");  
        } else {  
            Swal.fire("تم", "تم حذف القضية بنجاح", "success");  
            bootstrap.Modal.getInstance(document.getElementById('editCaseModal')).hide();  
              
            // إعادة تحميل البيانات  
            if (searchInput.value) {  
                searchCases();  
            }  
        }  
    } catch (err) {
        Swal.fire("خطأ", "حدث خطأ أثناء حذف القضية", "error");
    }
}  
  
// تأكيد حذف القضية من تفاصيل القضية  
function confirmDeleteCaseFromDetails(caseId) {  
    Swal.fire({  
        title: 'هل أنت متأكد؟',  
        text: "سيتم حذف القضية وجميع جلساتها!",  
        icon: 'warning',  
        showCancelButton: true,  
        confirmButtonColor: '#d33',  
        cancelButtonColor: '#3085d6',  
        confirmButtonText: 'نعم، احذف',  
        cancelButtonText: 'إلغاء'  
    }).then(async (result) => {  
        if (result.isConfirmed) {  
            await deleteCase(caseId);  
            bootstrap.Modal.getInstance(document.getElementById('caseModal')).hide();  
        }  
    });  
}  
  
// تأكيد حذف القضية من نتائج البحث  
function confirmDeleteCaseFromSearch(caseId) {  
    Swal.fire({  
        title: 'هل أنت متأكد؟',  
        text: "سيتم حذف القضية وجميع جلساتها!",  
        icon: 'warning',  
        showCancelButton: true,  
        confirmButtonColor: '#d33',  
        cancelButtonColor: '#3085d6',  
        confirmButtonText: 'نعم، احذف',  
        cancelButtonText: 'إلغاء'  
    }).then(async (result) => {  
        if (result.isConfirmed) {  
            await deleteCase(caseId);  
            searchCases();  
        }  
    });  
}  
  
// تحميل الجلسة للتعديل  
async function loadSessionForEdit(sessionId) {  
    try {
        const { data, error } = await db  
            .from('sessions')  
            .select('*')  
            .eq('id', sessionId)  
            .single();  
    
        if (error || !data) {  
            return Swal.fire("خطأ", "لم يتم العثور على الجلسة", "error");  
        }  
    
        // تعبئة الحقول  
        const sessionDate = new Date(data.session_date);  
        const localDateTime = sessionDate.toISOString().slice(0, 16);  
        document.getElementById('edit_session_date').value = localDateTime;  
        document.getElementById('edit_decision').value = data.decision || '';  
        document.getElementById('edit_session_case_status').value = data.case_status || 'جديدة';  
    
        // حفظ ID الجلسة للاستخدام لاحقاً  
        window.editingSessionId = sessionId;  
    
        // عرض المودال  
        const editModal = new bootstrap.Modal(document.getElementById('editSessionModal'));  
        editModal.show();  
    } catch (err) {
        Swal.fire("خطأ", "حدث خطأ في تحميل الجلسة للتعديل", "error");
    }
}  
  
// تحديث الجلسة  
async function updateSession() {  
    if (!window.editingSessionId) return;  
  
    const updatedData = {  
        session_date: document.getElementById('edit_session_date').value,  
        decision: document.getElementById('edit_decision').value,  
        case_status: document.getElementById('edit_session_case_status').value
    };  
    
    console.log('بيانات تحديث الجلسة:', updatedData);
    
    try {
        const { error } = await db  
            .from('sessions')  
            .update(updatedData)  
            .eq('id', window.editingSessionId);  
    
        if (error) {  
            console.error('خطأ في تحديث الجلسة:', error);
            Swal.fire("خطأ", error.message, "error");  
        } else {  
            Swal.fire("تم", "تم تحديث الجلسة بنجاح", "success");  
            bootstrap.Modal.getInstance(document.getElementById('editSessionModal')).hide();  
              
            // إعادة تحميل الجلسات القادمة  
            loadUpcoming('week');  
        }  
    } catch (err) {
        console.error('خطأ غير متوقع في تحديث الجلسة:', err);
        Swal.fire("خطأ", "حدث خطأ أثناء تحديث الجلسة: " + err.message, "error");
    }
}  
  
// تأكيد حذف الجلسة  
function confirmDeleteSession() {  
    if (!window.editingSessionId) return;  
  
    Swal.fire({  
        title: 'هل أنت متأكد؟',  
        text: "سيتم حذف الجلسة!",  
        icon: 'warning',  
        showCancelButton: true,  
        confirmButtonColor: '#d33',  
        cancelButtonColor: '#3085d6',  
        confirmButtonText: 'نعم، احذف',  
        cancelButtonText: 'إلغاء'  
    }).then(async (result) => {  
        if (result.isConfirmed) {  
            await deleteSession(window.editingSessionId);  
        }  
    });  
}  
  
// حذف الجلسة  
async function deleteSession(sessionId) {  
    try {
        const { error } = await db  
            .from('sessions')  
            .delete()  
            .eq('id', sessionId);  
    
        if (error) {  
            Swal.fire("خطأ", error.message, "error");  
        } else {  
            Swal.fire("تم", "تم حذف الجلسة بنجاح", "success");  
            bootstrap.Modal.getInstance(document.getElementById('editSessionModal')).hide();  
              
            // إعادة تحميل الجلسات القادمة  
            loadUpcoming('week');  
        }  
    } catch (err) {
        Swal.fire("خطأ", "حدث خطأ أثناء حذف الجلسة", "error");
    }
}  
  
// حذف الجلسة من تفاصيل القضية  
function deleteSessionFromDetails(sessionId, caseId) {  
    Swal.fire({  
        title: 'هل أنت متأكد؟',  
        text: "سيتم حذف الجلسة!",  
        icon: 'warning',  
        showCancelButton: true,  
        confirmButtonColor: '#d33',  
        cancelButtonColor: '#3085d6',  
        confirmButtonText: 'نعم، احذف',  
        cancelButtonText: 'إلغاء'  
    }).then(async (result) => {  
        if (result.isConfirmed) {  
            await deleteSession(sessionId);  
            // إعادة فتح تفاصيل القضية لتحديث البيانات  
            openCaseDetails(caseId);  
        }  
    });  
}  
  
// طباعة PDF  
async function printCasePDF() {  
    if (!window.currentCaseForPrint) return;  
      
    const { jsPDF } = window.jspdf;  
    const doc = new jsPDF();  
      
    const caseData = window.currentCaseForPrint;  
      
    // إعداد النص العربي  
    doc.setFont('Times', 'normal');  
      
    // العنوان  
    doc.setFontSize(20);  
    doc.text('نظام إدارة القضايا', 105, 15, { align: 'center' });  
    doc.setFontSize(16);  
    doc.text('تفاصيل القضية', 105, 25, { align: 'center' });  
      
    doc.setFontSize(12);  
    let y = 40;  
      
    // معلومات القضية  
    doc.text(`كود القضية: ${caseData.case_code || `${caseData.case_number}/${caseData.case_year}`}`, 20, y);  
    y += 10;  
    doc.text(`رقم القضية: ${caseData.case_number}/${caseData.case_year}`, 20, y);  
    y += 10;  
    doc.text(`المحكمة: ${caseData.court_name}`, 20, y);  
    y += 10;  
    doc.text(`الدائرة: ${caseData.circle || 'غير محدد'}`, 20, y);  
    y += 10;  
    doc.text(`نوع القضية: ${caseData.case_type || 'مدنية'}`, 20, y);  
    y += 10;  
    doc.text(`حالة القضية: ${caseData.case_status || 'جديدة'}`, 20, y);  
    y += 15;  
      
    // معلومات الأطراف  
    doc.text('معلومات الأطراف:', 20, y);  
    y += 10;  
    doc.text(`العميل: ${caseData.client_name}`, 30, y);  
    y += 10;  
    doc.text(`صفة العميل: ${caseData.client_role}`, 30, y);  
    y += 10;  
    doc.text(`هاتف العميل: ${caseData.client_phone}`, 30, y);  
    y += 10;  
    doc.text(`إيميل العميل: ${caseData.client_email || 'غير محدد'}`, 30, y);  
    y += 10;  
    doc.text(`الخصم: ${caseData.opponent_name || 'غير محدد'}`, 30, y);  
    y += 15;  
      
    // موضوع القضية  
    if (caseData.case_subject) {  
        doc.text('موضوع القضية:', 20, y);  
        y += 10;  
        const splitSubject = doc.splitTextToSize(caseData.case_subject, 170);  
        doc.text(splitSubject, 30, y);  
        y += splitSubject.length * 7;  
    }  
      
    // ملاحظات  
    if (caseData.notes) {  
        doc.text('ملاحظات:', 20, y);  
        y += 10;  
        const splitNotes = doc.splitTextToSize(caseData.notes, 170);  
        doc.text(splitNotes, 30, y);  
        y += splitNotes.length * 7;  
    }  
      
    // الجلسات  
    if (caseData.sessions && caseData.sessions.length > 0) {  
        doc.text('سجل الجلسات:', 20, y);  
        y += 10;  
          
        caseData.sessions.forEach((session, index) => {  
            if (y > 250) {  
                doc.addPage();  
                y = 20;  
            }  
              
            const sessionDate = new Date(session.session_date);  
            const dateStr = sessionDate.toLocaleDateString('ar-EG');  
              
            doc.text(`${index + 1}. تاريخ الجلسة: ${dateStr}`, 30, y);  
            y += 10;  
            doc.text(`   حالة القضية: ${session.case_status || 'جديدة'}`, 30, y);  
            y += 10;  
              
            if (session.decision) {  
                const splitDecision = doc.splitTextToSize(`القرار: ${session.decision}`, 160);  
                doc.text(splitDecision, 40, y);  
                y += splitDecision.length * 7;  
            }  
            y += 5;  
        });  
    }  
      
    // توقيع و تاريخ الطباعة  
    doc.text(`تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG')}`, 20, 280);  
      
    // حفظ الملف  
    doc.save(`قضية_${caseData.case_code || caseData.case_number || 'غير_مسمى'}.pdf`);  
}  
  
// تصدير جميع النتائج إلى PDF  
async function exportToPDF() {  
    const { jsPDF } = window.jspdf;  
    const doc = new jsPDF();  
      
    doc.setFont('Times', 'normal');  
    doc.setFontSize(20);  
    doc.text('تقرير القضايا', 105, 15, { align: 'center' });  
      
    doc.setFontSize(12);  
    doc.text(`تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG')}`, 20, 30);  
      
    // يمكن تطوير هذه الدالة أكثر حسب الحاجة  
    doc.text('لتطوير هذه الخاصية أكثر، يرجى التواصل مع المطور.', 105, 150, { align: 'center' });  
      
    doc.save('تقرير_القضايا.pdf');  
}  
  
// تحميل الجلسات القادمة  
async function loadUpcoming(range, btn){  
    if(btn) {   
        document.querySelectorAll('#sessions .btn-group .btn').forEach(b=>b.classList.remove('active'));   
        btn.classList.add('active');   
    }  
      
    const today = new Date();  
    const startDate = today.toISOString().split('T')[0];  
      
    const endDate = new Date();  
    if(range === 'week') {  
        endDate.setDate(today.getDate() + 7);  
    } else {  
        endDate.setMonth(today.getMonth() + 1);  
    }  
      
    const endDateStr = endDate.toISOString().split('T')[0];  
    
    try {
        // نستخدم استعلام منفصل لجلب البيانات
        // أولاً: جلب الجلسات في النطاق الزمني
        const { data: sessions, error: sessionsError } = await db  
            .from('sessions')  
            .select('*')  
            .gte('session_date', startDate)  
            .lte('session_date', endDateStr)  
            .order('session_date', { ascending: true });  
          
        if(sessionsError) {   
            upcomingSessions.innerHTML = "<div class='alert alert-danger'>خطأ في التحميل: " + sessionsError.message + "</div>";   
            return;   
        }  
          
        if(!sessions || sessions.length === 0) {  
            upcomingSessions.innerHTML = "<p class='text-center text-muted'>لا توجد جلسات قادمة</p>";  
            return;  
        }  
        
        // ثانياً: جلب بيانات القضايا لكل جلسة
        const sessionsWithCases = [];
        
        for(let session of sessions) {
            const { data: caseData, error: caseError } = await db
                .from('cases')
                .select('*')
                .eq('id', session.case_id)
                .single();
            
            if (!caseError && caseData) {
                sessionsWithCases.push({
                    ...session,
                    cases: caseData
                });
            } else {
                sessionsWithCases.push({
                    ...session,
                    cases: {}
                });
            }
        }
          
        upcomingSessions.innerHTML = sessionsWithCases.map(s => {  
            const caseData = s.cases || {};  
            const sessionDate = new Date(s.session_date);  
            const formattedDate = sessionDate.toLocaleDateString('ar-EG', {  
                weekday: 'long',  
                year: 'numeric',  
                month: 'long',  
                day: 'numeric',  
                hour: '2-digit',  
                minute: '2-digit'  
            });  
              
            const statusClass = getStatusClass(s.case_status);  
            const adminNumber = extractAdminNumber(caseData.case_code);
              
            return `  
            <div class="session-card card-glass mb-3 p-3">  
                <div class="d-flex justify-content-between">  
                    <div>  
                        <b>${formattedDate}</b>  
                        <span class="case-status ${statusClass} ms-2">${s.case_status || 'جديدة'}</span>  
                    </div>  
                    <div class="btn-group btn-group-sm">  
                        <button class="btn btn-outline-warning" onclick="loadSessionForEdit('${s.id}')">  
                            <i class="bi bi-pencil"></i>  
                        </button>  
                        <button class="btn btn-outline-danger" onclick="deleteSession('${s.id}')">  
                            <i class="bi bi-trash"></i>  
                        </button>  
                    </div>  
                </div>  
                <div>  
                    ${caseData.client_name || 'غير معروف'} -   
                    قضية ${caseData.case_number || 'غير محدد'}/${caseData.case_year || 'غير محدد'}  
                </div>  
                <div><small>كود القضية: ${caseData.case_code || `${caseData.case_number}/${caseData.case_year}`}</small></div>  
                ${adminNumber ? `<div><small>الرقم الإداري: ${adminNumber}</small></div>` : ''}
                ${caseData.opponent_name ? `<div><small>ضد: ${caseData.opponent_name}</small></div>` : ''}  
                <div class="mt-2 d-flex gap-2">  
                    <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); addToGoogleCalendarFromSession('${s.id}')">  
                        <i class="bi bi-calendar-plus"></i>  
                    </button>  
                    <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); setReminder('${s.id}')">  
                        <i class="bi bi-bell"></i>  
                    </button>  
                </div>  
            </div>`;  
        }).join('');  
    } catch (err) {
        console.error('خطأ في تحميل الجلسات القادمة:', err);
        upcomingSessions.innerHTML = "<div class='alert alert-danger'>خطأ في تحميل الجلسات القادمة</div>";
    }
}  
  
// الإشعارات - نسخة معدلة لا تسبب أخطاء
function requestNotificationPermission() {  
    if ("Notification" in window && Notification.permission === "default") {  
        Notification.requestPermission().then(permission => {  
            if (permission === "granted") {  
                console.log("تم تفعيل الإشعارات");  
            }  
        });  
    }  
}  
  
function sendNotification(title, body) {  
    try {
        // تحقق من أن المتصفح يدعم الإشعارات
        if (!("Notification" in window)) {
            console.log("هذا المتصفح لا يدعم الإشعارات");
            return;
        }
        
        // تحقق من صلاحية إنشاء إشعار
        if (Notification.permission === "granted") {
            // استخدم ServiceWorkerRegistration إذا كان متاحاً
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.ready.then(function(registration) {
                    registration.showNotification(title, {
                        body: body,
                        icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>'
                    });
                });
            } else {
                // استخدم Notification العادي
                new Notification(title, {   
                    body: body,  
                    icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>'  
                });
            }
        }
    } catch (err) {
        console.log('خطأ في إرسال الإشعار:', err);
        // لا تظهر خطأ للمستخدم
    }
}  
  
function enableNotifications() {  
    if ("Notification" in window) {  
        Notification.requestPermission().then(permission => {  
            if (permission === "granted") {  
                Swal.fire("تم", "تم تفعيل الإشعارات بنجاح", "success");  
                // إشعار اختباري آمن
                try {
                    sendNotification('نظام القضايا', 'تم تفعيل الإشعارات بنجاح');
                } catch (err) {
                    console.log('تعذر إرسال الإشعار الاختباري:', err);
                }
            } else {  
                Swal.fire("تم", "يمكنك تفعيل الإشعارات لاحقاً من إعدادات المتصفح", "info");  
            }  
        });  
    } else {  
        Swal.fire("عذراً", "المتصفح لا يدعم الإشعارات", "warning");  
    }  
}  
  
// وظائف مساعدة للجلسات  
async function addToGoogleCalendarFromSession(sessionId) {  
    // يمكن تطوير هذه الدالة لإضافة جلسة محددة للتقويم  
    Swal.fire("معلومة", "سيتم تطوير هذه الخاصية في التحديث القادم", "info");  
}  
  
function setReminder(sessionId) {  
    Swal.fire("معلومة", "سيتم تطوير خاصية التذكير في التحديث القادم", "info");  
}  
  
// تهيئة التاريخ الافتراضي في حقل الجلسة  
document.addEventListener('DOMContentLoaded', function() {  
    const now = new Date();  
    const nextWeek = new Date();  
    nextWeek.setDate(now.getDate() + 7);  
    const localDateTime = nextWeek.toISOString().slice(0, 16);  
    document.getElementById('s_date').value = localDateTime;  
    
    // اختبار اتصال Supabase عند تحميل الصفحة
    testSupabaseConnection();
});  
</script>  
  
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>  
<script>
    // وظيفة حساب الإحصائيات
    async function updateStatistics() {
        try {
            // جلب بيانات القضايا لحساب الإحصائيات
            const { data: cases, error } = await _supabase.from('cases').select('client_phone');
            if (error) throw error;

            if (cases) {
                // إجمالي القضايا
                document.getElementById('totalCasesCount').innerText = cases.length;
                
                // عدد العملاء الفريدين بناءً على رقم الهاتف لمنع التكرار
                const uniquePhones = new Set();
                cases.forEach(c => {
                    if (c.client_phone) {
                        // تنظيف رقم الهاتف من المسافات لضمان دقة الحساب
                        uniquePhones.add(c.client_phone.trim());
                    }
                });
                document.getElementById('totalClientsCount').innerText = uniquePhones.size;
            }
        } catch (err) {
            console.error('Error updating stats:', err);
        }
    }

    // ربط تحديث الإحصائيات بفتح تبويب البحث
    document.addEventListener('DOMContentLoaded', () => {
        const searchTabBtn = document.querySelector('button[data-bs-target="#search"]');
        if (searchTabBtn) {
            searchTabBtn.addEventListener('shown.bs.tab', updateStatistics);
        }
        // تحديث أولي عند الدخول
        updateStatistics();
    });
</script>
</body>
<div class="container-fluid px-3 mt-4">
    <!-- هنا يتم وضع التبويبات والنماذج من v1 مع استبدال الكلاسات -->
    <!-- ملاحظة للمستخدم: تم دمج المنطق البرمجي كاملاً في النسخة المرفقة -->
</div>

<script>
    // منطق الـ PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); deferredPrompt = e;
        document.getElementById('installBtn').style.display = 'block';
    });
    async function installPWA() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') deferredPrompt = null;
        }
    }
</script>

<script>
    // وظيفة حساب الإحصائيات
    async function updateStatistics() {
        try {
            // جلب بيانات القضايا لحساب الإحصائيات
            const { data: cases, error } = await _supabase.from('cases').select('client_phone');
            if (error) throw error;

            if (cases) {
                // إجمالي القضايا
                document.getElementById('totalCasesCount').innerText = cases.length;
                
                // عدد العملاء الفريدين بناءً على رقم الهاتف لمنع التكرار
                const uniquePhones = new Set();
                cases.forEach(c => {
                    if (c.client_phone) {
                        // تنظيف رقم الهاتف من المسافات لضمان دقة الحساب
                        uniquePhones.add(c.client_phone.trim());
                    }
                });
                document.getElementById('totalClientsCount').innerText = uniquePhones.size;
            }
        } catch (err) {
            console.error('Error updating stats:', err);
        }
    }

    // ربط تحديث الإحصائيات بفتح تبويب البحث
    document.addEventListener('DOMContentLoaded', () => {
        const searchTabBtn = document.querySelector('button[data-bs-target="#search"]');
        if (searchTabBtn) {
            searchTabBtn.addEventListener('shown.bs.tab', updateStatistics);
        }
        // تحديث أولي عند الدخول
        updateStatistics();
    });
</script>
</body>
</html>
